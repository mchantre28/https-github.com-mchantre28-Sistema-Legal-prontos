// === SISTEMA LEGAL ===
// v2026-02-19: filtro clientes Ativo por defeito, restaurarFiltros com fallback
// ÍNDICE DE SECÇÕES (para navegação):
// 1-230: Login, auth, utilitários
// 230-400: Firestore sync, listeners, indicador
// 400-500: configurarEventos, modais base
// 500-2900: carregarSecao, gerarConteudoSecao (dashboard, clientes, honorários, etc.)
// 2900-3100: fecharModalRobusto, modais
// 3100-4900: Filtros, migrações, heranças, registos, documentos
// 4900-5100: Tarefas
// 5100-10900: Prazos, calendário, notificações, relatórios
// 10900-12000: Documentos, convidados
// 12000-14500: Modais edição (cliente, contrato, honorário, etc.)
// 14500-22300: Backup, histórico, misc

// Debug: em true permite logs na consola; em false silencia (produção)
const DEBUG_LOG = false;
(function() {
    const orig = console.log;
    console.log = function(...a) { if (DEBUG_LOG) orig.apply(console, a); };
})();
// Silenciar avisos conhecidos (Tailwind CDN, Firestore enableIndexedDbPersistence deprecado)
(function() {
    const orig = console.warn;
    console.warn = function(m) {
        if (typeof m === 'string' && (m.includes('cdn.tailwindcss.com') || m.includes('enableIndexedDbPersistence'))) return;
        orig.apply(console, arguments);
    };
})();
// Stub para compatibilidade (evita "inicializarPWA is not defined" em versões antigas/cache)
function inicializarPWA() {}
if (typeof window !== 'undefined') window.inicializarPWA = inicializarPWA;

// Armazenamento: sessão e config vão para Firestore (sistema/sessao, sistema/config)
// appStorage mantido como fallback para migration flags e outros (usa sessionStorage)
const appStorage = typeof sessionStorage !== 'undefined' ? sessionStorage : { getItem: () => null, setItem: () => {}, removeItem: () => {}, clear: () => {}, get length() { return 0; }, key: () => null };

// IDs imutáveis (crypto.randomUUID) - evita mistura de registos entre dispositivos/sessões
function gerarIdImutavel() {
    return typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'
        ? crypto.randomUUID()
        : 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 11);
}

/** Normaliza id de formulário/URL: devolve número se for só dígitos (compat. antiga), senão string (UUID). */
function parseIdSafe(val) {
    if (val == null || val === '') return null;
    const s = String(val).trim();
    return /^\d+$/.test(s) ? parseInt(s, 10) : s;
}

// SISTEMA DE LOGIN
const USUARIO_PADRAO = 'admin';
const SENHA_PADRAO = 'APM2024!';
const CHAVE_SENHA_HASH = 'adminSenhaHash';
const LISTA_PAGINA_TAMANHO = 25;

/** Devolve hash SHA-256 da senha em hexadecimal (para guardar/comparar). */
async function hashSenha(senha) {
    if (!senha || typeof crypto === 'undefined' || !crypto.subtle) {
        return '';
    }
    const buf = new TextEncoder().encode(senha);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

/** Lê o hash da senha admin do Firestore. */
async function lerHashAdminFirestore() {
    if (!firestoreDb) return null;
    try {
        const doc = await firestoreDb.collection('sistema').doc('config').get();
        return doc.exists ? (doc.data().adminSenhaHash || null) : null;
    } catch (e) { console.warn('lerHashAdminFirestore:', e); return null; }
}

/** Guarda o hash da senha admin no Firestore. */
async function guardarHashAdminFirestore(hash) {
    if (!firestoreDb) return;
    try {
        await firestoreDb.collection('sistema').doc('config').set({ adminSenhaHash: hash, updatedAt: new Date().toISOString() }, { merge: true });
    } catch (e) { console.warn('guardarHashAdminFirestore:', e); }
}

/** Verifica se a senha do admin está correta. Hash no Firestore ou fallback appStorage. */
async function verificarSenhaAdmin(senha) {
    const h = await hashSenha(senha);
    let stored = null;
    if (firestoreDb) {
        stored = await lerHashAdminFirestore();
        if (!stored && senha === SENHA_PADRAO) {
            await guardarHashAdminFirestore(await hashSenha(SENHA_PADRAO));
            return true;
        }
    }
    if (!stored) stored = appStorage.getItem(CHAVE_SENHA_HASH);
    if (!stored) return senha === SENHA_PADRAO && h === await hashSenha(SENHA_PADRAO);
    return h === stored;
}

/** Abre modal para o admin alterar a senha (só visível para admin). */
function abrirModalAlterarSenha() {
    if (appStorage.getItem('tipoUsuario') !== 'admin') return;
    const html = `
        <div id="modalAlterarSenha" class="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50" onclick="if (event.target === this) fecharModalAlterarSenha()">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
                <h3 class="text-lg font-semibold mb-4">Alterar senha (Admin)</h3>
                <form id="formAlterarSenha" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Senha atual</label>
                        <input type="password" id="alterarSenhaAtual" class="w-full px-3 py-2 border border-gray-300 rounded-md" required placeholder="Senha atual">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nova senha</label>
                        <input type="password" id="alterarSenhaNova" class="w-full px-3 py-2 border border-gray-300 rounded-md" required placeholder="Nova senha" minlength="6">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar nova senha</label>
                        <input type="password" id="alterarSenhaConfirmar" class="w-full px-3 py-2 border border-gray-300 rounded-md" required placeholder="Repetir nova senha">
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="fecharModalAlterarSenha()" class="flex-1 py-2 px-4 border border-gray-300 rounded-md hover:bg-gray-100">Cancelar</button>
                        <button type="submit" class="flex-1 py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700">Guardar nova senha</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    const wrap = document.createElement('div');
    wrap.innerHTML = html;
    document.body.appendChild(wrap.firstElementChild);
    document.getElementById('formAlterarSenha').addEventListener('submit', async function(e) {
        e.preventDefault();
        const atual = document.getElementById('alterarSenhaAtual').value;
        const nova = document.getElementById('alterarSenhaNova').value;
        const conf = document.getElementById('alterarSenhaConfirmar').value;
        if (nova !== conf) {
            alert('A nova senha e a confirmação não coincidem.');
            return;
        }
        if (nova.length < 6) {
            alert('A nova senha deve ter pelo menos 6 caracteres.');
            return;
        }
        const ok = await verificarSenhaAdmin(atual);
        if (!ok) {
            alert('Senha atual incorreta.');
            return;
        }
        try {
            const novoHash = await hashSenha(nova);
            if (firestoreDb) await guardarHashAdminFirestore(novoHash);
            appStorage.setItem(CHAVE_SENHA_HASH, novoHash);
            if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Senha alterada com sucesso.', 'success');
            else alert('Senha alterada com sucesso.');
        } catch (err) {
            alert('Erro ao guardar: ' + (err.message || err));
        }
        fecharModalAlterarSenha();
    });
}
function fecharModalAlterarSenha() {
    const el = document.getElementById('modalAlterarSenha');
    if (el) el.remove();
}

/** Abre modal com atalhos de teclado disponíveis. */
function abrirModalAtalhos() {
    const existente = document.getElementById('modalAtalhos');
    if (existente) { existente.remove(); return; }
    const modal = document.createElement('div');
    modal.id = 'modalAtalhos';
    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black/50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[85vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold">Atalhos de teclado</h3>
                <button type="button" onclick="fecharModalAtalhos()" class="text-gray-500 hover:text-gray-700 p-1">×</button>
            </div>
            <div class="p-4 overflow-y-auto">
                <table class="w-full text-sm">
                    <tr><td class="py-2 font-mono bg-gray-50 px-2 rounded">Ctrl+K</td><td class="py-2 pl-3">Focar pesquisa global</td></tr>
                    <tr><td class="py-2 font-mono bg-gray-50 px-2 rounded">Ctrl+S</td><td class="py-2 pl-3">Guardar formulário em foco</td></tr>
                    <tr><td class="py-2 font-mono bg-gray-50 px-2 rounded">Esc</td><td class="py-2 pl-3">Fechar modal</td></tr>
                    <tr><td class="py-2 font-mono bg-gray-50 px-2 rounded">?</td><td class="py-2 pl-3">Abrir este painel</td></tr>
                </table>
                <p class="text-xs text-gray-500 mt-4">No Mac use ⌘ em vez de Ctrl.</p>
            </div>
        </div>
    `;
    modal.onclick = fecharModalAtalhos;
    document.body.appendChild(modal);
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
}
function fecharModalAtalhos() {
    const el = document.getElementById('modalAtalhos');
    if (el) el.remove();
}

// === FIREBASE (CONVIDADOS EM NUVEM) ===
const firebaseConfig = {
    apiKey: "AIzaSyBv1KtXvzvHKZRL367ST4GrZFTYVOmFuzE",
    authDomain: "anapaulamedinasolicitadora.firebaseapp.com",
    projectId: "anapaulamedinasolicitadora",
    storageBucket: "anapaulamedinasolicitadora.firebasestorage.app",
    messagingSenderId: "420983654368",
    appId: "1:420983654368:web:4918cacde4ea3603b78d85",
    measurementId: "G-Z3DM5PB0LR"
};

// App Check: chave reCAPTCHA v3. Desativado para evitar recaptcha-error em localhost.
const APP_CHECK_SITE_KEY = '';

let firestoreDb = null;

function initFirebase() {
    try {
        if (typeof firebase === 'undefined') return;
        if (!firebase.apps || firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        firestoreDb = firebase.firestore();
        // App Check (opcional): ativa em background para não bloquear init; se falhar, Firestore pode ainda funcionar se "Enforce" estiver desativado no Console
        if (APP_CHECK_SITE_KEY && typeof firebase.appCheck !== 'undefined') {
            setTimeout(() => {
                try {
                    const provider = firebase.appCheck?.ReCaptchaV3Provider
                        ? new firebase.appCheck.ReCaptchaV3Provider(APP_CHECK_SITE_KEY)
                        : APP_CHECK_SITE_KEY;
                    firebase.appCheck().activate(provider, true);
                } catch (e) { console.warn('App Check não ativado:', e?.message || e); }
            }, 0);
        }
        const deveLimparCache = (typeof sessionStorage !== 'undefined' ? sessionStorage : {}).getItem?.('limparCacheFirestoreNaProximaCarga') === 'true';
        if (deveLimparCache) {
            try { sessionStorage.removeItem('limparCacheFirestoreNaProximaCarga'); } catch (e) {}
            const limparCache = async () => {
                try {
                    await firestoreDb.clearPersistence();
                } catch (err) {
                    console.warn('clearPersistence falhou, a tentar IndexedDB:', err?.message || err);
                    // Fallback: apagar bases IndexedDB do Firestore manualmente
                    const projId = (firebaseConfig && firebaseConfig.projectId) || 'anapaulamedinasolicitadora';
                    const dbNames = ['firestore', 'firebasefirestore', 'firestore_[DEFAULT]_' + projId + '_default'];
                    for (const name of dbNames) {
                        try {
                            if (typeof indexedDB !== 'undefined' && indexedDB.deleteDatabase) {
                                indexedDB.deleteDatabase(name);
                            }
                        } catch (e) {}
                    }
                    if (typeof indexedDB !== 'undefined' && indexedDB.databases) {
                        indexedDB.databases().then(dbs => {
                            (dbs || []).filter(d => d.name && d.name.includes('firestore')).forEach(d => {
                                try { indexedDB.deleteDatabase(d.name); } catch (e) {}
                            });
                        }).catch(() => {});
                    }
                }
            };
            window.__promiseCacheFirestoreLimpo = limparCache().finally(() => {
                try { firestoreDb.enablePersistence().catch(() => {}); } catch (e) {}
            });
        } else {
            // enablePersistence deprecado; manter para offline - aviso silenciado
            try { firestoreDb.enablePersistence().catch(() => {}); } catch (e) {}
        }
    } catch (error) {
        console.warn('Firebase não inicializado:', error);
    }
}

initFirebase();

// Firestore = fonte principal dos dados (cache offline via IndexedDB)
// Entidades de negócio que vão para Firestore:
// - clientes | processos (herancas, migracoes, registos) | tarefas | honorarios | contratos | logs (auditoria)
// Corrigir user-dollar inexistente no Lucide
(function(){var m={'user-dollar':'circle-dollar-sign'};var f=function(){for(var i in m)document.querySelectorAll('[data-lucide="'+i+'"]').forEach(function(el){el.setAttribute('data-lucide',m[i])})};if(typeof lucide!=='undefined'&&lucide.createIcons){var o=lucide.createIcons.bind(lucide);lucide.createIcons=function(){f();return o()}};document.readyState==='loading'?document.addEventListener('DOMContentLoaded',f):f()})();
const CLOUD_ENTIDADES = [
    // 'clientes' omitido: APENAS Firestore (ouvirClientes + criar/atualizar/apagarClienteCloud)
    'honorarios',
    'contratos',
    'prazos',
    'notificacoes',
    'herancas',   // processos
    'migracoes',  // processos
    'registos',   // processos
    'documentos',
    'tarefas',
    'convidados',
    'entidades',
    'integracoes_externas',
    'representantes'
];
/** Entidades portuguesas — útil para a solicitadora associar processos, tarefas e documentos às instituições corretas */
const ENTIDADES_PORTUGAL = [
    { id: '', nome: '— Nenhuma / Outra —' },
    { id: 'financas_at', nome: 'Finanças (AT)' },
    { id: 'conservatorias_irn', nome: 'Conservatórias (IRN)' },
    { id: 'imt', nome: 'IMT' },
    { id: 'camaras_municipais', nome: 'Câmaras Municipais' },
    { id: 'seguranca_social', nome: 'Segurança Social' },
    { id: 'bancos', nome: 'Bancos' },
    { id: 'embaixadas_consulados', nome: 'Embaixadas / Consulados' },
    { id: 'registo_predial', nome: 'Registo Predial (Online)' },
    { id: 'registo_comercial', nome: 'Registo Comercial (Online)' },
    { id: 'registo_automovel', nome: 'Registo Automóvel (Online)' }
];
const CLOUD_DEBOUNCE_MS = 100; // Firestore = fonte principal; sync rápido para enviar dados à nuvem
window.__cloudSyncTimers = window.__cloudSyncTimers || {};

// Gestor de listeners Firestore — pausa e retoma para evitar conflitos durante backup/importação
const listenerManager = {
    activeListeners: [],
    add(unsubscribeFn) {
        if (typeof unsubscribeFn === 'function') this.activeListeners.push(unsubscribeFn);
    },
    pause() {
        this.activeListeners.forEach(unsub => { try { unsub(); } catch (e) { console.warn(e); } });
        this.activeListeners = [];
    },
    resume(iniciarListenersFn) {
        if (typeof iniciarListenersFn === 'function') iniciarListenersFn();
    }
};
window.listenerManager = listenerManager;

/** Reativa todos os listeners Firestore (para backup/loader e importBackup) */
function startAllListeners() {
    iniciarListenersFirestore();
}
window.startAllListeners = startAllListeners;

/** Inicia os listeners Firestore em tempo real (para retomar após pause em import/backup) */
function iniciarListenersFirestore() {
    if (!isCloudReady()) return;
    window.__ouvirClientesUnsubscribe = ouvirClientes((lista) => {
        clientes = lista; window.clientes = clientes;
        // Atualizar sempre a secao visivel quando clientes chegam (evita F5 apos login)
        if (typeof secaoAtiva === 'string') {
            carregarSecao(secaoAtiva);
            if (typeof atualizarInterface === 'function') atualizarInterface();
        }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirClientesUnsubscribe);
    window.__ouvirContratosUnsubscribe = ouvirContratos((lista) => {
        contratos = lista; window.contratos = contratos;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirContratosUnsubscribe);
    window.__ouvirHonorariosUnsubscribe = ouvirHonorarios((lista) => {
        honorarios = lista; window.honorarios = honorarios;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirHonorariosUnsubscribe);
    for (const entidade of PROCESSO_ENTIDADES) {
        const key = '__ouvir' + entidade.charAt(0).toUpperCase() + entidade.slice(1).replace(/s$/, '') + 'sUnsubscribe';
        window[key] = ouvirProcessos(entidade, (lista) => {
            if (entidade === 'herancas') { herancas = lista; window.herancas = herancas; }
            else if (entidade === 'migracoes') { migracoes = lista; window.migracoes = migracoes; }
            else if (entidade === 'registos') { registos = lista; window.registos = registos; }
            if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
        });
    }
    PROCESSO_ENTIDADES.forEach(ent => { const k = '__ouvir' + ent.charAt(0).toUpperCase() + ent.slice(1).replace(/s$/, '') + 'sUnsubscribe'; if (window[k]) (window.addListener || listenerManager.add.bind(listenerManager))(window[k]); });
    window.__ouvirTarefasUnsubscribe = ouvirTarefas((lista) => {
        tarefas = lista; window.tarefas = tarefas;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirTarefasUnsubscribe);
    window.__ouvirPrazosUnsubscribe = ouvirPrazos((lista) => {
        prazos = lista; window.prazos = prazos;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirPrazosUnsubscribe);
    window.__ouvirNotificacoesUnsubscribe = ouvirNotificacoes((lista) => {
        notificacoes = lista; window.notificacoes = notificacoes;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirNotificacoesUnsubscribe);
    window.__ouvirDocumentosUnsubscribe = ouvirDocumentos((lista) => {
        documentos = lista; window.documentos = documentos;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirDocumentosUnsubscribe);
    window.__ouvirConvidadosUnsubscribe = ouvirConvidados((lista) => {
        convidados = lista; window.convidados = convidados;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirConvidadosUnsubscribe);
    window.__ouvirEntidadesUnsubscribe = ouvirEntidades((lista) => {
        entidades = lista; window.entidades = entidades;
        if (lista.length === 0 && isCloudReady() && !window.__entidadesSeedTentado) {
            window.__entidadesSeedTentado = true;
            seedEntidadesSeVazio();
        }
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirEntidadesUnsubscribe);
    window.__ouvirIntegracoesExternasUnsubscribe = ouvirIntegracoesExternas((lista) => {
        integracoesExternas = lista; window.integracoesExternas = integracoesExternas;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirIntegracoesExternasUnsubscribe);
    window.__ouvirRepresentantesUnsubscribe = ouvirRepresentantes((lista) => {
        representantes = lista; window.representantes = representantes;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirRepresentantesUnsubscribe);
    window.__ouvirFaturasUnsubscribe = ouvirFaturas((lista) => {
        window.faturas = lista;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirFaturasUnsubscribe);
    window.__ouvirPagamentosUnsubscribe = ouvirPagamentos((lista) => {
        pagamentos = lista;
        window.pagamentos = pagamentos;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirPagamentosUnsubscribe);
    window.__ouvirDespesasUnsubscribe = ouvirDespesas((lista) => {
        despesas = lista;
        window.despesas = despesas;
        if (typeof secaoAtiva === 'string') { carregarSecao(secaoAtiva); if (typeof atualizarInterface === 'function') atualizarInterface(); }
    });
    (window.addListener || listenerManager.add.bind(listenerManager))(window.__ouvirDespesasUnsubscribe);
}
window.__cloudSyncPending = window.__cloudSyncPending || 0;
window.__cloudSyncError = window.__cloudSyncError || null;

function isCloudReady() {
    return !!firestoreDb;
}

/** Formata tempo relativo: "agora", "há 1 min", "há 5 min", "há 1 h", etc. */
function formatarTempoRelativo(isoString) {
    if (!isoString) return 'agora';
    const d = new Date(isoString);
    const agora = new Date();
    const seg = Math.floor((agora - d) / 1000);
    if (seg < 15) return 'agora';
    if (seg < 60) return `há ${seg} s`;
    const min = Math.floor(seg / 60);
    if (min < 60) return `há ${min} min`;
    const h = Math.floor(min / 60);
    if (h < 24) return `há ${h} h`;
    const dias = Math.floor(h / 24);
    return `há ${dias} d`;
}

/** Devolve o texto "Sincronizado há X" para o badge. */
function obterTextoUltimaSincronizacao() {
    try {
        const iso = appStorage.getItem('cloudSyncUltimoSucesso');
        const txt = formatarTempoRelativo(iso);
        return txt === 'agora' ? 'Sincronizado' : `Sinc. ${txt}`;
    } catch (e) { return 'Sincronizado'; }
}

function atualizarIndicadorSync(status, mensagem) {
    const badge = document.getElementById('syncStatusBadge');
    if (!badge) return;
    const dot = badge.querySelector('.sync-dot');
    const text = badge.querySelector('.sync-text');
    const banner = document.getElementById('offlineBanner');
    const labels = {
        ok: mensagem || obterTextoUltimaSincronizacao(),
        syncing: mensagem || 'A sincronizar...',
        offline: mensagem || 'Offline — dados locais, sincroniza ao reconectar',
        error: mensagem || 'Erro — alterações por sincronizar, clique para tentar'
    };
    const colors = {
        ok: '#10b981',
        syncing: '#f59e0b',
        offline: '#6b7280',
        error: '#ef4444'
    };
    if (text) text.textContent = labels[status] || labels.ok;
    if (dot) dot.style.background = colors[status] || colors.ok;
    badge.setAttribute('data-status', status);
    if (status === 'ok') badge.title = `Última sincronização: ${formatarTempoRelativo(appStorage.getItem('cloudSyncUltimoSucesso') || '')}`;
    else if (status === 'error') badge.title = 'Há alterações por sincronizar. Clique para tentar novamente.';
    else if (status === 'offline') badge.title = 'Sem ligação. Os dados estão guardados localmente e serão sincronizados quando reconectar.';
    else if (status === 'syncing') badge.title = 'A sincronizar com a nuvem...';
    else badge.title = '';
    badge.style.cursor = (status === 'error' || status === 'offline') ? 'pointer' : '';
    // Mostrar o banner amarelo "Está offline" só quando o browser está realmente sem internet
    if (banner) {
        const semInternet = typeof navigator !== 'undefined' && navigator.onLine === false;
        banner.classList.toggle('show', status === 'offline' && semInternet);
    }
}

function iniciarSync() {
    window.__cloudSyncPending = (window.__cloudSyncPending || 0) + 1;
    atualizarIndicadorSync('syncing');
}

function finalizarSync(erro) {
    window.__cloudSyncPending = Math.max(0, (window.__cloudSyncPending || 0) - 1);
    if (erro) {
        window.__cloudSyncError = erro;
    }
    if (window.__cloudSyncPending === 0) {
        if (window.__cloudSyncError) {
            atualizarIndicadorSync('error', 'Erro — clique para tentar');
            const msg = navigator.onLine
                ? 'Erro de sincronização. 1) Verifique a internet. 2) Clique no indicador vermelho (canto superior direito) para tentar novamente. Os dados locais estão guardados.'
                : 'Sem ligação à internet. Verifique a Wi-Fi ou dados móveis. Clique no indicador vermelho para sincronizar quando voltar a ter conexão.';
            mostrarNotificacao(msg, 'error');
            try {
                appStorage.setItem('cloudSyncUltimoErro', new Date().toISOString());
            } catch (error) {
                console.warn('Erro ao guardar último erro de sync:', error);
            }
        } else {
            atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline');
            if (isCloudReady()) {
                try {
                    appStorage.setItem('cloudSyncUltimoSucesso', new Date().toISOString());
                } catch (error) {
                    console.warn('Erro ao guardar último sync:', error);
                }
            }
        }
    }
}

function obterIdEntidade(entidade, item) {
    if (!item) return null;
    if (entidade === 'convidados') {
        return item.codigo || item.id || null;
    }
    return item.id ?? null;
}

function normalizarParaComparacao(item) {
    const clone = { ...(item || {}) };
    delete clone.updatedAt;
    delete clone.createdAt;
    delete clone.lastModifiedBy;
    return JSON.stringify(clone);
}

function prepararListaParaSync(entidade, lista) {
    if (!Array.isArray(lista)) return lista;
    const agoraIso = new Date().toISOString();
    const anteriores = Array.isArray(obterListaGlobal(entidade)) ? obterListaGlobal(entidade) : [];
    const prevMap = new Map();
    (anteriores || []).forEach(item => {
        const id = obterIdEntidade(entidade, item);
        if (id !== null && id !== undefined) {
            prevMap.set(String(id), item);
        }
    });
    const tipoUsuario = (window.__tipoUsuario || window.__sessionTipoUsuario || 'N/D').toString();
    const usuarioNome = (window.__usuarioNome || window.__sessionUsuarioNome || 'Sistema').toString();
    return lista.map(item => {
        const id = obterIdEntidade(entidade, item);
        const prev = id !== null && id !== undefined ? prevMap.get(String(id)) : null;
        const mudou = normalizarParaComparacao(item) !== normalizarParaComparacao(prev);
        const novo = { ...item };
        if (!novo.createdAt && !novo.dataCriacao) {
            novo.createdAt = prev?.createdAt || prev?.dataCriacao || agoraIso;
        }
        if (!novo.updatedAt) {
            novo.updatedAt = prev?.updatedAt || novo.dataCriacao || novo.createdAt || agoraIso;
        }
        if (mudou) {
            novo.updatedAt = agoraIso;
            novo.lastModifiedBy = {
                tipo: tipoUsuario,
                nome: usuarioNome,
                em: agoraIso
            };
        } else if (prev?.lastModifiedBy && !novo.lastModifiedBy) {
            novo.lastModifiedBy = prev.lastModifiedBy;
        }
        return novo;
    });
}

// Estrutura Firestore clientes: tipo (particular|empresa), razaoSocial, documentosIdentificacao, ativo
function prepararClienteParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    const obj = {
        id: item.id,
        tipo: item.tipo ?? 'particular',
        nome: item.nome ?? '',
        razaoSocial: item.razaoSocial ?? '',
        nif: item.nif ?? '',
        email: item.email ?? '',
        telefone: item.telefone ?? '',
        contactos: item.contactos ?? { emailAlternativo: '', telefoneAlternativo: '' },
        morada: item.morada ?? item.endereco ?? '',
        documentosIdentificacao: item.documentosIdentificacao ?? [],
        ativo: item.ativo !== false,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true,
        status: item.status ?? 'ativo',
        endereco: item.endereco ?? item.morada ?? '',
        dataCriacao: item.dataCriacao ?? item.createdAt ?? agora,
        criadoPorConvidado: item.criadoPorConvidado ?? null,
        criadoPor: item.criadoPor ?? 'N/D',
        criadoPorTipo: (item.criadoPorTipo && String(item.criadoPorTipo).trim()) || 'admin',
        criadoPorNome: item.criadoPorNome ?? 'N/D',
        tipoUsuario: item.tipoUsuario ?? 'N/D'
    };
    return Object.fromEntries(Object.entries(obj).filter(([, v]) => v !== undefined));
}

function lerClienteDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        endereco: data.endereco ?? data.morada ?? '',
        dataCriacao: data.dataCriacao ?? data.createdAt
    };
}

// Estrutura Firestore representantes: clienteEmpresaId, validadeProcuracao, poderes
function prepararRepresentanteParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        clienteEmpresaId: item.clienteEmpresaId ?? null,
        clienteEmpresaNome: item.clienteEmpresaNome ?? '',
        nome: item.nome ?? '',
        nif: item.nif ?? '',
        cargo: item.cargo ?? '',
        contactoEmail: item.contactoEmail ?? '',
        contactoTelefone: item.contactoTelefone ?? '',
        poderes: item.poderes ?? [],
        documentoIdentificacaoUrl: item.documentoIdentificacaoUrl ?? '',
        procuracaoUrl: item.procuracaoUrl ?? '',
        validadeProcuracao: item.validadeProcuracao ?? null,
        ativo: item.ativo !== false,
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerRepresentanteDoFirestore(data) {
    if (!data) return data;
    return { ...data };
}

// Estrutura Firestore faturas: numero, clienteId, valorTotal, estado, dataEmissao
function prepararFaturaParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        id: item.id,
        numero: item.numero ?? '',
        clienteId: item.clienteId ?? '',
        clienteNome: item.clienteNome ?? '',
        honorarioId: item.honorarioId ?? null,
        processoTipo: item.processoTipo ?? null,
        processoId: item.processoId ?? null,
        dataEmissao: item.dataEmissao ?? item.data ?? agora,
        valorTotal: parseFloat(item.valorTotal ?? item.valor ?? 0),
        valorBase: parseFloat(item.valorBase ?? item.valor ?? 0),
        valorIva: parseFloat(item.valorIva ?? item.juros ?? 0),
        estado: item.estado ?? item.status ?? 'pendente',
        itens: item.itens ?? [],
        metodoPagamento: item.metodoPagamento ?? '',
        notas: item.notas ?? item.observacoes ?? '',
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerFaturaDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        data: data.data ?? data.dataEmissao,
        valor: data.valor ?? data.valorTotal,
        status: data.status ?? data.estado,
        observacoes: data.observacoes ?? data.notas
    };
}

// Estrutura Firestore pagamentos: faturaId, valor, dataPagamento, metodoPagamento
function prepararPagamentoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        id: item.id,
        faturaId: item.faturaId ?? '',
        valor: parseFloat(item.valor ?? 0),
        dataPagamento: item.dataPagamento ?? item.data ?? agora.split('T')[0],
        metodoPagamento: item.metodoPagamento ?? item.metodo ?? '',
        referencia: item.referencia ?? '',
        notas: item.notas ?? '',
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora,
        anulado: item.anulado === true,
        deleted: item.deleted === true
    };
}

function lerPagamentoDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        data: data.data ?? data.dataPagamento,
        metodo: data.metodo ?? data.metodoPagamento
    };
}

const DESPESA_TIPOS = ['taxa', 'certidao', 'deslocacao', 'fotocopia', 'outro'];
const DESPESA_PROCESOS = ['herancas', 'migracoes', 'registos'];

function prepararDespesaParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        id: item.id,
        processoTipo: item.processoTipo ?? 'herancas',
        processoId: item.processoId ?? '',
        descricao: item.descricao ?? '',
        valor: parseFloat(item.valor ?? 0),
        data: item.data ?? agora.split('T')[0],
        tipo: item.tipo ?? 'outro',
        anulado: item.anulado === true,
        deleted: item.deleted === true,
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora
    };
}

function lerDespesaDoFirestore(data) {
    if (!data) return data;
    return { ...data };
}

// === CRUD Clientes (simples e seguro, usa serverTimestamp) ===
function obterServerTimestamp() {
    return typeof firebase !== 'undefined' && firebase.firestore && firebase.firestore.FieldValue
        ? firebase.firestore.FieldValue.serverTimestamp()
        : new Date().toISOString();
}

async function criarClienteCloud(cliente) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = cliente.id || gerarIdImutavel();
    const prep = prepararClienteParaFirestore({ ...cliente, id });
    const payload = Object.fromEntries(
        Object.entries({
            ...prep,
            id,
            createdAt: obterServerTimestamp(),
            updatedAt: obterServerTimestamp(),
            deleted: false
        }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('clientes').doc(String(id)).set(payload, { merge: true });
    return { ...cliente, id, ...payload };
}

async function obterClienteCloud(id) {
    if (!isCloudReady() || !id) return null;
    const doc = await firestoreDb.collection('clientes').doc(String(id)).get();
    if (!doc.exists) return null;
    return lerClienteDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarClienteCloud(id, dados) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    const prep = prepararClienteParaFirestore({ ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('clientes').doc(String(id)).update(payload);
    return { ...dados, id };
}

async function excluirClienteCloud(id, softDelete = false) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    if (softDelete) {
        await apagarClienteCloud(id);
    } else {
        await firestoreDb.collection('clientes').doc(String(id)).delete();
    }
}

/** Soft delete: marca cliente como apagado (deleted: true, updatedAt no servidor). */
async function apagarClienteCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('clientes').doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

// === CRUD Contratos (Firestore como fonte principal) ===
// UI integrada: salvarContrato → criarContratoCloud (setDoc) | excluirContrato → apagarContratoCloud (updateDoc deleted: true)
// Leitura: ouvirContratos atualiza global contratos em tempo real; obterContratosAtual() prioriza essa fonte
async function criarContratoCloud(contrato) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = contrato.id || gerarIdImutavel();
    const payload = {
        ...prepararContratoParaFirestore({ ...contrato, id }),
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection('contratos').doc(String(id)).set(payload, { merge: true });
    return { ...contrato, id, ...payload };
}

async function obterContratoCloud(id) {
    if (!isCloudReady() || !id) return null;
    const doc = await firestoreDb.collection('contratos').doc(String(id)).get();
    if (!doc.exists) return null;
    return lerContratoDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarContratoCloud(id, dados) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    const prep = prepararContratoParaFirestore({ ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('contratos').doc(String(id)).update(payload);
    return { ...dados, id };
}

async function apagarContratoCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('contratos').doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

// === CRUD Honorários (Firestore como fonte principal) ===
async function criarHonorarioCloud(honorario) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = honorario.id || gerarIdImutavel();
    const payload = {
        ...prepararHonorarioParaFirestore({ ...honorario, id }),
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection('honorarios').doc(String(id)).set(payload, { merge: true });
    return { ...honorario, id, ...payload };
}

async function obterHonorarioCloud(id) {
    if (!isCloudReady() || !id) return null;
    const doc = await firestoreDb.collection('honorarios').doc(String(id)).get();
    if (!doc.exists) return null;
    return lerHonorarioDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarHonorarioCloud(id, dados) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    const prep = prepararHonorarioParaFirestore({ ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('honorarios').doc(String(id)).update(payload);
    return { ...dados, id };
}

async function apagarHonorarioCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('honorarios').doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

/** Criar pagamento no Firestore e atualizar fatura (somaPagamentos, estado). */
async function criarPagamentoCloud(pagamento) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const faturaId = pagamento.faturaId;
    if (!faturaId) throw new Error('faturaId obrigatório');
    const id = pagamento.id || gerarIdImutavel();
    const prep = prepararPagamentoParaFirestore({ ...pagamento, id });
    const payload = { ...prep, id, anulado: false, deleted: false };
    await firestoreDb.collection('pagamentos').doc(String(id)).set(payload, { merge: true });
    await atualizarFaturaAposPagamento(faturaId);
    return { ...pagamento, id };
}

/** Recalcula somaPagamentos na fatura e atualiza estado (pago/pendente). */
async function atualizarFaturaAposPagamento(faturaId) {
    if (!isCloudReady() || !faturaId) return;
    const snap = await firestoreDb.collection('pagamentos').where('faturaId', '==', String(faturaId)).get();
    const soma = snap.docs
        .filter(d => !d.data().anulado && !d.data().deleted)
        .reduce((s, d) => s + (parseFloat(d.data().valor) || 0), 0);
    const faturaDoc = await firestoreDb.collection('faturas').doc(String(faturaId)).get();
    if (!faturaDoc.exists) return;
    const valorTotal = parseFloat(faturaDoc.data().valorTotal ?? faturaDoc.data().valor ?? 0);
    const estado = soma >= valorTotal ? 'pago' : (soma > 0 ? 'parcial' : 'pendente');
    await firestoreDb.collection('faturas').doc(String(faturaId)).update({
        somaPagamentos: soma,
        estado,
        updatedAt: obterServerTimestamp()
    });
}

/** Criar/atualizar fatura no Firestore. */
async function criarFaturaCloud(fatura) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = fatura.id || gerarIdImutavel();
    const prep = prepararFaturaParaFirestore({ ...fatura, id });
    const payload = {
        ...prep,
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection('faturas').doc(String(id)).set(payload, { merge: true });
    return { ...fatura, id };
}

/** Escuta honorários em tempo real. Devolve função para cancelar a subscrição. */
function ouvirHonorarios(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('honorarios').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(h => !h.deleted)
            .map(lerHonorarioDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de honorários:', err);
    });
}

/** Escuta contratos em tempo real. Devolve função para cancelar a subscrição. */
function ouvirContratos(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('contratos').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(c => !c.deleted)
            .map(lerContratoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de contratos:', err);
    });
}

/** Escuta representantes em tempo real. */
function ouvirRepresentantes(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('representantes').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(r => !r.deleted)
            .map(lerRepresentanteDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de representantes:', err);
    });
}

/** Escuta faturas em tempo real. */
function ouvirFaturas(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('faturas').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(f => !f.deleted && f.id !== 'seed-inicial')
            .map(lerFaturaDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de faturas:', err);
    });
}

/** Escuta pagamentos em tempo real. */
function ouvirPagamentos(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('pagamentos').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => !p.deleted && !p.anulado && p.id !== 'seed-inicial')
            .map(lerPagamentoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de pagamentos:', err);
    });
}

/** Escuta despesas em tempo real. */
function ouvirDespesas(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('despesas').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(d => !d.deleted && !d.anulado && d.id !== 'seed-inicial')
            .map(lerDespesaDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de despesas:', err);
    });
}

async function criarDespesaCloud(despesa) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const processoTipo = despesa.processoTipo || 'herancas';
    const processoId = despesa.processoId;
    if (!processoId) throw new Error('Processo obrigatório');
    const valor = parseFloat(despesa.valor ?? 0);
    if (valor < 0) throw new Error('Valor inválido');

    const id = despesa.id || gerarIdImutavel();
    const prep = prepararDespesaParaFirestore({ ...despesa, id });
    const payload = { ...prep, id, createdAt: obterServerTimestamp(), updatedAt: obterServerTimestamp(), deleted: false, anulado: false };
    await firestoreDb.collection('despesas').doc(String(id)).set(payload, { merge: true });
    return { ...despesa, id };
}

async function anularDespesaCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('despesas').doc(String(id)).update({ anulado: true, updatedAt: obterServerTimestamp() });
}

/** Criar pagamento e atualizar somaPagamentos na fatura. */
async function criarPagamentoCloud(pagamento) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const faturaId = pagamento.faturaId;
    if (!faturaId) throw new Error('Fatura obrigatória');
    const valor = parseFloat(pagamento.valor ?? 0);
    if (valor <= 0) throw new Error('Valor deve ser maior que zero');

    const id = pagamento.id || gerarIdImutavel();
    const prep = prepararPagamentoParaFirestore({ ...pagamento, id });
    const payload = {
        ...prep,
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false,
        anulado: false
    };

    await firestoreDb.collection('pagamentos').doc(String(id)).set(payload, { merge: true });

    const faturaRef = firestoreDb.collection('faturas').doc(String(faturaId));
    const faturaSnap = await faturaRef.get();
    if (faturaSnap.exists) {
        const faturaData = faturaSnap.data();
        const somaAtual = parseFloat(faturaData.somaPagamentos ?? 0) || 0;
        const novaSoma = somaAtual + valor;
        const valorTotal = parseFloat(faturaData.valorTotal ?? faturaData.valor ?? 0) || 0;
        const estado = novaSoma >= valorTotal - 0.01 ? 'pago' : (faturaData.estado || 'pendente');
        await faturaRef.update({
            somaPagamentos: novaSoma,
            estado,
            updatedAt: obterServerTimestamp()
        });
    }
    return { ...pagamento, id };
}

/** Escuta clientes em tempo real. Devolve função para cancelar a subscrição. */
function ouvirClientes(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('clientes').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(c => !c.deleted)
            .map(lerClienteDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de clientes:', err);
    });
}

// === CRUD Processos (heranças, migrações, registos) ===
async function criarProcessoCloud(entidade, item) {
    if (!isCloudReady() || !PROCESSO_ENTIDADES.includes(entidade)) throw new Error('Firestore ou entidade inválida');
    const id = item.id || gerarIdImutavel();
    const payload = {
        ...prepararProcessoParaFirestore(entidade, { ...item, id }),
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection(entidade).doc(String(id)).set(payload, { merge: true });
    return { ...item, id, ...payload };
}

async function obterProcessoCloud(entidade, id) {
    if (!isCloudReady() || !id || !PROCESSO_ENTIDADES.includes(entidade)) return null;
    const doc = await firestoreDb.collection(entidade).doc(String(id)).get();
    if (!doc.exists) return null;
    return lerProcessoDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarProcessoCloud(entidade, id, dados) {
    if (!isCloudReady() || !id || !PROCESSO_ENTIDADES.includes(entidade)) throw new Error('Firestore ou id inválido');
    const prep = prepararProcessoParaFirestore(entidade, { ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection(entidade).doc(String(id)).update(payload);
    return { ...dados, id };
}

async function apagarProcessoCloud(entidade, id) {
    if (!isCloudReady() || !id || !PROCESSO_ENTIDADES.includes(entidade)) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection(entidade).doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

/** Escuta processos em tempo real. entidade: herancas | migracoes | registos */
function ouvirProcessos(entidade, callback) {
    if (!isCloudReady() || !PROCESSO_ENTIDADES.includes(entidade)) return () => {};
    return firestoreDb.collection(entidade).onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => !p.deleted)
            .map(lerProcessoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de', entidade, ':', err);
    });
}

// === CRUD Tarefas ===
async function criarTarefaCloud(tarefa) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = tarefa.id || gerarIdImutavel();
    const payload = {
        ...prepararTarefaParaFirestore({ ...tarefa, id }),
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection('tarefas').doc(String(id)).set(payload, { merge: true });
    return { ...tarefa, id, ...payload };
}

async function obterTarefaCloud(id) {
    if (!isCloudReady() || !id) return null;
    const doc = await firestoreDb.collection('tarefas').doc(String(id)).get();
    if (!doc.exists) return null;
    return lerTarefaDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarTarefaCloud(id, dados) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    const prep = prepararTarefaParaFirestore({ ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('tarefas').doc(String(id)).update(payload);
    return { ...dados, id };
}

async function apagarTarefaCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('tarefas').doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

/** Escuta tarefas em tempo real. Devolve função para cancelar a subscrição. */
function ouvirTarefas(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('tarefas').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(t => !t.deleted)
            .map(lerTarefaDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de tarefas:', err);
    });
}

// === CRUD Prazos ===
async function criarPrazoCloud(prazo) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = prazo.id || gerarIdImutavel();
    const payload = {
        ...prepararPrazoParaFirestore({ ...prazo, id }),
        id,
        createdAt: obterServerTimestamp(),
        updatedAt: obterServerTimestamp(),
        deleted: false
    };
    await firestoreDb.collection('prazos').doc(String(id)).set(payload, { merge: true });
    return { ...prazo, id, ...payload };
}

async function obterPrazoCloud(id) {
    if (!isCloudReady() || !id) return null;
    const doc = await firestoreDb.collection('prazos').doc(String(id)).get();
    if (!doc.exists) return null;
    return lerPrazoDoFirestore({ id: doc.id, ...doc.data() });
}

async function atualizarPrazoCloud(id, dados) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    const prep = prepararPrazoParaFirestore({ ...dados, id });
    const payload = Object.fromEntries(
        Object.entries({ ...prep, updatedAt: obterServerTimestamp() }).filter(([, v]) => v !== undefined)
    );
    await firestoreDb.collection('prazos').doc(String(id)).update(payload);
    return { ...dados, id };
}

async function apagarPrazoCloud(id) {
    if (!isCloudReady() || !id) throw new Error('Firestore ou id inválido');
    await firestoreDb.collection('prazos').doc(String(id)).update({
        deleted: true,
        updatedAt: obterServerTimestamp()
    });
}

/** Escuta prazos em tempo real. */
function ouvirPrazos(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('prazos').onSnapshot((snapshot) => {
        const lista = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(p => !p.deleted)
            .map(lerPrazoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => {
        console.warn('Erro na escuta em tempo real de prazos:', err);
    });
}

// === CRUD Notificações ===
async function criarNotificacaoCloud(notificacao) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = notificacao.id || gerarIdImutavel();
    const payload = {
        ...prepararNotificacaoParaFirestore({ ...notificacao, id }),
        id, createdAt: obterServerTimestamp(), updatedAt: obterServerTimestamp(), deleted: false
    };
    await firestoreDb.collection('notificacoes').doc(String(id)).set(payload, { merge: true });
    return { ...notificacao, id, ...payload };
}

async function apagarNotificacaoCloud(id) {
    if (!isCloudReady() || !id) return;
    await firestoreDb.collection('notificacoes').doc(String(id)).update({ deleted: true, updatedAt: obterServerTimestamp() });
}

function ouvirNotificacoes(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('notificacoes').onSnapshot((snapshot) => {
        const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(n => !n.deleted).map(lerNotificacaoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => console.warn('Erro na escuta de notificações:', err));
}

// === CRUD Documentos ===
async function criarDocumentoCloud(documento) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = documento.id || gerarIdImutavel();
    const payload = {
        ...prepararDocumentoParaFirestore({ ...documento, id }),
        id, createdAt: obterServerTimestamp(), updatedAt: obterServerTimestamp(), deleted: false
    };
    await firestoreDb.collection('documentos').doc(String(id)).set(payload, { merge: true });
    return { ...documento, id, ...payload };
}

async function apagarDocumentoCloud(id) {
    if (!isCloudReady() || !id) return;
    await firestoreDb.collection('documentos').doc(String(id)).update({ deleted: true, updatedAt: obterServerTimestamp() });
}

function ouvirDocumentos(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('documentos').onSnapshot((snapshot) => {
        const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(d => !d.deleted).map(lerDocumentoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => console.warn('Erro na escuta de documentos:', err));
}

// === CRUD Convidados ===
async function criarConvidadoCloud(convidado) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const codigo = convidado.codigo || gerarCodigoAcesso();
    const payload = {
        ...prepararConvidadoParaFirestore({ ...convidado, codigo }),
        codigo, createdAt: obterServerTimestamp(), updatedAt: obterServerTimestamp(), deleted: false
    };
    await firestoreDb.collection('convidados').doc(String(codigo)).set(payload, { merge: true });
    return { ...convidado, codigo, ...payload };
}

async function apagarConvidadoCloud(codigoOuId) {
    if (!isCloudReady() || !codigoOuId) return;
    const docId = String(codigoOuId);
    await firestoreDb.collection('convidados').doc(docId).update({ deleted: true, updatedAt: obterServerTimestamp() });
}

function ouvirConvidados(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('convidados').onSnapshot((snapshot) => {
        const lista = snapshot.docs.map(doc => ({ ...doc.data(), codigo: doc.id, id: doc.data().id || doc.id })).filter(c => !c.deleted).map(lerConvidadoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => console.warn('Erro na escuta de convidados:', err));
}

// === ENTIDADES (Integrações Externas - catálogo) ===
function prepararEntidadeParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        id: item.id,
        nome: item.nome ?? '',
        tipo: item.tipo ?? 'outra',
        sigla: item.sigla ?? '',
        contactos: item.contactos ?? null,
        website: item.website ?? '',
        portalUrl: item.portalUrl ?? '',
        ativo: item.ativo !== false,
        notas: item.notas ?? '',
        ordem: typeof item.ordem === 'number' ? item.ordem : 0,
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}
function lerEntidadeDoFirestore(data) {
    if (!data) return data;
    return { ...data };
}
async function criarEntidadeCloud(item) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = item.id || gerarIdImutavel();
    const payload = prepararEntidadeParaFirestore({ ...item, id });
    await firestoreDb.collection('entidades').doc(String(id)).set(payload, { merge: true });
    return { ...item, id, ...payload };
}
async function atualizarEntidadeCloud(id, dados) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const payload = { ...prepararEntidadeParaFirestore({ ...dados, id }), updatedAt: new Date().toISOString() };
    await firestoreDb.collection('entidades').doc(String(id)).update(payload);
    return { ...dados, id, ...payload };
}
async function desativarEntidadeCloud(id) {
    if (!isCloudReady()) return;
    await firestoreDb.collection('entidades').doc(String(id)).update({ ativo: false, updatedAt: new Date().toISOString() });
}
function ouvirEntidades(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('entidades').onSnapshot((snapshot) => {
        const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(e => !e.deleted).map(lerEntidadeDoFirestore).sort((a, b) => (a.ordem || 0) - (b.ordem || 0));
        if (typeof callback === 'function') callback(lista);
    }, (err) => console.warn('Erro na escuta de entidades:', err));
}
/** Seed inicial: popula coleção entidades a partir de ENTIDADES_PORTUGAL se estiver vazia. */
async function seedEntidadesSeVazio() {
    if (!isCloudReady()) return;
    try {
        const snap = await firestoreDb.collection('entidades').limit(1).get();
        if (!snap.empty) return;
        const tipos = { financas_at: 'financas', conservatorias_irn: 'conservatoria', imt: 'imt', camaras_municipais: 'camara_municipal', seguranca_social: 'seguranca_social', bancos: 'banco', embaixadas_consulados: 'embaixada_consulado', registo_predial: 'registo_online', registo_comercial: 'registo_online', registo_automovel: 'registo_online' };
        const origem = (typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).filter(e => e.id);
        for (let i = 0; i < origem.length; i++) {
            const e = origem[i];
            await criarEntidadeCloud({
                id: e.id,
                nome: e.nome,
                tipo: tipos[e.id] || 'outra',
                ativo: true,
                ordem: i
            });
        }
    } catch (err) { console.warn('Seed entidades:', err); }
}

/** Retorna ENTIDADES_PORTUGAL da coleção Firestore ou fallback para constante. */
function obterEntidadesParaSelect() {
    const lista = Array.isArray(entidades) ? entidades.filter(e => e.ativo !== false) : [];
    if (lista.length > 0) {
        return [{ id: '', nome: '— Nenhuma / Outra —' }, ...lista.map(e => ({ id: e.id, nome: e.nome }))];
    }
    return typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : [{ id: '', nome: '— Nenhuma / Outra —' }];
}

// === INTEGRAÇÕES EXTERNAS ===
function prepararIntegracaoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        id: item.id,
        entidadeId: item.entidadeId ?? '',
        entidadeNome: item.entidadeNome ?? '',
        clienteId: item.clienteId ?? null,
        clienteNome: item.clienteNome ?? '',
        processoTipo: item.processoTipo ?? 'heranca',
        processoId: item.processoId ?? null,
        processoRef: item.processoRef ?? '',
        tipoInteracao: item.tipoInteracao ?? 'pedido',
        descricao: item.descricao ?? '',
        estado: item.estado ?? 'pendente',
        dataEnvio: item.dataEnvio ?? null,
        dataResposta: item.dataResposta ?? null,
        prazoResposta: item.prazoResposta ?? null,
        canal: item.canal ?? 'online',
        referenciaExterna: item.referenciaExterna ?? '',
        anexosEnvio: Array.isArray(item.anexosEnvio) ? item.anexosEnvio : [],
        anexosResposta: Array.isArray(item.anexosResposta) ? item.anexosResposta : [],
        comprovativoPagamento: item.comprovativoPagamento ?? '',
        taxaPaga: typeof item.taxaPaga === 'number' ? item.taxaPaga : 0,
        utilizadorId: item.utilizadorId ?? null,
        utilizadorNome: item.utilizadorNome ?? '',
        createdAt: item.createdAt ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}
function lerIntegracaoDoFirestore(data) {
    if (!data) return data;
    return { ...data };
}
async function criarIntegracaoCloud(item) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const id = item.id || gerarIdImutavel();
    const payload = prepararIntegracaoParaFirestore({ ...item, id });
    await firestoreDb.collection('integracoes_externas').doc(String(id)).set(payload, { merge: true });
    await criarLogIntegracaoCloud({ integracaoId: id, acao: 'criar', detalhes: { descricao: item.descricao } });
    return { ...item, id, ...payload };
}
async function atualizarIntegracaoCloud(id, dados) {
    if (!isCloudReady()) throw new Error('Firestore não disponível');
    const payload = { ...prepararIntegracaoParaFirestore({ ...dados, id }), updatedAt: new Date().toISOString() };
    await firestoreDb.collection('integracoes_externas').doc(String(id)).update(payload);
    await criarLogIntegracaoCloud({ integracaoId: id, acao: 'atualizar', detalhes: {} });
    return { ...dados, id, ...payload };
}
async function apagarIntegracaoCloud(id) {
    if (!isCloudReady()) return;
    await firestoreDb.collection('integracoes_externas').doc(String(id)).update({ deleted: true, updatedAt: new Date().toISOString() });
}
function ouvirIntegracoesExternas(callback) {
    if (!isCloudReady()) return () => {};
    return firestoreDb.collection('integracoes_externas').onSnapshot((snapshot) => {
        const lista = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(i => !i.deleted).map(lerIntegracaoDoFirestore);
        if (typeof callback === 'function') callback(lista);
    }, (err) => console.warn('Erro na escuta de integracoes_externas:', err));
}

// === LOGS INTEGRAÇÕES (auditoria) ===
async function criarLogIntegracaoCloud(item) {
    if (!isCloudReady()) return;
    const id = gerarIdImutavel();
    const payload = {
        id,
        integracaoId: item.integracaoId ?? '',
        acao: item.acao ?? 'criar',
        data: new Date().toISOString(),
        utilizadorId: item.utilizadorId ?? appStorage.getItem('usuarioLogado') ?? null,
        utilizadorNome: item.utilizadorNome ?? '',
        detalhes: item.detalhes ?? {},
        createdAt: new Date().toISOString()
    };
    await firestoreDb.collection('logs_integracoes').doc(id).set(payload, { merge: true });
}

// Estrutura Firestore processos: numeroInterno, solicitadorResponsavel, dataConclusao
const PROCESSO_ENTIDADES = ['herancas', 'migracoes', 'registos'];
const PROCESSO_TIPOS = { herancas: 'heranca', migracoes: 'migracao', registos: 'registo' };

function prepararProcessoParaFirestore(entidade, item) {
    if (!item || !PROCESSO_ENTIDADES.includes(entidade)) return item;
    const agora = new Date().toISOString();
    const tipoProcesso = PROCESSO_TIPOS[entidade] || entidade.replace(/s$/, '');
    return {
        ...item,
        numeroInterno: item.numeroInterno ?? item.numero ?? '',
        clienteId: item.clienteId ?? null,
        clienteNome: item.clienteNome ?? '',
        tipo: item.tipo ?? tipoProcesso,
        estado: item.estado ?? item.status ?? '',
        prioridade: item.prioridade ?? 'media',
        dataAbertura: item.dataAbertura ?? item.dataCriacao ?? item.createdAt ?? agora,
        dataConclusao: item.dataConclusao ?? null,
        solicitadorResponsavel: item.solicitadorResponsavel ?? null,
        descricao: item.descricao ?? '',
        notas: item.notas ?? '',
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerProcessoDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        status: data.status ?? data.estado,
        prioridade: data.prioridade ?? 'media',
        dataCriacao: data.dataCriacao ?? data.createdAt
    };
}

// Estrutura Firestore tarefas: processoTipo, processoId, estado, prazo, responsavelId
function prepararTarefaParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        processoTipo: item.processoTipo ?? null,
        processoId: item.processoId ?? item.referenciaId ?? null,
        clienteId: item.clienteId ?? null,
        titulo: item.titulo ?? '',
        descricao: item.descricao ?? '',
        estado: item.estado ?? (item.concluida ? 'concluida' : 'aberta'),
        concluida: item.concluida === true || item.status === 'concluida',
        prazo: item.prazo ?? item.dataLimite ?? null,
        dataLimite: item.dataLimite ?? item.prazo ?? null,
        responsavelId: item.responsavelId ?? null,
        anexos: item.anexos ?? [],
        dataCriacao: item.dataCriacao ?? item.createdAt ?? agora,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerTarefaDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        status: data.status ?? (data.concluida ? 'concluida' : 'aberta'),
        dataCriacao: data.dataCriacao ?? data.createdAt
    };
}

// Estrutura recomendada Firestore honorarios: processoId, valor, descricao, data, createdAt, updatedAt, deleted
function prepararHonorarioParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        processoId: item.processoId ?? item.referenciaId ?? null,
        valor: item.valor ?? 0,
        descricao: item.descricao ?? item.servico ?? '',
        data: item.data ?? item.vencimento ?? item.dataCriacao ?? agora,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerHonorarioDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        servico: data.servico ?? data.descricao,
        vencimento: data.vencimento ?? data.data,
        dataCriacao: data.dataCriacao ?? data.createdAt
    };
}

// Estrutura recomendada Firestore contratos: clienteId, tipo, descricao, valor, status, vencimento, createdAt, updatedAt, deleted
function prepararContratoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        clienteId: item.clienteId ?? null,
        tipo: item.tipo ?? '',
        descricao: item.descricao ?? '',
        valor: item.valor ?? 0,
        valorIVA: item.valorIVA ?? 0,
        valorTotal: item.valorTotal ?? item.valor ?? 0,
        status: item.status ?? 'ativo',
        vencimento: item.vencimento ?? item.dataFim ?? null,
        dataInicio: item.dataInicio ?? null,
        dataFim: item.dataFim ?? null,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? item.dataAtualizacao ?? agora,
        deleted: item.deleted === true
    };
}

function lerContratoDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        dataCriacao: data.dataCriacao ?? data.createdAt,
        dataAtualizacao: data.dataAtualizacao ?? data.updatedAt
    };
}

// Estrutura Firestore prazos: processoTipo, processoId, tipoPrazo, entidadeRelacionada, alertaGerado
function prepararPrazoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        processoTipo: item.processoTipo ?? null,
        processoId: item.processoId ?? item.referenciaId ?? null,
        clienteId: item.clienteId ?? null,
        tipo: item.tipo ?? item.tipoPrazo ?? '',
        tipoPrazo: item.tipoPrazo ?? item.tipo ?? 'legal',
        descricao: item.descricao ?? '',
        dataLimite: item.dataLimite ?? null,
        entidadeRelacionada: item.entidadeRelacionada ?? null,
        alertaGerado: item.alertaGerado === true,
        status: item.status ?? 'ativo',
        prioridade: item.prioridade ?? 'media',
        referenciaId: item.referenciaId ?? null,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? item.dataAtualizacao ?? agora,
        deleted: item.deleted === true
    };
}

function lerPrazoDoFirestore(data) {
    if (!data) return data;
    return {
        ...data,
        dataCriacao: data.dataCriacao ?? data.createdAt,
        dataAtualizacao: data.dataAtualizacao ?? data.updatedAt
    };
}

function prepararNotificacaoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        tipo: item.tipo ?? '',
        titulo: item.titulo ?? '',
        mensagem: item.mensagem ?? '',
        destinatarioId: item.destinatarioId ?? 'todos',
        lida: item.lida === true,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerNotificacaoDoFirestore(data) {
    if (!data) return data;
    return { ...data, dataCriacao: data.dataCriacao ?? data.createdAt };
}

function prepararDocumentoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        clienteId: item.clienteId ?? null,
        nomeArquivo: item.nomeArquivo ?? '',
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerDocumentoDoFirestore(data) {
    if (!data) return data;
    return { ...data, dataCriacao: data.dataCriacao ?? data.createdAt };
}

function prepararConvidadoParaFirestore(item) {
    if (!item) return item;
    const agora = new Date().toISOString();
    return {
        ...item,
        nome: item.nome ?? '',
        codigo: item.codigo ?? item.id,
        clientesAutorizados: item.clientesAutorizados ?? [],
        ativo: item.ativo !== false,
        createdAt: item.createdAt ?? item.dataCriacao ?? agora,
        updatedAt: item.updatedAt ?? agora,
        deleted: item.deleted === true
    };
}

function lerConvidadoDoFirestore(data) {
    if (!data) return data;
    return { ...data, dataCriacao: data.dataCriacao ?? data.createdAt };
}

function obterListaGlobal(entidade) {
    if (entidade === 'clientes') return obterClientesAtual();
    if (entidade === 'honorarios') return honorarios;
    if (entidade === 'contratos') return contratos;
    if (entidade === 'prazos') return prazos;
    if (entidade === 'notificacoes') return notificacoes;
    if (entidade === 'herancas') return herancas;
    if (entidade === 'migracoes') return migracoes;
    if (entidade === 'registos') return registos;
    if (entidade === 'documentos') return documentos;
    if (entidade === 'tarefas') return tarefas;
    if (entidade === 'convidados') return obterConvidadosAtual();
    if (entidade === 'entidades') return obterEntidadesAtual();
    if (entidade === 'integracoes_externas') return obterIntegracoesExternasAtual();
    if (entidade === 'representantes') return representantes || [];
    return [];
}

function salvarEntidadeCloud(entidade, item) {
    if (!isCloudReady()) return Promise.resolve();
    const id = obterIdEntidade(entidade, item);
    if (id === null || id === undefined) return Promise.resolve();
    let payload = item;
    if (entidade === 'clientes') payload = prepararClienteParaFirestore(item);
    else if (PROCESSO_ENTIDADES.includes(entidade)) payload = prepararProcessoParaFirestore(entidade, item);
    else if (entidade === 'tarefas') payload = prepararTarefaParaFirestore(item);
    else if (entidade === 'honorarios') payload = prepararHonorarioParaFirestore(item);
    else if (entidade === 'contratos') payload = prepararContratoParaFirestore(item);
    else if (entidade === 'prazos') payload = prepararPrazoParaFirestore(item);
    else if (entidade === 'notificacoes') payload = prepararNotificacaoParaFirestore(item);
    else if (entidade === 'documentos') payload = prepararDocumentoParaFirestore(item);
    else if (entidade === 'convidados') payload = prepararConvidadoParaFirestore(item);
    else if (entidade === 'entidades') payload = prepararEntidadeParaFirestore(item);
    else if (entidade === 'integracoes_externas') payload = prepararIntegracaoParaFirestore(item);
    else if (entidade === 'representantes') payload = prepararRepresentanteParaFirestore(item);
    if (payload && typeof payload === 'object') payload = Object.fromEntries(Object.entries(payload).filter(([, v]) => v !== undefined));
    return firestoreDb.collection(entidade).doc(String(id)).set(payload, { merge: true })
        .catch((error) => {
            console.warn(`Erro ao salvar ${entidade} na nuvem:`, error);
            window.__cloudSyncError = error;
        });
}

function excluirEntidadeCloud(entidade, id) {
    if (!isCloudReady()) return Promise.resolve();
    if (id === null || id === undefined) return Promise.resolve();
    return firestoreDb.collection(entidade).doc(String(id)).delete()
        .catch((error) => {
            console.warn(`Erro ao excluir ${entidade} na nuvem:`, error);
            window.__cloudSyncError = error;
        });
}

function agendarSyncEntidade(entidade, lista, removidos = []) {
    if (!CLOUD_ENTIDADES.includes(entidade)) return;
    if (window.__cloudSyncTimers[entidade]) {
        clearTimeout(window.__cloudSyncTimers[entidade]);
    }
    window.__cloudSyncTimers[entidade] = setTimeout(async () => {
        if (!isCloudReady()) {
            atualizarIndicadorSync('offline');
            return;
        }
        iniciarSync();
        try {
            const promises = [];
            (lista || []).forEach(item => promises.push(salvarEntidadeCloud(entidade, item)));
            (removidos || []).forEach(id => promises.push(excluirEntidadeCloud(entidade, id)));
            await Promise.all(promises);
            try {
                appStorage.setItem('cloudSyncUltimaEntidade', entidade);
                appStorage.setItem('cloudSyncUltimaEntidadeEm', new Date().toISOString());
            } catch (error) {
                console.warn('Erro ao guardar última entidade sincronizada:', error);
            }
        } catch (error) {
            console.warn(`Erro no sync de ${entidade}:`, error);
            window.__cloudSyncError = error;
        } finally {
            finalizarSync(window.__cloudSyncError);
        }
    }, CLOUD_DEBOUNCE_MS);
}

function obterTimestampItem(item) {
    const valor = item?.updatedAt || item?.dataCriacao || item?.createdAt || item?.data;
    const ts = valor ? new Date(valor).getTime() : 0;
    return Number.isNaN(ts) ? 0 : ts;
}

function mesclarListasPorId(entidade, local, cloud) {
    const map = new Map();
    // Firestore = fonte principal: cloud sempre ganha em conflitos; local só traz itens offline (não presentes na nuvem)
    const idsCloud = new Set((cloud || []).map(i => String(obterIdEntidade(entidade, i))).filter(Boolean));
    (local || []).forEach(item => {
        const id = obterIdEntidade(entidade, item);
        if (id === null || id === undefined) return;
        if (idsCloud.has(String(id))) return; // já existe na nuvem → Firestore ganha
        map.set(String(id), item); // item só local (criado offline)
    });
    (cloud || []).forEach(item => {
        const id = obterIdEntidade(entidade, item);
        if (id === null || id === undefined) return;
        map.set(String(id), item); // Firestore é a fonte de verdade
    });
    return Array.from(map.values());
}

async function sincronizarEntidadeNuvem(entidade) {
    if (!isCloudReady()) return;
    if (!CLOUD_ENTIDADES.includes(entidade)) return;
    iniciarSync();
    try {
        const local = Array.isArray(obterListaGlobal(entidade)) ? obterListaGlobal(entidade) : [];
        // Se o utilizador fez "Limpar todos os dados", não trazer dados da nuvem (mantém local vazio)
        const naoRestaurar = appStorage.getItem('naoRestaurarDaNuvem') === 'true';
        let merged;
        if (naoRestaurar) {
            merged = local;
        } else {
            const snap = await firestoreDb.collection(entidade).get();
            const raw = snap.docs.map(doc => doc.data());
            let cloud = raw;
            if (entidade === 'clientes') {
                cloud = raw.map(lerClienteDoFirestore).filter(c => !c.deleted);
            } else if (PROCESSO_ENTIDADES.includes(entidade)) {
                cloud = raw.map(lerProcessoDoFirestore).filter(p => !p.deleted);
            } else if (entidade === 'tarefas') {
                cloud = raw.map(lerTarefaDoFirestore).filter(t => !t.deleted);
            } else if (entidade === 'honorarios') {
                cloud = raw.map(lerHonorarioDoFirestore).filter(h => !h.deleted);
            } else if (entidade === 'contratos') {
                cloud = raw.map(lerContratoDoFirestore).filter(c => !c.deleted);
            } else if (entidade === 'prazos') {
                cloud = raw.map(lerPrazoDoFirestore).filter(p => !p.deleted);
            } else if (entidade === 'notificacoes') {
                cloud = raw.map(lerNotificacaoDoFirestore).filter(n => !n.deleted);
            } else if (entidade === 'documentos') {
                cloud = raw.map(lerDocumentoDoFirestore).filter(d => !d.deleted);
            } else if (entidade === 'convidados') {
                cloud = snap.docs.map(doc => ({ ...doc.data(), codigo: doc.id, id: doc.data().id || doc.id })).map(lerConvidadoDoFirestore).filter(c => !c.deleted);
            } else if (entidade === 'entidades') {
                cloud = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(e => !e.deleted).map(lerEntidadeDoFirestore);
            } else if (entidade === 'integracoes_externas') {
                cloud = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(i => !i.deleted).map(lerIntegracaoDoFirestore);
            } else if (entidade === 'representantes') {
                cloud = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).filter(r => !r.deleted).map(lerRepresentanteDoFirestore);
            }
            merged = mesclarListasPorId(entidade, local, cloud);
        }
        salvarDados(entidade, merged, { skipCloudSync: true });
        try {
            appStorage.setItem('cloudSyncUltimaEntidade', entidade);
            appStorage.setItem('cloudSyncUltimaEntidadeEm', new Date().toISOString());
        } catch (error) {
            console.warn('Erro ao guardar última entidade sincronizada:', error);
        }
        try {
            appStorage.setItem('cloudSyncUltimaEntidade', entidade);
            appStorage.setItem('cloudSyncUltimaEntidadeEm', new Date().toISOString());
        } catch (error) {
            console.warn('Erro ao guardar última entidade sincronizada:', error);
        }
    } catch (error) {
        console.warn(`Erro ao sincronizar ${entidade}:`, error);
        window.__cloudSyncError = error;
    } finally {
        finalizarSync(window.__cloudSyncError);
    }
}

const CHAVE_MIGRACAO_CLIENTES = 'clientesMigradosParaFirestore';

/** Migração clientes: desativada. Clientes apenas do Firestore. */
async function migrarClientesLocalParaFirestore() {
    if (!isCloudReady()) return;
    try { appStorage.setItem(CHAVE_MIGRACAO_CLIENTES, 'true'); } catch (e) {}
}

/** Migração: envia dados do localStorage (e sessionStorage) para Firestore e limpa o storage. Executa uma vez. */
const CHAVE_LOCALSTORAGE_MIGRADO = 'localStorageMigradoParaFirebase';
async function migrarLocalStorageParaFirestore(forcar = false) {
    if (!isCloudReady() || !window.localStorage) return;
    if (!forcar && appStorage.getItem(CHAVE_LOCALSTORAGE_MIGRADO) === 'true') return;
    const entidades = ['clientes', 'honorarios', 'contratos', 'prazos', 'notificacoes', 'herancas', 'migracoes', 'registos', 'documentos', 'tarefas', 'convidados'];
    let migrouAlgo = false;
    try {
        for (const entidade of entidades) {
            const raw = localStorage.getItem(entidade) || appStorage.getItem(entidade);
            const lista = raw ? (() => { try { return JSON.parse(raw); } catch (e) { return []; } })() : [];
            if (!Array.isArray(lista) || lista.length === 0) continue;
            const criarFn = entidade === 'clientes' ? criarClienteCloud : entidade === 'honorarios' ? criarHonorarioCloud : entidade === 'contratos' ? criarContratoCloud : entidade === 'prazos' ? criarPrazoCloud : entidade === 'convidados' ? criarConvidadoCloud : null;
            const criarProcesso = entidade === 'herancas' || entidade === 'migracoes' || entidade === 'registos';
            for (const item of lista) {
                if (!item || item.deleted === true) continue;
                if (!item.id) item.id = gerarIdImutavel();
                if (criarFn) await criarFn(item);
                else if (criarProcesso) await criarProcessoCloud(entidade, item);
                else if (entidade === 'notificacoes' && typeof criarNotificacaoCloud === 'function') await criarNotificacaoCloud(item);
                else if (entidade === 'documentos' && typeof criarDocumentoCloud === 'function') await criarDocumentoCloud(item);
                else if (entidade === 'tarefas' && typeof criarTarefaCloud === 'function') await criarTarefaCloud(item);
                migrouAlgo = true;
            }
            try { localStorage.removeItem(entidade); appStorage.removeItem(entidade); } catch (e) {}
        }
        if (migrouAlgo && typeof mostrarNotificacao === 'function') mostrarNotificacao('Dados migrados do storage local para Firebase.', 'success');
        appStorage.setItem(CHAVE_LOCALSTORAGE_MIGRADO, 'true');
    } catch (err) { console.warn('migrarLocalStorageParaFirestore:', err); }
}

/** Migração manual: envia dados de localStorage/sessionStorage para Firebase e limpa o storage. Chamado pelo botão em Backup. */
async function executarMigracaoLocalParaFirebase() {
    if (!isCloudReady()) {
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Firebase não configurado. Configure o firebaseConfig em script.js.', 'error');
        return;
    }
    if (!confirm('Migrar todos os dados em localStorage/sessionStorage para o Firebase? Os dados locais serão eliminados após a migração.')) return;
    try {
        appStorage.removeItem(CHAVE_LOCALSTORAGE_MIGRADO);
        await migrarLocalStorageParaFirestore(true);
        const entidades = ['clientes', 'honorarios', 'contratos', 'prazos', 'notificacoes', 'herancas', 'migracoes', 'registos', 'documentos', 'tarefas', 'convidados', 'entidades', 'integracoes_externas'];
        if (typeof localStorage !== 'undefined') {
            entidades.forEach(e => { try { localStorage.removeItem(e); } catch (x) {} });
        }
        entidades.forEach(e => { try { appStorage.removeItem(e); } catch (x) {} });
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Migração concluída. Dados agora apenas no Firebase.', 'success');
        if (typeof carregarSecao === 'function') carregarSecao(secaoAtiva || 'backup');
    } catch (err) {
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Erro na migração: ' + (err?.message || err), 'error');
    }
}

const CHAVE_MIGRACAO_HONORARIOS = 'honorariosMigrados';

/** Migração única: envia honorários do appStorage (sessionStorage) para o Firestore. Executa uma vez. */
async function migrarHonorariosLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_HONORARIOS) === 'true') return;

    const raw = localStorage.getItem('honorarios') || appStorage.getItem('honorarios');
    const honorariosLocal = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(honorariosLocal) || honorariosLocal.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_HONORARIOS, 'true'); } catch (e) {}
        return;
    }

    try {
        for (const h of honorariosLocal) {
            if (!h || (h.deleted === true)) continue;
            if (!h.id) h.id = gerarIdImutavel();
            await criarHonorarioCloud(h);
        }
        appStorage.removeItem('honorarios');
        appStorage.setItem(CHAVE_MIGRACAO_HONORARIOS, 'true');
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao('Honorários migrados para a nuvem.', 'success');
        }
    } catch (err) {
        console.warn('Erro na migração de honorários:', err);
    }
}

const CHAVE_MIGRACAO_CONTRATOS = 'contratosMigrados';

/** Migração única: envia processos (heranças/migrações/registos) do appStorage para Firestore. */
async function migrarProcessosLocalParaFirestore(entidade) {
    if (!isCloudReady() || !PROCESSO_ENTIDADES.includes(entidade)) return;
    const chave = entidade + 'Migrados';
    if (appStorage.getItem(chave) === 'true') return;

    const raw = appStorage.getItem(entidade);
    const lista = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(lista) || lista.length === 0) {
        try { appStorage.setItem(chave, 'true'); } catch (e) {}
        return;
    }

    try {
        for (const p of lista) {
            if (!p || (p.deleted === true)) continue;
            if (!p.id) p.id = gerarIdImutavel();
            await criarProcessoCloud(entidade, p);
        }
        appStorage.removeItem(entidade);
        appStorage.setItem(chave, 'true');
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao(entidade + ' migrados para a nuvem.', 'success');
        }
    } catch (err) {
        console.warn('Erro na migração de', entidade, ':', err);
    }
}

/** Migração única: envia contratos do appStorage para o Firestore. Executa uma vez. */
async function migrarContratosLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_CONTRATOS) === 'true') return;

    const raw = appStorage.getItem('contratos');
    const contratosLocal = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(contratosLocal) || contratosLocal.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_CONTRATOS, 'true'); } catch (e) {}
        return;
    }

    try {
        for (const c of contratosLocal) {
            if (!c || (c.deleted === true)) continue;
            if (!c.id) c.id = gerarIdImutavel();
            await criarContratoCloud(c);
        }
        appStorage.removeItem('contratos');
        appStorage.setItem(CHAVE_MIGRACAO_CONTRATOS, 'true');
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao('Contratos migrados para a nuvem.', 'success');
        }
    } catch (err) {
        console.warn('Erro na migração de contratos:', err);
    }
}

const CHAVE_MIGRACAO_TAREFAS = 'tarefasMigrados';

/** Migração única: envia tarefas do appStorage para o Firestore. */
async function migrarTarefasLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_TAREFAS) === 'true') return;

    const raw = appStorage.getItem('tarefas');
    const tarefasLocal = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(tarefasLocal) || tarefasLocal.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_TAREFAS, 'true'); } catch (e) {}
        return;
    }

    try {
        for (const t of tarefasLocal) {
            if (!t || (t.deleted === true)) continue;
            if (!t.id) t.id = gerarIdImutavel();
            await criarTarefaCloud(t);
        }
        appStorage.removeItem('tarefas');
        appStorage.setItem(CHAVE_MIGRACAO_TAREFAS, 'true');
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao('Tarefas migradas para a nuvem.', 'success');
        }
    } catch (err) {
        console.warn('Erro na migração de tarefas:', err);
    }
}

const CHAVE_MIGRACAO_PRAZOS = 'prazosMigrados';

const CHAVE_MIGRACAO_NOTIFICACOES = 'notificacoesMigrados';
/** Migração única: envia notificações do appStorage para o Firestore. */
async function migrarNotificacoesLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_NOTIFICACOES) === 'true') return;
    const raw = appStorage.getItem('notificacoes');
    const lista = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(lista) || lista.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_NOTIFICACOES, 'true'); } catch (e) {}
        return;
    }
    try {
        for (const n of lista) {
            if (!n || (n.deleted === true)) continue;
            if (!n.id) n.id = gerarIdImutavel();
            await criarNotificacaoCloud(n);
        }
        appStorage.removeItem('notificacoes');
        appStorage.setItem(CHAVE_MIGRACAO_NOTIFICACOES, 'true');
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Notificações migradas para a nuvem.', 'success');
    } catch (err) { console.warn('Erro na migração de notificações:', err); }
}

const CHAVE_MIGRACAO_DOCUMENTOS = 'documentosMigrados';
/** Migração única: envia documentos do appStorage para o Firestore. */
async function migrarDocumentosLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_DOCUMENTOS) === 'true') return;
    const raw = appStorage.getItem('documentos');
    const lista = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(lista) || lista.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_DOCUMENTOS, 'true'); } catch (e) {}
        return;
    }
    try {
        for (const d of lista) {
            if (!d || (d.deleted === true)) continue;
            if (!d.id) d.id = gerarIdImutavel();
            await criarDocumentoCloud(d);
        }
        appStorage.removeItem('documentos');
        appStorage.setItem(CHAVE_MIGRACAO_DOCUMENTOS, 'true');
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Documentos migrados para a nuvem.', 'success');
    } catch (err) { console.warn('Erro na migração de documentos:', err); }
}

const CHAVE_MIGRACAO_FATURAS = 'faturasMigrados';
/** Migração única: envia faturas do appStorage para o Firestore. */
async function migrarFaturasLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_FATURAS) === 'true') return;
    const raw = appStorage.getItem('faturas');
    const lista = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(lista) || lista.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_FATURAS, 'true'); } catch (e) {}
        return;
    }
    try {
        for (const f of lista) {
            if (!f || (f.deleted === true) || f.id === 'seed-inicial') continue;
            if (!f.id) f.id = gerarIdImutavel();
            await criarFaturaCloud(f);
        }
        appStorage.removeItem('faturas');
        appStorage.setItem(CHAVE_MIGRACAO_FATURAS, 'true');
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Faturas migradas para a nuvem.', 'success');
    } catch (err) { console.warn('Erro na migração de faturas:', err); }
}

const CHAVE_MIGRACAO_CONVIDADOS = 'convidadosMigrados';
/** Migração única: envia convidados do appStorage para o Firestore. */
async function migrarConvidadosLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_CONVIDADOS) === 'true') return;
    const raw = appStorage.getItem('convidados');
    const lista = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(lista) || lista.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_CONVIDADOS, 'true'); } catch (e) {}
        return;
    }
    try {
        for (const c of lista) {
            if (!c || (c.deleted === true)) continue;
            if (!c.codigo) c.codigo = gerarCodigoAcesso();
            await criarConvidadoCloud(c);
        }
        appStorage.removeItem('convidados');
        appStorage.setItem(CHAVE_MIGRACAO_CONVIDADOS, 'true');
        if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Convidados migrados para a nuvem.', 'success');
    } catch (err) { console.warn('Erro na migração de convidados:', err); }
}

/** Migração única: envia prazos do appStorage para o Firestore. */
async function migrarPrazosLocalParaFirestore() {
    if (!isCloudReady()) return;
    if (appStorage.getItem(CHAVE_MIGRACAO_PRAZOS) === 'true') return;

    const raw = appStorage.getItem('prazos');
    const prazosLocal = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(prazosLocal) || prazosLocal.length === 0) {
        try { appStorage.setItem(CHAVE_MIGRACAO_PRAZOS, 'true'); } catch (e) {}
        return;
    }

    try {
        for (const p of prazosLocal) {
            if (!p || (p.deleted === true)) continue;
            if (!p.id) p.id = gerarIdImutavel();
            await criarPrazoCloud(p);
        }
        appStorage.removeItem('prazos');
        appStorage.setItem(CHAVE_MIGRACAO_PRAZOS, 'true');
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao('Prazos migrados para a nuvem.', 'success');
        }
    } catch (err) {
        console.warn('Erro na migração de prazos:', err);
    }
}

async function sincronizarTodasEntidadesNuvem() {
    if (!isCloudReady()) {
        atualizarIndicadorSync('offline');
        return;
    }
    await migrarLocalStorageParaFirestore();
    await migrarClientesLocalParaFirestore();
    await migrarContratosLocalParaFirestore();
    await migrarHonorariosLocalParaFirestore();
    for (const entidade of PROCESSO_ENTIDADES) {
        await migrarProcessosLocalParaFirestore(entidade);
    }
    await migrarTarefasLocalParaFirestore();
    await migrarPrazosLocalParaFirestore();
    await migrarNotificacoesLocalParaFirestore();
    await migrarDocumentosLocalParaFirestore();
    await migrarConvidadosLocalParaFirestore();
    await migrarFaturasLocalParaFirestore();
    for (const entidade of CLOUD_ENTIDADES) {
        await sincronizarEntidadeNuvem(entidade);
    }
}

/** Após sincronização com a nuvem, atualiza dados locais e refresca a interface (para ver dados vindos da nuvem). */
function refrescarInterfaceAposSync() {
    carregarDados();
    if (typeof secaoAtiva === 'string') carregarSecao(secaoAtiva);
    if (typeof atualizarInterface === 'function') atualizarInterface();
}

function forcarSincronizacaoNuvem() {
    if (!isCloudReady()) {
        atualizarIndicadorSync('offline', 'Offline');
        mostrarNotificacao('Serviço indisponível. Verifique a internet e se o Firebase está configurado. Os dados locais estão guardados.', 'warning');
        return;
    }
    appStorage.removeItem('naoRestaurarDaNuvem');
    window.__cloudSyncError = null;
    atualizarIndicadorSync('syncing', 'A sincronizar...');
    mostrarNotificacao('A sincronizar… Aguarde um momento.', 'info');
    if (typeof listenerManager !== 'undefined' && listenerManager.pause) listenerManager.pause();
    iniciarListenersFirestore();
    sincronizarTodasEntidadesNuvem().then(() => {
        if (isCloudReady()) try { appStorage.setItem('cloudSyncUltimoSucesso', new Date().toISOString()); } catch (e) {}
        carregarDados();
        carregarSecao(typeof secaoAtiva === 'string' ? secaoAtiva : 'dashboard');
        if (typeof atualizarInterface === 'function') atualizarInterface();
        atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline');
    }).catch((err) => {
        console.warn('Erro ao forçar sincronização:', err);
        atualizarIndicadorSync('error', 'Erro — clique para tentar');
        const msg = !navigator.onLine
            ? 'Sem internet. Verifique a Wi‑Fi ou dados móveis e tente novamente.'
            : 'A sincronização falhou. Verifique a internet e clique no indicador vermelho para tentar novamente. Se persistir, faça Ctrl+Shift+R.';
        mostrarNotificacao(msg, 'error');
    });
}

function salvarConvidadoCloud(convidado) {
    return salvarEntidadeCloud('convidados', convidado);
}

async function obterConvidadoPorCodigoCloud(codigo) {
    if (!firestoreDb || !codigo) return null;
    try {
        const snap = await firestoreDb.collection('convidados').doc(String(codigo)).get();
        if (!snap.exists) return null;
        const data = snap.data();
        const codigoDoc = snap.id;
        const clientesAuth = Array.isArray(data?.clientesAutorizados) ? data.clientesAutorizados : [];
        // Estrutura completa para convidado noutro dispositivo: codigo, id e clientesAutorizados obrigatórios
        return lerConvidadoDoFirestore({
            ...data,
            codigo: codigoDoc,
            id: data?.id || codigoDoc,
            clientesAutorizados: clientesAuth
        });
    } catch (error) {
        console.warn('Erro ao ler convidado na nuvem:', error);
        return null;
    }
}

/** Lê sessão do Firestore (sistema/sessao). Retorna { tipoUsuario, usuarioNome, convidadoId } ou null. */
async function lerSessaoFirestore() {
    if (!firestoreDb) return null;
    try {
        const doc = await firestoreDb.collection('sistema').doc('sessao').get();
        if (!doc.exists) return null;
        const d = doc.data();
        const updatedAt = d?.updatedAt ? new Date(d.updatedAt).getTime() : 0;
        const maxIdade = 7 * 24 * 60 * 60 * 1000; // 7 dias
        if (Date.now() - updatedAt > maxIdade) return null;
        return { tipoUsuario: d?.tipoUsuario || '', usuarioNome: d?.usuarioNome || '', convidadoId: d?.convidadoId || '' };
    } catch (e) { console.warn('lerSessaoFirestore:', e); return null; }
}

/** Guarda sessão no Firestore. */
async function guardarSessaoFirestore(tipoUsuario, usuarioNome, convidadoId) {
    if (!firestoreDb) return;
    try {
        await firestoreDb.collection('sistema').doc('sessao').set({
            tipoUsuario: tipoUsuario || '',
            usuarioNome: usuarioNome || '',
            convidadoId: convidadoId || '',
            updatedAt: new Date().toISOString()
        });
    } catch (e) { console.warn('guardarSessaoFirestore:', e); }
}

/** Remove sessão do Firestore. */
async function limparSessaoFirestore() {
    if (!firestoreDb) return;
    try {
        await firestoreDb.collection('sistema').doc('sessao').delete();
    } catch (e) { console.warn('limparSessaoFirestore:', e); }
}

/** Append log de backup no Firestore (sistema/backup_logs). */
async function firestoreLogBackup(message) {
    if (!firestoreDb) return;
    try {
        const ref = firestoreDb.collection('sistema').doc('backup_logs');
        const doc = await ref.get();
        const logs = (doc.exists ? doc.data().logs : []) || [];
        logs.push({ message, timestamp: new Date().toISOString() });
        await ref.set({ logs: logs.slice(-200) });
    } catch (e) { console.warn('firestoreLogBackup:', e); }
}

/** Lê logs de backup do Firestore. */
async function firestoreGetBackupLogs() {
    if (!firestoreDb) return [];
    try {
        const doc = await firestoreDb.collection('sistema').doc('backup_logs').get();
        return (doc.exists ? doc.data().logs : []) || [];
    } catch (e) { return []; }
}

/** Limpa logs de backup no Firestore. */
async function firestoreClearBackupLogs() {
    if (!firestoreDb) return;
    try {
        await firestoreDb.collection('sistema').doc('backup_logs').set({ logs: [] });
    } catch (e) { console.warn('firestoreClearBackupLogs:', e); }
}

/** getBackupLogs, logBackup, clearBackupLogs — base para secção Backup (Firestore) */
function getBackupLogs() { return Array.isArray(window.__backupLogsCache) ? window.__backupLogsCache : []; }
function logBackup(msg) { try { console.log('Backup:', msg); } catch (e) {} }
function clearBackupLogs() { window.__backupLogsCache = []; }

/** Exporta todos os dados do Firestore para JSON (download). */
async function exportarBackupFirestore() {
    if (!isCloudReady()) { mostrarNotificacao('Firestore não disponível.', 'error'); return; }
    const lerPorColecao = {
        clientes: lerClienteDoFirestore,
        honorarios: lerHonorarioDoFirestore,
        contratos: lerContratoDoFirestore,
        prazos: lerPrazoDoFirestore,
        notificacoes: lerNotificacaoDoFirestore,
        herancas: lerProcessoDoFirestore,
        migracoes: lerProcessoDoFirestore,
        registos: lerProcessoDoFirestore,
        documentos: lerDocumentoDoFirestore,
        tarefas: lerTarefaDoFirestore,
        convidados: lerConvidadoDoFirestore,
        entidades: lerEntidadeDoFirestore,
        integracoes_externas: lerIntegracaoDoFirestore,
        representantes: lerRepresentanteDoFirestore,
        faturas: lerFaturaDoFirestore,
        pagamentos: lerPagamentoDoFirestore,
        despesas: lerDespesaDoFirestore
    };
    try {
        mostrarNotificacao('A exportar dados do Firestore...', 'info');
        const dados = {};
        for (const [col, lerFn] of Object.entries(lerPorColecao)) {
            const snap = await firestoreDb.collection(col).get();
            let lista = snap.docs
                .map(d => ({ id: d.id, ...d.data() }))
                .filter(d => !d.deleted && !d.anulado && !['faturas','pagamentos','despesas'].includes(col) ? true : d.id !== 'seed-inicial');
            if (typeof lerFn === 'function') lista = lista.map(d => lerFn(d));
            dados[col] = lista;
        }
        const backup = { timestamp: new Date().toISOString(), versao: '1.0', dados };
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_firestore_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
        try { appStorage.setItem('backupExportUltimo', new Date().toISOString()); } catch (e) {}
        if (typeof logBackup === 'function') logBackup('Exportação Firestore concluída');
        mostrarNotificacao('Backup exportado com sucesso.', 'success');
    } catch (e) {
        console.warn('exportarBackupFirestore:', e);
        mostrarNotificacao('Erro ao exportar: ' + (e?.message || e), 'error');
    }
}
window.exportarBackupFirestore = exportarBackupFirestore;
window.exportBackupFromFirestore = exportarBackupFirestore;

(function() {
    const origLog = window.logBackup;
    const origClear = window.clearBackupLogs;
    if (origLog) {
        window.logBackup = function(msg) {
            origLog(msg);
            firestoreLogBackup(msg);
        };
    }
    if (origClear) {
        window.clearBackupLogs = function() {
            origClear();
            window.__backupLogsCache = [];
            firestoreClearBackupLogs();
        };
    }
})();

async function verificarLogin() {
    const sessao = await lerSessaoFirestore();
    if (sessao && (sessao.tipoUsuario === 'admin' || sessao.tipoUsuario === 'convidado')) {
        window.__tipoUsuario = sessao.tipoUsuario;
        window.__usuarioNome = sessao.usuarioNome;
        appStorage.setItem('usuarioLogado', 'true');
        appStorage.setItem('tipoUsuario', sessao.tipoUsuario);
        appStorage.setItem('usuarioNome', sessao.usuarioNome);
        if (sessao.convidadoId) appStorage.setItem('convidadoId', sessao.convidadoId);
        return true;
    }
    if (appStorage.getItem('usuarioLogado')) {
        window.__tipoUsuario = appStorage.getItem('tipoUsuario') || '';
        window.__usuarioNome = appStorage.getItem('usuarioNome') || 'Sistema';
        return true;
    }
    mostrarTelaLogin();
    return false;
}

function mostrarTelaLogin() {
    document.body.innerHTML = `
        <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
            <div class="mb-6">
                <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                    <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                    <p class="text-gray-600 mt-2">Selecione o tipo de acesso</p>
                </div>
                
                <div class="space-y-4">
                    <button onclick="mostrarLoginAdmin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 flex items-center justify-center">
                        <i data-lucide="shield-check" class="w-5 h-5 mr-2"></i>
                        Administrador
                    </button>
                    
                    <button onclick="mostrarLoginConvidado()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 mr-2"></i>
                        Convidado
                    </button>
                </div>
                
                <div class="mt-6 text-center text-sm text-gray-600">
                    <p><strong>Administrador:</strong> Acesso total ao sistema</p>
                    <p><strong>Convidado:</strong> Acesso limitado a clientes autorizados</p>
                </div>
            </div>
        </div>
    `;
    
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
}

function mostrarLoginAdmin() {
    document.body.innerHTML = `
        <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
            <div class="mb-6">
                <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                    <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                    <p class="text-gray-600 mt-2">Login Administrador - Acesso total ao sistema</p>
                </div>
                
                <form id="formLoginAdmin" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <input type="text" id="usuario" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite seu usuário" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="senha" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha" required>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                            Voltar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Entrar
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 text-center text-sm text-gray-600">
                    <p><strong>🔒 Acesso Restrito</strong></p>
                    <p>Entre em contato com o administrador para obter as credenciais</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('formLoginAdmin').addEventListener('submit', async function(e) {
        e.preventDefault();
        const usuario = document.getElementById('usuario').value;
        const senha = document.getElementById('senha').value;
        if (usuario !== USUARIO_PADRAO) {
            alert('Usuário ou senha incorretos!');
            return;
        }
        const ok = await verificarSenhaAdmin(senha);
        if (ok) {
            await guardarSessaoFirestore('admin', usuario || 'Admin', null);
            appStorage.setItem('usuarioLogado', 'true');
            appStorage.setItem('usuarioNome', usuario);
            appStorage.setItem('tipoUsuario', 'admin');
            window.__tipoUsuario = 'admin';
            window.__usuarioNome = usuario || 'Admin';
            location.reload();
        } else {
            alert('Usuário ou senha incorretos!');
        }
    });
}

function mostrarLoginConvidado() {
    document.body.innerHTML = `
        <div class="min-h-screen bg-gray-100 flex flex-col items-center justify-center py-8">
            <div class="mb-6">
                <img src="ana.jpg" alt="Ana Paula Medina Solicitadora" class="mx-auto w-24 h-24 object-contain">
            </div>
            <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Sistema Legal</h1>
                    <p class="text-lg font-semibold text-blue-600 mt-2">ANA PAULA MEDINA - SOLICITADORA</p>
                    <p class="text-gray-600 mt-2">Login Convidado - Acesso limitado a clientes autorizados</p>
                </div>
                
                <form id="formLoginConvidado" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                        <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Digite seu nome" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Código de Acesso</label>
                        <input type="text" id="codigoAcesso" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="8 letras/números (ex: A1B2C3D4)" required maxlength="8" pattern="[A-Za-z0-9]{8}" inputmode="text" autocomplete="one-time-code" title="O código deve ter exatamente 8 caracteres (letras e números)">
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="mostrarTelaLogin()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                            Voltar
                        </button>
                        <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                            Entrar
                        </button>
                    </div>
                </form>
                
                <div class="mt-6 text-center text-sm text-gray-600">
                    <p>Peça o código de acesso ao administrador</p>
                </div>
            </div>
        </div>
    `;
    
    // Restringir o campo código a aceitar apenas letras e números (máx. 8)
    const inputCodigo = document.getElementById('codigoAcesso');
    inputCodigo.addEventListener('input', function() {
        this.value = this.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase().slice(0, 8);
    });
    
    document.getElementById('formLoginConvidado').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nome = document.getElementById('nomeConvidado').value.trim();
        const codigo = (document.getElementById('codigoAcesso').value || '').trim().toUpperCase();
        
        // Validar formato do código: exatamente 8 caracteres, apenas A-Z e 0-9
        const formatoValido = /^[A-Z0-9]{8}$/.test(codigo);
        if (!formatoValido) {
            alert('O código de acesso deve ter exatamente 8 caracteres (letras e números). Exemplo: A1B2C3D4');
            return;
        }
        
        // Verificar se o código existe e está ativo (Firestore/convidados em memória)
        let convidado = await obterConvidadoPorCodigoCloud(codigo);
        if (!convidado && Array.isArray(convidados)) {
            convidado = convidados.find(c => (c.codigo || c.id) === codigo && c.ativo !== false);
        }
        
        if (convidado && convidado.ativo) {
            // Verificar se o nome é válido e corresponde ao convidado registado
            const normalizar = (s) => (s || '').trim().toLowerCase().replace(/\s+/g, ' ');
            const nomeRegistado = normalizar(convidado.nome);
            const nomeInserido = normalizar(nome);
            // Sempre exigir que o nome tenha pelo menos 2 caracteres
            if (nomeInserido.length < 2) {
                alert('Introduza o seu nome (mínimo 2 caracteres).');
                return;
            }
            // Quando o convidado tem nome registado, o inserido deve corresponder
            if (nomeRegistado && nomeInserido !== nomeRegistado) {
                alert('O nome não corresponde ao convidado associado a este código.');
                return;
            }
            if (!nomeRegistado) {
                // Convidado sem nome registado: rejeitar texto que pareça aleatório (ex: sem vogais)
                const temVogal = /[aeiouáéíóúàèìòùãõâêîôû]/i.test(nomeInserido);
                if (!temVogal) {
                    alert('Introduza um nome válido (o nome deve conter letras).');
                    return;
                }
            }
            // Cache local do convidado para uso offline
            try {
                const lista = JSON.parse(appStorage.getItem('convidados') || '[]');
                const index = lista.findIndex(c => c.codigo === codigo);
                if (index >= 0) {
                    lista[index] = { ...lista[index], ...convidado };
                } else {
                    lista.push(convidado);
                }
                salvarDados('convidados', lista);
            } catch (error) {
                console.warn('Erro ao cachear convidado localmente:', error);
            }
            await guardarSessaoFirestore('convidado', nome || 'Convidado', convidado.id || codigo);
            appStorage.setItem('usuarioLogado', nome || 'Convidado');
            appStorage.setItem('usuarioNome', nome);
            appStorage.setItem('tipoUsuario', 'convidado');
            appStorage.setItem('convidadoId', convidado.id || codigo);
            location.reload();
        } else {
            alert('Código de acesso inválido ou inativo!');
        }
    });
}

function logout() {
    limparSessaoFirestore();
    appStorage.removeItem('usuarioLogado');
    appStorage.removeItem('usuarioNome');
    appStorage.removeItem('tipoUsuario');
    appStorage.removeItem('convidadoId');
    location.reload();
}

// FUNÇÃO PARA GERAR CÓDIGOS DE ACESSO SEGUROS
function gerarCodigoAcesso() {
    const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let codigo = '';
    for (let i = 0; i < 8; i++) {
        codigo += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }
    return codigo;
}

/** Remove definitivamente do Firestore apenas documentos com deleted: true (purga lixo). */
async function purgarDocumentosEliminadosFirestore() {
    if (!isCloudReady() || !firestoreDb) {
        mostrarNotificacao('Firestore não disponível.', 'error');
        return;
    }
    if (!exigirAdmin('purga de dados eliminados')) return;
    if (!confirm('Remover da base de dados todos os itens que já foram "eliminados" (clientes, convidados, documentos, etc.)?\n\nIsto não afeta dados ativos. É irreversível.')) return;
    if (!confirm('Confirma a purga?')) return;
    const colecoes = ['clientes', 'honorarios', 'contratos', 'prazos', 'notificacoes', 'herancas', 'migracoes', 'registos', 'documentos', 'tarefas', 'convidados', 'faturas', 'representantes'];
    let total = 0;
    try {
        mostrarNotificacao('A purgar...', 'info');
        for (const nome of colecoes) {
            let n = 0;
            while (true) {
                const col = firestoreDb.collection(nome);
                const snapshot = await col.get();
                const aApagar = snapshot.docs.filter(d => d.data().deleted === true);
                if (aApagar.length === 0) break;
                const batch = firestoreDb.batch();
                aApagar.slice(0, 500).forEach(d => batch.delete(d.ref));
                await batch.commit();
                n += Math.min(aApagar.length, 500);
            }
            total += n;
        }
        if (total > 0) {
            mostrarNotificacao(`${total} documento(s) eliminado(s) removido(s) da base de dados.`, 'success');
            if (typeof carregarSecao === 'function') carregarSecao('backup');
        } else {
            mostrarNotificacao('Nenhum documento eliminado encontrado. Base já está limpa.', 'info');
        }
    } catch (err) {
        console.error('Erro na purga:', err);
        mostrarNotificacao('Erro ao purgar: ' + (err.message || err), 'error');
    }
}
window.purgarDocumentosEliminadosFirestore = purgarDocumentosEliminadosFirestore;

/** Apaga todos os documentos de uma coleção Firestore (em lotes de 500). */
async function apagarColecaoFirestore(nomeColecao) {
    if (!firestoreDb) return;
    const col = firestoreDb.collection(nomeColecao);
    let apagados = 0;
    while (true) {
        const snapshot = await col.limit(500).get();
        if (snapshot.empty) break;
        const batch = firestoreDb.batch();
        snapshot.docs.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        apagados += snapshot.size;
    }
    return apagados;
}

/** Utilitários Firestore: leitura, escrita e limpeza de coleções */
async function readCollectionFirestore(nome) {
    if (!firestoreDb) return [];
    const snapshot = await firestoreDb.collection(nome).get();
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
}
async function writeCollectionFirestore(nome, dados) {
    if (!firestoreDb || !Array.isArray(dados)) return;
    const col = firestoreDb.collection(nome);
    for (const item of dados) {
        const id = item.id || gerarIdImutavel();
        await col.doc(String(id)).set({ ...item, id });
    }
}
async function clearCollectionFirestore(nome) {
    return await apagarColecaoFirestore(nome);
}
window.readCollectionFirestore = readCollectionFirestore;
window.writeCollectionFirestore = writeCollectionFirestore;
window.clearCollectionFirestore = clearCollectionFirestore;

/** Modal de confirmação com digitação obrigatória — evita limpezas acidentais */
function mostrarModalConfirmarApagar(opcoes) {
    const { titulo = 'Confirmar eliminação', mensagem = 'Para confirmar, escreva exatamente o texto abaixo:', textoConfirmar = 'APAGAR', aoConfirmar } = opcoes || {};
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer || typeof aoConfirmar !== 'function') return;

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70]';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-labelledby', 'modalConfirmarApagarTitulo');
    modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6" onclick="event.stopPropagation()">
            <h2 id="modalConfirmarApagarTitulo" class="text-xl font-bold text-red-700 mb-4">${titulo}</h2>
            <p class="text-gray-700 mb-4">${mensagem}</p>
            <p class="font-mono font-bold bg-gray-100 px-3 py-2 rounded mb-4 text-center">${textoConfirmar}</p>
            <input type="text" id="inputConfirmarApagar" class="w-full border-2 border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-red-500 mb-4" placeholder="Escreva aqui..." autocomplete="off" aria-label="Digite ${textoConfirmar} para confirmar">
            <p id="erroConfirmarApagar" class="text-red-600 text-sm mb-2 hidden"></p>
            <div class="flex gap-3 justify-end">
                <button type="button" id="btnCancelarApagar" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">Cancelar</button>
                <button type="button" id="btnConfirmarApagar" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700" disabled>Confirmar</button>
            </div>
        </div>
    `;
    modal.onclick = (e) => { if (e.target === modal) fecharModalRobusto(); };

    const fechar = () => { modal.remove(); if (typeof fecharModalRobusto === 'function') fecharModalRobusto(); };
    const input = modal.querySelector('#inputConfirmarApagar');
    const btnConfirmar = modal.querySelector('#btnConfirmarApagar');
    const erro = modal.querySelector('#erroConfirmarApagar');

    input.addEventListener('input', () => {
        const ok = input.value.trim().toUpperCase() === textoConfirmar.toUpperCase();
        btnConfirmar.disabled = !ok;
        erro.classList.add('hidden');
    });
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') fechar();
        if (e.key === 'Enter' && !btnConfirmar.disabled) btnConfirmar.click();
    });

    modal.querySelector('#btnCancelarApagar').onclick = fechar;
    btnConfirmar.onclick = () => {
        if (input.value.trim().toUpperCase() !== textoConfirmar.toUpperCase()) {
            erro.textContent = 'O texto não coincide. Escreva exatamente: ' + textoConfirmar;
            erro.classList.remove('hidden');
            return;
        }
        fechar();
        aoConfirmar();
    };

    modalContainer.innerHTML = '';
    modalContainer.appendChild(modal);
    modalContainer.classList.add('show');
    setTimeout(() => input.focus(), 100);
}
window.mostrarModalConfirmarApagar = mostrarModalConfirmarApagar;

/** Começar do ZERO ABSOLUTO: apaga tudo (local + Firestore). Irreversível. */
async function comecarDoZeroAbsoluto() {
    if (!exigirAdmin('começar do zero absoluto')) return;
    if (!confirm('⚠️ ZERO ABSOLUTO\n\nIsto vai APAGAR TUDO:\n• Clientes, honorários, contratos\n• Heranças, migrações, registos\n• Tarefas, prazos, notificações\n• Documentos\n• TODOS os convidados\n• Firestore e memória local\n\nÉ IRREVERSÍVEL. Tem certeza?')) return;
    if (!confirm('🚨 CONFIRMAÇÃO FINAL\n\nVai começar do zero absoluto. Todos os dados serão eliminados permanentemente.\n\nContinuar?')) return;

    mostrarModalConfirmarApagar({
        titulo: 'Confirmar Zero Absoluto',
        mensagem: 'Para confirmar a eliminação de todos os dados, escreva exatamente:',
        textoConfirmar: 'APAGAR',
        aoConfirmar: executarZeroAbsoluto
    });
}
async function executarZeroAbsoluto() {
    try {
        mostrarNotificacao('A apagar tudo...', 'info');
        // Pausar listeners para permitir limpeza do cache
        if (typeof listenerManager !== 'undefined' && listenerManager.pause) listenerManager.pause();

        const colecoes = ['clientes', 'honorarios', 'contratos', 'prazos', 'notificacoes', 'herancas', 'migracoes', 'registos', 'documentos', 'tarefas', 'convidados'];
        if (isCloudReady()) {
            for (const col of colecoes) {
                try {
                    const n = await apagarColecaoFirestore(col);
                    if (n > 0) { /* apagados */ }
                } catch (e) {
                    console.warn('Erro ao apagar', col, e);
                }
            }
        }

        ['honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'convidados', 'prazos', 'notificacoes', 'tarefas', 'documentos', 'clientes',
         'honorariosMigrados', 'contratosMigrados', 'herancasMigrados', 'migracoesMigrados', 'registosMigrados', 'tarefasMigrados', 'prazosMigrados', 'notificacoesMigrados', 'documentosMigrados', 'convidadosMigrados', 'clientesMigrados'
        ].forEach(k => appStorage.removeItem(k));

        clientes = []; honorarios = []; contratos = []; herancas = []; migracoes = []; registos = []; prazos = []; notificacoes = []; tarefas = []; documentos = []; convidados = [];
        window.clientes = clientes; window.honorarios = honorarios; window.contratos = contratos; window.herancas = herancas; window.migracoes = migracoes; window.registos = registos; window.prazos = prazos; window.notificacoes = notificacoes; window.tarefas = tarefas; window.documentos = documentos; window.convidados = convidados;

        appStorage.setItem('dadosLimpos', 'true');
        appStorage.setItem('limparCacheFirestoreNaProximaCarga', 'true');
        // NAO setar naoRestaurarDaNuvem - permite que listeners carreguem dados ao voltar

        mostrarNotificacao('✅ Zero absoluto concluído! A recarregar...', 'success');
        setTimeout(() => location.reload(), 1500);
    } catch (err) {
        console.error(err);
        mostrarNotificacao('Erro ao apagar. Tente novamente.', 'error');
    }
}
window.comecarDoZeroAbsoluto = comecarDoZeroAbsoluto;

/** Limpa TUDO exceto o cliente DACIANA e o convidado WILSON. Elimina dados fantasmas que reaparecem. */
async function limparBaseManterApenasDacianaWilson() {
    if (!exigirAdmin('esta limpeza')) return;
    if (!isCloudReady()) { mostrarNotificacao('Firestore não disponível.', 'error'); return; }
    if (!confirm('Esta ação vai:\n\n• Apagar TODOS honorários, contratos, heranças, migrações, registos, prazos, tarefas, notificações, documentos\n• Manter APENAS o cliente "DACIANA" e o convidado "WILSON"\n• Apagar todos os outros clientes e convidados\n\nÉ irreversível. Continuar?')) return;
    if (!confirm('Confirma? O cliente DACIANA e o convidado WILSON serão os únicos a ficar.')) return;

    try {
        mostrarNotificacao('A limpar...', 'info');
        if (typeof listenerManager !== 'undefined' && listenerManager.pause) listenerManager.pause();

        // Apagar coleções inteiras
        const colecoesCompletas = ['honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'notificacoes', 'documentos', 'tarefas', 'entidades', 'integracoes_externas', 'representantes'];
        for (const col of colecoesCompletas) {
            try { await apagarColecaoFirestore(col); } catch (e) { console.warn('Erro ao apagar', col, e); }
        }

        // Faturas: apagar tudo exceto seed-inicial
        const snapFaturas = await firestoreDb.collection('faturas').get();
        const batchF = firestoreDb.batch();
        snapFaturas.docs.forEach(d => { if (d.id !== 'seed-inicial') batchF.delete(d.ref); });
        if (!snapFaturas.empty) await batchF.commit();

        // Clientes: apagar todos exceto DACIANA (nome contém "daciana", insensível a maiúsculas)
        const snapClientes = await firestoreDb.collection('clientes').get();
        const aApagarClientes = snapClientes.docs.filter(d => !(d.data().nome || '').toLowerCase().includes('daciana'));
        for (let i = 0; i < aApagarClientes.length; i += 500) {
            const batchC = firestoreDb.batch();
            aApagarClientes.slice(i, i + 500).forEach(d => batchC.delete(d.ref));
            await batchC.commit();
        }

        // Convidados: apagar todos exceto WILSON (nome contém "wilson", insensível a maiúsculas)
        const snapConvidados = await firestoreDb.collection('convidados').get();
        const aApagarConvidados = snapConvidados.docs.filter(d => !(d.data().nome || '').toLowerCase().includes('wilson'));
        for (let i = 0; i < aApagarConvidados.length; i += 500) {
            const batchConv = firestoreDb.batch();
            aApagarConvidados.slice(i, i + 500).forEach(d => batchConv.delete(d.ref));
            await batchConv.commit();
        }

        // Limpar localStorage/sessionStorage para evitar que dados antigos migrem de volta
        const chaves = ['clientes', 'honorarios', 'contratos', 'prazos', 'notificacoes', 'herancas', 'migracoes', 'registos', 'documentos', 'tarefas', 'convidados', 'faturas', 'representantes', 'entidades', 'integracoes_externas'];
        chaves.forEach(k => { try { localStorage.removeItem(k); sessionStorage.removeItem(k); } catch (e) {} });
        ['honorariosMigrados', 'contratosMigrados', 'herancasMigrados', 'migracoesMigrados', 'registosMigrados', 'tarefasMigrados', 'prazosMigrados', 'notificacoesMigrados', 'documentosMigrados', 'convidadosMigrados', 'faturasMigrados', 'localStorageMigradoParaFirebase', 'clientesMigradosParaFirestore'].forEach(k => { try { appStorage.setItem(k, 'true'); localStorage.setItem(k, 'true'); sessionStorage.setItem(k, 'true'); } catch (e) {} });

        appStorage.setItem('limparCacheFirestoreNaProximaCarga', 'true');
        mostrarNotificacao('✅ Base limpa. Mantidos apenas DACIANA e WILSON. A recarregar...', 'success');
        setTimeout(() => location.reload(), 2000);
    } catch (err) {
        console.error(err);
        mostrarNotificacao('Erro: ' + (err?.message || err), 'error');
    }
}
window.limparBaseManterApenasDacianaWilson = limparBaseManterApenasDacianaWilson;

// FUNÇÃO PARA LIMPEZA PROFISSIONAL (só local – mantém opção antiga)
function limparDadosParaUsoProfissional() {
    if (!exigirAdmin('limpeza profissional')) return;
    if (confirm('⚠️ Esta ação apaga os dados LOCAIS. Para apagar TUDO (Firestore incluído), use "Começar do zero absoluto" na secção Backup.\n\nContinuar com limpeza local apenas?')) {
        if (confirm('🚨 Confirma?')) {
            mostrarModalConfirmarApagar({
                titulo: 'Confirmar limpeza local',
                mensagem: 'Para confirmar a eliminação dos dados locais, escreva exatamente:',
                textoConfirmar: 'APAGAR',
                aoConfirmar: () => {
                    ['honorarios', 'contratos', 'herancas', 'migracoes', 'registos', 'convidados', 'prazos', 'notificacoes', 'tarefas', 'documentos'].forEach(k => appStorage.removeItem(k));
                    clientes = []; honorarios = []; contratos = []; herancas = []; migracoes = []; registos = []; prazos = []; notificacoes = []; tarefas = []; documentos = []; convidados = [];
                    Object.assign(window, { clientes, honorarios, contratos, herancas, migracoes, registos, prazos, notificacoes, tarefas, documentos, convidados });
                    appStorage.setItem('dadosLimpos', 'true');
                    appStorage.setItem('naoRestaurarDaNuvem', 'true');
                    mostrarNotificacao('✅ Dados locais limpos.', 'success');
                    setTimeout(() => location.reload(), 2000);
                }
            });
        }
    }
}

// Limpar dados locais (para convidado em outro computador) - mesmo que limparDadosParaUsoProfissional
function executarLimpezaIgualAdmin(lastClearedAt) {
    // clientes: apenas Firestore
    appStorage.removeItem('honorarios');
    appStorage.removeItem('contratos');
    appStorage.removeItem('herancas');
    appStorage.removeItem('migracoes');
    appStorage.removeItem('registos');
    appStorage.removeItem('convidados');
    appStorage.removeItem('prazos');
    appStorage.removeItem('notificacoes');
    appStorage.removeItem('tarefas');
    appStorage.removeItem('documentos');
    appStorage.removeItem('usuarioLogado');
    appStorage.removeItem('usuarioNome');
    appStorage.removeItem('tipoUsuario');
    appStorage.removeItem('convidadoId');
    appStorage.setItem('dadosLimpos', 'true');
    if (lastClearedAt) appStorage.setItem('lastSeenClearedAt', String(lastClearedAt));
    location.reload();
}

function limparDadosLocaisERecarregar() {
    if (!confirm('⚠️ Limpar dados locais\n\nIsto vai apagar todos os dados guardados neste navegador (sessão local). Será necessário fazer login novamente.\n\nContinuar?')) return;
    if (!confirm('🚨 Confirmação: Tem certeza que deseja limpar os dados locais?')) return;

    mostrarModalConfirmarApagar({
        titulo: 'Confirmar limpeza de dados locais',
        mensagem: 'Para confirmar, escreva exatamente:',
        textoConfirmar: 'APAGAR',
        aoConfirmar: () => executarLimpezaIgualAdmin(Date.now())
    });
}

// SISTEMA DE GESTÃO DE CONVIDADOS
async function criarConvidado(nome, clientesAutorizados) {
    const convidados = JSON.parse(appStorage.getItem('convidados') || '[]');
    const codigo = gerarCodigoAcesso(); // Usar função de código seguro
    
    const novoConvidado = {
        id: gerarIdImutavel(),
        nome: nome,
        codigo: codigo,
        clientesAutorizados: clientesAutorizados || [],
        ativo: true,
        dataCriacao: new Date().toISOString()
    };
    
    convidados.push(novoConvidado);
    try {
        salvarDados('convidados', convidados);
    } catch (error) {
        console.warn('Erro ao salvar convidado localmente:', error);
    }
    Promise.resolve()
        .then(() => salvarConvidadoCloud(novoConvidado))
        .then(() => sincronizarConvidadosDaNuvem())
        .catch((error) => {
            console.warn('Erro ao sincronizar convidado:', error);
            mostrarNotificacao('Convidado criado localmente. Nuvem indisponível.', 'warning');
        });
    
    return novoConvidado;
}

function obterConvidados() {
    return obterConvidadosAtual();
}

/** Devolve o rótulo "Para: Admin", "Para: Todos" ou "Para: [Nome do convidado]" */
function obterRotuloDestinatarioNotificacao(destinatarioId) {
    if (!destinatarioId || destinatarioId === 'todos') return 'Para: Todos';
    if (destinatarioId === 'admin') return 'Para: Admin';
    const convidados = obterConvidados();
    const convidado = convidados.find(c => c.ativo && (String(c.id) === String(destinatarioId) || String(c.codigo) === String(destinatarioId)));
    return convidado ? 'Para: ' + (convidado.nome || 'Convidado') : 'Para: Convidado (id ' + destinatarioId + ')';
}
window.obterRotuloDestinatarioNotificacao = obterRotuloDestinatarioNotificacao;

async function sincronizarConvidadosDaNuvem() {
    await sincronizarEntidadeNuvem('convidados');
}

function ativarDesativarConvidadoCore(idOuCodigo, ativo) {
    const convidados = obterConvidados();
    const convidado = convidados.find(c =>
        String(c.id) === String(idOuCodigo) || String(c.codigo) === String(idOuCodigo)
    );
    if (convidado) {
        convidado.ativo = ativo;
        if (!ativo) {
            convidado.desativadoEm = new Date().toISOString();
        } else {
            convidado.desativadoEm = null;
        }
        salvarDados('convidados', convidados);
        salvarConvidadoCloud(convidado);
    }
}

function excluirConvidado(idOuCodigo) {
    if (!confirm('Tem certeza que deseja eliminar este convidado?')) return;
    const convidados = obterConvidados();
    const convidado = convidados.find(c =>
        String(c.id) === String(idOuCodigo) || String(c.codigo) === String(idOuCodigo)
    );
    if (!convidado) {
        mostrarNotificacao('Convidado não encontrado.', 'error');
        return;
    }
    const novos = convidados.filter(c =>
        String(c.id) !== String(idOuCodigo) && String(c.codigo) !== String(idOuCodigo)
    );
    salvarDados('convidados', novos);
    const docId = convidado.codigo || convidado.id;
    excluirEntidadeCloud('convidados', docId);
    mostrarNotificacao('Convidado eliminado.', 'success');
    carregarSecao('convidados');
}

function limparConvidadosInativos() {
    const convidados = obterConvidados();
    const agora = Date.now();
    const limite = 7 * 24 * 60 * 60 * 1000;
    const paraRemover = convidados.filter(c => {
        if (c.ativo) return false;
        const data = c.desativadoEm || c.dataCriacao;
        const ts = data ? new Date(data).getTime() : 0;
        return ts && (agora - ts) > limite;
    });
    if (!paraRemover.length) return convidados;
    const restantes = convidados.filter(c => !paraRemover.includes(c));
    salvarDados('convidados', restantes);
    paraRemover.forEach(c => {
        const docId = c.codigo || c.id;
        excluirEntidadeCloud('convidados', docId);
    });
    return restantes;
}

// FUNÇÃO RECRIADA PARA CORRIGIR PROBLEMA
function editarPermissoesConvidado(idOuCodigo, clientesAutorizados) {
    const convidados = obterConvidadosAtual();
    const convidado = convidados.find(c => String(c.id) === String(idOuCodigo) || String(c.codigo) === String(idOuCodigo));
    
    if (convidado) {
        
        // Verificar se há novos clientes autorizados
        const clientesAntigosNorm = (convidado.clientesAutorizados || []).map(a => String(a));
        const novosClientes = clientesAutorizados.filter(id => !clientesAntigosNorm.includes(String(id)));
        
        // Atualizar permissões
        convidado.clientesAutorizados = clientesAutorizados;
        salvarDados('convidados', convidados);
        salvarConvidadoCloud(convidado);
        
        // Criar notificações automáticas para novos clientes
        if (novosClientes.length > 0) {
            const listaClientes = obterClientesAtual();
            novosClientes.forEach(clienteId => {
                const cliente = listaClientes.find(c => String(c.id) === String(clienteId));
                if (cliente) {
                    criarNotificacao({
                        tipo: 'cliente_autorizado',
                        titulo: 'Novo Cliente Autorizado',
                        mensagem: `O cliente "${cliente.nome}" foi autorizado para você.`,
                        prioridade: 'media',
                        referenciaId: clienteId,
                        destinatarioId: idOuCodigo,
                        acao: 'ver_cliente',
                        suprimirToast: true  // Admin já vê "Permissões atualizadas com sucesso!"
                    });
                }
            });
        }
        
        setTimeout(() => carregarSecao('convidados'), 100);
    } else {
        mostrarNotificacao('Convidado não encontrado.', 'error');
    }
}

// VERIFICAÇÃO DE PERMISSÕES
/** Verifica se uma tarefa está atribuída ao convidado. */
function tarefaAtribuidaAoConvidado(tarefa, convidado, convidadoAtualRaw) {
    if (!tarefa || tarefa.responsavelTipo !== 'convidado') return false;
    const convidadoId = parseInt(convidadoAtualRaw);
    return (
        (Number.isFinite(convidadoId) && parseInt(tarefa.responsavelId) === convidadoId) ||
        (tarefa.responsavelCodigo && String(tarefa.responsavelCodigo) === String(convidadoAtualRaw)) ||
        (tarefa.responsavelId != null && String(tarefa.responsavelId) === String(convidadoAtualRaw)) ||
        (convidado && String(tarefa.responsavelId) === String(convidado.id)) ||
        (convidado && String(tarefa.responsavelCodigo) === String(convidado.codigo)) ||
        (convidado && tarefa.responsavelNome && tarefa.responsavelNome === convidado.nome)
    );
}

/** Devolve IDs de clientes que o convidado pode ver: clientesAutorizados + clientes de tarefas atribuídas. */
function obterIdsClientesVisiveisParaConvidado(convidado) {
    if (!convidado || !convidado.ativo) return [];
    const ids = new Set((convidado.clientesAutorizados || []).map(a => String(a)));
    const convidadoAtualRaw = appStorage.getItem('convidadoId');
    const tarefas = obterTarefasAtual();
    tarefas.forEach(t => {
        if (t.clienteId && tarefaAtribuidaAoConvidado(t, convidado, convidadoAtualRaw)) {
            ids.add(String(t.clienteId));
        }
    });
    return Array.from(ids);
}

function verificarPermissaoCliente(clienteId) {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    
    if (tipoUsuario === 'admin') {
        return true; // Admin tem acesso total
    }
    
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        
        if (convidado && convidado.ativo) {
            const idNorm = parseIdSafe(clienteId);
            if (idNorm == null) return false;
            const idsVisiveis = obterIdsClientesVisiveisParaConvidado(convidado);
            return idsVisiveis.includes(String(idNorm));
        }
    }
    
    return false;
}

function exigirAdmin(acao = 'esta operação') {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario !== 'admin') {
        mostrarNotificacao(`Acesso restrito: somente administrador pode executar ${acao}.`, 'error');
        return false;
    }
    return true;
}

function obterNomeEntidade(tipo) {
    const nomes = {
        cliente: 'cliente',
        honorario: 'honorário',
        contrato: 'contrato',
        heranca: 'herança',
        migracao: 'migração',
        registo: 'registo',
        prazo: 'prazo',
        documento: 'documento'
    };
    return nomes[tipo] || tipo || 'item';
}

function exigirPermissaoAcao(acao, entidade) {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario === 'admin') {
        return true;
    }
    if (tipoUsuario === 'convidado') {
        return true;
    }
    if (appStorage.getItem('convidadoId')) {
        return true;
    }
    mostrarNotificacao(`Acesso restrito: perfil não pode ${acao} ${obterNomeEntidade(entidade)}.`, 'error');
    return false;
}

function exigirPermissaoAcaoItem(acao, entidade, item) {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario === 'admin') {
        return true;
    }
    if (tipoUsuario === 'convidado' && acao === 'editar') {
        return true;
    }
    mostrarNotificacao(`Acesso restrito: perfil não pode ${acao} ${obterNomeEntidade(entidade)}.`, 'error');
    return false;
}

function obterClientePorIdOuNome(clienteId, clienteNome) {
    const lista = obterClientesAtual();
    if (clienteId !== null && clienteId !== undefined && clienteId !== '') {
        const encontradoPorId = lista.find(c => String(c.id) === String(clienteId));
        if (encontradoPorId) return encontradoPorId;
    }
    if (clienteNome) {
        const nomeNormalizado = String(clienteNome).trim().toLowerCase();
        const encontradoPorNome = lista.find(c => String(c.nome || '').trim() === String(clienteNome).trim());
        if (encontradoPorNome) return encontradoPorNome;
        const encontradoCaseInsensitive = lista.find(c => String(c.nome || '').trim().toLowerCase() === nomeNormalizado);
        if (encontradoCaseInsensitive) return encontradoCaseInsensitive;
    }
    return null;
}

function renderClienteLink(clienteId, clienteNome) {
    const nome = clienteNome || 'Cliente';
    const idValor = clienteId !== null && clienteId !== undefined ? String(clienteId) : '';
    const nomeSeguro = String(nome).replace(/"/g, '&quot;');
    return `<a href="#" class="js-cliente-detalhes-link" data-cliente-id="${idValor}" data-cliente-nome="${nomeSeguro}" onclick="abrirClientePorIdOuNome(this.dataset.clienteId, this.dataset.clienteNome); return false;" style="color: #2563eb; text-decoration: underline; cursor: pointer;">${nome}</a>`;
}

function abrirClientePorIdOuNome(clienteId, clienteNome) {
    mostrarNotificacao('A abrir cliente...', 'info');
    const cliente = obterClientePorIdOuNome(clienteId, clienteNome);
    if (!cliente) {
        mostrarNotificacao('Cliente não encontrado.', 'error');
        return;
    }
    mostrarInformacoesCompletasCliente(cliente);
}

// Verificar login após o DOM estar carregado
document.addEventListener('DOMContentLoaded', async function() {
    // PWA: registar Service Worker para instalação e uso offline básico
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    // Aguardar limpeza do cache Firestore (após zero absoluto) antes de iniciar listeners
    if (window.__promiseCacheFirestoreLimpo) {
        await window.__promiseCacheFirestoreLimpo;
    }
    const logado = await verificarLogin();
    if (!logado) {
        return;
    }
    // Se login OK, configurar interface baseada no tipo de usuário
    configurarInterfaceUsuario();
    // Forçar largura do sidebar
    forcarLarguraSidebar();
    // Aplicar novamente após um delay
    setTimeout(forcarLarguraSidebar, 1000);
    setTimeout(forcarLarguraSidebar, 2000);
    // Inicializar sistema normalmente
    init();
});

function forcarLarguraSidebar() {
    // Tentar múltiplas formas de encontrar o sidebar
    const sidebar = document.getElementById('sidebar');
    const sidebarClass = document.querySelector('.sidebar');
    
    if (sidebar) {
        sidebar.style.width = '300px';
        sidebar.style.minWidth = '300px';
        sidebar.style.maxWidth = '300px';
        sidebar.style.setProperty('width', '300px', 'important');
        sidebar.style.setProperty('min-width', '300px', 'important');
        sidebar.style.setProperty('max-width', '300px', 'important');
    }
    
    if (sidebarClass) {
        sidebarClass.style.width = '300px';
        sidebarClass.style.minWidth = '300px';
        sidebarClass.style.maxWidth = '300px';
        sidebarClass.style.setProperty('width', '300px', 'important');
        sidebarClass.style.setProperty('min-width', '300px', 'important');
        sidebarClass.style.setProperty('max-width', '300px', 'important');
    }
    
    // Aplicar também no conteúdo principal
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
        mainContent.style.marginLeft = '300px';
        mainContent.style.setProperty('margin-left', '300px', 'important');
    }
}

function configurarInterfaceUsuario() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const navConvidados = document.getElementById('nav-convidados');
    const btnAlterarSenha = document.getElementById('btnAlterarSenhaHeader');
    document.body.classList.toggle('perfil-convidado', tipoUsuario === 'convidado');
    document.body.classList.toggle('perfil-admin', tipoUsuario === 'admin');
    
    if (tipoUsuario === 'admin' && navConvidados) {
        navConvidados.style.display = 'block';
    } else if (navConvidados) {
        navConvidados.style.display = 'none';
    }
    if (btnAlterarSenha) {
        btnAlterarSenha.classList.toggle('hidden', tipoUsuario !== 'admin');
    }
    
    // Ocultar seções administrativas para convidados
    if (tipoUsuario === 'convidado') {
        ocultarSecoesConvidado();
    } else {
        mostrarTodasSecoes();
    }
}

function ocultarSecoesConvidado() {
    // Ocultar apenas seções administrativas
    const secoesParaOcultar = [
        'nav-relatorios',
        'nav-backup',
        'nav-historico',
        'nav-convidados',
        'nav-integracoes'
    ];
    
    secoesParaOcultar.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'none';
        }
    });
    
    // Garantir que as seções permitidas ficam visíveis
    const secoesPermitidas = [
        'nav-dashboard',
        'nav-clientes',
        'nav-honorarios',
        'nav-pagamentos',
        'nav-despesas',
        'nav-contratos',
        'nav-herancas',
        'nav-migracao',
        'nav-registos',
        'nav-prazos',
        'nav-tarefas',
        'nav-calendario',
        'nav-documentos'
    ];
    secoesPermitidas.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'block';
        }
    });
}

function mostrarTodasSecoes() {
    // Mostrar todas as seções para administradores
    const todasSecoes = [
        'nav-dashboard',
        'nav-clientes',
        'nav-honorarios',
        'nav-pagamentos',
        'nav-despesas',
        'nav-contratos', 
        'nav-herancas',
        'nav-migracao',
        'nav-registos',
        'nav-prazos',
        'nav-tarefas',
        'nav-calendario',
        'nav-documentos',
        'nav-integracoes',
        'nav-relatorios',
        'nav-backup',
        'nav-historico',
        'nav-convidados'
    ];
    
    todasSecoes.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'block';
        }
    });
}

// Dados globais
let clientes = [];
let honorarios = [];
let contratos = [];
let prazos = [];
let notificacoes = [];
let herancas = [];
let migracoes = [];
let registos = [];
let documentos = [];
let tarefas = [];
let convidados = [];
let entidades = [];
let integracoesExternas = [];
let representantes = [];
let pagamentos = [];
let despesas = [];
let calendarioModo = 'mensal';
let calendarioDataRef = new Date();
let calendarioFiltroCliente = '';
let calendarioFiltroStatus = '';
let calendarioFiltroTipo = '';
let calendarioFiltroPrioridade = '';
let secaoAtiva = 'dashboard';
let relatorioAvancadoUltimosResultados = [];

// Garantir que as variáveis estão definidas globalmente
window.clientes = clientes;
window.honorarios = honorarios;
window.contratos = contratos;
window.prazos = prazos;
window.notificacoes = notificacoes;
window.herancas = herancas;
window.migracoes = migracoes;
window.registos = registos;
window.documentos = documentos;
window.tarefas = tarefas;
window.convidados = convidados;
window.calendarioModo = calendarioModo;
window.calendarioDataRef = calendarioDataRef;
window.calendarioFiltroCliente = calendarioFiltroCliente;
window.calendarioFiltroStatus = calendarioFiltroStatus;
window.calendarioFiltroTipo = calendarioFiltroTipo;
window.calendarioFiltroPrioridade = calendarioFiltroPrioridade;
window.relatorioAvancadoUltimosResultados = relatorioAvancadoUltimosResultados;

// === FUNÇÃO DE TESTE ===
function testarBotao() {
    alert('BOTÃO FUNCIONANDO!');
}

// === FUNÇÕES DE EDIÇÃO DIRETA ===
function duplicarContrato(id) {
    const listaContratos = obterContratosAtual();
    const contrato = listaContratos.find(c => String(c.id) === String(id));
    if (!contrato) {
        mostrarNotificacao('Contrato não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('criar', 'contrato')) return;
    fecharModalRobusto();
    abrirModal('contrato');
    setTimeout(() => {
        const set = (idEl, val) => { const el = document.getElementById(idEl); if (el && val != null) el.value = String(val); };
        set('contratoCliente', contrato.clienteId || '');
        set('contratoTipo', contrato.tipo || '');
        set('contratoValor', contrato.valor ?? '');
        set('contratoIVA', String(contrato.iva ?? 23));
        set('contratoPercentagem', contrato.percentagem ?? '');
        set('contratoStatus', 'pendente');
        set('contratoDataInicio', contrato.dataInicio || '');
        set('contratoObservacoes', contrato.observacoes || '');
        const parceria = contrato.parceria || 'sem';
        set('contratoParceria', parceria);
        set('contratoParceriaNome', contrato.parceriaNome || '');
        const parceriaDiv = document.getElementById('contratoParceriaNomeDiv');
        if (parceriaDiv) parceriaDiv.style.display = (parceria === 'empresa' || parceria === 'pessoa') ? '' : 'none';
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Contrato';
        lucide.createIcons();
    }, 150);
}

function editarContratoDireto(id) {
    const listaContratos = Array.isArray(contratos) ? contratos : (obterContratosAtual?.() || []);
    const contrato = listaContratos.find(c => String(c.id) === String(id));
    if (contrato) {
        fecharModalRobusto();
        setTimeout(() => abrirModalEdicaoContrato(contrato), 200);
    } else {
        mostrarNotificacao('Contrato não encontrado!', 'error');
    }
}

function editarHonorarioDireto(id) {
    const honorario = obterHonorariosAtual().find(h => String(h.id) === String(id));
    if (honorario) {
        fecharModalRobusto();
        setTimeout(() => abrirModalEdicaoHonorario(honorario), 200);
    } else {
        mostrarNotificacao('Honorário não encontrado!', 'error');
    }
}

function duplicarHonorario(id) {
    const honorario = obterHonorariosAtual().find(h => String(h.id) === String(id));
    if (!honorario) {
        mostrarNotificacao('Honorário não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('criar', 'honorario')) return;
    fecharModalRobusto();
    abrirModal('honorario');
    setTimeout(() => {
        const set = (idEl, val) => { const el = document.getElementById(idEl); if (el && val != null) el.value = String(val); };
        set('honorarioCliente', honorario.cliente || honorario.clienteNome || '');
        set('honorarioServico', (honorario.servico || '') + ' (cópia)');
        set('honorarioValor', honorario.valor ?? '');
        set('honorarioStatus', 'pendente');
        set('honorarioVencimento', honorario.vencimento || '');
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Honorário';
        lucide.createIcons();
    }, 150);
}

async function excluirHonorarioDireto(id) {
    if (!exigirPermissaoAcao('apagar', 'honorario')) return;
    if (!confirm('Tem certeza que deseja excluir este honorário? Esta ação não pode ser desfeita.')) return;

    let honorariosAtual = obterHonorariosAtual();
    const honorariosAtualizados = honorariosAtual.filter(h => String(h.id) !== String(id));

    try {
        if (isCloudReady()) {
            await apagarHonorarioCloud(id);
            honorarios = honorariosAtualizados;
            window.honorarios = honorarios;
            salvarDados('honorarios', honorariosAtualizados, { skipCloudSync: true });
        } else {
            salvarDados('honorarios', honorariosAtualizados);
        }
        mostrarNotificacao('Honorário excluído com sucesso!', 'success');
        setTimeout(() => {
            carregarSecao('honorarios');
            if (typeof atualizarListaHonorarios === 'function') atualizarListaHonorarios(honorariosAtualizados);
        }, 100);
    } catch (err) {
        console.warn('Erro ao apagar honorário na nuvem, a guardar localmente:', err);
        salvarDados('honorarios', honorariosAtualizados);
        mostrarNotificacao('Honorário excluído com sucesso!', 'success');
        setTimeout(() => carregarSecao('honorarios'), 100);
    }
}

function editarClienteDireto(id) {
    const cliente = obterClientesAtual().find(c => String(c.id) === String(id));
    if (cliente) {
        fecharModal();
        setTimeout(() => abrirModalEdicaoCliente(cliente), 100);
    } else {
        mostrarNotificacao('Cliente não encontrado!', 'error');
    }
}

/** Abre o modal de novo cliente com dados preenchidos a partir do cliente indicado (para duplicar). */
function duplicarCliente(id) {
    const cliente = obterClientesAtual().find(c => String(c.id) === String(id));
    if (!cliente) {
        mostrarNotificacao('Cliente não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcaoItem('criar', 'cliente', cliente)) return;
    fecharModal();
    abrirModal('cliente');
    setTimeout(() => {
        const set = (idEl, val) => { const el = document.getElementById(idEl); if (el && val != null) el.value = String(val); };
        set('clienteNome', (cliente.nome || '') + ' (cópia)');
        set('clienteEmail', cliente.email || '');
        set('clienteTelefone', cliente.telefone || '');
        set('clienteNIF', ''); // NIF em branco - cada cliente deve ter o seu
        set('clienteEndereco', cliente.endereco || cliente.morada || '');
        set('clienteStatus', cliente.status || 'ativo');
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Cliente';
        lucide.createIcons();
    }, 150);
}

// Inicialização
function init() {
    
    // getBackupLogs lê de Firestore quando há cache (preenchido ao abrir secção Backup)
    if (typeof window.getBackupLogs === 'function') {
        const _origGet = window.getBackupLogs;
        window.getBackupLogs = function() {
            if (Array.isArray(window.__backupLogsCache)) return window.__backupLogsCache;
            return _origGet();
        };
    }
    
    // Firestore = fonte principal. Sync traz dados da nuvem e atualiza.
    carregarDados();
    carregarDadosExemplo();
    // Indicador de sync: mostrar último estado conhecido (erro se último evento foi erro)
    const ultimoErro = appStorage.getItem('cloudSyncUltimoErro');
    const ultimoOk = appStorage.getItem('cloudSyncUltimoSucesso');
    if (ultimoErro && (!ultimoOk || new Date(ultimoErro).getTime() > new Date(ultimoOk).getTime())) {
        atualizarIndicadorSync('error', 'Erro — clique para tentar novamente');
    } else {
        atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline');
    }
    window.addEventListener('online', () => atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline'));
    window.addEventListener('offline', () => atualizarIndicadorSync('offline'));
    limparConvidadosInativos();

    // Sincronizar sempre ao carregar (após zero absoluto o Firestore está vazio; cache é limpo)
    sincronizarTodasEntidadesNuvem().then(() => {
        if (isCloudReady()) try { appStorage.setItem('cloudSyncUltimoSucesso', new Date().toISOString()); } catch (e) {}
        appStorage.removeItem('naoRestaurarDaNuvem');
        carregarDados();
        carregarSecao(typeof secaoAtiva !== 'undefined' ? secaoAtiva : 'dashboard');
        atualizarInterface();
        atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline');
    });

    // Escuta em tempo real - SEMPRE ativar para carregar clientes e resto (evita ter de forçar backup/F5)
    if (isCloudReady()) {
        iniciarListenersFirestore();
    }

    // Sincronizar sessão para window (para listeners/prepararLista)
    try {
        window.__tipoUsuario = appStorage.getItem('tipoUsuario') || '';
        window.__usuarioNome = appStorage.getItem('usuarioNome') || 'Sistema';
    } catch (e) {}
    const tipoUsuario = window.__tipoUsuario || '';
    if (tipoUsuario === 'convidado') {
        carregarSecao('clientes');
    } else {
        carregarSecao('dashboard');
    }

    // Se a área de conteúdo continuar vazia (ex.: script.js não carregou no GitHub Pages), mostrar aviso
    setTimeout(() => {
        const el = document.getElementById('conteudoDinamico');
        if (el && el.textContent.trim().length < 50) {
            el.innerHTML = `
                <div class="p-6 bg-amber-50 border border-amber-200 rounded-lg text-amber-800">
                    <p class="font-semibold mb-2">A área de conteúdo não carregou.</p>
                    <p class="text-sm mb-2">Se publicou em GitHub Pages, verifique que <strong>index.html</strong>, <strong>script.js</strong> e <strong>styles.css</strong> estão na mesma pasta no repositório.</p>
                    <p class="text-sm">Abra as ferramentas do programador (F12) → separador Rede/Network e confirme que script.js é carregado sem erro 404.</p>
                </div>
            `;
        }
    }, 500);

    // Sincronização periódica em background (a cada 5 min)
    const SYNC_PERIODICO_MS = 5 * 60 * 1000;
    if (isCloudReady()) {
        window.__syncPeriodico = setInterval(() => {
            if (isCloudReady()) {
                sincronizarTodasEntidadesNuvem().then(() => {
                    if (isCloudReady()) try { appStorage.setItem('cloudSyncUltimoSucesso', new Date().toISOString()); } catch (e) {}
                    carregarDados();
                    carregarSecao(typeof secaoAtiva !== 'undefined' ? secaoAtiva : 'dashboard');
                    atualizarInterface();
                    atualizarIndicadorSync('ok');
                });
            }
        }, SYNC_PERIODICO_MS);
    }

    // Ao voltar ao separador: reiniciar listeners (podem ter sido suspensos) e sincronizar
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && isCloudReady()) {
            if (typeof listenerManager !== 'undefined' && listenerManager.pause && listenerManager.resume) {
                listenerManager.pause();
                listenerManager.resume(iniciarListenersFirestore);
            }
            sincronizarTodasEntidadesNuvem().then(() => {
                if (isCloudReady()) try { appStorage.setItem('cloudSyncUltimoSucesso', new Date().toISOString()); } catch (e) {}
                carregarDados();
                carregarSecao(typeof secaoAtiva !== 'undefined' ? secaoAtiva : 'dashboard');
                atualizarInterface();
                atualizarIndicadorSync(isCloudReady() ? 'ok' : 'offline');
            });
        }
    });
    
    configurarEventos();
    inicializarPesquisaGlobal();
    atualizarInterface();
    iniciarSistemaNotificacoes();
    iniciarSistemaBackup();
    configurarMonitorizacaoErros();
    setTimeout(verificarLembreteBackup, 3000);
    setTimeout(verificarNotificacaoBrowserPrazos, 5000);
    setTimeout(sugerirPermissaoNotificacoes, 8000);
    setTimeout(function() { if (typeof mostrarGuiaPrimeiroUso === 'function') mostrarGuiaPrimeiroUso(); }, 2000);
    inicializarAcessibilidadeModais();
    
    // Inicializar funcionalidades mobile (PWA via Service Worker já registado em DOMContentLoaded)
    if (typeof inicializarGestosTouch === 'function') inicializarGestosTouch();
    
    
    // Calcular juros automáticos na inicialização
    // calcularJurosAutomaticos(); // REMOVIDO
}

function inicializarPesquisaGlobal() {
    const input = document.getElementById('globalSearchInput');
    const results = document.getElementById('globalSearchResults');
    const container = document.getElementById('globalSearchContainer');
    if (!input || !results || !container) return;
    
    let timer = null;
    const fecharResultados = () => {
        results.classList.add('hidden');
        results.innerHTML = '';
    };
    
    const renderizar = (termo) => {
        const resultados = executarPesquisaGlobal(termo);
        if (resultados.length === 0) {
            results.innerHTML = `
                <div class="px-4 py-3 text-sm text-gray-500">
                    Nenhum resultado encontrado para "${termo}".
                </div>
            `;
            results.classList.remove('hidden');
            return;
        }
        
        let selectedIdx = 0;
        const itens = resultados.map((item, idx) => {
            const attrs = [`data-secao="${item.secao}"`, `data-index="${idx}"`];
            if (item.clienteId != null) attrs.push(`data-cliente-id="${String(item.clienteId).replace(/"/g, '&quot;')}"`);
            if (item.clienteNome) attrs.push(`data-cliente-nome="${String(item.clienteNome).replace(/"/g, '&quot;')}"`);
            const sel = idx === 0 ? ' bg-blue-50' : '';
            return `<button type="button" class="pesquisa-result-item w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0${sel}" ${attrs.join(' ')}>
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm font-semibold text-gray-800">${item.titulo}</div>
                        <div class="text-xs text-gray-500">${item.subtitulo || ''}</div>
                    </div>
                    <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">${item.tipo}</span>
                </div>
            </button>`;
        }).join('');
        
        results.innerHTML = `
            <div class="px-4 py-2 text-xs text-gray-400 border-b border-gray-100">
                Resultados: ${resultados.length} (↑↓ navegar, Enter selecionar)
            </div>
            <div class="max-h-80 overflow-y-auto pesquisa-result-list">${itens}</div>
        `;
        results.classList.remove('hidden');
        window.__pesquisaSelectedIndex = 0;
        window.__pesquisaResultados = resultados;
    };
    
    const ativarResultadoSelecionado = () => {
        const list = results.querySelector('.pesquisa-result-list');
        if (!list) return;
        const sel = window.__pesquisaSelectedIndex;
        const btn = list.querySelector(`.pesquisa-result-item[data-index="${sel}"]`);
        if (btn) btn.click();
    };
    
    const atualizarSelecaoVisual = (novoIdx) => {
        const list = results.querySelector('.pesquisa-result-list');
        if (!list) return;
        const btns = list.querySelectorAll('.pesquisa-result-item');
        if (novoIdx < 0 || novoIdx >= btns.length) return;
        window.__pesquisaSelectedIndex = novoIdx;
        btns.forEach((b, i) => {
            b.classList.toggle('bg-blue-50', i === novoIdx);
        });
        btns[novoIdx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    };
    
    input.addEventListener('input', () => {
        const termo = input.value.trim();
        if (timer) clearTimeout(timer);
        if (termo.length < 2) {
            fecharResultados();
            return;
        }
        timer = setTimeout(() => renderizar(termo), 250);
    });
    
    input.addEventListener('focus', () => {
        const termo = input.value.trim();
        if (termo.length >= 2) {
            renderizar(termo);
        }
    });
    
    results.addEventListener('click', (event) => {
        const botao = event.target.closest('[data-secao]');
        if (!botao) return;
        const secao = botao.getAttribute('data-secao');
        const clienteId = botao.getAttribute('data-cliente-id');
        const clienteNome = botao.getAttribute('data-cliente-nome') || '';
        fecharResultados();
        if (secao) carregarSecao(secao);
        if (clienteId != null && secao === 'clientes' && typeof abrirClientePorIdOuNome === 'function') {
            setTimeout(() => abrirClientePorIdOuNome(clienteId, clienteNome), 200);
        }
    });
    
    document.addEventListener('click', (event) => {
        if (!container.contains(event.target)) {
            fecharResultados();
        }
    });
    
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            fecharResultados();
            if (document.activeElement === input) input.blur();
            return;
        }
        // Ctrl+K ou Cmd+K: focar a pesquisa global
        if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
            event.preventDefault();
            input.focus();
            input.select();
            if (input.value.trim().length >= 2) {
                renderizar(input.value.trim());
            }
            return;
        }
        // Navegação por teclado nos resultados (quando input focado e resultados visíveis)
        if (document.activeElement === input && !results.classList.contains('hidden')) {
            const list = results.querySelector('.pesquisa-result-list');
            const total = list ? list.querySelectorAll('.pesquisa-result-item').length : 0;
            if (total === 0) return;
            let idx = window.__pesquisaSelectedIndex ?? 0;
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                atualizarSelecaoVisual((idx + 1) % total);
                return;
            }
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                atualizarSelecaoVisual((idx - 1 + total) % total);
                return;
            }
            if (event.key === 'Enter') {
                event.preventDefault();
                ativarResultadoSelecionado();
                fecharResultados();
                return;
            }
        }
    });
}

function executarPesquisaGlobal(termo) {
    const termoLower = termo.toLowerCase();
    const resultados = [];
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    
    const clientePermitido = (clienteId) => {
        if (tipoUsuario !== 'convidado') return true;
        if (!clienteId) return false;
        return verificarPermissaoCliente(clienteId);
    };
    
    const clientesParaPesquisar = obterClientesAtual();
    clientesParaPesquisar.forEach(cliente => {
        if (!clientePermitido(cliente.id)) return;
        const haystack = [
            cliente.nome,
            cliente.email,
            cliente.telefone,
            cliente.nif
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Cliente',
                titulo: cliente.nome,
                subtitulo: [cliente.email, cliente.telefone].filter(Boolean).join(' • '),
                secao: 'clientes',
                clienteId: cliente.id,
                clienteNome: cliente.nome
            });
        }
    });
    
    const honorariosParaPesquisar = Array.isArray(honorarios) ? honorarios : [];
    honorariosParaPesquisar.forEach(honorario => {
        if (honorario.clienteId && !clientePermitido(honorario.clienteId)) return;
        const clienteNome = honorario.clienteNome || honorario.cliente || obterNomeClienteRelatorio(honorario);
        const haystack = [
            honorario.descricao,
            honorario.valor,
            honorario.estado,
            honorario.tipo,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Honorário',
                titulo: honorario.descricao || 'Honorário',
                subtitulo: [clienteNome, honorario.valor, honorario.estado].filter(Boolean).join(' • '),
                secao: 'honorarios'
            });
        }
    });
    
    const contratosParaPesquisar = Array.isArray(contratos) ? contratos : [];
    contratosParaPesquisar.forEach(contrato => {
        if (contrato.clienteId && !clientePermitido(contrato.clienteId)) return;
        const clienteNome = contrato.cliente || contrato.clienteNome || obterNomeClienteRelatorio(contrato);
        const haystack = [
            contrato.tipo,
            contrato.descricao,
            contrato.status,
            contrato.valor,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Contrato',
                titulo: contrato.tipo || contrato.descricao || 'Contrato',
                subtitulo: [clienteNome, contrato.status].filter(Boolean).join(' • '),
                secao: 'contratos'
            });
        }
    });
    
    const registosParaPesquisar = Array.isArray(registos) ? registos : [];
    registosParaPesquisar.forEach(registo => {
        if (registo.clienteId && !clientePermitido(registo.clienteId)) return;
        const clienteNome = registo.cliente || registo.clienteNome || obterNomeClienteRelatorio(registo);
        const haystack = [
            registo.tipo,
            registo.descricao,
            registo.status,
            registo.valor,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Processo',
                titulo: registo.tipo || registo.descricao || 'Processo',
                subtitulo: [clienteNome, registo.status].filter(Boolean).join(' • '),
                secao: 'registos'
            });
        }
    });
    
    const prazosParaPesquisar = Array.isArray(prazos) ? prazos : [];
    prazosParaPesquisar.forEach(prazo => {
        if (prazo.clienteId && !clientePermitido(prazo.clienteId)) return;
        const clienteNome = prazo.clienteNome || prazo.cliente || obterNomeClienteRelatorio(prazo);
        const haystack = [
            prazo.descricao,
            prazo.tipo,
            prazo.status,
            prazo.dataLimite,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            const data = extrairDataRelatorio(prazo);
            resultados.push({
                tipo: 'Prazo',
                titulo: prazo.descricao || prazo.tipo || 'Prazo',
                subtitulo: [clienteNome, data ? formatarDataRelatorio(data) : null].filter(Boolean).join(' • '),
                secao: 'prazos'
            });
        }
    });
    
    const herancasParaPesquisar = Array.isArray(herancas) ? herancas : [];
    herancasParaPesquisar.forEach(heranca => {
        if (heranca.clienteId && !clientePermitido(heranca.clienteId)) return;
        const clienteNome = heranca.cliente || heranca.clienteNome || obterNomeClienteRelatorio(heranca);
        const haystack = [
            heranca.tipo,
            heranca.descricao,
            heranca.status,
            heranca.valor,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Herança',
                titulo: heranca.tipo || heranca.descricao || 'Herança',
                subtitulo: [clienteNome, heranca.status].filter(Boolean).join(' • '),
                secao: 'herancas'
            });
        }
    });
    
    const migracoesParaPesquisar = Array.isArray(migracoes) ? migracoes : [];
    migracoesParaPesquisar.forEach(migracao => {
        if (migracao.clienteId && !clientePermitido(migracao.clienteId)) return;
        const clienteNome = migracao.cliente || migracao.clienteNome || obterNomeClienteRelatorio(migracao);
        const haystack = [
            migracao.tipo,
            migracao.descricao,
            migracao.status,
            migracao.valor,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Migração',
                titulo: migracao.tipo || migracao.descricao || 'Migração',
                subtitulo: [clienteNome, migracao.status].filter(Boolean).join(' • '),
                secao: 'migracoes'
            });
        }
    });
    
    const tarefasParaPesquisar = Array.isArray(tarefas) ? tarefas : [];
    tarefasParaPesquisar.forEach(tarefa => {
        if (tarefa.clienteId && !clientePermitido(tarefa.clienteId)) return;
        const clienteNome = tarefa.clienteNome || tarefa.cliente || obterNomeClienteRelatorio(tarefa);
        const haystack = [
            tarefa.titulo,
            tarefa.descricao,
            tarefa.status,
            tarefa.processoTipo,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Tarefa',
                titulo: tarefa.titulo || 'Tarefa',
                subtitulo: [clienteNome, tarefa.descricao].filter(Boolean).join(' • '),
                secao: 'tarefas'
            });
        }
    });
    
    const documentosParaPesquisar = Array.isArray(documentos) ? documentos : [];
    documentosParaPesquisar.forEach(doc => {
        if (doc.deleted) return;
        if (doc.clienteId && !clientePermitido(doc.clienteId)) return;
        const clienteNome = doc.clienteNome || doc.cliente || obterNomeClienteRelatorio(doc);
        const haystack = [
            doc.nomeArquivo,
            doc.descricao,
            doc.processoTipo,
            doc.tipo,
            doc.categoria,
            clienteNome
        ].filter(Boolean).join(' ').toLowerCase();
        if (haystack.includes(termoLower)) {
            resultados.push({
                tipo: 'Minuta',
                titulo: doc.nomeArquivo || 'Documento',
                subtitulo: [clienteNome, doc.processoTipo || doc.tipo].filter(Boolean).join(' • '),
                secao: 'documentos'
            });
        }
    });
    
    return resultados.slice(0, 25);
}



// Função robusta para fechar modais
function fecharModalRobusto() {
    try {
        const modalsFixedInset = document.querySelectorAll('.fixed.inset-0');
        modalsFixedInset.forEach((modal) => { if (modal.parentNode) modal.remove(); });
        
        const todosModais = document.querySelectorAll('.modal');
        todosModais.forEach((modal) => { if (modal.parentNode) modal.remove(); });
        
        let count = 0;
        document.querySelectorAll('div').forEach(div => {
            const computedStyle = getComputedStyle(div);
            if ((computedStyle.position === 'fixed' || div.style.position === 'fixed') &&
                div.id !== 'sidebar' && !div.classList.contains('sidebar') &&
                !div.id.includes('header') && !div.id.includes('nav')) {
                if (div.classList.contains('modal') || div.classList.contains('backdrop') ||
                    div.classList.contains('bg-black') || div.classList.contains('bg-opacity') ||
                    div.getAttribute('onclick')?.includes('fecharModal')) {
                    count++;
                    if (div.parentNode) div.remove();
                }
            }
        });
        
        let zIndexCount = 0;
        document.querySelectorAll('*').forEach(el => {
            const style = getComputedStyle(el);
            if (parseInt(style.zIndex) >= 50 && el.id !== 'sidebar' && el.id !== 'mobileMenuBtn' &&
                el.id !== 'menuHamburguer' && !el.classList.contains('sidebar') &&
                !el.classList.contains('header') && el.tagName !== 'BUTTON') {
                if (el.classList.contains('modal') || el.classList.contains('backdrop') ||
                    el.classList.contains('bg-black') || el.classList.contains('bg-opacity') ||
                    (el.classList.contains('fixed') && el.classList.contains('inset-0'))) {
                    zIndexCount++;
                    if (el.parentNode) el.remove();
                }
            }
        });
        
        const modalContainer = document.getElementById('modalContainer');
        if (modalContainer) {
            modalContainer.classList.remove('show');
            modalContainer.innerHTML = '';
            modalContainer.setAttribute('aria-hidden', 'true');
        }
        
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
            document.activeElement.blur();
        }
        
    } catch (e) {
        console.warn('❌ Erro na solução definitiva final:', e);
    }
}

// Função simples para fechar modal (backup)
function fecharModalSimples() {
    const modal = document.querySelector('.modal');
    if (modal) modal.remove();
}

// Função de teste para modal
function testarModal() {
    fecharModalRobusto();
    
    // Criar modal de teste simples
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.8) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 99999 !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    
    modal.innerHTML = `
        <div style="
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        ">
            <h2 style="color: #1f2937; margin-bottom: 20px;">🧪 TESTE DE MODAL</h2>
            <p style="color: #6b7280; margin-bottom: 20px;">Se vês esta mensagem, o modal está a funcionar!</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="fecharModalRobusto()" style="
                    background: #3b82f6;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                ">Fechar Robusto</button>
                <button onclick="fecharModalSimples()" style="
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 16px;
                ">Fechar Simples</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Função ultra-simples para modal
function modalUltraSimples() {
    
    // Criar div simples
    const div = document.createElement('div');
    div.id = 'modal-teste';
    div.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 999999;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    div.innerHTML = `
        <div style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 300px;
            text-align: center;
        ">
            <h3>🎯 MODAL ULTRA-SIMPLES</h3>
            <p>Se vês isto, o modal funciona!</p>
            <button onclick="document.getElementById('modal-teste').remove()" style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
            ">Fechar</button>
        </div>
    `;
    
    document.body.appendChild(div);
}

// Modo Escuro
function inicializarModoEscuro_REMOVED() {
    const savedTheme = appStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        ativarModoEscuro();
    } else {
        desativarModoEscuro();
    }
}

function toggleDarkMode() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    
    if (isDark) {
        desativarModoEscuro();
    } else {
        ativarModoEscuro();
    }
}

function ativarModoEscuro() {
    document.documentElement.setAttribute('data-theme', 'dark');
    appStorage.setItem('theme', 'dark');
    
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    
    if (icon) icon.setAttribute('data-lucide', 'sun');
    if (text) text.textContent = 'Modo Claro';
    
    // Re-renderizar ícones
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
}

function desativarModoEscuro() {
    document.documentElement.removeAttribute('data-theme');
    appStorage.setItem('theme', 'light');
    
    const icon = document.getElementById('darkModeIcon');
    const text = document.getElementById('darkModeText');
    
    if (icon) icon.setAttribute('data-lucide', 'moon');
    if (text) text.textContent = 'Modo Escuro';
    
    // Re-renderizar ícones
    if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
    }
}

// Gestos Touch
function inicializarGestosTouch() {
    let startX, startY, endX, endY;
    
    document.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    });
    
    document.addEventListener('touchend', (e) => {
        endX = e.changedTouches[0].clientX;
        endY = e.changedTouches[0].clientY;
        
        const deltaX = endX - startX;
        const deltaY = endY - startY;
        
        // Swipe horizontal (mudança de seção)
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0) {
                // Swipe direita - seção anterior
                navegarSecaoAnterior();
            } else {
                // Swipe esquerda - próxima seção
                navegarProximaSecao();
            }
        }
        
        // Swipe vertical (fechar modais)
        if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 100) {
            if (deltaY > 0) {
                // Swipe para baixo - fechar modal
                fecharModal();
            }
        }
    });
    
    // Pull to refresh
    let pullStartY = 0;
    let isPulling = false;
    
    document.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
            pullStartY = e.touches[0].clientY;
            isPulling = true;
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (isPulling && window.scrollY === 0) {
            const pullDistance = e.touches[0].clientY - pullStartY;
            if (pullDistance > 100) {
                // Pull to refresh
                window.location.reload();
                isPulling = false;
            }
        }
    });
}

function navegarSecaoAnterior() {
    const secoes = ['dashboard', 'clientes', 'honorarios', 'pagamentos', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'tarefas', 'calendario', 'documentos', 'integracoes', 'relatorios', 'backup', 'historico'];
    const indiceAtual = secoes.indexOf(secaoAtiva);
    if (indiceAtual > 0) {
        carregarSecao(secoes[indiceAtual - 1]);
    }
}

function navegarProximaSecao() {
    const secoes = ['dashboard', 'clientes', 'honorarios', 'pagamentos', 'contratos', 'herancas', 'migracoes', 'registos', 'prazos', 'tarefas', 'calendario', 'documentos', 'integracoes', 'relatorios', 'backup', 'historico'];
    const indiceAtual = secoes.indexOf(secaoAtiva);
    if (indiceAtual < secoes.length - 1) {
        carregarSecao(secoes[indiceAtual + 1]);
    }
}

// Notificações Push (Web Notifications API)
/** Envia notificação nativa do browser se a permissão estiver concedida. */
function enviarNotificacaoBrowserSafe(titulo, corpo, tag) {
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
    try {
        const notif = new Notification(titulo, {
            body: corpo,
            tag: tag || 'sistema-legal',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">⚖</text></svg>'
        });
        notif.onclick = () => { window.focus(); notif.close(); if (typeof carregarSecao === 'function') carregarSecao('dashboard'); };
    } catch (e) { console.warn('Notificação browser:', e); }
}
window.enviarNotificacaoBrowserSafe = enviarNotificacaoBrowserSafe;

/** Sugere ativar notificações do browser uma vez por sessão. */
/** Rola até o guia de primeiro uso no dashboard (se existir) e adiciona destaque. */
function mostrarGuiaPrimeiroUso() {
    const el = document.getElementById('guiaPrimeiroUso');
    if (!el) return;
    try {
        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        el.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
        setTimeout(() => el.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2'), 3000);
    } catch (e) { /* ignorar */ }
}

function sugerirPermissaoNotificacoes() {
    if (typeof Notification === 'undefined' || Notification.permission !== 'default') return;
    try {
        if (appStorage.getItem('notificacoesSugeridas') === '1') return;
        appStorage.setItem('notificacoesSugeridas', '1');
        mostrarNotificacao('Quer receber alertas de prazos e tarefas com o site em segundo plano? O sistema pedirá permissão quando houver alertas.', 'info');
    } catch (e) { console.warn('Sugerir notificações:', e); }
}

function solicitarPermissaoNotificacoes() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then((permission) => {
                if (permission === 'granted') {
                    mostrarNotificacao('Notificações ativadas!', 'success');
                }
            });
        }
    }
}

function enviarNotificacaoPush(titulo, corpo, icone) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(titulo, {
            body: corpo,
            icon: icone || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzYjgyZjYiLz4KPHBhdGggZD0iTTk2IDQ4QzY5LjQ5IDQ4IDQ4IDY5LjQ5IDQ4IDk2UzY5LjQ5IDE0NCA5NiAxNDRTMTQ0IDEyMi41MSAxNDQgOTZTMTIyLjUxIDQ4IDk2IDQ4Wk05NiAxMjhDNzMuOTA5IDEyOCA1NiAxMTAuMDkgNTYgODhTNzMuOTA5IDQ4IDk2IDQ4UzEzNiA2NS45MSAxMzYgODhTMTE4LjA5IDEyOCA5NiAxMjhaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
            badge: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTYiIGhlaWdodD0iOTYiIHZpZXdCb3g9IjAgMCA5NiA5NiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9Ijk2IiBoZWlnaHQ9Ijk2IiByeD0iMTIiIGZpbGw9IiNmNTk5MGIiLz4KPHBhdGggZD0iTTQ4IDI0QzM0Ljc0IDI0IDI0IDM0Ljc0IDI0IDQ4UzM0Ljc0IDcyIDQ4IDcyUzcyIDYxLjI2IDcyIDQ4UzYxLjI2IDI0IDQ4IDI0Wk00OCA2NEM0MC4yNyA2NCAzNCA1Ny43MyAzNCA1MFM0MC4yNyAzNiA0OCAzNlM2MiA0Mi4yNyA2MiA1MFM1NS73MyA2NCA0OCA2NFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=',
            vibrate: [200, 100, 200],
            requireInteraction: true
        });

        notification.onclick = () => {
            window.focus();
            notification.close();
        };
    }
}





function calcularJurosAutomaticos_REMOVED() {
    
    const honorariosVencidos = honorarios.filter(h => {
        if (h.status === 'pago') return false;
        const dataVencimento = new Date(h.vencimento);
        return dataVencimento < new Date();
    });
    
    honorariosVencidos.forEach(honorario => {
        const diasAtraso = Math.ceil((new Date() - new Date(honorario.vencimento)) / (1000 * 60 * 60 * 24));
        const taxaJuros = 0.0005; // 0.05% ao dia
        const juros = parseFloat(honorario.valor) * taxaJuros * diasAtraso;
        
        if (juros > 0) {
            honorario.jurosCalculados = juros;
            honorario.diasAtraso = diasAtraso;
            honorario.valorComJuros = parseFloat(honorario.valor) + juros;
            
            // Criar notificação de juros
            criarNotificacao({
                titulo: `Juros calculados - ${honorario.clienteNome}`,
                descricao: `Juros de €${juros.toFixed(2)} calculados (${diasAtraso} dias de atraso)`,
                tipo: 'warning',
                categoria: 'juros_calculados',
                referenciaId: honorario.clienteId
            });
        }
    });
    
    // Verificar se a função existe antes de chamar
    if (typeof salvarHonorarios === 'function') {
        salvarHonorarios();
    } else {
        console.error('❌ Função salvarHonorarios não encontrada!');
        // Fallback: salvar diretamente
        try {
            salvarDados('honorarios', honorarios);
        } catch (error) {
            console.error('❌ Erro no fallback:', error);
        }
    }
}

// 3. GERAÇÃO AUTOMÁTICA DE FATURAS
async function gerarFaturaAutomatica(honorarioId) {
    const honorario = honorarios.find(h => h.id === honorarioId);
    if (!honorario) return;
    
    const cliente = (typeof obterClientePorIdOuNome === 'function' ? obterClientePorIdOuNome(honorario.clienteId, honorario.clienteNome || honorario.cliente) : null) || clientes.find(c => String(c.id) === String(honorario.clienteId));
    if (!cliente) return;
    
    const fatura = {
        id: gerarIdImutavel(),
        numero: `FAT-${new Date().getFullYear()}-${String(Date.now()).slice(-6)}`,
        clienteId: cliente.id,
        clienteNome: cliente.nome || honorario.clienteNome || honorario.cliente || '[Cliente]',
        honorarioId: honorarioId,
        data: new Date().toISOString().split('T')[0],
        valor: honorario.valorComJuros || honorario.valor,
        juros: honorario.jurosCalculados || 0,
        status: 'pendente',
        observacoes: `Fatura gerada automaticamente para ${honorario.descricao || honorario.servico || 'Honorário'}`
    };
    
    // Guardar fatura (Firestore ou localStorage)
    if (isCloudReady()) {
        try {
            await criarFaturaCloud(fatura);
            if (Array.isArray(window.faturas)) window.faturas = [...(window.faturas || []), fatura];
        } catch (e) {
            console.warn('Erro ao guardar fatura na nuvem, fallback local:', e);
            const faturas = obterFaturas();
            faturas.push(fatura);
            appStorage.setItem('faturas', JSON.stringify(faturas));
        }
    } else {
        const faturas = obterFaturas();
        faturas.push(fatura);
        appStorage.setItem('faturas', JSON.stringify(faturas));
    }
    
    // Criar notificação
    criarNotificacao({
        titulo: `Fatura gerada - ${cliente.nome}`,
        descricao: `Fatura ${fatura.numero} gerada automaticamente`,
        tipo: 'success',
        categoria: 'fatura_gerada',
        referenciaId: cliente.id
    });
    
    return fatura;
}

// 4. SINCRONIZAÇÃO COM CALENDÁRIO
function sincronizarComCalendario_REMOVED() {
    
    const eventos = [];
    
    // Adicionar prazos
    prazos.forEach(prazo => {
        if (prazo.status === 'ativo' && prazo.dataLimite) {
            eventos.push({
                titulo: `📋 Prazo: ${prazo.descricao}`,
                data: prazo.dataLimite,
                tipo: 'prazo',
                cliente: prazo.clienteNome,
                descricao: prazo.observacoes || 'Prazo importante do Sistema Legal'
            });
        }
    });
    
    // Adicionar vencimentos de honorários
    honorarios.forEach(honorario => {
        if (isHonorarioEmAberto(honorario) && honorario.vencimento) {
            eventos.push({
                titulo: `💰 Vencimento: ${honorario.descricao}`,
                data: honorario.vencimento,
                tipo: 'vencimento',
                cliente: honorario.clienteNome,
                valor: honorario.valor,
                descricao: `Honorário de €${parseFloat(honorario.valor).toFixed(2)}`
            });
        }
    });
    
    // Adicionar contratos com vencimento
    contratos.forEach(contrato => {
        if (contrato.vencimento) {
            eventos.push({
                titulo: `📄 Contrato: ${contrato.descricao}`,
                data: contrato.vencimento,
                tipo: 'contrato',
                cliente: contrato.clienteNome,
                descricao: `Contrato - ${contrato.tipo}`
            });
        }
    });
    
    // Adicionar heranças com prazo
    herancas.forEach(heranca => {
        if (heranca.prazo) {
            eventos.push({
                titulo: `⚖️ Herança: ${heranca.descricao}`,
                data: heranca.prazo,
                tipo: 'heranca',
                cliente: heranca.clienteNome,
                descricao: `Processo de herança - ${heranca.tipo}`
            });
        }
    });
    
    
    if (eventos.length === 0) {
        mostrarNotificacao('Nenhum evento encontrado para exportar!', 'info');
        return;
    }
    
    // Gerar arquivo ICS para importar no calendário
    gerarArquivoICS(eventos);
}

function gerarArquivoICS(eventos) {
    
    // Função para formatar data no formato ICS
    function formatarDataICS(data) {
        return data.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    }
    
    // Função para escapar texto para ICS
    function escaparTextoICS(texto) {
        return texto
            .replace(/\\/g, '\\\\')
            .replace(/;/g, '\\;')
            .replace(/,/g, '\\,')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '');
    }
    
    let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Sistema Legal//Sistema Legal//PT
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Sistema Legal - Prazos e Vencimentos
X-WR-CALDESC:Calendário do Sistema Legal com prazos e vencimentos
X-WR-TIMEZONE:Europe/Lisbon`;

    eventos.forEach((evento, index) => {
        const dataInicio = new Date(evento.data);
        const dataFim = new Date(dataInicio.getTime() + (24 * 60 * 60 * 1000)); // +1 dia
        
        // Gerar UID único
        const uid = `sistema-legal-${Date.now()}-${index}@sistemalegal.com`;
        
        // Formatar datas
        const dtstart = formatarDataICS(dataInicio);
        const dtend = formatarDataICS(dataFim);
        const dtstamp = formatarDataICS(new Date());
        
        // Escapar textos
        const summary = escaparTextoICS(evento.titulo);
        const description = escaparTextoICS(`Cliente: ${evento.cliente}${evento.valor ? `\\nValor: €${evento.valor}` : ''}\\n\\nSistema Legal - ANA PAULA MEDINA`);
        const location = escaparTextoICS('Sistema Legal');
        
        icsContent += `
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${summary}
DESCRIPTION:${description}
LOCATION:${location}
STATUS:CONFIRMED
TRANSP:OPAQUE
SEQUENCE:0
END:VEVENT`;
    });

    icsContent += `
END:VCALENDAR`;

    // Criar e baixar arquivo
    const blob = new Blob([icsContent], { 
        type: 'text/calendar;charset=utf-8',
        endings: 'native'
    });
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Sistema_Legal_Calendario_${new Date().toISOString().split('T')[0]}.ics`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    mostrarNotificacao(`Arquivo de calendário gerado com sucesso! (${eventos.length} eventos)`, 'success');
}

// 5. INTEGRAÇÃO COM SISTEMAS EXTERNOS
function inicializarIntegracoes() {
    // Verificar se há integrações configuradas
    const integracoes = obterIntegracoes();
    
    integracoes.forEach(integracao => {
        if (integracao.ativa) {
            switch(integracao.tipo) {
                case 'email':
                    configurarIntegracaoEmail(integracao);
                    break;
                case 'calendario':
                    configurarIntegracaoCalendario(integracao);
                    break;
                case 'contabilidade':
                    configurarIntegracaoContabilidade(integracao);
                    break;
            }
        }
    });
}

function configurarIntegracaoEmail(config) {
    // Aqui você integraria com Gmail API, Outlook API, etc.
}

function configurarIntegracaoCalendario(config) {
    // Aqui você integraria com Google Calendar, Outlook Calendar, etc.
}

function configurarIntegracaoContabilidade(config) {
    // Aqui você integraria com sistemas de contabilidade
}



function obterFaturas() {
    // Firestore = fonte principal quando disponível
    if (isCloudReady() && Array.isArray(window.faturas)) return window.faturas;
    const raw = appStorage.getItem('faturas');
    return raw ? JSON.parse(raw) : [];
}

function obterIntegracoes() {
    const integracoes = appStorage.getItem('integracoes');
    const resultado = integracoes ? JSON.parse(integracoes) : [];
    return resultado;
}

function salvarIntegracoes(integracoes) {
    appStorage.setItem('integracoes', JSON.stringify(integracoes));
}

// Função para salvar honorários (CORRIGIDA - v2.0)
function salvarHonorarios() {
    try {
        salvarDados('honorarios', honorarios);
    } catch (error) {
        console.error('❌ Erro ao salvar honorários:', error);
        mostrarNotificacao('Erro ao salvar honorários!', 'error');
    }
}





async function gerarFaturasAutomaticas() {
    // Inclui TODOS os honorários com valor que ainda não têm fatura (com ou sem juros)
    const honorariosElegiveis = (honorarios || []).filter(h => {
        if (h.deleted) return false;
        const valor = parseFloat(h.valor) || 0;
        return valor > 0 && !obterFaturas().find(f => String(f.honorarioId) === String(h.id));
    });
    if (honorariosElegiveis.length === 0) {
        mostrarNotificacao('Nenhum honorário elegível! Crie um honorário com valor e que ainda não tenha fatura.', 'info');
        return;
    }
    let faturasGeradas = 0;
    for (const honorario of honorariosElegiveis) {
        await gerarFaturaAutomatica(honorario.id);
        faturasGeradas++;
    }
    mostrarNotificacao(`${faturasGeradas} fatura(s) gerada(s) com sucesso!`, 'success');
    carregarSecao('documentos');
    setTimeout(() => {
        const sel = document.getElementById('templateModelo');
        if (sel) sel.value = 'fatura_recibo';
        if (typeof toggleCamposProcuracaoAima === 'function') toggleCamposProcuracaoAima();
        if (typeof atualizarPreviewTemplateDocumento === 'function') atualizarPreviewTemplateDocumento();
    }, 400);
}

// Funções para gerenciar lembretes
function editarLembrete(lembreteId) {
    const lembretes = obterLembretes();
    const lembrete = lembretes.find(l => l.id === lembreteId);
    
    if (!lembrete) {
        mostrarNotificacao('Lembrete não encontrado!', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Editar Lembrete</h3>
                <button onclick="fecharModalRobusto()" class="btn btn-sm btn-secondary">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <form onsubmit="atualizarLembrete(event, ${lembreteId})">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Cliente</label>
                        <select name="clienteId" required class="w-full p-2 border rounded-lg">
                            <option value="">Selecione um cliente</option>
                            ${clientes.map(c => `<option value="${c.id}" ${c.id === lembrete.clienteId ? 'selected' : ''}>${c.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Título</label>
                        <input type="text" name="titulo" required class="w-full p-2 border rounded-lg" 
                               value="${lembrete.titulo}" placeholder="Título do lembrete">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Data/Hora</label>
                        <input type="datetime-local" name="data" required class="w-full p-2 border rounded-lg" 
                               value="${lembrete.data}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Descrição</label>
                        <textarea name="descricao" class="w-full p-2 border rounded-lg" rows="3" 
                                  placeholder="Descrição do lembrete">${lembrete.descricao}</textarea>
                    </div>
                    <div class="flex space-x-3">
                        <button type="submit" class="btn btn-primary">Atualizar Lembrete</button>
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                    </div>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function atualizarLembrete(event, lembreteId) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    const lembretes = obterLembretes();
    const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
    
    if (lembreteIndex === -1) {
        mostrarNotificacao('Lembrete não encontrado!', 'error');
        return;
    }
    
    lembretes[lembreteIndex] = {
        ...lembretes[lembreteIndex],
        clienteId: parseInt(formData.get('clienteId')),
        titulo: formData.get('titulo'),
        data: formData.get('data'),
        descricao: formData.get('descricao'),
        atualizadoEm: new Date().toISOString()
    };
    
    appStorage.setItem('lembretes', JSON.stringify(lembretes));
    
    fecharModal();
    mostrarNotificacao('Lembrete atualizado com sucesso!', 'success');
    carregarSecao('dashboard');
}

function desativarLembrete(lembreteId) {
    if (!confirm('Tem certeza que deseja desativar este lembrete?')) {
        return;
    }
    
    const lembretes = obterLembretes();
    const lembreteIndex = lembretes.findIndex(l => l.id === lembreteId);
    
    if (lembreteIndex === -1) {
        mostrarNotificacao('Lembrete não encontrado!', 'error');
        return;
    }
    
    lembretes[lembreteIndex].ativo = false;
    lembretes[lembreteIndex].desativadoEm = new Date().toISOString();
    
    appStorage.setItem('lembretes', JSON.stringify(lembretes));
    
    mostrarNotificacao('Lembrete desativado com sucesso!', 'success');
    carregarSecao('dashboard');
}

// Função para configurar integrações
function configurarIntegracoes() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Configurar Integrações</h3>
                <button onclick="fecharModalRobusto()" class="btn btn-sm btn-secondary">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Integração de Email -->
                <div class="card p-4">
                    <h4 class="font-semibold mb-3">📧 Integração de Email</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Servidor SMTP</label>
                            <input type="text" id="smtpServer" class="w-full p-2 border rounded-lg" 
                                   placeholder="smtp.gmail.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Porta</label>
                            <input type="number" id="smtpPort" class="w-full p-2 border rounded-lg" 
                                   placeholder="587" value="587">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="smtpEmail" class="w-full p-2 border rounded-lg" 
                                   placeholder="seu@email.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Senha</label>
                            <input type="password" id="smtpPassword" class="w-full p-2 border rounded-lg" 
                                   placeholder="Senha do email">
                        </div>
                        <button onclick="salvarIntegracaoEmail()" class="btn btn-primary">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Salvar Configuração
                        </button>
                    </div>
                </div>

                <!-- Integração de Calendário -->
                <div class="card p-4">
                    <h4 class="font-semibold mb-3">📅 Integração de Calendário</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tipo de Calendário</label>
                            <select id="calendarioTipo" class="w-full p-2 border rounded-lg">
                                <option value="google">Google Calendar</option>
                                <option value="outlook">Outlook Calendar</option>
                                <option value="apple">Apple Calendar</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">API Key</label>
                            <input type="text" id="calendarioApiKey" class="w-full p-2 border rounded-lg" 
                                   placeholder="Chave da API">
                        </div>
                        <button onclick="salvarIntegracaoCalendario()" class="btn btn-primary">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Salvar Configuração
                        </button>
                    </div>
                </div>

                <!-- Integração de Contabilidade -->
                <div class="card p-4">
                    <h4 class="font-semibold mb-3">💰 Integração de Contabilidade</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Sistema</label>
                            <select id="contabilidadeSistema" class="w-full p-2 border rounded-lg">
                                <option value="sap">SAP</option>
                                <option value="oracle">Oracle</option>
                                <option value="custom">Sistema Personalizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">URL da API</label>
                            <input type="url" id="contabilidadeUrl" class="w-full p-2 border rounded-lg" 
                                   placeholder="https://api.exemplo.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Token de Acesso</label>
                            <input type="text" id="contabilidadeToken" class="w-full p-2 border rounded-lg" 
                                   placeholder="Token de autenticação">
                        </div>
                        <button onclick="salvarIntegracaoContabilidade()" class="btn btn-primary">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Salvar Configuração
                        </button>
                    </div>
                </div>

                <div class="flex space-x-3">
                    <button onclick="fecharModalRobusto()" class="btn btn-secondary">Fechar</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function salvarIntegracaoEmail() {
    const config = {
        tipo: 'email',
        servidor: document.getElementById('smtpServer').value,
        porta: document.getElementById('smtpPort').value,
        email: document.getElementById('smtpEmail').value,
        senha: document.getElementById('smtpPassword').value,
        ativa: true,
        configuradaEm: new Date().toISOString()
    };
    
    const integracoes = obterIntegracoes();
    const index = integracoes.findIndex(i => i.tipo === 'email');
    
    if (index >= 0) {
        integracoes[index] = config;
    } else {
        integracoes.push(config);
    }
    
    salvarIntegracoes(integracoes);
    mostrarNotificacao('Configuração de email salva com sucesso!', 'success');
}

function salvarIntegracaoCalendario() {
    const config = {
        tipo: 'calendario',
        sistema: document.getElementById('calendarioTipo').value,
        apiKey: document.getElementById('calendarioApiKey').value,
        ativa: true,
        configuradaEm: new Date().toISOString()
    };
    
    const integracoes = obterIntegracoes();
    const index = integracoes.findIndex(i => i.tipo === 'calendario');
    
    if (index >= 0) {
        integracoes[index] = config;
    } else {
        integracoes.push(config);
    }
    
    salvarIntegracoes(integracoes);
    mostrarNotificacao('Configuração de calendário salva com sucesso!', 'success');
}

function salvarIntegracaoContabilidade() {
    const config = {
        tipo: 'contabilidade',
        sistema: document.getElementById('contabilidadeSistema').value,
        url: document.getElementById('contabilidadeUrl').value,
        token: document.getElementById('contabilidadeToken').value,
        ativa: true,
        configuradaEm: new Date().toISOString()
    };
    
    const integracoes = obterIntegracoes();
    const index = integracoes.findIndex(i => i.tipo === 'contabilidade');
    
    if (index >= 0) {
        integracoes[index] = config;
    } else {
        integracoes.push(config);
    }
    
    salvarIntegracoes(integracoes);
    mostrarNotificacao('Configuração de contabilidade salva com sucesso!', 'success');
}

function carregarDados() {
    try {
        // Firestore = fonte principal. Dados vêm apenas da nuvem.
        clientes = Array.isArray(clientes) ? clientes : [];
        window.clientes = clientes;
        honorarios = Array.isArray(honorarios) ? honorarios : [];
        window.honorarios = honorarios;
        contratos = Array.isArray(contratos) ? contratos : [];
        window.contratos = contratos;
        prazos = Array.isArray(prazos) ? prazos : [];
        window.prazos = prazos;
        notificacoes = Array.isArray(notificacoes) ? notificacoes : [];
        window.notificacoes = notificacoes;
        herancas = Array.isArray(herancas) ? herancas : [];
        window.herancas = herancas;
        migracoes = Array.isArray(migracoes) ? migracoes : [];
        window.migracoes = migracoes;
        registos = Array.isArray(registos) ? registos : [];
        window.registos = registos;
        documentos = Array.isArray(documentos) ? documentos : [];
        window.documentos = documentos;
        tarefas = Array.isArray(tarefas) ? tarefas : [];
        window.tarefas = tarefas;
        convidados = Array.isArray(convidados) ? convidados : [];
        window.convidados = convidados;
        pagamentos = Array.isArray(pagamentos) ? pagamentos : [];
        window.pagamentos = pagamentos;
        despesas = Array.isArray(despesas) ? despesas : [];
        window.despesas = despesas;

        // Dados vêm apenas do Firestore (cache IndexedDB quando offline)
    } catch (error) {
        console.error('❌ Erro ao carregar dados:', error);
        mostrarNotificacao('Erro ao carregar dados salvos', 'error');
    }
}

function carregarDadosExemplo() {
    // Com Firestore ativo: nunca criar dados de exemplo (dados vêm da nuvem)
    if (isCloudReady()) {
        return;
    }
    // Verificar se os dados foram limpos - se sim, não recriar dados de exemplo
    const dadosLimpos = appStorage.getItem('dadosLimpos');
    if (dadosLimpos === 'true') {
        return;
    }
    
    if (clientes.length === 0) {
        clientes = [
            {
                id: 1,
                nome: 'João Silva',
                email: 'joao@email.com',
                telefone: '123456789',
                nif: '123456789',
                endereco: 'Rua das Flores, 123',
                status: 'ativo',
                dataCriacao: new Date().toISOString()
            },
            {
                id: 2,
                nome: 'Maria Santos',
                email: 'maria@email.com',
                telefone: '987654321',
                nif: '987654321',
                endereco: 'Av. Principal, 456',
                status: 'ativo',
                dataCriacao: new Date().toISOString()
            }
        ];
        atualizarClientesEmMemoria(clientes);
    }

    if (honorarios.length === 0) {
        honorarios = [
            {
                id: 1,
                cliente: 'João Silva',
                servico: 'Consulta Jurídica',
                valor: 150.00,
                status: 'pago',
                vencimento: new Date().toISOString().split('T')[0],
                dataCriacao: new Date().toISOString()
            },
            {
                id: 2,
                cliente: 'Maria Santos',
                servico: 'Elaboração de Contrato',
                valor: 300.00,
                status: 'pendente',
                vencimento: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                dataCriacao: new Date().toISOString()
            }
        ];
        salvarDados('honorarios', honorarios);
    }

    if (contratos.length === 0) {
        contratos = [
            {
                id: 1,
                clienteId: 1,
                clienteNome: 'João Silva',
                tipo: 'Prestação de Serviços',
                descricao: 'Assessoria jurídica empresarial',
                valor: 5000.00,
                iva: 23,
                valorIVA: 1150.00,
                valorTotal: 6150.00,
                dataInicio: new Date().toISOString().split('T')[0],
                dataFim: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                status: 'ativo',
                observacoes: 'Contrato de assessoria jurídica anual',
                dataCriacao: new Date().toISOString()
            },
            {
                id: 2,
                clienteId: 2,
                clienteNome: 'Maria Santos',
                tipo: 'Consultoria',
                descricao: 'Consultoria em direito trabalhista',
                valor: 2500.00,
                iva: 23,
                valorIVA: 575.00,
                valorTotal: 3075.00,
                dataInicio: new Date().toISOString().split('T')[0],
                dataFim: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                status: 'ativo',
                observacoes: 'Consultoria específica para questões trabalhistas',
                dataCriacao: new Date().toISOString()
            }
        ];
        salvarDados('contratos', contratos);
    }

    if (prazos.length === 0) {
        prazos = [
            {
                id: 1,
                honorarioId: 1,
                clienteId: 1,
                clienteNome: 'João Silva',
                tipo: 'Vencimento',
                descricao: 'Vencimento de honorário - Consultoria jurídica',
                dataLimite: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'ativo',
                prioridade: 'alta',
                notificacoes: [],
                dataCriacao: new Date().toISOString()
            },
            {
                id: 2,
                honorarioId: 2,
                clienteId: 2,
                clienteNome: 'Maria Santos',
                tipo: 'Lembrete',
                descricao: 'Lembrete de pagamento - Elaboração de contrato',
                dataLimite: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
                status: 'ativo',
                prioridade: 'media',
                notificacoes: [],
                dataCriacao: new Date().toISOString()
            }
        ];
        salvarDados('prazos', prazos);
    }

    if (notificacoes.length === 0) {
        notificacoes = [];
        salvarDados('notificacoes', notificacoes);
    }

    // Heranças, Migrações e Registos sem dados de teste (uso profissional)

}

function salvarDados(chave, dados, opcoes = {}) {
    try {
        // clientes: APENAS memória (Firestore via ouvirClientes + CRUD). NUNCA appStorage.
        if (chave === 'clientes') {
            if (Array.isArray(dados)) atualizarClientesEmMemoria(dados);
            return;
        }
        // Verificar se os dados são válidos
        if (!dados || !Array.isArray(dados)) {
            console.error('❌ Dados inválidos para salvar:', dados);
            mostrarNotificacao('Erro: Dados inválidos', 'error');
            return;
        }
        const { skipCloudSync } = opcoes || {};
        const isSyncavel = CLOUD_ENTIDADES.includes(chave);
        const dadosParaSalvar = isSyncavel && !skipCloudSync ? prepararListaParaSync(chave, dados) : dados;
        let removidos = [];
        if (isSyncavel && !skipCloudSync) {
            try {
                const anterior = Array.isArray(obterListaGlobal(chave)) ? obterListaGlobal(chave) : [];
                const idsNovos = new Set((dadosParaSalvar || []).map(item => String(obterIdEntidade(chave, item))).filter(Boolean));
                removidos = (anterior || [])
                    .map(item => obterIdEntidade(chave, item))
                    .filter(id => id !== null && id !== undefined)
                    .map(id => String(id))
                    .filter(id => !idsNovos.has(id));
            } catch (error) {
                console.warn('Erro ao calcular removidos:', chave, error);
            }
        }
        
        const reduzirPayloadLocal = (key, lista) => {
            if (key === 'tarefas') {
                return (lista || []).map(tarefa => ({
                    ...tarefa,
                    anexos: []
                }));
            }
            return lista;
        };

        const limparBackupsLocal = () => {
            try {
                Object.keys(appStorage)
                    .filter(chave => chave.startsWith('backup_'))
                    .forEach(chave => appStorage.removeItem(chave));
            } catch (error) {
                console.warn('Erro ao limpar backups antigos:', error);
            }
        };

        // Dados só no Firestore (persistência offline via IndexedDB)
        let armazenamentoOk = true;
        const usarLocalStorage = false;
        if (usarLocalStorage) {
            const dadosLocal = reduzirPayloadLocal(chave, dadosParaSalvar);
            try {
                appStorage.setItem(chave, JSON.stringify(dadosLocal));
            } catch (storageError) {
                window.__storageQuotaExceeded = true;
                limparBackupsLocal();
                try {
                    appStorage.setItem(chave, JSON.stringify(reduzirPayloadLocal(chave, dadosParaSalvar)));
                } catch (e) {
                    armazenamentoOk = false;
                    mostrarNotificacao('Sem espaço local. Dados mantidos e sincronizados na nuvem.', 'warning');
                }
            }
        }
        
        // Atualizar variáveis globais
        if (chave === 'clientes') {
            clientes = dadosParaSalvar;
            window.clientes = clientes;
        } else if (chave === 'honorarios') {
            honorarios = dadosParaSalvar;
            window.honorarios = honorarios;
        } else if (chave === 'contratos') {
            contratos = dadosParaSalvar;
            window.contratos = contratos;
        } else if (chave === 'prazos') {
            prazos = dadosParaSalvar;
            window.prazos = prazos;
        } else if (chave === 'notificacoes') {
            notificacoes = dadosParaSalvar;
            window.notificacoes = notificacoes;
        } else if (chave === 'herancas') {
            herancas = dadosParaSalvar;
            window.herancas = herancas;
        } else if (chave === 'migracoes') {
            migracoes = dadosParaSalvar;
            window.migracoes = migracoes;
        } else if (chave === 'registos') {
            registos = dadosParaSalvar;
            window.registos = registos;
        } else if (chave === 'documentos') {
            documentos = dadosParaSalvar;
            window.documentos = documentos;
        } else if (chave === 'tarefas') {
            tarefas = dadosParaSalvar;
            window.tarefas = tarefas;
        } else if (chave === 'convidados') {
            convidados = dadosParaSalvar;
            window.convidados = convidados;
        } else if (chave === 'entidades') {
            entidades = dadosParaSalvar;
            window.entidades = entidades;
        } else if (chave === 'integracoes_externas') {
            integracoesExternas = dadosParaSalvar;
            window.integracoesExternas = integracoesExternas;
        } else if (chave === 'representantes') {
            representantes = dadosParaSalvar;
            window.representantes = representantes;
        }
        
        if (!skipCloudSync && isSyncavel) {
            agendarSyncEntidade(chave, dadosParaSalvar, removidos);
        }
        
    } catch (error) {
        console.error('❌ Erro ao salvar dados:', error);
        mostrarNotificacao('Erro ao salvar dados: ' + error.message, 'error');
    }
}

// === AUDITORIA E LOGS ===
window.auditoriaCloud = window.auditoriaCloud || [];
window.__auditoriaCloudCarregada = window.__auditoriaCloudCarregada || false;
window.__auditoriaCloudSyncing = window.__auditoriaCloudSyncing || false;

function combinarAuditorias(local, cloud) {
    const map = new Map();
    // logs (auditoria): Firestore = fonte principal; cloud sobrepõe local
    [...(local || []), ...(cloud || [])].forEach(item => {
        const chave = [
            item.id || '',
            item.tsMs || '',
            item.timestamp || '',
            item.usuario || '',
            item.acao || '',
            item.entidade || ''
        ].join('|');
        map.set(chave, item); // último (cloud) ganha
    });
    return Array.from(map.values()).sort((a, b) => {
        const dataA = a.tsMs || Date.parse(a.timestamp) || 0;
        const dataB = b.tsMs || Date.parse(b.timestamp) || 0;
        return dataB - dataA;
    });
}

function obterAuditoriaSemFiltro() {
    try {
        const local = JSON.parse(appStorage.getItem('auditoria') || '[]');
        const cloud = Array.isArray(window.auditoriaCloud) ? window.auditoriaCloud : [];
        return combinarAuditorias(local, cloud);
    } catch (error) {
        console.error('❌ Erro ao carregar auditoria completa:', error);
        return [];
    }
}

function obterAuditoria() {
    try {
        let combinado = obterAuditoriaSemFiltro();
        const tipoUsuario = appStorage.getItem('tipoUsuario') || 'desconhecido';
        if (tipoUsuario !== 'admin') {
            const usuarioLogado = appStorage.getItem('usuarioLogado') || '';
            combinado = combinado.filter(item => item.usuario === usuarioLogado);
        }
        return combinado;
    } catch (error) {
        console.error('❌ Erro ao carregar auditoria:', error);
        return [];
    }
}

function registrarAuditoria(acao, entidade, descricao, dadosAntes = null, dadosDepois = null) {
    try {
        const tipoUsuario = appStorage.getItem('tipoUsuario') || 'desconhecido';
        const usuarioLogado = appStorage.getItem('usuarioLogado') || 'N/D';
        const auditoria = obterAuditoriaSemFiltro();
        const item = {
            id: gerarIdImutavel(),
            timestamp: new Date().toISOString(),
            tsMs: Date.now(),
            usuario: usuarioLogado,
            tipoUsuario,
            acao,
            entidade,
            descricao,
            dadosAntes,
            dadosDepois
        };
        auditoria.unshift(item);
        appStorage.setItem('auditoria', JSON.stringify(auditoria.slice(0, 200)));
        salvarAuditoriaCloud(item);
    } catch (error) {
        console.error('❌ Erro ao registrar auditoria:', error);
    }
}

function salvarAuditoriaCloud(item) {
    if (!firestoreDb || !item) return Promise.resolve();
    return firestoreDb.collection('auditoria').add({
        ...item,
        origem: 'cloud',
        syncedAt: new Date().toISOString()
    }).catch((error) => {
        console.warn('Erro ao salvar auditoria na nuvem:', error);
    });
}

async function sincronizarAuditoriaNuvem() {
    if (!firestoreDb || window.__auditoriaCloudSyncing) return;
    window.__auditoriaCloudSyncing = true;
    try {
        const snap = await firestoreDb.collection('auditoria').orderBy('tsMs', 'desc').limit(200).get();
        window.auditoriaCloud = snap.docs.map(doc => doc.data());
        window.__auditoriaCloudCarregada = true;
    } catch (error) {
        console.warn('Erro ao carregar auditoria da nuvem:', error);
    } finally {
        window.__auditoriaCloudSyncing = false;
    }
}

function obterMetaAuditoriaItem(entidade, item) {
    const id = item && item.id !== undefined ? String(item.id) : '';
    if (!id) return null;
    const auditoria = obterAuditoriaSemFiltro();
    const relevantes = auditoria.filter(a => {
        if (a.entidade !== entidade) return false;
        const idDepois = a.dadosDepois && a.dadosDepois.id !== undefined ? String(a.dadosDepois.id) : '';
        const idAntes = a.dadosAntes && a.dadosAntes.id !== undefined ? String(a.dadosAntes.id) : '';
        return idDepois === id || idAntes === id;
    });
    if (relevantes.length === 0) return null;
    const ultimo = relevantes[0];
    const criado = [...relevantes].reverse().find(a => a.acao === 'criar' || a.acao === 'importar') || relevantes[relevantes.length - 1];
    return {
        criadoPor: criado?.usuario || 'N/D',
        criadoEm: criado?.timestamp || '',
        atualizadoPor: ultimo?.usuario || 'N/D',
        atualizadoEm: ultimo?.timestamp || ''
    };
}

function renderMetaAuditoria(entidade, item) {
    const meta = obterMetaAuditoriaItem(entidade, item);
    if (!meta) return '';
    const dataAtualizado = meta.atualizadoEm ? new Date(meta.atualizadoEm).toLocaleString('pt-PT') : '';
    return `<div class="text-[11px] text-gray-500">Criado por ${meta.criadoPor} • Atualizado por ${meta.atualizadoPor}${dataAtualizado ? ` • ${dataAtualizado}` : ''}</div>`;
}

function exportarAuditoria() {
    const auditoria = obterAuditoria();
    const blob = new Blob([JSON.stringify(auditoria, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `auditoria_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    mostrarNotificacao('Auditoria exportada com sucesso!', 'success');
}

function limparAuditoria() {
    if (!confirm('Deseja limpar o histórico de auditoria?')) return;
    appStorage.removeItem('auditoria');
    mostrarNotificacao('Auditoria limpa com sucesso!', 'success');
}

function escaparHtml(texto) {
    if (texto == null || texto === undefined) return '';
    return String(texto)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatarAuditoriaJson(dados) {
    if (!dados) {
        return '<span class="text-xs text-gray-500">Sem dados</span>';
    }
    const json = JSON.stringify(dados, null, 2);
    return `<pre class="text-xs bg-gray-50 border border-gray-200 rounded p-3 overflow-x-auto">${escaparHtml(json)}</pre>`;
}

function obterDocumentoAuditoria(item) {
    if (!item || item.entidade !== 'documento') return null;
    const doc = item.dadosDepois || item.dadosAntes;
    if (!doc || !doc.conteudo) return null;
    return doc;
}

function abrirDocumentoAuditoria(auditoriaId) {
    const auditoria = obterAuditoriaSemFiltro();
    const item = auditoria.find(a => String(a.id) === String(auditoriaId));
    const doc = obterDocumentoAuditoria(item);
    if (!doc) {
        mostrarNotificacao('Documento não encontrado no histórico.', 'warning');
        return;
    }
    abrirDocumentoEmNovaAba(doc);
}

function renderAcaoDocumentoHistorico(item) {
    const tipoUsuarioAtual = appStorage.getItem('tipoUsuario') || '';
    if (tipoUsuarioAtual !== 'admin') return '';
    const doc = obterDocumentoAuditoria(item);
    if (!doc) return '';
    const nome = doc.nomeArquivo ? escaparHtml(doc.nomeArquivo) : 'Documento';
    return `
        <button type="button" class="btn btn-secondary" onclick="abrirDocumentoAuditoria(${item.id})">
            Abrir documento (${nome})
        </button>
    `;
}

function gerarHistoricoDetalhado() {
    const auditoria = obterAuditoria();
    const usuarios = [...new Set(auditoria.map(item => item.usuario).filter(Boolean))].sort();
    const entidades = [...new Set(auditoria.map(item => item.entidade).filter(Boolean))].sort();
    const acoes = [...new Set(auditoria.map(item => item.acao).filter(Boolean))].sort();
    const tiposUsuario = [...new Set(auditoria.map(item => item.tipoUsuario).filter(Boolean))].sort();
    const tipoUsuarioAtual = appStorage.getItem('tipoUsuario') || 'desconhecido';
    const resumoAdmin = tipoUsuarioAtual === 'admin' ? (() => {
        const todos = obterAuditoriaSemFiltro();
        const porUsuario = todos.reduce((acc, item) => {
            const usuario = item.usuario || 'N/D';
            if (!acc[usuario]) {
                acc[usuario] = { total: 0, ultima: item.timestamp || '' };
            }
            acc[usuario].total += 1;
            if (item.timestamp && (!acc[usuario].ultima || item.timestamp > acc[usuario].ultima)) {
                acc[usuario].ultima = item.timestamp;
            }
            return acc;
        }, {});
        const cards = Object.entries(porUsuario).map(([usuario, info]) => `
            <div class="card p-4">
                <div class="text-sm text-gray-500">Usuário</div>
                <div class="text-lg font-semibold text-gray-900">${usuario}</div>
                <div class="text-xs text-gray-600 mt-2">Ações: ${info.total}</div>
                <div class="text-xs text-gray-400">Última: ${info.ultima ? new Date(info.ultima).toLocaleString('pt-PT') : 'N/D'}</div>
            </div>
        `).join('');
        return `
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Resumo por utilizador</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${cards || '<div class="text-sm text-gray-500">Sem dados de auditoria.</div>'}
                </div>
            </div>
        `;
    })() : '';
    
    return `
        <div class="space-y-6">
            <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                <div>
                    <h2 class="text-2xl font-bold">Histórico de Alterações</h2>
                    <p class="text-sm text-gray-600">Quem mudou o quê, quando e em qual secção.</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button onclick="exportarAuditoria()" class="btn btn-secondary">
                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                        Exportar
                    </button>
                    <button onclick="limparAuditoria()" class="btn btn-danger">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        Limpar
                    </button>
                </div>
            </div>
            
            ${resumoAdmin}
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                        <input id="filtroHistoricoTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: cliente, contrato, prazo...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Usuário</label>
                        <select id="filtroHistoricoUsuario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todos</option>
                            ${usuarios.map(u => `<option value="${u}">${u}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo usuário</label>
                        <select id="filtroHistoricoTipoUsuario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todos</option>
                            ${tiposUsuario.map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ação</label>
                        <select id="filtroHistoricoAcao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todas</option>
                            ${acoes.map(a => `<option value="${a}">${a}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                        <select id="filtroHistoricoEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todas</option>
                            ${entidades.map(e => `<option value="${e}">${e}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                        <select id="filtroHistoricoPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todos</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="aplicarFiltrosHistorico()" class="btn btn-primary">
                            <i data-lucide="filter" class="w-4 h-4"></i>
                            Aplicar filtros
                        </button>
                        <button onclick="limparFiltrosHistorico()" class="btn btn-secondary">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="text-sm text-gray-600" id="historicoResumo"></div>
            <div id="listaHistoricoDetalhado" class="space-y-3"></div>
        </div>
    `;
}

function limparFiltrosHistorico() {
    const campos = [
        'filtroHistoricoTexto',
        'filtroHistoricoUsuario',
        'filtroHistoricoTipoUsuario',
        'filtroHistoricoAcao',
        'filtroHistoricoEntidade',
        'filtroHistoricoPeriodo'
    ];
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    aplicarFiltrosHistorico();
}

function aplicarFiltrosHistorico() {
    const auditoria = obterAuditoria();
    const texto = (document.getElementById('filtroHistoricoTexto')?.value || '').toLowerCase();
    const usuario = document.getElementById('filtroHistoricoUsuario')?.value || '';
    const tipoUsuario = document.getElementById('filtroHistoricoTipoUsuario')?.value || '';
    const acao = document.getElementById('filtroHistoricoAcao')?.value || '';
    const entidade = document.getElementById('filtroHistoricoEntidade')?.value || '';
    const periodo = document.getElementById('filtroHistoricoPeriodo')?.value || '';
    
    let filtrados = auditoria;
    if (usuario) filtrados = filtrados.filter(item => item.usuario === usuario);
    if (tipoUsuario) filtrados = filtrados.filter(item => item.tipoUsuario === tipoUsuario);
    if (acao) filtrados = filtrados.filter(item => item.acao === acao);
    if (entidade) filtrados = filtrados.filter(item => item.entidade === entidade);
    if (texto) {
        filtrados = filtrados.filter(item => {
            const alvo = [
                item.usuario,
                item.tipoUsuario,
                item.acao,
                item.entidade,
                item.descricao
            ].filter(Boolean).join(' ').toLowerCase();
            return alvo.includes(texto);
        });
    }
    if (periodo) {
        const agora = new Date();
        const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
        const inicioSemana = new Date(hoje);
        inicioSemana.setDate(hoje.getDate() - hoje.getDay());
        const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
        filtrados = filtrados.filter(item => {
            if (!item.timestamp) return false;
            const data = new Date(item.timestamp);
            if (periodo === 'hoje') return data >= hoje;
            if (periodo === 'semana') return data >= inicioSemana;
            if (periodo === 'mes') return data >= inicioMes;
            return true;
        });
    }
    
    renderizarHistoricoDetalhado(filtrados);
}

function renderizarHistoricoDetalhado(itens) {
    const resumo = document.getElementById('historicoResumo');
    const container = document.getElementById('listaHistoricoDetalhado');
    if (resumo) {
        resumo.textContent = `Registos: ${itens.length}`;
    }
    if (!container) return;
    if (itens.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">Nenhuma alteração encontrada.</div>';
        return;
    }
    
    container.innerHTML = itens.slice(0, 200).map(item => {
        const acaoDocumento = renderAcaoDocumentoHistorico(item);
        return `
            <div class="card p-4">
                <div class="flex flex-col gap-2 lg:flex-row lg:items-start lg:justify-between">
                    <div>
                        <div class="text-sm font-semibold text-gray-800">${(item.acao || '').toUpperCase()} ${item.entidade || ''}</div>
                        <div class="text-xs text-gray-600">${item.descricao || ''}</div>
                        <div class="text-xs text-gray-500">${item.timestamp ? new Date(item.timestamp).toLocaleString('pt-PT') : ''}</div>
                    </div>
                    <div class="text-xs text-gray-500">${item.usuario || 'N/D'} (${item.tipoUsuario || 'N/D'})</div>
                </div>
                ${acaoDocumento ? `<div class="mt-2">${acaoDocumento}</div>` : ''}
                <details class="mt-3">
                    <summary class="text-sm text-blue-600 cursor-pointer">Ver detalhes</summary>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                        <div>
                            <div class="text-xs font-semibold text-gray-600 mb-1">Antes</div>
                            ${formatarAuditoriaJson(item.dadosAntes)}
                        </div>
                        <div>
                            <div class="text-xs font-semibold text-gray-600 mb-1">Depois</div>
                            ${formatarAuditoriaJson(item.dadosDepois)}
                        </div>
                    </div>
                </details>
            </div>
        `;
    }).join('');
}

function registrarErro(contexto, erro, detalhe = null) {
    try {
        const erros = JSON.parse(appStorage.getItem('errosSistema') || '[]');
        erros.unshift({
            id: gerarIdImutavel(),
            timestamp: new Date().toISOString(),
            contexto,
            mensagem: erro?.message || String(erro),
            detalhe
        });
        appStorage.setItem('errosSistema', JSON.stringify(erros.slice(0, 200)));
    } catch (error) {
        console.error('❌ Erro ao registrar erro do sistema:', error);
    }
}

function configurarMonitorizacaoErros() {
    window.addEventListener('error', (event) => {
        registrarErro('window.onerror', event.error || event.message, {
            arquivo: event.filename,
            linha: event.lineno,
            coluna: event.colno
        });
    });
    window.addEventListener('unhandledrejection', (event) => {
        registrarErro('unhandledrejection', event.reason);
    });
}

// === VALIDAÇÕES ===
function validarEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

function normalizarTelefone(telefone) {
    return telefone.replace(/[\s-]/g, '').trim();
}

function validarTelefone(telefone) {
    const limpo = normalizarTelefone(telefone);
    return /^[0-9]{9,15}$/.test(limpo);
}

function validarNIF(nif) {
    const limpo = (nif || '').replace(/\D/g, '');
    if (!/^\d{9}$/.test(limpo)) return false;
    const prefixosValidos = ['1', '2', '3', '5', '6', '8', '9'];
    if (!prefixosValidos.includes(limpo[0])) return false;
    const soma = limpo
        .split('')
        .slice(0, 8)
        .reduce((acc, digito, idx) => acc + parseInt(digito, 10) * (9 - idx), 0);
    const resto = soma % 11;
    const digitoControle = resto < 2 ? 0 : 11 - resto;
    return digitoControle === parseInt(limpo[8], 10);
}

function configurarEventos() {
    document.getElementById('menuHamburguer')?.addEventListener('click', () => {
        toggleSidebar();
    });

    // Botão Voltar ao topo: mostrar ao rolar, esconder no topo
    const btnVoltarTopo = document.getElementById('btnVoltarTopo');
    if (btnVoltarTopo) {
        const limiar = 300;
        const atualizarVisibilidade = () => {
            const visivel = window.scrollY > limiar;
            btnVoltarTopo.classList.toggle('opacity-0', !visivel);
            btnVoltarTopo.classList.toggle('pointer-events-none', !visivel);
        };
        window.addEventListener('scroll', atualizarVisibilidade, { passive: true });
        atualizarVisibilidade();
        btnVoltarTopo.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // Atalho N: novo cliente (quando na secção clientes e não está a escrever num campo)
    document.addEventListener('keydown', (e) => {
        if (e.key !== 'n' && e.key !== 'N') return;
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || (e.target && e.target.isContentEditable)) return;
        if (typeof secaoAtiva !== 'string' || secaoAtiva !== 'clientes') return;
        if (appStorage.getItem('tipoUsuario') === 'convidado') return;
        e.preventDefault();
        if (typeof abrirModal === 'function') abrirModal('cliente');
    });

    // Delegation: botões Editar/Concluir/Excluir de tarefas
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-tarefa-acao][data-tarefa-id]');
        if (!btn || btn.disabled) return;
        const id = btn.getAttribute('data-tarefa-id');
        const acao = btn.getAttribute('data-tarefa-acao');
        if (!id || !acao) return;
        e.preventDefault();
        e.stopPropagation();
        try {
            if (acao === 'editar') abrirModalEditarTarefa(id);
            else if (acao === 'alterar-status') alterarStatusTarefa(id);
            else if (acao === 'excluir') excluirTarefa(id);
            else if (acao === 'concluir') concluirTarefaConvidado(id);
        } catch (err) {
            console.error('Erro ao executar acao tarefa:', acao, err);
            mostrarNotificacao('Erro ao executar. Veja a consola (F12).', 'error');
        }
    }, true);

    // Delegation: botões Editar/Excluir de clientes (evita problemas com UUID em onclick)
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-cliente-acao][data-cliente-id]');
        if (!btn) return;
        const id = btn.getAttribute('data-cliente-id');
        const acao = btn.getAttribute('data-cliente-acao');
        if (!id || !acao) return;
        e.preventDefault();
        e.stopPropagation();
        try {
            if (acao === 'editar') editarClienteDireto(id);
            else if (acao === 'excluir') excluirItem('cliente', id);
            else if (acao === 'duplicar') duplicarCliente(id);
        } catch (err) {
            console.error('Erro ao executar acao cliente:', acao, err);
            mostrarNotificacao('Erro ao executar. Veja a consola (F12).', 'error');
        }
    }, true);

    // Delegation: botão copiar (email, telefone, etc.)
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-copiar]');
        if (!btn) return;
        const valor = btn.getAttribute('data-copiar');
        if (!valor) return;
        e.preventDefault();
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(valor).then(() => {
                if (typeof mostrarNotificacao === 'function') mostrarNotificacao('Copiado para a área de transferência', 'success');
            }).catch(() => {});
        }
    }, true);

    const syncBadge = document.getElementById('syncStatusBadge');
    if (syncBadge) {
        syncBadge.addEventListener('click', () => {
            const status = syncBadge.getAttribute('data-status');
            if (status === 'error' || status === 'offline') {
                if (typeof forcarSincronizacaoNuvem === 'function') forcarSincronizacaoNuvem();
            }
        });
        syncBadge.addEventListener('keydown', (e) => {
            if ((e.key === 'Enter' || e.key === ' ') && (syncBadge.getAttribute('data-status') === 'error' || syncBadge.getAttribute('data-status') === 'offline')) {
                e.preventDefault();
                if (typeof forcarSincronizacaoNuvem === 'function') forcarSincronizacaoNuvem();
            }
        });
        // Atualizar "há X min" no badge a cada minuto
        setInterval(() => {
            if (syncBadge.getAttribute('data-status') === 'ok' && syncBadge.querySelector('.sync-text')) {
                syncBadge.querySelector('.sync-text').textContent = obterTextoUltimaSincronizacao();
            }
        }, 60000);
    }

    document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('open')) {
            toggleSidebar();
        }
    });

    function mostrarAtalhosTeclado() {
        const msg = 'Atalhos: Esc = fechar modal · Ctrl+S = guardar formulário · Ctrl+K = pesquisa global';
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao(msg, 'info');
        } else {
            alert(msg);
        }
    }
    window.mostrarAtalhosTeclado = mostrarAtalhosTeclado;

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (typeof fecharModalRobusto === 'function') fecharModalRobusto();
            else if (typeof fecharModal === 'function') fecharModal();
            return;
        }
        // Ctrl+S ou Cmd+S: guardar formulário em foco
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            const form = document.activeElement?.closest('form');
            if (form) {
                const btn = form.querySelector('button[type="submit"]');
                if (btn && !btn.disabled) {
                    btn.click();
                    if (typeof mostrarNotificacao === 'function') mostrarNotificacao('A guardar...', 'info');
                }
            }
            return;
        }
        // Ctrl+K ou Cmd+K: focar pesquisa global
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            const searchInput = document.getElementById('globalSearchInput');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
            return;
        }
        // Ctrl+N ou Cmd+N: criar novo item na secção ativa (evitar quando em input/textarea)
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            const tag = (document.activeElement?.tagName || '').toUpperCase();
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(tag)) return;
            e.preventDefault();
            const sec = typeof secaoAtiva === 'string' ? secaoAtiva : '';
            const acoes = {
                clientes: () => { if (typeof abrirModal === 'function') abrirModal('cliente'); },
                honorarios: () => { if (typeof abrirModal === 'function') abrirModal('honorario'); },
                contratos: () => { if (typeof abrirModal === 'function') abrirModal('contrato'); },
                herancas: () => { if (typeof abrirModal === 'function') abrirModal('heranca'); },
                migracoes: () => { if (typeof abrirModal === 'function') abrirModal('migracao'); },
                registos: () => { if (typeof abrirModal === 'function') abrirModal('registo'); },
                prazos: () => { if (typeof abrirModal === 'function') abrirModal('prazo'); },
                tarefas: () => { if (typeof criarTarefa === 'function') criarTarefa(); }
            };
            if (acoes[sec]) acoes[sec]();
            return;
        }
        // ? (Shift+/) ou F1: mostrar atalhos disponíveis
        if (e.key === '?' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            mostrarAtalhosTeclado();
        }
    });

    // Acessibilidade: role e aria nos modais
    const mc = document.getElementById('modalContainer');
    if (mc) {
        mc.setAttribute('aria-hidden', 'true');
        const observer = new MutationObserver(() => {
            if (mc.classList.contains('show') && mc.children.length > 0) {
                mc.setAttribute('role', 'dialog');
                mc.setAttribute('aria-modal', 'true');
                mc.setAttribute('aria-hidden', 'false');
            } else {
                mc.setAttribute('aria-hidden', 'true');
            }
        });
        observer.observe(mc, { attributes: true, attributeFilter: ['class'], childList: true });
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    const menuHamburguer = document.getElementById('menuHamburguer');
    if (sidebar) {
        const aberto = sidebar.classList.toggle('open');
        document.body.classList.toggle('sidebar-open', aberto);
        if (overlay) overlay.classList.toggle('active', aberto);
        if (menuBtn) menuBtn.setAttribute('aria-expanded', aberto ? 'true' : 'false');
        if (menuHamburguer) menuHamburguer.setAttribute('aria-expanded', aberto ? 'true' : 'false');
        if (aberto && menuBtn && typeof menuBtn.focus === 'function') try { menuBtn.focus(); } catch (e) {}
    }
}

function carregarSecao(secao) {
    
    // Verificar se é convidado e redirecionar para clientes se necessário
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario === 'convidado') {
        const secoesPermitidas = [
            'dashboard',
            'clientes',
            'honorarios',
            'pagamentos',
            'contratos',
            'herancas',
            'migracoes',
            'registos',
            'prazos',
            'tarefas',
            'calendario',
            'documentos'
        ];
        if (!secoesPermitidas.includes(secao)) {
            secao = 'dashboard'; // Redirecionar para visão geral
        }
    }
    
    // Fechar qualquer modal aberto antes de carregar nova seção
    if (typeof fecharModalRobusto === 'function') fecharModalRobusto();
    else if (typeof fecharModal === 'function') fecharModal();
    
    // Mostrar loader em secções pesadas
    const secoesComLoader = ['dashboard', 'clientes', 'honorarios', 'contratos', 'relatorios', 'tarefas', 'documentos', 'integracoes', 'migracoes', 'herancas', 'registos', 'prazos'];
    const mensagensLoader = {
        dashboard: 'A preparar visão geral',
        clientes: 'A preparar lista de clientes',
        honorarios: 'A preparar honorários',
        contratos: 'A preparar contratos',
        relatorios: 'A preparar relatórios',
        tarefas: 'A preparar tarefas',
        documentos: 'A preparar documentos',
        integracoes: 'A preparar integrações externas',
        migracoes: 'A preparar migrações',
        herancas: 'A preparar heranças',
        registos: 'A preparar registos',
        prazos: 'A preparar prazos'
    };
    const conteudoElement = document.getElementById('conteudoDinamico');
    if (conteudoElement && secoesComLoader.includes(secao)) {
        conteudoElement.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 text-gray-500">
                <i data-lucide="loader" class="w-12 h-12 animate-spin mb-4 text-blue-600"></i>
                <p class="text-lg font-medium">A carregar...</p>
                <p class="text-sm mt-1">${mensagensLoader[secao] || 'Por favor aguarde'}</p>
            </div>`;
        if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    }
    
    // Reset limites de paginação ao entrar na secção
    if (secao === 'clientes') window.__clientesLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'honorarios') window.__honorariosLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'contratos') window.__contratosLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'tarefas') window.__tarefasLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'prazos') window.__prazosLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'herancas') window.__herancasLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'migracoes') window.__migracoesLimit = LISTA_PAGINA_TAMANHO;
    if (secao === 'registos') window.__registosLimit = LISTA_PAGINA_TAMANHO;
    // Ordenação: manter estado (não resetar) para não confundir o utilizador
    
    // Recarregar dados em memória antes de gerar conteúdo
    carregarDados();
    
    secaoAtiva = secao;
    atualizarNavegacao();
    atualizarTitulo(secao);
    
    const conteudoEl = document.getElementById('conteudoDinamico');
    const carregarConteudo = () => {
        const conteudo = gerarConteudoSecao(secao);
        if (conteudoEl) {
            conteudoEl.innerHTML = conteudo;
            removerBotoesAnexos();
        } else {
            console.error('❌ Elemento conteudoDinamico não encontrado');
        }
        inicializarSecao(secao);
    
    // Inicializar filtros para seções específicas
    if (secao === 'clientes') {
        setTimeout(() => { restaurarFiltrosClientes(); aplicarFiltrosClientes(); }, 100);
    }
    if (secao === 'migracoes') {
        setTimeout(() => {
            aplicarFiltrosMigracoes();
        }, 100);
    }
    
    if (secao === 'contratos') {
        setTimeout(() => { restaurarFiltrosContratos(); aplicarFiltrosContratos(); }, 100);
    }
    
    if (secao === 'honorarios') {
        setTimeout(() => { restaurarFiltrosHonorarios(); aplicarFiltrosHonorarios(); }, 100);
    }
    
    if (secao === 'prazos') {
        setTimeout(() => {
            aplicarFiltrosPrazos();
            lucide.createIcons();
        }, 100);
    }
    
    if (secao === 'tarefas') {
        setTimeout(() => {
            aplicarFiltrosTarefas();
        }, 100);
    }
    
    if (secao === 'calendario') {
        setTimeout(() => {
            inicializarCalendarioPrazos();
        }, 100);
    }
    
    if (secao === 'herancas') {
        setTimeout(() => {
            if (typeof aplicarFiltrosHerancas === 'function') aplicarFiltrosHerancas();
        }, 100);
    }
    
    if (secao === 'registos') {
        setTimeout(() => {
            if (typeof aplicarFiltrosRegistos === 'function') aplicarFiltrosRegistos();
        }, 100);
    }
    if (secao === 'integracoes') {
        setTimeout(() => {
            if (typeof aplicarFiltrosIntegracoes === 'function') aplicarFiltrosIntegracoes();
        }, 100);
    }
    
    // Sem execução de testes automáticos para heranças/registos
    
    // Só tentar fechar sidebar se estiver no sistema principal
    if (window.innerWidth <= 1024 && document.getElementById('sidebar')) {
        toggleSidebar();
    }
    
    // Criar gráficos avançados se for a seção dashboard
    if (secao === 'dashboard') {
        setTimeout(() => {
            criarGraficosAvancados();
        }, 500);
    }
    };
    requestAnimationFrame(carregarConteudo);
}

function atualizarNavegacao() {
    const secaoParaNav = { migracoes: 'nav-migracao' };
    const navId = secaoParaNav[secaoAtiva] || `nav-${secaoAtiva}`;
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    if (sidebarItems.length > 0) {
        sidebarItems.forEach(item => {
            item.classList.remove('active');
            item.removeAttribute('aria-current');
        });
        const activeItem = document.getElementById(navId);
        if (activeItem) {
            activeItem.classList.add('active');
            activeItem.setAttribute('aria-current', 'page');
        }
    }
}

function atualizarTitulo(secao) {
    const titulos = {
        dashboard: 'Visão Geral',
        clientes: 'Gestão de Clientes',
        honorarios: 'Gestão de Honorários',
        pagamentos: 'Registo de Pagamentos',
        despesas: 'Gestão de Despesas',
        contratos: 'Gestão de Contratos',
        prazos: 'Gestão de Prazos',
        herancas: 'Gestão de Heranças',
        migracoes: 'Gestão de Migração',
        registos: 'Gestão de Registos',
        documentos: 'Minutas',
        integracoes: 'Integrações Externas',
        tarefas: 'Sistema de Tarefas',
        calendario: 'Calendário de Prazos',
        relatorios: 'Gestão de Relatórios',
        backup: 'Sistema de Backup',
        historico: 'Histórico de Alterações',
    };
    
    const tituloElement = document.getElementById('tituloSecao');
    const subtituloElement = document.getElementById('subtituloSecao');
    const pageTitleElement = document.getElementById('pageTitle');
    const titulo = titulos[secao] || 'Sistema Legal';
    
    if (tituloElement) tituloElement.textContent = titulo;
    if (subtituloElement) {
        subtituloElement.textContent = 'Visão geral do sistema';
    }
    if (pageTitleElement) pageTitleElement.textContent = titulo;
}

function gerarConteudoSecao(secao) {
    if (!migracoes) migracoes = [];
    
    try {
    const conteudos = {
        dashboard: gerarDashboard(),
        clientes: gerarClientes(),
        honorarios: gerarHonorarios(),
        pagamentos: gerarPagamentos(),
        despesas: gerarDespesas(),
        contratos: gerarContratos(),
        prazos: gerarPrazos(),
        herancas: gerarHerancas(),
        convidados: gerarConvidados(),
        migracoes: gerarMigracao(),
        registos: gerarRegistos(),
        documentos: gerarDocumentos(),
        integracoes: gerarIntegracoes(),
        tarefas: gerarTarefas(),
        calendario: gerarCalendarioPrazos(),
        notificacoes: gerarNotificacoes(),
        relatorios: gerarRelatorios(),
        backup: gerarBackup(),
        historico: gerarHistoricoDetalhado(),
    };
    
    return conteudos[secao] || '<p>Seção não encontrada</p>';
    } catch (error) {
        console.error('❌ Erro ao gerar conteúdo da seção:', secao, error);
        return `
            <div class="p-6 bg-red-50 border border-red-200 rounded-lg text-red-700">
                Ocorreu um erro ao carregar esta seção. Atualize a página (Ctrl+F5).
            </div>
        `;
    }
}

function gerarRelatorioCompleto() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    let clientesParaMostrar = clientes;
    let honorariosParaMostrar = honorarios;
    let herancasParaMostrar = herancas;
    let migracoesParaMostrar = migracoes;
    let registosParaMostrar = registos;
    let contratosParaMostrar = contratos;
    let prazosParaMostrar = obterPrazosAtual();
    
    // Filtrar dados para convidados
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        
        if (convidado && convidado.ativo) {
            const idsVisiveis = obterIdsClientesVisiveisParaConvidado(convidado);
            clientesParaMostrar = clientes.filter(c => idsVisiveis.includes(String(c.id)));
            honorariosParaMostrar = honorarios.filter(h => idsVisiveis.includes(String(h.clienteId)));
            herancasParaMostrar = herancas.filter(h => idsVisiveis.includes(String(h.clienteId)));
            migracoesParaMostrar = migracoes.filter(m => idsVisiveis.includes(String(m.clienteId)));
            registosParaMostrar = registos.filter(r => idsVisiveis.includes(String(r.clienteId)));
            contratosParaMostrar = contratos.filter(c => idsVisiveis.includes(String(c.clienteId)));
            prazosParaMostrar = prazos.filter(p => idsVisiveis.includes(String(p.clienteId)));
        } else {
            clientesParaMostrar = [];
            honorariosParaMostrar = [];
            herancasParaMostrar = [];
            migracoesParaMostrar = [];
            registosParaMostrar = [];
            contratosParaMostrar = [];
            prazosParaMostrar = [];
        }
    }
    
    const valorTotalHonorarios = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    const valorTotalHerancas = herancasParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    const valorTotalMigracoes = migracoesParaMostrar.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0);
    const valorTotalRegistos = registosParaMostrar.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
    const valorTotalContratos = contratosParaMostrar.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0);
    const valorTotalGeral = valorTotalHonorarios + valorTotalHerancas + valorTotalMigracoes + valorTotalRegistos + valorTotalContratos;
    
    const relatorio = `
RELATÓRIO COMPLETO - SISTEMA LEGAL
Data: ${new Date().toLocaleDateString('pt-PT')} ${new Date().toLocaleTimeString('pt-PT')}

=== RESUMO GERAL ===
Total de Clientes: ${clientesParaMostrar.length}
Total de Honorários: ${honorariosParaMostrar.length}
Total de Heranças: ${herancasParaMostrar.length}
Total de Migrações: ${migracoesParaMostrar.length}
Total de Registos: ${registosParaMostrar.length}
Total de Contratos: ${contratosParaMostrar.length}

=== RESUMO FINANCEIRO ===
Valor Total Honorários: €${(Math.round(valorTotalHonorarios * 100) / 100).toFixed(2)}
Valor Total Heranças: €${(Math.round(valorTotalHerancas * 100) / 100).toFixed(2)}
Valor Total Migrações: €${(Math.round(valorTotalMigracoes * 100) / 100).toFixed(2)}
Valor Total Registos: €${(Math.round(valorTotalRegistos * 100) / 100).toFixed(2)}
Valor Total Contratos: €${(Math.round(valorTotalContratos * 100) / 100).toFixed(2)}
VALOR TOTAL GERAL: €${(Math.round(valorTotalGeral * 100) / 100).toFixed(2)}

=== STATUS DOS HONORÁRIOS ===
Pagos: ${honorariosParaMostrar.filter(h => h.status === 'pago').length}
Pendentes: ${honorariosParaMostrar.filter(h => isHonorarioEmAberto(h)).length}
Vencidos: ${honorariosParaMostrar.filter(h => {
        if (!h.vencimento) return false;
        const dataVencimento = new Date(h.vencimento);
        const hoje = new Date();
        return dataVencimento < hoje && isHonorarioEmAberto(h);
    }).length}

=== PRAZOS PRÓXIMOS (7 dias) ===
${prazos.filter(p => {
        if (!p.dataLimite) return false;
        const dataLimite = new Date(p.dataLimite);
        const hoje = new Date();
        const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
        return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
    }).map(p => `- ${p.descricao} (${p.clienteNome}) - ${p.tipo} - ${Math.ceil((new Date(p.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias`).join('\n') || 'Nenhum prazo próximo'}

=== TOP 5 CLIENTES POR VALOR ===
${clientesParaMostrar.map(cliente => {
        const valorCliente = honorariosParaMostrar
            .filter(h => h.clienteId === cliente.id)
            .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
        return { ...cliente, valorTotal: valorCliente };
    }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => 
        `${index + 1}. ${cliente.nome} - €${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}`
    ).join('\n')}

=== RELATÓRIO GERADO AUTOMATICAMENTE ===
Sistema Legal - ANA PAULA MEDINA
    `;
    
    textoParaPdf('Relatório Completo', relatorio, 'baixar', `relatorio_completo_${new Date().toISOString().split('T')[0]}.pdf`);
}

/** Abre o relatório completo em janela imprimível (utilizador pode "Guardar como PDF" no diálogo de impressão). */
function imprimirRelatorioCompletoComoPdf() {
    const janela = window.open('', '_blank');
    if (!janela) {
        mostrarNotificacao('Permita abrir a janela para imprimir ou guardar como PDF.', 'warning');
        return;
    }
    const conteudo = document.getElementById('relatorioCompletoParaImpressao');
    if (conteudo) {
        janela.document.write(conteudo.innerHTML);
    } else {
        carregarSecao('relatorios');
        const dados = obterDadosRelatorioCompleto();
        if (!dados) return;
        const html = gerarHtmlRelatorioCompleto(dados);
        janela.document.write(html);
    }
    janela.document.close();
    setTimeout(() => { janela.focus(); janela.print(); }, 250);
}
function obterDadosRelatorioCompleto() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    let clientesParaMostrar = obterClientesAtual();
    let honorariosParaMostrar = obterHonorariosAtual();
    let herancasParaMostrar = obterHerancasAtual();
    let migracoesParaMostrar = obterMigracoesAtual();
    let registosParaMostrar = obterRegistosAtual();
    let contratosParaMostrar = obterContratosAtual();
    let prazosParaMostrar = obterPrazosAtual();
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidadosAtual();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        if (!convidado || !convidado.ativo) return null;
        const idsVisiveis = obterIdsClientesVisiveisParaConvidado(convidado);
        clientesParaMostrar = clientesParaMostrar.filter(c => idsVisiveis.includes(String(c.id)));
        honorariosParaMostrar = honorariosParaMostrar.filter(h => idsVisiveis.includes(String(h.clienteId)));
        herancasParaMostrar = herancasParaMostrar.filter(h => idsVisiveis.includes(String(h.clienteId)));
        migracoesParaMostrar = migracoesParaMostrar.filter(m => idsVisiveis.includes(String(m.clienteId)));
        registosParaMostrar = registosParaMostrar.filter(r => idsVisiveis.includes(String(r.clienteId)));
        contratosParaMostrar = contratosParaMostrar.filter(c => idsVisiveis.includes(String(c.clienteId)));
        prazosParaMostrar = prazosParaMostrar.filter(p => idsVisiveis.includes(String(p.clienteId)));
    }
    const valorTotalH = honorariosParaMostrar.reduce((s, h) => s + (parseFloat(h.valor) || 0), 0);
    const valorTotalHer = herancasParaMostrar.reduce((s, h) => s + (parseFloat(h.valor) || 0), 0);
    const valorTotalMig = migracoesParaMostrar.reduce((s, m) => s + (parseFloat(m.valor) || 0), 0);
    const valorTotalReg = registosParaMostrar.reduce((s, r) => s + (parseFloat(r.valor) || 0), 0);
    const valorTotalCont = contratosParaMostrar.reduce((s, c) => s + (parseFloat(c.valor) || 0), 0);
    const prazosProximos = prazosParaMostrar.filter(p => {
        if (!p.dataLimite) return false;
        const d = new Date(p.dataLimite);
        const h = new Date();
        const dias = Math.ceil((d - h) / (1000 * 60 * 60 * 24));
        return dias <= 7 && dias >= 0 && p.status === 'ativo';
    });
    const top5 = clientesParaMostrar.map(c => ({
        ...c,
        valorTotal: honorariosParaMostrar.filter(h => String(h.clienteId) === String(c.id)).reduce((s, h) => s + (parseFloat(h.valor) || 0), 0)
    })).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5);
    return { clientesParaMostrar, honorariosParaMostrar, valorTotalH, valorTotalHer, valorTotalMig, valorTotalReg, valorTotalCont, prazosProximos, top5 };
}
function gerarHtmlRelatorioCompleto(d) {
    const total = d.valorTotalH + d.valorTotalHer + d.valorTotalMig + d.valorTotalReg + d.valorTotalCont;
    const dataStr = new Date().toLocaleString('pt-PT');
    const prazosHtml = d.prazosProximos.map(p => {
        const dias = Math.ceil((new Date(p.dataLimite) - new Date()) / (1000 * 60 * 60 * 24));
        return `<li>${p.descricao} (${p.clienteNome}) - ${p.tipo} - ${dias} dias</li>`;
    }).join('') || '<li>Nenhum prazo próximo</li>';
    const top5Html = d.top5.map((c, i) => `<li>${i + 1}. ${c.nome} - €${(Math.round(c.valorTotal * 100) / 100).toFixed(2)}</li>`).join('');
    return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relatório Completo</title><style>body{font-family:Arial,sans-serif;margin:24px;color:#111}.h1{font-size:20px;margin-bottom:8px}h2{font-size:14px;margin-top:20px;margin-bottom:8px}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #e5e7eb;padding:6px}th{background:#f3f4f6}ul{margin:4px 0;padding-left:20px}</style></head><body>
<h1 class="h1">RELATÓRIO COMPLETO - SISTEMA LEGAL</h1>
<p>Data: ${dataStr}</p>
<h2>Resumo Geral</h2>
<p>Clientes: ${d.clientesParaMostrar.length} | Honorários: ${d.honorariosParaMostrar.length} | Heranças: ${d.clientesParaMostrar.length} | Migrações: ${d.clientesParaMostrar.length} | Registos: ${d.clientesParaMostrar.length} | Contratos: ${d.clientesParaMostrar.length}</p>
<h2>Resumo Financeiro</h2>
<p>Honorários: €${d.valorTotalH.toFixed(2)} | Heranças: €${d.valorTotalHer.toFixed(2)} | Migrações: €${d.valorTotalMig.toFixed(2)} | Registos: €${d.valorTotalReg.toFixed(2)} | Contratos: €${d.valorTotalCont.toFixed(2)}</p>
<p><strong>VALOR TOTAL: €${total.toFixed(2)}</strong></p>
<h2>Prazos Próximos (7 dias)</h2><ul>${prazosHtml}</ul>
<h2>Top 5 Clientes por Valor</h2><ul>${top5Html}</ul>
<p><em>Sistema Legal - Relatório gerado automaticamente</em></p>
</body></html>`;
}

/** Converte texto em PDF (download ou imprimir). Usado para todos os relatórios. */
async function textoParaPdf(titulo, texto, acao, nomeFicheiro) {
    try {
        const jsPDF = (window.jspdf && window.jspdf.jsPDF) || (window.jspdf && window.jspdf.default) || window.jsPDF;
        if (!jsPDF) {
            mostrarNotificacao('Biblioteca PDF não carregada. Faça Ctrl+F5 para recarregar.', 'error');
            return;
        }
        const doc = new jsPDF({ format: 'a4', unit: 'mm' });
        const margin = 15;
        let y = await adicionarLogoAoPdf(doc, margin);
        doc.setFont('times', 'normal');
        doc.setFontSize(11);
        const pageWidth = doc.internal.pageSize.getWidth();
        const maxWidth = pageWidth - margin * 2;
        const lineHeight = 6;
        const textoComRodape = (texto || '') + '\n' + (typeof obterRodapeDocumento === 'function' ? obterRodapeDocumento() : '');
        const blocos = textoComRodape.split('\n');
        blocos.forEach(bloco => {
            const linhas = doc.splitTextToSize(bloco || ' ', maxWidth);
            linhas.forEach(linha => {
                if (y > 280) { doc.addPage(); y = margin; }
                doc.text(linha, margin, y);
                y += lineHeight;
            });
        });
        const nome = nomeFicheiro || `${(titulo || 'relatorio').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        if (acao === 'baixar') {
            doc.save(nome);
            mostrarNotificacao('Relatório PDF gerado com sucesso!', 'success');
        } else if (acao === 'imprimir') {
            const blob = doc.output('blob');
            const url = URL.createObjectURL(blob);
            const janela = window.open(url, '_blank');
            if (janela) {
                janela.addEventListener('load', () => setTimeout(() => { janela.print(); URL.revokeObjectURL(url); }, 500));
            } else {
                doc.save(nome);
                URL.revokeObjectURL(url);
            }
        }
    } catch (e) {
        console.error('Erro ao gerar PDF:', e);
        mostrarNotificacao('Erro ao gerar PDF. Verifique a consola.', 'error');
    }
}

/** Abre relatório em texto numa janela imprimível (utilizador pode "Guardar como PDF" no diálogo de impressão). */
function abrirRelatorioTextoComoPdf(titulo, relatorioTexto) {
    const janela = window.open('', '_blank');
    if (!janela) {
        mostrarNotificacao('Permita abrir a janela para imprimir ou guardar como PDF.', 'warning');
        return;
    }
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${escaparHtml(titulo)}</title><style>body{font-family:Arial,sans-serif;margin:24px;color:#111;font-size:12px}pre{white-space:pre-wrap;word-wrap:break-word}</style></head><body><h1>${escaparHtml(titulo)}</h1><pre>${escaparHtml(relatorioTexto)}</pre></body></html>`;
    janela.document.write(html);
    janela.document.close();
    setTimeout(() => { janela.focus(); janela.print(); }, 250);
}

// NOVA FUNÇÃO: Relatório personalizado por cliente
function gerarRelatorioCliente() {
    
    // Verificar se já existe um modal aberto
    const modalExistente = document.querySelector('.modal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Verificar se há clientes
    if (!clientes || clientes.length === 0) {
        mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
        return;
    }
    
    
    // Criar modal para seleção de cliente
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 99999 !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    modal.innerHTML = `
        <div class="modal-content" style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e5e7eb;
            ">
                <h3 style="margin: 0; color: #1f2937;">📊 Relatório Personalizado por Cliente</h3>
                <button class="close-btn" onclick="fecharModalRobusto()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #6b7280;
                ">&times;</button>
            </div>
            <div class="modal-body" style="margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="clienteSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                    <select id="clienteSelecionado" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="">-- Escolha um cliente --</option>
                        ${clientes.map(cliente => 
                            `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="tipoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório:</label>
                    <select id="tipoRelatorio" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="completo">Relatório Completo</option>
                        <option value="honorarios">Apenas Honorários</option>
                        <option value="contratos">Apenas Contratos</option>
                        <option value="herancas">Apenas Heranças</option>
                        <option value="migracoes">Apenas Migrações</option>
                        <option value="registos">Apenas Registos</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="periodoRelatorio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                    <select id="periodoRelatorio" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="todos">Todos os dados</option>
                        <option value="mes">Último mês</option>
                        <option value="trimestre">Último trimestre</option>
                        <option value="ano">Último ano</option>
                        <option value="personalizado">Período personalizado</option>
                    </select>
                </div>
                <div id="periodoPersonalizado" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label for="dataInicio" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                    <input type="date" id="dataInicio" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        margin-bottom: 10px;
                    ">
                    <label for="dataFim" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                    <input type="date" id="dataFim" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            </div>
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
            ">
                <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                ">Cancelar</button>
                <button class="btn btn-secondary" onclick="gerarRelatorioClienteSelecionado(false)" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    PDF
                </button>
                <button class="btn btn-primary" onclick="gerarRelatorioClienteSelecionado(true)" style="
                    padding: 8px 16px;
                    background-color: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    PDF / Imprimir
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Verificar se o modal foi criado corretamente
    setTimeout(() => {
        const modalTeste = document.querySelector('.modal');
        if (modalTeste) {
            // Forçar visibilidade do modal
            modalTeste.style.display = 'flex';
            modalTeste.style.visibility = 'visible';
            modalTeste.style.opacity = '1';
        } else {
        }
    }, 100);
    
    // Event listener para período personalizado
    setTimeout(() => {
        const periodoSelect = document.getElementById('periodoRelatorio');
        if (periodoSelect) {
            periodoSelect.addEventListener('change', function() {
                const periodoPersonalizado = document.getElementById('periodoPersonalizado');
                if (this.value === 'personalizado') {
                    periodoPersonalizado.style.display = 'block';
                } else {
                    periodoPersonalizado.style.display = 'none';
                }
            });
        } else {
        }
    }, 100);
}

function gerarRelatorioClienteSelecionado(exportarComoPdf) {
    
    const clienteSelecionado = document.getElementById('clienteSelecionado').value;
    const tipoRelatorio = document.getElementById('tipoRelatorio').value;
    const periodoRelatorio = document.getElementById('periodoRelatorio').value;
    
    
    if (!clienteSelecionado) {
        mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
        return;
    }
    
    
    // Filtrar dados por cliente
    const dadosCliente = {
        honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
        contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
        herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
        migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
        registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
    };
    
    // Aplicar filtro de período se necessário
    if (periodoRelatorio !== 'todos') {
        const agora = new Date();
        let dataLimite = new Date();
        
        switch (periodoRelatorio) {
            case 'mes':
                dataLimite.setMonth(agora.getMonth() - 1);
                break;
            case 'trimestre':
                dataLimite.setMonth(agora.getMonth() - 3);
                break;
            case 'ano':
                dataLimite.setFullYear(agora.getFullYear() - 1);
                break;
            case 'personalizado':
                const dataInicio = document.getElementById('dataInicio').value;
                const dataFim = document.getElementById('dataFim').value;
                if (!dataInicio || !dataFim) {
                    mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                    return;
                }
                // Aplicar filtro personalizado
                Object.keys(dadosCliente).forEach(tipo => {
                    dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                        const dataItem = new Date(item.data);
                        return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                    });
                });
                break;
        }
        
        if (periodoRelatorio !== 'personalizado') {
            Object.keys(dadosCliente).forEach(tipo => {
                dadosCliente[tipo] = dadosCliente[tipo].filter(item => {
                    const dataItem = new Date(item.data);
                    return dataItem >= dataLimite;
                });
            });
        }
    }
    
    // Gerar relatório
    let relatorio = `RELATÓRIO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
    relatorio += '==========================================\n\n';
    relatorio += `Cliente: ${clienteSelecionado}\n`;
    relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
    relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
    relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
    relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
    
    // Adicionar seções baseadas no tipo de relatório
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
        relatorio += 'HONORÁRIOS:\n';
        relatorio += '-----------\n';
        if (dadosCliente.honorarios.length > 0) {
            let totalHonorarios = 0;
            dadosCliente.honorarios.forEach((honorario, index) => {
                relatorio += `${index + 1}. ${honorario.descricao}\n`;
                relatorio += `   Valor: €${honorario.valor}\n`;
                relatorio += `   Status: ${formatarStatusHonorario(honorario.status)}\n`;
                relatorio += `   Data: ${honorario.data}\n\n`;
                totalHonorarios += parseFloat(honorario.valor) || 0;
            });
            relatorio += `TOTAL HONORÁRIOS: €${totalHonorarios.toFixed(2)}\n\n`;
        } else {
            relatorio += 'Nenhum honorário encontrado.\n\n';
        }
    }
    
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
        relatorio += 'CONTRATOS:\n';
        relatorio += '----------\n';
        if (dadosCliente.contratos.length > 0) {
            dadosCliente.contratos.forEach((contrato, index) => {
                relatorio += `${index + 1}. ${contrato.tipo}\n`;
                relatorio += `   Valor: €${contrato.valor}\n`;
                relatorio += `   Status: ${contrato.status}\n`;
                relatorio += `   Data: ${contrato.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhum contrato encontrado.\n\n';
        }
    }
    
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
        relatorio += 'HERANÇAS:\n';
        relatorio += '---------\n';
        if (dadosCliente.herancas.length > 0) {
            dadosCliente.herancas.forEach((heranca, index) => {
                relatorio += `${index + 1}. ${heranca.tipo}\n`;
                relatorio += `   Valor: €${heranca.valor}\n`;
                relatorio += `   Status: ${heranca.status}\n`;
                relatorio += `   Data: ${heranca.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhuma herança encontrada.\n\n';
        }
    }
    
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
        relatorio += 'MIGRAÇÕES:\n';
        relatorio += '----------\n';
        if (dadosCliente.migracoes.length > 0) {
            dadosCliente.migracoes.forEach((migracao, index) => {
                relatorio += `${index + 1}. ${migracao.tipo}\n`;
                relatorio += `   Valor: €${migracao.valor}\n`;
                relatorio += `   Status: ${migracao.status}\n`;
                relatorio += `   Data: ${migracao.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhuma migração encontrada.\n\n';
        }
    }
    
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
        relatorio += 'REGISTOS:\n';
        relatorio += '---------\n';
        if (dadosCliente.registos.length > 0) {
            dadosCliente.registos.forEach((registo, index) => {
                relatorio += `${index + 1}. ${registo.tipo}\n`;
                relatorio += `   Valor: €${registo.valor}\n`;
                relatorio += `   Status: ${registo.status}\n`;
                relatorio += `   Data: ${registo.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhum registo encontrado.\n\n';
        }
    }
    
    relatorio += '==========================================\n';
    relatorio += 'Relatório personalizado gerado automaticamente\n';
    relatorio += 'Sistema Legal - Gestão Jurídica\n';
    
    if (exportarComoPdf) {
        abrirRelatorioTextoComoPdf(`Relatório Personalizado - ${clienteSelecionado}`, relatorio);
    } else {
        textoParaPdf(`Relatório - ${clienteSelecionado}`, relatorio, 'baixar', `relatorio_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    setTimeout(() => {
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
        document.querySelectorAll('.modal').forEach(m => m.remove());
    }, 100);
    
    mostrarNotificacao(exportarComoPdf ? `Relatório PDF aberto para ${clienteSelecionado}` : `Relatório personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
}

// NOVA FUNÇÃO: Relatório financeiro personalizado por cliente
function gerarRelatorioFinanceiroCliente() {
    
    // Verificar se já existe um modal aberto
    const modalExistente = document.querySelector('.modal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Verificar se há clientes
    if (!clientes || clientes.length === 0) {
        mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
        return;
    }
    
    
    // Criar modal para seleção de cliente
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 99999 !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    modal.innerHTML = `
        <div class="modal-content" style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e5e7eb;
            ">
                <h3 style="margin: 0; color: #1f2937;">💰 Relatório Financeiro Personalizado</h3>
                <button class="close-btn" onclick="fecharModalRobusto()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #6b7280;
                ">&times;</button>
            </div>
            <div class="modal-body" style="margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="clienteFinanceiroSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                    <select id="clienteFinanceiroSelecionado" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="">-- Escolha um cliente --</option>
                        ${clientes.map(cliente => 
                            `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="tipoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório Financeiro:</label>
                    <select id="tipoRelatorioFinanceiro" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="completo">Relatório Financeiro Completo</option>
                        <option value="honorarios">Apenas Honorários</option>
                        <option value="receitas">Apenas Receitas</option>
                        <option value="pendentes">Apenas Pendentes</option>
                        <option value="pagos">Apenas Pagos</option>
                        <option value="vencidos">Apenas Vencidos</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="periodoRelatorioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                    <select id="periodoRelatorioFinanceiro" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="todos">Todos os dados</option>
                        <option value="mes">Último mês</option>
                        <option value="trimestre">Último trimestre</option>
                        <option value="ano">Último ano</option>
                        <option value="personalizado">Período personalizado</option>
                    </select>
                </div>
                <div id="periodoPersonalizadoFinanceiro" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label for="dataInicioFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                    <input type="date" id="dataInicioFinanceiro" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        margin-bottom: 10px;
                    ">
                    <label for="dataFimFinanceiro" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                    <input type="date" id="dataFimFinanceiro" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            </div>
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
            ">
                <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                ">Cancelar</button>
                <button class="btn btn-secondary" onclick="gerarRelatorioFinanceiroClienteSelecionado(false)" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    PDF
                </button>
                <button class="btn btn-primary" onclick="gerarRelatorioFinanceiroClienteSelecionado(true)" style="
                    padding: 8px 16px;
                    background-color: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    PDF / Imprimir
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Verificar se o modal foi criado corretamente
    setTimeout(() => {
        const modalTeste = document.querySelector('.modal');
        if (modalTeste) {
            // Forçar visibilidade do modal
            modalTeste.style.display = 'flex';
            modalTeste.style.visibility = 'visible';
            modalTeste.style.opacity = '1';
        } else {
        }
    }, 100);
    
    // Event listener para período personalizado
    setTimeout(() => {
        const periodoSelect = document.getElementById('periodoRelatorioFinanceiro');
        if (periodoSelect) {
            periodoSelect.addEventListener('change', function() {
                const periodoPersonalizado = document.getElementById('periodoPersonalizadoFinanceiro');
                if (this.value === 'personalizado') {
                    periodoPersonalizado.style.display = 'block';
                } else {
                    periodoPersonalizado.style.display = 'none';
                }
            });
        } else {
        }
    }, 100);
}

function gerarRelatorioFinanceiroClienteSelecionado(exportarComoPdf) {
    exportarComoPdf = Boolean(exportarComoPdf);
    
    const clienteSelecionado = document.getElementById('clienteFinanceiroSelecionado').value;
    const tipoRelatorio = document.getElementById('tipoRelatorioFinanceiro').value;
    const periodoRelatorio = document.getElementById('periodoRelatorioFinanceiro').value;
    
    if (!clienteSelecionado) {
        mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
        return;
    }
    
    // Filtrar dados financeiros por cliente
    const dadosFinanceiros = {
        honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
        contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
        herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
        migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
        registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
    };
    
    // Aplicar filtro de período se necessário
    if (periodoRelatorio !== 'todos') {
        const agora = new Date();
        let dataLimite = new Date();
        
        switch (periodoRelatorio) {
            case 'mes':
                dataLimite.setMonth(agora.getMonth() - 1);
                break;
            case 'trimestre':
                dataLimite.setMonth(agora.getMonth() - 3);
                break;
            case 'ano':
                dataLimite.setFullYear(agora.getFullYear() - 1);
                break;
            case 'personalizado':
                const dataInicio = document.getElementById('dataInicioFinanceiro').value;
                const dataFim = document.getElementById('dataFimFinanceiro').value;
                if (!dataInicio || !dataFim) {
                    mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                    return;
                }
                // Aplicar filtro personalizado
                Object.keys(dadosFinanceiros).forEach(tipo => {
                    dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                        const dataItem = new Date(item.data);
                        return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                    });
                });
                break;
        }
        
        if (periodoRelatorio !== 'personalizado') {
            Object.keys(dadosFinanceiros).forEach(tipo => {
                dadosFinanceiros[tipo] = dadosFinanceiros[tipo].filter(item => {
                    const dataItem = new Date(item.data);
                    return dataItem >= dataLimite;
                });
            });
        }
    }
    
    // Calcular totais financeiros
    let totalHonorarios = 0;
    let totalContratos = 0;
    let totalHerancas = 0;
    let totalMigracoes = 0;
    let totalRegistos = 0;
    
    dadosFinanceiros.honorarios.forEach(h => totalHonorarios += parseFloat(h.valor) || 0);
    dadosFinanceiros.contratos.forEach(c => totalContratos += parseFloat(c.valor) || 0);
    dadosFinanceiros.herancas.forEach(h => totalHerancas += parseFloat(h.valor) || 0);
    dadosFinanceiros.migracoes.forEach(m => totalMigracoes += parseFloat(m.valor) || 0);
    dadosFinanceiros.registos.forEach(r => totalRegistos += parseFloat(r.valor) || 0);
    
    const totalGeral = totalHonorarios + totalContratos + totalHerancas + totalMigracoes + totalRegistos;
    
    // Gerar relatório financeiro
    let relatorio = `RELATÓRIO FINANCEIRO PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
    relatorio += '==================================================\n\n';
    relatorio += `Cliente: ${clienteSelecionado}\n`;
    relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
    relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
    relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
    relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
    
    // Resumo financeiro
    relatorio += 'RESUMO FINANCEIRO:\n';
    relatorio += '==================\n';
    relatorio += `Total Geral: €${totalGeral.toFixed(2)}\n`;
    relatorio += `Honorários: €${totalHonorarios.toFixed(2)}\n`;
    relatorio += `Contratos: €${totalContratos.toFixed(2)}\n`;
    relatorio += `Heranças: €${totalHerancas.toFixed(2)}\n`;
    relatorio += `Migrações: €${totalMigracoes.toFixed(2)}\n`;
    relatorio += `Registos: €${totalRegistos.toFixed(2)}\n\n`;
    
    // Adicionar seções baseadas no tipo de relatório
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
        relatorio += 'HONORÁRIOS:\n';
        relatorio += '-----------\n';
        if (dadosFinanceiros.honorarios.length > 0) {
            let totalHonorariosCliente = 0;
            dadosFinanceiros.honorarios.forEach((honorario, index) => {
                relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                relatorio += `   Valor: €${honorario.valor}\n`;
                relatorio += `   Status: ${formatarStatusHonorario(honorario.status)}\n`;
                relatorio += `   Data: ${honorario.data}\n`;
                if (honorario.vencimento) {
                    relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                }
                relatorio += `\n`;
                totalHonorariosCliente += parseFloat(honorario.valor) || 0;
            });
            relatorio += `TOTAL HONORÁRIOS: €${totalHonorariosCliente.toFixed(2)}\n\n`;
        } else {
            relatorio += 'Nenhum honorário encontrado.\n\n';
        }
    }
    
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'receitas') {
        relatorio += 'RECEITAS (Contratos, Heranças, Migrações, Registos):\n';
        relatorio += '==================================================\n';
        
        if (dadosFinanceiros.contratos.length > 0) {
            relatorio += 'CONTRATOS:\n';
            dadosFinanceiros.contratos.forEach((contrato, index) => {
                relatorio += `${index + 1}. ${contrato.tipo}\n`;
                relatorio += `   Valor: €${contrato.valor}\n`;
                relatorio += `   Status: ${contrato.status}\n`;
                relatorio += `   Data: ${contrato.data}\n\n`;
            });
        }
        
        if (dadosFinanceiros.herancas.length > 0) {
            relatorio += 'HERANÇAS:\n';
            dadosFinanceiros.herancas.forEach((heranca, index) => {
                relatorio += `${index + 1}. ${heranca.tipo}\n`;
                relatorio += `   Valor: €${heranca.valor}\n`;
                relatorio += `   Status: ${heranca.status}\n`;
                relatorio += `   Data: ${heranca.data}\n\n`;
            });
        }
        
        if (dadosFinanceiros.migracoes.length > 0) {
            relatorio += 'MIGRAÇÕES:\n';
            dadosFinanceiros.migracoes.forEach((migracao, index) => {
                relatorio += `${index + 1}. ${migracao.tipo}\n`;
                relatorio += `   Valor: €${migracao.valor}\n`;
                relatorio += `   Status: ${migracao.status}\n`;
                relatorio += `   Data: ${migracao.data}\n\n`;
            });
        }
        
        if (dadosFinanceiros.registos.length > 0) {
            relatorio += 'REGISTOS:\n';
            dadosFinanceiros.registos.forEach((registo, index) => {
                relatorio += `${index + 1}. ${registo.tipo}\n`;
                relatorio += `   Valor: €${registo.valor}\n`;
                relatorio += `   Status: ${registo.status}\n`;
                relatorio += `   Data: ${registo.data}\n\n`;
            });
        }
    }
    
    // Análise por status
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'pendentes' || tipoRelatorio === 'pagos' || tipoRelatorio === 'vencidos') {
        relatorio += 'ANÁLISE POR STATUS:\n';
        relatorio += '==================\n';
        
        const honorariosPendentes = dadosFinanceiros.honorarios.filter(h => isHonorarioEmAberto(h));
        const honorariosPagos = dadosFinanceiros.honorarios.filter(h => h.status === 'pago');
        const honorariosVencidos = dadosFinanceiros.honorarios.filter(h => h.status === 'vencido');
        
        relatorio += `Honorários Pendentes: ${honorariosPendentes.length} (€${honorariosPendentes.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
        relatorio += `Honorários Pagos: ${honorariosPagos.length} (€${honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n`;
        relatorio += `Honorários Vencidos: ${honorariosVencidos.length} (€${honorariosVencidos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0).toFixed(2)})\n\n`;
    }
    
    relatorio += '==================================================\n';
    relatorio += 'Relatório financeiro personalizado gerado automaticamente\n';
    relatorio += 'Sistema Legal - Gestão Jurídica\n';
    
    if (exportarComoPdf) {
        abrirRelatorioTextoComoPdf(`Relatório Financeiro - ${clienteSelecionado}`, relatorio);
    } else {
        textoParaPdf(`Relatório Financeiro - ${clienteSelecionado}`, relatorio, 'baixar', `relatorio_financeiro_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    setTimeout(() => {
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
        document.querySelectorAll('.modal').forEach(m => m.remove());
    }, 100);
    
    mostrarNotificacao(exportarComoPdf ? `Relatório PDF aberto para ${clienteSelecionado}` : `Relatório financeiro personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
}

// NOVA FUNÇÃO: Relatório geral personalizado por cliente
function gerarRelatorioGeralCliente() {
    
    // Verificar se já existe um modal aberto
    const modalExistente = document.querySelector('.modal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Verificar se há clientes
    if (!clientes || clientes.length === 0) {
        mostrarNotificacao('Nenhum cliente encontrado para gerar relatório!', 'warning');
        return;
    }
    
    
    // Criar modal para seleção de cliente
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 99999 !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    modal.innerHTML = `
        <div class="modal-content" style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e5e7eb;
            ">
                <h3 style="margin: 0; color: #1f2937;">📊 Relatório Geral Personalizado</h3>
                <button class="close-btn" onclick="fecharModalRobusto()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #6b7280;
                ">&times;</button>
            </div>
            <div class="modal-body" style="margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="clienteGeralSelecionado" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Selecione o Cliente:</label>
                    <select id="clienteGeralSelecionado" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="">-- Escolha um cliente --</option>
                        ${clientes.map(cliente => 
                            `<option value="${cliente.nome}">${cliente.nome} (${cliente.email})</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="tipoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Tipo de Relatório Geral:</label>
                    <select id="tipoRelatorioGeral" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="completo">Relatório Geral Completo</option>
                        <option value="dados_pessoais">Apenas Dados Pessoais</option>
                        <option value="honorarios">Apenas Honorários</option>
                        <option value="contratos">Apenas Contratos</option>
                        <option value="herancas">Apenas Heranças</option>
                        <option value="migracoes">Apenas Migrações</option>
                        <option value="registos">Apenas Registos</option>
                        <option value="documentos">Apenas Documentos</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="periodoRelatorioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Período:</label>
                    <select id="periodoRelatorioGeral" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="todos">Todos os dados</option>
                        <option value="mes">Último mês</option>
                        <option value="trimestre">Último trimestre</option>
                        <option value="ano">Último ano</option>
                        <option value="personalizado">Período personalizado</option>
                    </select>
                </div>
                <div id="periodoPersonalizadoGeral" class="form-group" style="display: none; margin-bottom: 15px;">
                    <label for="dataInicioGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Início:</label>
                    <input type="date" id="dataInicioGeral" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                        margin-bottom: 10px;
                    ">
                    <label for="dataFimGeral" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">Data de Fim:</label>
                    <input type="date" id="dataFimGeral" class="form-control" style="
                        width: 100%;
                        padding: 8px 12px;
                        border: 1px solid #d1d5db;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                </div>
            </div>
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
            ">
                <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                ">Cancelar</button>
                <button class="btn btn-secondary" onclick="gerarRelatorioGeralClienteSelecionado(false)" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    PDF
                </button>
                <button class="btn btn-primary" onclick="gerarRelatorioGeralClienteSelecionado(true)" style="
                    padding: 8px 16px;
                    background-color: #6366f1;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    PDF / Imprimir
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Verificar se o modal foi criado corretamente
    setTimeout(() => {
        const modalTeste = document.querySelector('.modal');
        if (modalTeste) {
            // Forçar visibilidade do modal
            modalTeste.style.display = 'flex';
            modalTeste.style.visibility = 'visible';
            modalTeste.style.opacity = '1';
        } else {
        }
    }, 100);
    
    // Event listener para período personalizado
    setTimeout(() => {
        const periodoSelect = document.getElementById('periodoRelatorioGeral');
        if (periodoSelect) {
            periodoSelect.addEventListener('change', function() {
                const periodoPersonalizado = document.getElementById('periodoPersonalizadoGeral');
                if (this.value === 'personalizado') {
                    periodoPersonalizado.style.display = 'block';
                } else {
                    periodoPersonalizado.style.display = 'none';
                }
            });
        } else {
        }
    }, 100);
}

function gerarRelatorioGeralClienteSelecionado(exportarComoPdf) {
    exportarComoPdf = Boolean(exportarComoPdf);
    
    const clienteSelecionado = document.getElementById('clienteGeralSelecionado').value;
    const tipoRelatorio = document.getElementById('tipoRelatorioGeral').value;
    const periodoRelatorio = document.getElementById('periodoRelatorioGeral').value;
    
    if (!clienteSelecionado) {
        mostrarNotificacao('Por favor, selecione um cliente!', 'warning');
        return;
    }
    
    
    // Filtrar dados gerais por cliente
    const dadosGeral = {
        honorarios: honorarios ? honorarios.filter(h => h.cliente === clienteSelecionado) : [],
        contratos: contratos ? contratos.filter(c => c.cliente === clienteSelecionado) : [],
        herancas: herancas ? herancas.filter(h => h.cliente === clienteSelecionado) : [],
        migracoes: migracoes ? migracoes.filter(m => m.cliente === clienteSelecionado) : [],
        registos: registos ? registos.filter(r => r.cliente === clienteSelecionado) : []
    };
    
    // Encontrar dados do cliente
    const cliente = clientes.find(c => c.nome === clienteSelecionado);
    
    // Aplicar filtro de período se necessário
    if (periodoRelatorio !== 'todos') {
        const agora = new Date();
        let dataLimite = new Date();
        
        switch (periodoRelatorio) {
            case 'mes':
                dataLimite.setMonth(agora.getMonth() - 1);
                break;
            case 'trimestre':
                dataLimite.setMonth(agora.getMonth() - 3);
                break;
            case 'ano':
                dataLimite.setFullYear(agora.getFullYear() - 1);
                break;
            case 'personalizado':
                const dataInicio = document.getElementById('dataInicioGeral').value;
                const dataFim = document.getElementById('dataFimGeral').value;
                if (!dataInicio || !dataFim) {
                    mostrarNotificacao('Por favor, selecione as datas do período personalizado!', 'warning');
                    return;
                }
                // Aplicar filtro personalizado
                Object.keys(dadosGeral).forEach(tipo => {
                    dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                        const dataItem = new Date(item.data);
                        return dataItem >= new Date(dataInicio) && dataItem <= new Date(dataFim);
                    });
                });
                break;
        }
        
        if (periodoRelatorio !== 'personalizado') {
            Object.keys(dadosGeral).forEach(tipo => {
                dadosGeral[tipo] = dadosGeral[tipo].filter(item => {
                    const dataItem = new Date(item.data);
                    return dataItem >= dataLimite;
                });
            });
        }
    }
    
    // Gerar relatório geral
    let relatorio = `RELATÓRIO GERAL PERSONALIZADO - ${clienteSelecionado.toUpperCase()}\n`;
    relatorio += '==================================================\n\n';
    relatorio += `Cliente: ${clienteSelecionado}\n`;
    relatorio += `Data: ${new Date().toLocaleDateString('pt-PT')}\n`;
    relatorio += `Hora: ${new Date().toLocaleTimeString('pt-PT')}\n`;
    relatorio += `Tipo: ${tipoRelatorio.toUpperCase()}\n`;
    relatorio += `Período: ${periodoRelatorio.toUpperCase()}\n\n`;
    
    // Dados pessoais do cliente
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'dados_pessoais') {
        relatorio += 'DADOS PESSOAIS DO CLIENTE:\n';
        relatorio += '==========================\n';
        if (cliente) {
            relatorio += `Nome: ${cliente.nome}\n`;
            relatorio += `Email: ${cliente.email}\n`;
            relatorio += `Telefone: ${cliente.telefone}\n`;
            relatorio += `NIF: ${cliente.nif}\n`;
            relatorio += `Data de Registo: ${cliente.data}\n`;
            if (cliente.endereco) {
                relatorio += `Endereço: ${cliente.endereco}\n`;
            }
            if (cliente.observacoes) {
                relatorio += `Observações: ${cliente.observacoes}\n`;
            }
        }
        relatorio += '\n';
    }
    
    // Honorários
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'honorarios') {
        relatorio += 'HONORÁRIOS:\n';
        relatorio += '-----------\n';
        if (dadosGeral.honorarios.length > 0) {
            let totalHonorarios = 0;
            dadosGeral.honorarios.forEach((honorario, index) => {
                relatorio += `${index + 1}. ${honorario.descricao || honorario.servico}\n`;
                relatorio += `   Valor: €${honorario.valor}\n`;
                relatorio += `   Status: ${formatarStatusHonorario(honorario.status)}\n`;
                relatorio += `   Data: ${honorario.data}\n`;
                if (honorario.vencimento) {
                    relatorio += `   Vencimento: ${honorario.vencimento}\n`;
                }
                relatorio += `\n`;
                totalHonorarios += parseFloat(honorario.valor) || 0;
            });
            relatorio += `TOTAL HONORÁRIOS: €${totalHonorarios.toFixed(2)}\n\n`;
        } else {
            relatorio += 'Nenhum honorário encontrado.\n\n';
        }
    }
    
    // Contratos
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'contratos') {
        relatorio += 'CONTRATOS:\n';
        relatorio += '----------\n';
        if (dadosGeral.contratos.length > 0) {
            dadosGeral.contratos.forEach((contrato, index) => {
                relatorio += `${index + 1}. ${contrato.tipo}\n`;
                relatorio += `   Valor: €${contrato.valor}\n`;
                relatorio += `   Status: ${contrato.status}\n`;
                relatorio += `   Data: ${contrato.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhum contrato encontrado.\n\n';
        }
    }
    
    // Heranças
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'herancas') {
        relatorio += 'HERANÇAS:\n';
        relatorio += '---------\n';
        if (dadosGeral.herancas.length > 0) {
            dadosGeral.herancas.forEach((heranca, index) => {
                relatorio += `${index + 1}. ${heranca.tipo}\n`;
                relatorio += `   Valor: €${heranca.valor}\n`;
                relatorio += `   Status: ${heranca.status}\n`;
                relatorio += `   Data: ${heranca.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhuma herança encontrada.\n\n';
        }
    }
    
    // Migrações
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'migracoes') {
        relatorio += 'MIGRAÇÕES:\n';
        relatorio += '----------\n';
        if (dadosGeral.migracoes.length > 0) {
            dadosGeral.migracoes.forEach((migracao, index) => {
                relatorio += `${index + 1}. ${migracao.tipo}\n`;
                relatorio += `   Valor: €${migracao.valor}\n`;
                relatorio += `   Status: ${migracao.status}\n`;
                relatorio += `   Data: ${migracao.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhuma migração encontrada.\n\n';
        }
    }
    
    // Registos
    if (tipoRelatorio === 'completo' || tipoRelatorio === 'registos') {
        relatorio += 'REGISTOS:\n';
        relatorio += '---------\n';
        if (dadosGeral.registos.length > 0) {
            dadosGeral.registos.forEach((registo, index) => {
                relatorio += `${index + 1}. ${registo.tipo}\n`;
                relatorio += `   Valor: €${registo.valor}\n`;
                relatorio += `   Status: ${registo.status}\n`;
                relatorio += `   Data: ${registo.data}\n\n`;
            });
        } else {
            relatorio += 'Nenhum registo encontrado.\n\n';
        }
    }
    
    // Resumo estatístico
    if (tipoRelatorio === 'completo') {
        relatorio += 'RESUMO ESTATÍSTICO:\n';
        relatorio += '===================\n';
        relatorio += `Total de Honorários: ${dadosGeral.honorarios.length}\n`;
        relatorio += `Total de Contratos: ${dadosGeral.contratos.length}\n`;
        relatorio += `Total de Heranças: ${dadosGeral.herancas.length}\n`;
        relatorio += `Total de Migrações: ${dadosGeral.migracoes.length}\n`;
        relatorio += `Total de Registos: ${dadosGeral.registos.length}\n\n`;
    }
    
    relatorio += '==================================================\n';
    relatorio += 'Relatório geral personalizado gerado automaticamente\n';
    relatorio += 'Sistema Legal - Gestão Jurídica\n';
    
    if (exportarComoPdf) {
        abrirRelatorioTextoComoPdf(`Relatório Geral - ${clienteSelecionado}`, relatorio);
    } else {
        textoParaPdf(`Relatório Geral - ${clienteSelecionado}`, relatorio, 'baixar', `relatorio_geral_${clienteSelecionado.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    }
    
    setTimeout(() => {
        const modal = document.querySelector('.modal');
        if (modal) modal.remove();
        document.querySelectorAll('.modal').forEach(m => m.remove());
    }, 100);
    
    mostrarNotificacao(exportarComoPdf ? `Relatório PDF aberto para ${clienteSelecionado}` : `Relatório geral personalizado para ${clienteSelecionado} gerado com sucesso!`, 'success');
}

function mostrarInformacoesCompletasCliente(cliente) {
    
    // Verificar se já existe um modal aberto
    const modalExistente = document.querySelector('.modal');
    if (modalExistente) {
        modalExistente.remove();
    }
    
    // Buscar todos os dados relacionados ao cliente
    const clienteId = cliente.id;
    const correspondeCliente = (item) => {
        if (!item) return false;
        if (clienteId && String(item.clienteId) === String(clienteId)) return true;
        return item.clienteNome === cliente.nome || item.cliente === cliente.nome;
    };
    const dadosCliente = {
        honorarios: honorarios ? honorarios.filter(correspondeCliente) : [],
        contratos: contratos ? contratos.filter(correspondeCliente) : [],
        herancas: herancas ? herancas.filter(correspondeCliente) : [],
        migracoes: migracoes ? migracoes.filter(correspondeCliente) : [],
        registos: registos ? registos.filter(correspondeCliente) : [],
        prazos: prazos ? prazos.filter(correspondeCliente) : [],
        tarefas: tarefas ? tarefas.filter(correspondeCliente) : [],
        documentos: documentos ? documentos.filter(correspondeCliente) : [],
        notificacoes: notificacoes ? notificacoes.filter(n => n.clienteId === clienteId || n.clienteNome === cliente.nome || n.cliente === cliente.nome) : []
    };
    
    // Criar modal com informações completas
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background-color: rgba(0, 0, 0, 0.7) !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 99999 !important;
        visibility: visible !important;
        opacity: 1 !important;
    `;
    modal.innerHTML = `
        <div class="modal-content" style="
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        ">
            <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #e5e7eb;
            ">
                <h3 style="margin: 0; color: #1f2937;">👤 ${cliente.nome} - Informações Completas</h3>
                <button class="close-btn" onclick="fecharModalRobusto()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #6b7280;
                ">&times;</button>
            </div>
            <div class="modal-body" style="margin-bottom: 20px;">
                <!-- Dados Pessoais -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">📋 Dados Pessoais</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <strong>Nome:</strong> ${cliente.nome}
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <strong>Email:</strong> ${cliente.email}
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <strong>Telefone:</strong> ${cliente.telefone}
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #ef4444;">
                            <strong>NIF:</strong> ${cliente.nif}
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #06b6d4;">
                            <strong>Status:</strong> ${cliente.status}
                        </div>
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                            <strong>Criado por:</strong> ${obterRotuloCriadorCliente(cliente)}
                        </div>
                    </div>
                    ${cliente.endereco ? `
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #6366f1; margin-top: 15px;">
                            <strong>Endereço:</strong> ${cliente.endereco}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Resumo Estatístico (6 itens: Honorários, Notificações, Contratos, Heranças, Migrações, Registos) -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">📊 Resumo Estatístico</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;">${dadosCliente.honorarios.length}</div>
                            <div style="font-size: 13px;">Honorários</div>
                        </div>
                        <div id="card-notificacoes-cliente" style="background: linear-gradient(135deg, #ea580c, #c2410c); color: white; padding: 16px; border-radius: 8px; text-align: center; border: 2px solid #9a3412;">
                            <div style="font-size: 22px; font-weight: bold;">${(dadosCliente.notificacoes && dadosCliente.notificacoes.length) || 0}</div>
                            <div style="font-size: 13px;">🔔 Notificações</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;">${dadosCliente.contratos.length}</div>
                            <div style="font-size: 13px;">Contratos</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;">${dadosCliente.herancas.length}</div>
                            <div style="font-size: 13px;">Heranças</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;">${dadosCliente.migracoes.length}</div>
                            <div style="font-size: 13px;">Migrações</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;">${dadosCliente.registos.length}</div>
                            <div style="font-size: 13px;">Registos</div>
                        </div>
                    </div>
                </div>
                
                <!-- Notificações do cliente (no processo) -->
                ${dadosCliente.notificacoes && dadosCliente.notificacoes.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 5px;">🔔 Notificações (${dadosCliente.notificacoes.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.notificacoes.map((noti) => `
                                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <span style="font-size: 11px; color: #ea580c; font-weight: 700;">${typeof obterRotuloDestinatarioNotificacao === 'function' ? obterRotuloDestinatarioNotificacao(noti.destinatarioId) : (noti.destinatarioId === 'admin' ? 'Para: Admin' : noti.destinatarioId === 'todos' ? 'Para: Todos' : 'Para: Convidado')}</span><br>
                                            <strong>${noti.titulo || 'Notificação'}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">${noti.mensagem || ''}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">${noti.dataCriacao ? new Date(noti.dataCriacao).toLocaleString('pt-PT') : ''}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Honorários -->
                ${dadosCliente.honorarios.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #3b82f6; padding-bottom: 5px;">💰 Honorários (${dadosCliente.honorarios.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.honorarios.map((honorario, index) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${honorario.descricao || honorario.servico}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Valor: €${honorario.valor} | Status: ${formatarStatusHonorario(honorario.status)}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data: ${honorario.data}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Contratos -->
                ${dadosCliente.contratos.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">📄 Contratos (${dadosCliente.contratos.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.contratos.map((contrato, index) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${contrato.tipo}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Valor: €${contrato.valor} | Status: ${contrato.status}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data: ${contrato.data}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Heranças -->
                ${dadosCliente.herancas.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 5px;">🏛️ Heranças (${dadosCliente.herancas.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.herancas.map((heranca, index) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${heranca.tipo}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Valor: €${heranca.valor} | Status: ${heranca.status}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data: ${heranca.data}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Migrações -->
                ${dadosCliente.migracoes.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #8b5cf6; padding-bottom: 5px;">🌍 Migrações (${dadosCliente.migracoes.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.migracoes.map((migracao, index) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #8b5cf6;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${migracao.tipo}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Valor: €${migracao.valor} | Status: ${migracao.status}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data: ${migracao.data}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Registos -->
                ${dadosCliente.registos.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #ef4444; padding-bottom: 5px;">📝 Registos (${dadosCliente.registos.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.registos.map((registo, index) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ef4444;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${registo.tipo}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Valor: €${registo.valor} | Status: ${registo.status}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data: ${registo.data}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Prazos -->
                ${dadosCliente.prazos.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #0ea5e9; padding-bottom: 5px;">⏰ Prazos (${dadosCliente.prazos.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.prazos.map((prazo) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #0ea5e9;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${prazo.descricao || prazo.tipo || 'Prazo'}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Status: ${prazo.status || 'ativo'}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">Data limite: ${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'N/D'}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Tarefas -->
                ${dadosCliente.tarefas.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #6366f1; padding-bottom: 5px;">✅ Tarefas (${dadosCliente.tarefas.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.tarefas.map((tarefa) => `
                                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #6366f1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <strong>${tarefa.titulo || 'Tarefa'}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">Status: ${tarefa.status || 'aberta'} | Prioridade: ${tarefa.prioridade || 'media'}</span><br>
                                            ${tarefa.responsavelNome ? `<span style="color: #374151; font-size: 12px; font-weight: 700;">Responsável: ${(tarefa.responsavelNome || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span><br>` : ''}
                                            <span style="color: #6b7280; font-size: 12px;">Prazo: ${tarefa.dataLimite ? new Date(tarefa.dataLimite).toLocaleDateString('pt-PT') : 'Sem prazo'}</span>
                                            ${tarefa.links && tarefa.links.length ? `
                                                <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px;">
                                                    ${tarefa.links.map(link => {
                                                        const href = normalizarLinkTarefa(link);
                                                        return href ? `<a href="${href}" target="_blank" rel="noopener noreferrer" style="font-size: 12px; color: #2563eb; text-decoration: underline;">${link}</a>` : '';
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                            ${tarefa.anexos && tarefa.anexos.length ? `
                                                <div style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 6px;">
                                                    ${tarefa.anexos.map(anexo => `
                                                        <button onclick="baixarAnexoTarefa(${JSON.stringify(tarefa.id)}, ${JSON.stringify(anexo.id)})" style="font-size: 12px; color: #2563eb; text-decoration: underline; background: transparent; border: none; padding: 0; cursor: pointer;">
                                                            ${anexo.nome}
                                                        </button>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Documentos -->
                <div style="margin-bottom: 30px;">
                    <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">📄 Documentos (${dadosCliente.documentos.length})</h4>
                    <div style="background: #f1f5f9; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-weight: 600; color: #0f172a; margin-bottom: 8px;">Adicionar documento rápido</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <select id="docModalProcessoTipo-${cliente.id}" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                                <option value="contrato">Contrato</option>
                                <option value="heranca">Herança</option>
                                <option value="migracao">Migração</option>
                                <option value="registo">Registo</option>
                                <option value="prazo">Prazo</option>
                                <option value="outro">Outro</option>
                            </select>
                            <select id="docModalEntidade-${cliente.id}" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;" title="Entidade">
                                ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                            </select>
                            <input id="docModalDescricao-${cliente.id}" type="text" placeholder="Descrição" style="grid-column: span 2; width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <input id="docModalTags-${cliente.id}" type="text" placeholder="Tags (vírgula)" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                            <input id="docModalArquivo-${cliente.id}" type="file" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                        </div>
                        <button type="button" class="js-doc-modal-add" data-cliente-id="${cliente.id}" data-cliente-nome="${String(cliente.nome || '').replace(/"/g, '&quot;')}" onclick="adicionarDocumentoModalHandler(this)" style="font-size: 12px; color: #ffffff; background: #10b981; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer;">
                            Guardar documento
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 160px; gap: 8px; margin-bottom: 10px;">
                        <input id="filtroDocumentosClienteModal" type="text" placeholder="Pesquisar documentos..." oninput="filtrarDocumentosClienteModal()" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px 10px; font-size: 14px;">
                        <select id="ordenacaoDocumentosClienteModal" onchange="filtrarDocumentosClienteModal()" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px 10px; font-size: 14px;">
                            <option value="data_desc">Mais recentes</option>
                            <option value="data_asc">Mais antigos</option>
                            <option value="nome_asc">Nome A-Z</option>
                            <option value="nome_desc">Nome Z-A</option>
                            <option value="tipo_asc">Tipo A-Z</option>
                            <option value="tipo_desc">Tipo Z-A</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <input id="filtroDocumentosClienteDataInicio" type="date" onchange="filtrarDocumentosClienteModal()" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                        <input id="filtroDocumentosClienteDataFim" type="date" onchange="filtrarDocumentosClienteModal()" style="width: 100%; border: 1px solid #e5e7eb; border-radius: 6px; padding: 6px 8px; font-size: 13px;">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <div id="resumoDocumentosClienteModal" style="font-size: 12px; color: #6b7280;"></div>
                        <button type="button" onclick="limparFiltrosDocumentosClienteModal()" style="font-size: 12px; color: #2563eb; background: transparent; border: none; cursor: pointer;">
                            Limpar filtros
                        </button>
                    </div>
                    <div id="listaDocumentosClienteModal" style="max-height: 300px; overflow-y: auto;"></div>
                </div>

                <!-- Notificações -->
                ${dadosCliente.notificacoes.length > 0 ? `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1f2937; font-size: 18px; font-weight: 600; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 5px;">🔔 Notificações (${dadosCliente.notificacoes.length})</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${dadosCliente.notificacoes.map((noti) => `
                                <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <span style="font-size: 11px; color: #ea580c; font-weight: 700;">${typeof obterRotuloDestinatarioNotificacao === 'function' ? obterRotuloDestinatarioNotificacao(noti.destinatarioId) : (noti.destinatarioId === 'admin' ? 'Para: Admin' : noti.destinatarioId === 'todos' ? 'Para: Todos' : 'Para: Convidado')}</span><br>
                                            <strong>${noti.titulo || 'Notificação'}</strong><br>
                                            <span style="color: #6b7280; font-size: 14px;">${noti.mensagem || ''}</span><br>
                                            <span style="color: #6b7280; font-size: 12px;">${noti.dataCriacao ? new Date(noti.dataCriacao).toLocaleString('pt-PT') : ''}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${dadosCliente.honorarios.length === 0 && dadosCliente.contratos.length === 0 && dadosCliente.herancas.length === 0 && dadosCliente.migracoes.length === 0 && dadosCliente.registos.length === 0 && dadosCliente.prazos.length === 0 && dadosCliente.tarefas.length === 0 && dadosCliente.documentos.length === 0 && dadosCliente.notificacoes.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <i data-lucide="file-x" style="width: 48px; height: 48px; margin: 0 auto 20px; display: block;"></i>
                        <h4 style="margin: 0 0 10px 0;">Nenhum item encontrado</h4>
                        <p style="margin: 0;">Este cliente ainda não possui registros associados.</p>
                    </div>
                ` : ''}
            </div>
            <div class="modal-footer" style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
            ">
                <button class="btn btn-secondary" onclick="fecharModalRobusto()" style="
                    padding: 8px 16px;
                    background-color: #6b7280;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                ">Fechar</button>
                <button class="btn btn-secondary" onclick="duplicarCliente('${String(cliente.id).replace(/'/g, "\\'")}'); fecharModalRobusto();" style="
                    padding: 8px 16px;
                    background-color: #8b5cf6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    Duplicar
                </button>
                <button class="btn btn-secondary" onclick="abrirDocumentosParaCliente(${cliente.id})" style="
                    padding: 8px 16px;
                    background-color: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="file-plus" class="w-4 h-4"></i>
                    Adicionar Documento
                </button>
                <button class="btn btn-primary js-relatorio-cliente" data-cliente-nome="${String(cliente.nome || '').replace(/"/g, '&quot;')}" style="
                    padding: 8px 16px;
                    background-color: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 5px;
                ">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    Gerar Relatório
                </button>
            </div>
        </div>
    `;
    
    window.__docsClienteModal = dadosCliente.documentos || [];
    document.body.appendChild(modal);
    const botaoAddDocumento = modal.querySelector('.js-doc-modal-add');
    if (botaoAddDocumento) {
        botaoAddDocumento.addEventListener('click', () => {
            const id = botaoAddDocumento.getAttribute('data-cliente-id');
            const nome = botaoAddDocumento.getAttribute('data-cliente-nome') || '';
            adicionarDocumentoModal(id, nome);
        });
    }
    const botaoRelatorioCliente = modal.querySelector('.js-relatorio-cliente');
    if (botaoRelatorioCliente) {
        botaoRelatorioCliente.addEventListener('click', () => {
            const nome = botaoRelatorioCliente.getAttribute('data-cliente-nome') || '';
            gerarRelatorioClienteEspecifico(nome);
        });
    }
    carregarFiltrosDocumentosClienteModal();
    renderDocumentosClienteModal(dadosCliente.documentos || [], '');
    
    // Verificar se o modal foi criado corretamente
    setTimeout(() => {
        const modalTeste = document.querySelector('.modal');
        if (modalTeste) {
            // Forçar visibilidade do modal
            modalTeste.style.display = 'flex';
            modalTeste.style.visibility = 'visible';
            modalTeste.style.opacity = '1';
        } else {
        }
    }, 200);
}

function obterDataDocumento(doc) {
    const data = new Date(doc.dataCriacao || doc.data || doc.dataDocumento || 0);
    return isNaN(data) ? null : data;
}

function ordenarDocumentos(documentos, modo) {
    const lista = [...documentos];
    switch (modo) {
        case 'data_asc':
            return lista.sort((a, b) => (obterDataDocumento(a) || 0) - (obterDataDocumento(b) || 0));
        case 'nome_asc':
            return lista.sort((a, b) => String(a.nomeArquivo || '').localeCompare(String(b.nomeArquivo || '')));
        case 'nome_desc':
            return lista.sort((a, b) => String(b.nomeArquivo || '').localeCompare(String(a.nomeArquivo || '')));
        case 'tipo_asc':
            return lista.sort((a, b) => String(a.processoTipo || a.tipo || a.categoria || '').localeCompare(String(b.processoTipo || b.tipo || b.categoria || '')));
        case 'tipo_desc':
            return lista.sort((a, b) => String(b.processoTipo || b.tipo || b.categoria || '').localeCompare(String(a.processoTipo || a.tipo || a.categoria || '')));
        case 'data_desc':
        default:
            return lista.sort((a, b) => (obterDataDocumento(b) || 0) - (obterDataDocumento(a) || 0));
    }
}

function agruparDocumentosPorTipo(documentos) {
    return documentos.reduce((acc, doc) => {
        const tipo = doc.processoTipo || doc.tipo || doc.categoria || 'outro';
        if (!acc[tipo]) acc[tipo] = [];
        acc[tipo].push(doc);
        return acc;
    }, {});
}

function renderDocumentosClienteModal(documentos, termo) {
    const container = document.getElementById('listaDocumentosClienteModal');
    const resumo = document.getElementById('resumoDocumentosClienteModal');
    if (!container) return;
    const ordenacao = document.getElementById('ordenacaoDocumentosClienteModal')?.value || 'data_desc';
    const dataInicioValor = document.getElementById('filtroDocumentosClienteDataInicio')?.value || '';
    const dataFimValor = document.getElementById('filtroDocumentosClienteDataFim')?.value || '';
    const dataInicio = dataInicioValor ? new Date(dataInicioValor) : null;
    const dataFim = dataFimValor ? new Date(dataFimValor) : null;
    if (dataFim) dataFim.setHours(23, 59, 59, 999);
    const filtro = (termo || '').toLowerCase();
    const filtrados = obterDocumentosAtual().filter(doc => {
        const alvo = [
            doc.nomeArquivo,
            doc.descricao,
            doc.processoTipo,
            doc.tipo,
            doc.categoria,
            ...(doc.tags || [])
        ].filter(Boolean).join(' ').toLowerCase();
        if (!alvo.includes(filtro)) return false;
        const dataDoc = obterDataDocumento(doc);
        if (dataInicio && dataDoc && dataDoc < dataInicio) return false;
        if (dataFim && dataDoc && dataDoc > dataFim) return false;
        return true;
    });
    if (filtrados.length === 0) {
        container.innerHTML = '<div style="color: #6b7280; font-size: 12px; padding: 8px 0;">Nenhum documento encontrado.</div>';
        if (resumo) resumo.textContent = '';
        return;
    }
    const grupos = agruparDocumentosPorTipo(ordenarDocumentos(filtrados, ordenacao));
    const tipos = Object.keys(grupos).sort();
    const documentoMaisRecente = ordenarDocumentos(filtrados, 'data_desc')[0];
    const indiceDocumento = new Map();
    filtrados.forEach((doc, idx) => indiceDocumento.set(doc, idx));
    window.__docsClienteModalFiltrados = filtrados;
    if (resumo) {
        const total = filtrados.length;
        resumo.textContent = `Total: ${total} | ` + tipos.map(tipo => `${tipo}: ${grupos[tipo].length}`).join(' | ');
    }
    container.innerHTML = tipos.map(tipo => `
        <div style="margin-bottom: 16px;">
            <div style="font-weight: 600; color: #065f46; margin-bottom: 8px; text-transform: capitalize;">${tipo} (${grupos[tipo].length})</div>
            ${grupos[tipo].map(doc => {
                const docIdx = indiceDocumento.get(doc);
                return `
                <div style="background: ${documentoMaisRecente && doc === documentoMaisRecente ? '#ecfeff' : '#f8fafc'}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${documentoMaisRecente && doc === documentoMaisRecente ? '#06b6d4' : '#10b981'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>${doc.nomeArquivo || 'Documento'}</strong>
                            ${documentoMaisRecente && doc === documentoMaisRecente ? `<span style="margin-left: 6px; font-size: 11px; color: #0f766e; font-weight: 600;">Mais recente</span>` : ''}<br>
                            <span style="color: #6b7280; font-size: 14px;">${doc.descricao || 'Sem descrição'}</span><br>
                            <span style="color: #6b7280; font-size: 12px;">Data: ${doc.dataCriacao ? new Date(doc.dataCriacao).toLocaleDateString('pt-PT') : 'N/D'}</span>
                            ${doc.conteudo ? `
                                <div style="margin-top: 6px;">
                                    <button onclick="abrirDocumentoClienteModal(${docIdx})" style="font-size: 12px; color: #2563eb; text-decoration: underline; background: transparent; border: none; padding: 0; cursor: pointer;">
                                        Abrir documento
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('')}
        </div>
    `).join('');
}

function filtrarDocumentosClienteModal() {
    const termo = document.getElementById('filtroDocumentosClienteModal')?.value || '';
    salvarFiltrosDocumentosClienteModal();
    renderDocumentosClienteModal(window.__docsClienteModal || [], termo);
}

function salvarFiltrosDocumentosClienteModal() {
    const estado = {
        termo: document.getElementById('filtroDocumentosClienteModal')?.value || '',
        ordenacao: document.getElementById('ordenacaoDocumentosClienteModal')?.value || 'data_desc',
        dataInicio: document.getElementById('filtroDocumentosClienteDataInicio')?.value || '',
        dataFim: document.getElementById('filtroDocumentosClienteDataFim')?.value || ''
    };
    appStorage.setItem('filtrosDocumentosClienteModal', JSON.stringify(estado));
}

function carregarFiltrosDocumentosClienteModal() {
    const estado = JSON.parse(appStorage.getItem('filtrosDocumentosClienteModal') || '{}');
    const termoEl = document.getElementById('filtroDocumentosClienteModal');
    const ordenacaoEl = document.getElementById('ordenacaoDocumentosClienteModal');
    const dataInicioEl = document.getElementById('filtroDocumentosClienteDataInicio');
    const dataFimEl = document.getElementById('filtroDocumentosClienteDataFim');
    if (termoEl && typeof estado.termo === 'string') termoEl.value = estado.termo;
    if (ordenacaoEl && estado.ordenacao) ordenacaoEl.value = estado.ordenacao;
    if (dataInicioEl && typeof estado.dataInicio === 'string') dataInicioEl.value = estado.dataInicio;
    if (dataFimEl && typeof estado.dataFim === 'string') dataFimEl.value = estado.dataFim;
}

function limparFiltrosDocumentosClienteModal() {
    const termoEl = document.getElementById('filtroDocumentosClienteModal');
    const ordenacaoEl = document.getElementById('ordenacaoDocumentosClienteModal');
    const dataInicioEl = document.getElementById('filtroDocumentosClienteDataInicio');
    const dataFimEl = document.getElementById('filtroDocumentosClienteDataFim');
    if (termoEl) termoEl.value = '';
    if (ordenacaoEl) ordenacaoEl.value = 'data_desc';
    if (dataInicioEl) dataInicioEl.value = '';
    if (dataFimEl) dataFimEl.value = '';
    salvarFiltrosDocumentosClienteModal();
    renderDocumentosClienteModal(window.__docsClienteModal || [], '');
}

function baixarDocumentoUrl(url, nome) {
    const link = document.createElement('a');
    link.href = url;
    link.download = nome || 'documento';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function abrirDocumentoEmNovaAba(doc) {
    const url = doc && doc.conteudo ? doc.conteudo : '';
    if (!url) {
        mostrarNotificacao('Documento sem conteúdo.', 'warning');
        return;
    }
    try {
        const tipoArquivo = (doc.tipoArquivo || '').toLowerCase();
        const isImagem = tipoArquivo.startsWith('image/') || url.startsWith('data:image/');
        if (isImagem) {
            const win = window.open('', '_blank');
            if (win) {
                win.document.title = doc.nomeArquivo || 'Imagem';
                win.document.body.style.margin = '0';
                win.document.body.style.display = 'block';
                win.document.body.style.overflow = 'auto';
                win.document.body.style.background = '#111827';
                win.document.body.innerHTML = `<div style="padding: 16px; text-align: center;"><img src="${url}" alt="Imagem" style="max-width: none; max-height: none; width: auto; height: auto; display: inline-block;" /></div>`;
                return;
            }
            baixarDocumentoUrl(url, doc.nomeArquivo);
            return;
        }
        if (url.startsWith('data:')) {
            const blob = await fetch(url).then(res => res.blob());
            const blobUrl = URL.createObjectURL(blob);
            const win = window.open(blobUrl, '_blank');
            setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
            if (!win) {
                baixarDocumentoUrl(blobUrl, doc.nomeArquivo);
            }
            return;
        }
        const win = window.open(url, '_blank');
        if (!win) {
            baixarDocumentoUrl(url, doc.nomeArquivo);
        }
    } catch (error) {
        console.warn('Falha ao abrir documento:', error);
        baixarDocumentoUrl(url, doc.nomeArquivo);
    }
}

function abrirDocumentoClienteModal(idx) {
    const lista = window.__docsClienteModalFiltrados || [];
    const doc = lista[idx];
    if (!doc) {
        mostrarNotificacao('Documento não encontrado.', 'error');
        return;
    }
    abrirDocumentoEmNovaAba(doc);
}

function gerarRelatorioClienteEspecifico(nomeCliente) {
    
    // Fechar modal atual
    fecharModalRobusto();
    
    // Simular seleção do cliente no relatório
    setTimeout(() => {
        gerarRelatorioCliente();
        
        // Preencher automaticamente o cliente selecionado
        setTimeout(() => {
            const selectCliente = document.getElementById('clienteSelecionado');
            if (selectCliente) {
                selectCliente.value = nomeCliente;
            }
        }, 200);
    }, 100);
}

function abrirDocumentosParaCliente(clienteId) {
    fecharModalRobusto();
    carregarSecao('documentos');
    setTimeout(() => {
        const select = document.getElementById('docCliente');
        if (select) {
            select.value = String(clienteId || '');
            select.dispatchEvent(new Event('change'));
            select.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        const descricao = document.getElementById('docDescricao');
        if (descricao) {
            descricao.focus();
        }
    }, 200);
}

function adicionarDocumentoModal(clienteId, clienteNome) {
    if (!exigirPermissaoAcao('criar', 'documento')) {
        return;
    }
    const processoTipo = document.getElementById(`docModalProcessoTipo-${clienteId}`)?.value || 'outro';
    const entidade = document.getElementById(`docModalEntidade-${clienteId}`)?.value || '';
    const descricao = document.getElementById(`docModalDescricao-${clienteId}`)?.value?.trim() || '';
    const tagsRaw = document.getElementById(`docModalTags-${clienteId}`)?.value || '';
    const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
    const arquivoInput = document.getElementById(`docModalArquivo-${clienteId}`);

    if (!arquivoInput || !arquivoInput.files || arquivoInput.files.length === 0) {
        mostrarNotificacao('Selecione um ficheiro.', 'warning');
        return;
    }
    const arquivo = arquivoInput.files[0];
    if (arquivo.size > 5 * 1024 * 1024) {
        mostrarNotificacao('Ficheiro acima de 5 MB. Tente um ficheiro menor.', 'error');
        return;
    }

    const reader = new FileReader();
    reader.onload = () => {
        const documento = {
            id: gerarIdImutavel(),
            clienteId,
            clienteNome: clienteNome || '',
            processoTipo,
            entidade,
            descricao,
            tags,
            nomeArquivo: arquivo.name,
            tipoArquivo: arquivo.type,
            tamanho: arquivo.size,
            conteudo: reader.result,
            criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
            tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D',
            dataCriacao: new Date().toISOString()
        };
        const lista = obterDocumentosAtual();
        lista.unshift(documento);
        salvarDocumentosLocal(lista);
        registrarAuditoria('criar', 'documento', `Documento adicionado: ${documento.nomeArquivo}`, null, documento);
        mostrarNotificacao('Documento adicionado com sucesso!', 'success');

        window.__docsClienteModal = lista.filter(doc => String(doc.clienteId || '') === String(clienteId));
        renderDocumentosClienteModal(window.__docsClienteModal || [], document.getElementById('filtroDocumentosClienteModal')?.value || '');
    };
    reader.readAsDataURL(arquivo);
}

function adicionarDocumentoModalHandler(elemento) {
    if (!elemento) return;
    const id = elemento.getAttribute('data-cliente-id');
    const nome = elemento.getAttribute('data-cliente-nome') || '';
    adicionarDocumentoModal(id, nome);
}

document.addEventListener('click', (event) => {
    const alvo = event.target;
    const botao = alvo && alvo.closest ? alvo.closest('.js-doc-modal-add') : null;
    if (!botao) {
        return;
    }
    const id = botao.getAttribute('data-cliente-id');
    const nome = botao.getAttribute('data-cliente-nome') || '';
    adicionarDocumentoModal(id, nome);
});

document.addEventListener('click', (event) => {
    const alvo = event.target;
    const botao = alvo && alvo.closest ? alvo.closest('.js-cliente-detalhes-link') : null;
    if (!botao) return;
    const id = botao.getAttribute('data-cliente-id');
    const nome = botao.getAttribute('data-cliente-nome') || '';
    const cliente = obterClientePorIdOuNome(id, nome);
    if (!cliente) {
        mostrarNotificacao('Cliente não encontrado.', 'error');
        return;
    }
    mostrarInformacoesCompletasCliente(cliente);
});

document.addEventListener('click', (event) => {
    const alvo = event.target;
    if (alvo && alvo.closest && alvo.closest('button')) return;
    const linha = alvo && alvo.closest ? alvo.closest('.js-honorario-row') : null;
    if (!linha) return;
    abrirClientePorIdOuNome(linha.dataset.clienteId, linha.dataset.clienteNome);
});

function gerarDashboard() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    // Usar obter*Atual() para garantir que os números batem com o resto da plataforma
    let clientesParaMostrar = obterClientesAtual();
    let honorariosParaMostrar = obterHonorariosAtual();
    let contratosParaMostrar = obterContratosAtual();
    let herancasParaMostrar = obterHerancasAtual();
    let migracoesParaMostrar = obterMigracoesAtual();
    let registosParaMostrar = obterRegistosAtual();
    let prazosParaMostrar = obterPrazosAtual();
    
    // Filtrar dados para convidados
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        
        if (convidado && convidado.ativo) {
            const idsVisiveis = obterIdsClientesVisiveisParaConvidado(convidado);
            clientesParaMostrar = clientes.filter(c => idsVisiveis.includes(String(c.id)));
            honorariosParaMostrar = honorarios.filter(h => idsVisiveis.includes(String(h.clienteId)));
            herancasParaMostrar = herancas.filter(h => idsVisiveis.includes(String(h.clienteId)));
            migracoesParaMostrar = migracoes.filter(m => idsVisiveis.includes(String(m.clienteId)));
            registosParaMostrar = registos.filter(r => idsVisiveis.includes(String(r.clienteId)));
            contratosParaMostrar = contratos.filter(c => idsVisiveis.includes(String(c.clienteId)));
            prazosParaMostrar = prazosParaMostrar.filter(p => idsVisiveis.includes(String(p.clienteId)));
        } else {
            // Se não há permissões, mostrar dados vazios
            clientesParaMostrar = [];
            honorariosParaMostrar = [];
            herancasParaMostrar = [];
            migracoesParaMostrar = [];
            registosParaMostrar = [];
            contratosParaMostrar = [];
            prazosParaMostrar = [];
        }
    }
    
    const totalClientes = clientesParaMostrar.filter(c => (c.status || 'ativo') === 'ativo').length;
    const totalHonorarios = honorariosParaMostrar.length;
    const valorTotal = honorariosParaMostrar.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    const honorariosPagos = honorariosParaMostrar.filter(h => h.status === 'pago').length;
    const honorariosPendentes = honorariosParaMostrar.filter(h => isHonorarioEmAberto(h)).length;
    const hoje = new Date();
    const honorariosVencidos = honorariosParaMostrar.filter(h => {
        if (!h.vencimento) return false;
        const dataVencimento = new Date(h.vencimento);
        return dataVencimento < hoje && isHonorarioEmAberto(h);
    }).length;
    const clientesComHonorarios = new Set(
        honorariosParaMostrar
            .map(h => h.clienteId || h.cliente || h.clienteNome)
            .filter(Boolean)
    ).size;
    const totalHerancas = herancasParaMostrar.length;
    const totalMigracoes = migracoesParaMostrar.length;
    const totalRegistos = registosParaMostrar.length;
    
    // Calcular IVA acumulado trimestral
    const agora = new Date();
    const trimestreAtual = Math.floor(agora.getMonth() / 3);
    const anoAtual = agora.getFullYear();
    const inicioTrimestre = new Date(anoAtual, trimestreAtual * 3, 1);
    const fimTrimestre = new Date(anoAtual, (trimestreAtual + 1) * 3, 0);
    
    // Calcular IVA de todos os itens do trimestre atual
    let ivaAcumuladoTrimestral = 0;
    
    // IVA dos honorários do trimestre
    const honorariosTrimestre = honorariosParaMostrar.filter(h => {
        const dataHonorario = new Date(h.dataCriacao);
        return dataHonorario >= inicioTrimestre && dataHonorario <= fimTrimestre;
    });
    honorariosTrimestre.forEach(h => {
        const valor = parseFloat(h.valor) || 0;
        const iva = parseFloat(h.iva) || 0;
        ivaAcumuladoTrimestral += (valor * iva / 100);
    });
    
    // IVA dos contratos do trimestre
    const contratosTrimestre = contratosParaMostrar.filter(c => {
        const dataContrato = new Date(c.dataCriacao);
        return dataContrato >= inicioTrimestre && dataContrato <= fimTrimestre;
    });
    contratosTrimestre.forEach(c => {
        const valor = parseFloat(c.valor) || 0;
        const iva = parseFloat(c.iva) || 0;
        ivaAcumuladoTrimestral += (valor * iva / 100);
    });
    
    // IVA das heranças do trimestre
    const herancasTrimestre = herancasParaMostrar.filter(h => {
        const dataHeranca = new Date(h.dataCriacao);
        return dataHeranca >= inicioTrimestre && dataHeranca <= fimTrimestre;
    });
    herancasTrimestre.forEach(h => {
        const valor = parseFloat(h.valor) || 0;
        const iva = parseFloat(h.iva) || 0;
        ivaAcumuladoTrimestral += (valor * iva / 100);
    });
    
    // IVA das migrações do trimestre
    const migracoesTrimestre = migracoesParaMostrar.filter(m => {
        const dataMigracao = new Date(m.dataCriacao);
        return dataMigracao >= inicioTrimestre && dataMigracao <= fimTrimestre;
    });
    migracoesTrimestre.forEach(m => {
        const valor = parseFloat(m.valor) || 0;
        const iva = parseFloat(m.iva) || 0;
        ivaAcumuladoTrimestral += (valor * iva / 100);
    });
    
    // IVA dos registos do trimestre
    const registosTrimestre = registosParaMostrar.filter(r => {
        const dataRegisto = new Date(r.dataCriacao);
        return dataRegisto >= inicioTrimestre && dataRegisto <= fimTrimestre;
    });
    registosTrimestre.forEach(r => {
        const valor = parseFloat(r.valor) || 0;
        const iva = parseFloat(r.iva) || 0;
        ivaAcumuladoTrimestral += (valor * iva / 100);
    });
    
    const nomeTrimestre = ['1º Trimestre', '2º Trimestre', '3º Trimestre', '4º Trimestre'][trimestreAtual];
    const prazosHoje = prazosParaMostrar.filter(p => {
        if (!p.dataLimite) return false;
        return new Date(p.dataLimite).toDateString() === hoje.toDateString() && p.status === 'ativo';
    }).length;

    const inicioMes = new Date(anoAtual, agora.getMonth(), 1);
    const fimMes = new Date(anoAtual, agora.getMonth() + 1, 0);
    const inicioMesAnterior = new Date(anoAtual, agora.getMonth() - 1, 1);
    const fimMesAnterior = new Date(anoAtual, agora.getMonth(), 0);
    const calcularTotaisPeriodo = (itens, inicio, fim) => {
        let total = 0;
        let iva = 0;
        itens.forEach((item) => {
            const dataCriacao = item.dataCriacao ? new Date(item.dataCriacao) : null;
            if (!dataCriacao || Number.isNaN(dataCriacao.getTime())) return;
            if (dataCriacao >= inicio && dataCriacao <= fim) {
                const valor = parseFloat(item.valor) || 0;
                const ivaPercentual = parseFloat(item.iva) || 0;
                total += valor;
                iva += (valor * ivaPercentual / 100);
            }
        });
        return { total, iva };
    };
    const totaisHonorariosMes = calcularTotaisPeriodo(honorariosParaMostrar, inicioMes, fimMes);
    const totaisContratosMes = calcularTotaisPeriodo(contratosParaMostrar, inicioMes, fimMes);
    const totaisHerancasMes = calcularTotaisPeriodo(herancasParaMostrar, inicioMes, fimMes);
    const totaisMigracoesMes = calcularTotaisPeriodo(migracoesParaMostrar, inicioMes, fimMes);
    const totaisRegistosMes = calcularTotaisPeriodo(registosParaMostrar, inicioMes, fimMes);
    const totalEntradasMes = totaisHonorariosMes.total + totaisContratosMes.total + totaisHerancasMes.total + totaisMigracoesMes.total + totaisRegistosMes.total;
    const ivaMes = totaisHonorariosMes.iva + totaisContratosMes.iva + totaisHerancasMes.iva + totaisMigracoesMes.iva + totaisRegistosMes.iva;
    
    const totaisHonorariosMesAnterior = calcularTotaisPeriodo(honorariosParaMostrar, inicioMesAnterior, fimMesAnterior);
    const totaisContratosMesAnterior = calcularTotaisPeriodo(contratosParaMostrar, inicioMesAnterior, fimMesAnterior);
    const totaisHerancasMesAnterior = calcularTotaisPeriodo(herancasParaMostrar, inicioMesAnterior, fimMesAnterior);
    const totaisMigracoesMesAnterior = calcularTotaisPeriodo(migracoesParaMostrar, inicioMesAnterior, fimMesAnterior);
    const totaisRegistosMesAnterior = calcularTotaisPeriodo(registosParaMostrar, inicioMesAnterior, fimMesAnterior);
    const totalEntradasMesAnterior = totaisHonorariosMesAnterior.total + totaisContratosMesAnterior.total + totaisHerancasMesAnterior.total + totaisMigracoesMesAnterior.total + totaisRegistosMesAnterior.total;
    const ivaMesAnterior = totaisHonorariosMesAnterior.iva + totaisContratosMesAnterior.iva + totaisHerancasMesAnterior.iva + totaisMigracoesMesAnterior.iva + totaisRegistosMesAnterior.iva;
    
    const formatarVariacao = (atual, anterior) => {
        if (anterior === 0 && atual === 0) {
            return { texto: '0%', classe: 'text-gray-600', icone: 'minus' };
        }
        if (anterior === 0) {
            return { texto: 'Novo', classe: 'text-emerald-600', icone: 'arrow-up-right' };
        }
        const perc = ((atual - anterior) / anterior) * 100;
        const texto = `${perc > 0 ? '+' : ''}${perc.toFixed(1)}%`;
        return {
            texto,
            classe: perc >= 0 ? 'text-emerald-600' : 'text-red-600',
            icone: perc >= 0 ? 'arrow-up-right' : 'arrow-down-right'
        };
    };
    const variacaoEntradas = formatarVariacao(totalEntradasMes, totalEntradasMesAnterior);
    const variacaoIva = formatarVariacao(ivaMes, ivaMesAnterior);

    const proximoPrazo = prazosParaMostrar
        .filter(p => p.dataLimite && p.status === 'ativo')
        .map(p => ({ ...p, dataLimiteDate: new Date(p.dataLimite) }))
        .filter(p => !Number.isNaN(p.dataLimiteDate.getTime()))
        .sort((a, b) => a.dataLimiteDate - b.dataLimiteDate)
        .find(p => p.dataLimiteDate >= hoje) || null;
    const diasParaProximoPrazo = proximoPrazo
        ? Math.ceil((proximoPrazo.dataLimiteDate - hoje) / (1000 * 60 * 60 * 24))
        : null;
    const proximos5Prazos = prazosParaMostrar
        .filter(p => p.dataLimite && (p.status === 'ativo' || p.status === 'vencido'))
        .map(p => ({ ...p, dataLimiteDate: new Date(p.dataLimite) }))
        .filter(p => !Number.isNaN(p.dataLimiteDate.getTime()))
        .sort((a, b) => a.dataLimiteDate - b.dataLimiteDate)
        .slice(0, 5);

    const movimentosRecentes = [
        ...honorariosParaMostrar.map(h => ({
            tipo: 'Honorário',
            clienteId: h.clienteId || null,
            cliente: h.cliente || h.clienteNome || 'Cliente',
            valor: h.valor,
            data: h.dataCriacao || h.data
        })),
        ...herancasParaMostrar.map(h => ({
            tipo: 'Herança',
            clienteId: h.clienteId || null,
            cliente: h.cliente || h.clienteNome || h.requerente || 'Cliente',
            valor: h.valor,
            data: h.dataCriacao || h.data
        })),
        ...migracoesParaMostrar.map(m => ({
            tipo: 'Migração',
            clienteId: m.clienteId || null,
            cliente: m.cliente || m.clienteNome || m.requerente || 'Cliente',
            valor: m.valor,
            data: m.dataCriacao || m.data
        })),
        ...registosParaMostrar.map(r => ({
            tipo: 'Registo',
            clienteId: r.clienteId || null,
            cliente: r.cliente || r.clienteNome || r.requerente || 'Cliente',
            valor: r.valor,
            data: r.dataCriacao || r.data
        })),
        ...contratosParaMostrar.map(c => ({
            tipo: 'Contrato',
            clienteId: c.clienteId || null,
            cliente: c.cliente || c.clienteNome || c.requerente || 'Cliente',
            valor: c.valor,
            data: c.dataCriacao || c.data
        }))
    ].filter(m => m.data && !Number.isNaN(new Date(m.data).getTime()))
        .sort((a, b) => new Date(b.data) - new Date(a.data))
        .slice(0, 5);

    const mostrarGuiaPrimeiroUso = totalClientes === 0 && tipoUsuario === 'admin' && !appStorage.getItem('guiaPrimeiroUsoConcluido');
    const fecharGuia = "document.getElementById('guiaPrimeiroUso')?.remove(); appStorage.setItem('guiaPrimeiroUsoConcluido', 'true');";
    return `
        <div class="space-y-6">
            ${mostrarGuiaPrimeiroUso ? `
            <div id="guiaPrimeiroUso" class="card p-6 border-2 border-blue-200 bg-blue-50" role="region" aria-labelledby="guiaTitulo">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 id="guiaTitulo" class="text-lg font-semibold text-blue-900 mb-2">Bem-vindo ao Sistema Legal</h3>
                        <p class="text-sm text-blue-800 mb-4">Siga estes passos para começar:</p>
                    </div>
                    <button type="button" onclick="${fecharGuia}" class="text-blue-600 hover:text-blue-800 p-1" aria-label="Fechar guia">×</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <button type="button" onclick="carregarSecao('clientes'); setTimeout(() => { if (typeof abrirModal === 'function') abrirModal('cliente'); }, 400);" class="flex items-center gap-3 p-4 bg-white rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:bg-blue-50 text-left transition">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">1</span>
                        <div><span class="font-medium text-blue-900">Criar cliente</span><br><span class="text-xs text-blue-700">Clientes → Novo Cliente</span></div>
                    </button>
                    <button type="button" onclick="carregarSecao('honorarios'); setTimeout(() => { if (typeof abrirModal === 'function') abrirModal('honorario'); }, 400);" class="flex items-center gap-3 p-4 bg-white rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:bg-blue-50 text-left transition">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">2</span>
                        <div><span class="font-medium text-blue-900">Criar honorário</span><br><span class="text-xs text-blue-700">Honorários → Novo Honorário</span></div>
                    </button>
                    <button type="button" onclick="carregarSecao('relatorios');" class="flex items-center gap-3 p-4 bg-white rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:bg-blue-50 text-left transition">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">3</span>
                        <div><span class="font-medium text-blue-900">Ver relatórios</span><br><span class="text-xs text-blue-700">Dashboard e exportações</span></div>
                    </button>
                    <button type="button" onclick="carregarSecao('backup');" class="flex items-center gap-3 p-4 bg-white rounded-lg border-2 border-blue-200 hover:border-blue-400 hover:bg-blue-50 text-left transition">
                        <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-700 font-bold">4</span>
                        <div><span class="font-medium text-blue-900">Exportar backup</span><br><span class="text-xs text-blue-700">Proteja os seus dados</span></div>
                    </button>
                </div>
                <button type="button" onclick="${fecharGuia}" class="btn btn-secondary text-sm">Entendido, não mostrar novamente</button>
            </div>
            ` : ''}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Honorários Vencidos</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="calendar" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Prazos Hoje</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                        </div>
                    </div>
                </div>
            </div>
            ${proximos5Prazos.length > 0 ? `
            <div class="card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-blue-600"></i>
                        Próximos prazos
                    </h3>
                    <button onclick="carregarSecao('prazos')" class="btn btn-secondary text-sm">Ver todos</button>
                </div>
                <ul class="space-y-2">
                    ${proximos5Prazos.map(p => {
                        const dias = Math.ceil((p.dataLimiteDate - hoje) / (1000 * 60 * 60 * 24));
                        const dataStr = p.dataLimiteDate.toLocaleDateString('pt-PT');
                        const clienteNome = p.clienteNome || p.cliente || 'Cliente';
                        const label = dias < 0 ? `${Math.abs(dias)} d atrasado` : (dias === 0 ? 'Hoje' : (dias === 1 ? 'Amanhã' : `${dias} dias`));
                        return `<li><button type="button" onclick="carregarSecao('prazos')" class="w-full flex items-center justify-between py-2 px-3 rounded-lg hover:bg-gray-50 text-left">
                            <span class="text-sm">${escaparHtml(p.descricao || p.tipo || 'Prazo')} <span class="text-gray-500">— ${escaparHtml(clienteNome)}</span></span>
                            <span class="text-xs ${dias <= 2 ? 'text-red-600 font-medium' : 'text-gray-600'}">${label} (${dataStr})</span>
                        </button></li>`;
                    }).join('')}
                </ul>
            </div>
            ` : ''}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Clientes</p>
                            <p class="text-2xl font-bold text-gray-900">${totalClientes}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Honorários</p>
                            <p class="text-2xl font-bold text-gray-900">${totalHonorarios}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Pagos</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-lg">
                            <i data-lucide="trending-up" class="w-6 h-6 text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i data-lucide="receipt" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">IVA Acumulado ${nomeTrimestre}</p>
                            <p class="text-2xl font-bold text-gray-900">€${Number(ivaAcumuladoTrimestral).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Métricas Avançadas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-indigo-100 rounded-lg">
                            <i data-lucide="target" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Taxa de Conversão</p>
                            <p class="text-2xl font-bold text-gray-900">${totalClientes > 0 ? Math.round((clientesComHonorarios / totalClientes) * 100) : 0}%</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-teal-100 rounded-lg">
                            <i data-lucide="calculator" class="w-6 h-6 text-teal-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Média por Cliente</p>
                            <p class="text-2xl font-bold text-gray-900">€${totalClientes > 0 ? (Math.round((valorTotal / totalClientes) * 100) / 100).toFixed(2) : '0.00'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Honorários Vencidos</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-pink-100 rounded-lg">
                            <i data-lucide="clock" class="w-6 h-6 text-pink-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Prazos Próximos</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosParaMostrar.filter(p => {
                                if (!p.dataLimite) return false;
                                const dataLimite = new Date(p.dataLimite);
                                const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                                return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                            }).length}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alertas e Resumos Inteligentes -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">🚨 Alertas Urgentes</h3>
                    <div class="space-y-3">
                        ${honorariosParaMostrar.filter(h => {
                            if (!h.vencimento) return false;
                            const dataVencimento = new Date(h.vencimento);
                            const hoje = new Date();
                            return dataVencimento < hoje && isHonorarioEmAberto(h);
                        }).slice(0, 3).map(honorario => `
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border-l-4 border-red-500">
                                <div>
                                    <p class="text-sm font-medium text-red-800">${honorario.cliente}</p>
                                    <p class="text-xs text-red-600">Vencido em ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</p>
                                </div>
                                <span class="text-red-600 font-bold">€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        ${honorariosParaMostrar.filter(h => {
                            if (!h.vencimento) return false;
                            const dataVencimento = new Date(h.vencimento);
                            const hoje = new Date();
                            return dataVencimento < hoje && isHonorarioEmAberto(h);
                        }).length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                <p class="text-sm text-green-600">Nenhum honorário vencido!</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">⏰ Prazos Próximos</h3>
                    ${proximoPrazo ? `
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                            <p class="text-xs text-blue-600 mb-1">Próximo prazo</p>
                            <p class="text-sm font-medium text-blue-800">${proximoPrazo.descricao}</p>
                            <p class="text-xs text-blue-600">${renderClienteLink(proximoPrazo.clienteId, proximoPrazo.clienteNome)} - ${proximoPrazo.dataLimiteDate.toLocaleDateString('pt-PT')} (${diasParaProximoPrazo} dias)</p>
                        </div>
                    ` : ''}
                    <div class="space-y-3">
                        ${prazosParaMostrar.filter(p => {
                            if (!p.dataLimite) return false;
                            const dataLimite = new Date(p.dataLimite);
                            const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                            return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                        }).slice(0, 3).map(prazo => `
                            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                                <div>
                                    <p class="text-sm font-medium text-yellow-800">${prazo.descricao}</p>
                                    <p class="text-xs text-yellow-600">${renderClienteLink(prazo.clienteId, prazo.clienteNome)} - ${Math.ceil((new Date(prazo.dataLimite) - new Date()) / (1000 * 60 * 60 * 24))} dias</p>
                                </div>
                                <span class="text-yellow-600 font-bold">${prazo.tipo}</span>
                            </div>
                        `).join('')}
                        ${prazosParaMostrar.filter(p => {
                            if (!p.dataLimite) return false;
                            const dataLimite = new Date(p.dataLimite);
                            const diferencaDias = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));
                            return diferencaDias <= 7 && diferencaDias >= 0 && p.status === 'ativo';
                        }).length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="check-circle" class="w-8 h-8 text-green-500 mx-auto mb-2"></i>
                                <p class="text-sm text-green-600">Nenhum prazo próximo!</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">📊 Resumo Financeiro</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-green-800 font-medium">Honorários Pagos</span>
                            <span class="text-green-600 font-bold">${honorariosPagos}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="text-yellow-800 font-medium">Honorários Pendentes</span>
                            <span class="text-yellow-600 font-bold">${honorariosPendentes}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-blue-800 font-medium">Valor Total</span>
                            <span class="text-blue-600 font-bold">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                            <span class="text-indigo-800 font-medium">Entradas do Mês</span>
                            <span class="text-indigo-600 font-bold">€${(Math.round(totalEntradasMes * 100) / 100).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                            <span class="text-emerald-800 font-medium">IVA do Mês</span>
                            <span class="text-emerald-600 font-bold">€${(Math.round(ivaMes * 100) / 100).toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                            <span class="text-purple-800 font-medium">Taxa de Conversão</span>
                            <span class="text-purple-600 font-bold">${totalClientes > 0 ? Math.round((honorariosParaMostrar.filter(h => h.clienteId).length / totalClientes) * 100) : 0}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">📈 Comparativo Mensal</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-lg">
                            <div>
                                <span class="text-indigo-800 font-medium">Entradas do Mês</span>
                                <p class="text-xs text-indigo-600">Mês anterior: €${(Math.round(totalEntradasMesAnterior * 100) / 100).toFixed(2)}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-indigo-600 font-bold">€${(Math.round(totalEntradasMes * 100) / 100).toFixed(2)}</span>
                                <div class="flex items-center justify-end gap-1 text-xs ${variacaoEntradas.classe}">
                                    <i data-lucide="${variacaoEntradas.icone}" class="w-3 h-3"></i>
                                    <span>${variacaoEntradas.texto}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                            <div>
                                <span class="text-emerald-800 font-medium">IVA do Mês</span>
                                <p class="text-xs text-emerald-600">Mês anterior: €${(Math.round(ivaMesAnterior * 100) / 100).toFixed(2)}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-emerald-600 font-bold">€${(Math.round(ivaMes * 100) / 100).toFixed(2)}</span>
                                <div class="flex items-center justify-end gap-1 text-xs ${variacaoIva.classe}">
                                    <i data-lucide="${variacaoIva.icone}" class="w-3 h-3"></i>
                                    <span>${variacaoIva.texto}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráficos Avançados -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">📊 Evolução Temporal dos Honorários</h3>
                    <div class="chart-container">
                        <canvas id="chartEvolucaoTemporal"></canvas>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">📈 Comparação Mensal</h3>
                    <div class="chart-container">
                        <canvas id="chartComparacaoMensal"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">🥧 Distribuição por Tipo</h3>
                    <div class="chart-container">
                        <canvas id="chartDistribuicaoTipo"></canvas>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">📈 Top 5 Clientes por Valor</h3>
                    <div class="space-y-3">
                        ${clientesParaMostrar.map(cliente => {
                            const valorCliente = honorariosParaMostrar
                                .filter(h => h.clienteId === cliente.id)
                                .reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
                            return { ...cliente, valorTotal: valorCliente };
                        }).sort((a, b) => b.valorTotal - a.valorTotal).slice(0, 5).map((cliente, index) => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full mr-3">${index + 1}</span>
                                    <div>
                                        <p class="font-medium text-gray-800">${renderClienteLink(cliente.id, cliente.nome)}</p>
                                        <p class="text-xs text-gray-600">${cliente.email}</p>
                                    </div>
                                </div>
                                <span class="text-blue-600 font-bold">€${(Math.round(cliente.valorTotal * 100) / 100).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        ${clientesParaMostrar.length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Últimos Clientes</h3>
                    <div class="space-y-3">
                        ${clientesParaMostrar.slice(-3).map(cliente => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">${renderClienteLink(cliente.id, cliente.nome)}</p>
                                    <p class="text-sm text-gray-600">${cliente.email}</p>
                                </div>
                                <span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span>
                            </div>
                        `).join('')}
                        ${clientesParaMostrar.length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-500">Nenhum cliente encontrado</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Últimos Honorários</h3>
                    <div class="space-y-3">
                        ${honorariosParaMostrar.slice(-3).map(honorario => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">${renderClienteLink(honorario.clienteId, honorario.cliente || honorario.clienteNome)}</p>
                                    <p class="text-sm text-gray-600">€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</p>
                                </div>
                                <span class="status-badge status-${honorario.status}">${formatarStatusHonorario(honorario.status)}</span>
                            </div>
                        `).join('')}
                        ${honorariosParaMostrar.length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="receipt" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-500">Nenhum honorário encontrado</p>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Últimos Movimentos</h3>
                    <div class="space-y-3">
                        ${movimentosRecentes.map(movimento => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium">${movimento.tipo} - ${renderClienteLink(movimento.clienteId, movimento.cliente)}</p>
                                    <p class="text-xs text-gray-600">${new Date(movimento.data).toLocaleDateString('pt-PT')}</p>
                                </div>
                                <span class="text-blue-600 font-bold">€${(Math.round((parseFloat(movimento.valor) || 0) * 100) / 100).toFixed(2)}</span>
                            </div>
                        `).join('')}
                        ${movimentosRecentes.length === 0 ? `
                            <div class="text-center py-4">
                                <i data-lucide="activity" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                <p class="text-sm text-gray-500">Nenhum movimento encontrado</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <!-- Ações Rápidas -->
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">⚡ Ações Rápidas</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <button onclick="carregarSecao('honorarios')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-blue-800">Criar Honorário</p>
                        </div>
                    </button>
                    
                    <button onclick="carregarSecao('prazos')" class="flex items-center justify-center p-4 bg-yellow-50 hover:bg-yellow-100 rounded-lg border border-yellow-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="clock" class="w-6 h-6 text-yellow-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-yellow-800">Ver Prazos</p>
                        </div>
                    </button>
                    
                    <button onclick="carregarSecao('clientes')" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="user-plus" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-green-800">Novo Cliente</p>
                        </div>
                    </button>

                    <button onclick="carregarSecao('herancas')" class="flex items-center justify-center p-4 bg-emerald-50 hover:bg-emerald-100 rounded-lg border border-emerald-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="home" class="w-6 h-6 text-emerald-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-emerald-800">Nova Herança</p>
                        </div>
                    </button>

                    <button onclick="carregarSecao('migracoes')" class="flex items-center justify-center p-4 bg-orange-50 hover:bg-orange-100 rounded-lg border border-orange-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="globe" class="w-6 h-6 text-orange-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-orange-800">Nova Migração</p>
                        </div>
                    </button>

                    <button onclick="carregarSecao('registos')" class="flex items-center justify-center p-4 bg-slate-50 hover:bg-slate-100 rounded-lg border border-slate-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="book-open" class="w-6 h-6 text-slate-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-slate-800">Novo Registo</p>
                        </div>
                    </button>
                    
                    <button onclick="gerarRelatorioCompleto()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg border border-purple-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="download" class="w-6 h-6 text-purple-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-purple-800">Relatório Geral</p>
                        </div>
                    </button>
                    
                    <button onclick="gerarRelatorioCliente()" class="flex items-center justify-center p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg border border-indigo-200 transition-colors">
                        <div class="text-center">
                            <i data-lucide="user-check" class="w-6 h-6 text-indigo-600 mx-auto mb-2"></i>
                            <p class="text-sm font-medium text-indigo-800">Relatório Cliente</p>
                        </div>
                    </button>
                    
                </div>
            </div>

            <!-- Novas Seções -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="home" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Heranças</p>
                            <p class="text-2xl font-bold text-gray-900">${totalHerancas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i data-lucide="users-2" class="w-6 h-6 text-orange-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Migrações</p>
                            <p class="text-2xl font-bold text-gray-900">${totalMigracoes}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-indigo-100 rounded-lg">
                            <i data-lucide="book-open" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Registos</p>
                            <p class="text-2xl font-bold text-gray-900">${totalRegistos}</p>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    `;
}

function criarGraficosAvancados() {
    // Dados para os gráficos
    const dadosEvolucaoTemporal = calcularEvolucaoTemporal();
    const dadosComparacaoMensal = calcularComparacaoMensal();
    const dadosDistribuicaoTipo = calcularDistribuicaoTipo();
    
    // Gráfico de Evolução Temporal
    const ctxEvolucao = document.getElementById('chartEvolucaoTemporal');
    if (ctxEvolucao) {
        const chartAntigo = typeof Chart !== 'undefined' && Chart.getChart ? Chart.getChart(ctxEvolucao) : null;
        if (chartAntigo) chartAntigo.destroy();
        new Chart(ctxEvolucao, {
            type: 'line',
            data: {
                labels: dadosEvolucaoTemporal.labels,
                datasets: [{
                    label: 'Honorários (€)',
                    data: dadosEvolucaoTemporal.valores,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de Comparação Mensal
    const ctxComparacao = document.getElementById('chartComparacaoMensal');
    if (ctxComparacao) {
        const chartAntigo = typeof Chart !== 'undefined' && Chart.getChart ? Chart.getChart(ctxComparacao) : null;
        if (chartAntigo) chartAntigo.destroy();
        new Chart(ctxComparacao, {
            type: 'bar',
            data: {
                labels: dadosComparacaoMensal.labels,
                datasets: [{
                    label: 'Honorários',
                    data: dadosComparacaoMensal.honorarios,
                    backgroundColor: 'rgba(34, 197, 94, 0.8)'
                }, {
                    label: 'Heranças',
                    data: dadosComparacaoMensal.herancas,
                    backgroundColor: 'rgba(249, 115, 22, 0.8)'
                }, {
                    label: 'Migrações',
                    data: dadosComparacaoMensal.migracoes,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '€' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gráfico de Distribuição por Tipo
    const ctxDistribuicao = document.getElementById('chartDistribuicaoTipo');
    if (ctxDistribuicao) {
        const chartAntigo = typeof Chart !== 'undefined' && Chart.getChart ? Chart.getChart(ctxDistribuicao) : null;
        if (chartAntigo) chartAntigo.destroy();
        new Chart(ctxDistribuicao, {
            type: 'doughnut',
            data: {
                labels: dadosDistribuicaoTipo.labels,
                datasets: [{
                    data: dadosDistribuicaoTipo.valores,
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)',
                        'rgba(249, 115, 22, 0.8)',
                        'rgba(59, 130, 246, 0.8)',
                        'rgba(168, 85, 247, 0.8)',
                        'rgba(236, 72, 153, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

function calcularEvolucaoTemporal() {
    const agora = new Date();
    const ultimos6Meses = [];
    
    for (let i = 5; i >= 0; i--) {
        const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
        ultimos6Meses.push(data);
    }
    
    const labels = ultimos6Meses.map(data => 
        data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
    );
    
    const valores = ultimos6Meses.map(data => {
        const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
        const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
        
        return window.honorarios ? window.honorarios.filter(h => {
            const dataHonorario = new Date(h.dataCriacao);
            return dataHonorario >= inicioMes && dataHonorario <= fimMes;
        }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
    });
    
    return { labels, valores };
}

function calcularComparacaoMensal() {
    const agora = new Date();
    const ultimos3Meses = [];
    
    for (let i = 2; i >= 0; i--) {
        const data = new Date(agora.getFullYear(), agora.getMonth() - i, 1);
        ultimos3Meses.push(data);
    }
    
    const labels = ultimos3Meses.map(data => 
        data.toLocaleDateString('pt-PT', { month: 'short', year: 'numeric' })
    );
    
    const valoresHonorarios = ultimos3Meses.map(data => {
        const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
        const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
        
        return window.honorarios ? window.honorarios.filter(h => {
            const dataHonorario = new Date(h.dataCriacao);
            return dataHonorario >= inicioMes && dataHonorario <= fimMes;
        }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
    });
    
    const valoresHerancas = ultimos3Meses.map(data => {
        const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
        const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
        
        return window.herancas ? window.herancas.filter(h => {
            const dataHeranca = new Date(h.dataCriacao);
            return dataHeranca >= inicioMes && dataHeranca <= fimMes;
        }).reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
    });
    
    const valoresMigracoes = ultimos3Meses.map(data => {
        const inicioMes = new Date(data.getFullYear(), data.getMonth(), 1);
        const fimMes = new Date(data.getFullYear(), data.getMonth() + 1, 0);
        
        return window.migracoes ? window.migracoes.filter(m => {
            const dataMigracao = new Date(m.dataCriacao);
            return dataMigracao >= inicioMes && dataMigracao <= fimMes;
        }).reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
    });
    
    return { labels, honorarios: valoresHonorarios, herancas: valoresHerancas, migracoes: valoresMigracoes };
}

function calcularDistribuicaoTipo() {
    const valorHonorarios = window.honorarios ? window.honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
    const valorHerancas = window.herancas ? window.herancas.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0) : 0;
    const valorMigracoes = window.migracoes ? window.migracoes.reduce((sum, m) => sum + (parseFloat(m.valor) || 0), 0) : 0;
    const valorRegistos = window.registos ? window.registos.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0) : 0;
    const valorContratos = window.contratos ? window.contratos.reduce((sum, c) => sum + (parseFloat(c.valor) || 0), 0) : 0;
    
    return {
        labels: ['Honorários', 'Heranças', 'Migrações', 'Registos', 'Contratos'],
        valores: [valorHonorarios, valorHerancas, valorMigracoes, valorRegistos, valorContratos]
    };
}

function obterRotuloCriadorCliente(cliente) {
    if (!cliente) return 'Admin';
    if (cliente.criadoPorTipo === 'convidado' || cliente.tipoUsuario === 'convidado' || cliente.criadoPorConvidado) {
        return 'Convidado';
    }
    return 'Admin';
}

function gerarClientes() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    let clientesParaMostrar = clientes;
    const limit = Math.max(LISTA_PAGINA_TAMANHO, window.__clientesLimit || LISTA_PAGINA_TAMANHO);
    
    // Filtrar clientes para convidados
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        
        
        if (convidado && convidado.ativo) {
            // Incluir: clientesAutorizados + clientes de tarefas atribuídas + clientes criados por ele
            const idsVisiveis = obterIdsClientesVisiveisParaConvidado(convidado);
            clientesParaMostrar = clientes.filter(cliente => 
                idsVisiveis.includes(String(cliente.id)) || 
                cliente.criadoPorConvidado === convidado.id ||
                String(cliente.criadoPorConvidado) === String(convidado.codigo)
            );
            
        } else {
            clientesParaMostrar = []; // Nenhum cliente se não há permissões
        }
    }
    
    const botaoNovoCliente = `
        <button onclick="abrirModal('cliente')" class="btn btn-primary" title="Adicionar novo cliente (atalho: tecla N)">
            <i data-lucide="plus" class="w-4 h-4"></i>
            Novo Cliente
        </button>
    `;
    
    const mostrarDicaPrimeiroCliente = tipoUsuario === 'admin' && clientesParaMostrar.length === 0 && !appStorage.getItem('guiaPrimeiroUsoConcluido');
    let ordClientes = window.__clientesOrdenar;
    if (!ordClientes) try { ordClientes = JSON.parse(appStorage.getItem('ordenarClientes') || '{}'); } catch(e) {}
    ordClientes = ordClientes && ordClientes.col ? ordClientes : { col: 'nome', dir: 1 };
    const seta = (col) => ordClientes.col === col ? (ordClientes.dir === 1 ? '↑' : '↓') : '↕';
    return `
        <div class="space-y-6">
            ${mostrarDicaPrimeiroCliente ? `
            <div id="dicaPrimeiroCliente" class="card p-4 border-2 border-blue-200 bg-blue-50 flex items-center justify-between gap-4" role="region" aria-label="Dica de primeiro uso">
                <p class="text-sm text-blue-800"><strong>Primeiro passo:</strong> Crie o seu primeiro cliente clicando em "Novo Cliente".</p>
                <button type="button" onclick="document.getElementById('dicaPrimeiroCliente')?.remove(); appStorage.setItem('guiaPrimeiroUsoConcluido', 'true');" class="text-blue-600 hover:text-blue-800 text-xs whitespace-nowrap" aria-label="Fechar dica">Ocultar</button>
            </div>
            ` : ''}
            <div class="flex justify-between items-center">
                ${botaoNovoCliente}
            </div>

            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaClientes" placeholder="Buscar clientes..." 
                           class="search-input" onkeyup="filtrarClientes()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                            <option value="ativo" selected>Ativo</option>
                            <option value="">Todos os status</option>
                            <option value="inativo">Inativo</option>
                            <option value="suspenso">Suspenso</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Criação</label>
                        <select id="filtroDataCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosClientes()">
                            <option value="">Todas as datas</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="ano">Este ano</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por NIF</label>
                        <input type="text" id="buscaNifClientes" placeholder="Digite o NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onkeyup="aplicarFiltrosClientes()">
                        <!-- CACHE UPDATE: Campo NIF adicionado -->
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosClientes()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorClientes">0</span> clientes encontrados
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="p-6">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarClientes('nome')" title="Ordenar por nome">Nome <span class="text-xs text-blue-500">${seta('nome')}</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarClientes('email')" title="Ordenar por email">Email <span class="text-xs text-blue-500">${seta('email')}</span></th>
                                    <th>Telefone</th>
                                    <th>NIF</th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarClientes('status')" title="Ordenar por status">Status <span class="text-xs text-blue-500">${seta('status')}</span></th>
                                    <th>Criado por</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaClientes">
                                ${(function() {
                                    const total = clientesParaMostrar.length;
                                    if (total === 0) {
                                        const tipoU = appStorage.getItem('tipoUsuario');
                                        const convId = appStorage.getItem('convidadoId');
                                        const conv = tipoU === 'convidado' && convId ? obterConvidados().find(c => String(c.id) === String(convId) || String(c.codigo) === String(convId)) : null;
                                        const temPermissoes = conv && (conv.clientesAutorizados || []).length > 0;
                                        const aCarregar = tipoU === 'convidado' && temPermissoes && clientes.length === 0 && isCloudReady();
                                        return `<tr><td colspan="7" class="text-center py-8 text-gray-500">
                                            ${aCarregar ? '<i data-lucide="loader" class="w-8 h-8 animate-spin mx-auto mb-2"></i><p>A carregar os seus clientes... (aguarde a sincronização)</p>' : '<i data-lucide="users" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i><p>Nenhum cliente encontrado</p>'}
                                        </td></tr>`;
                                    }
                                    const mostrar = clientesParaMostrar.slice(0, limit);
                                    const rows = mostrar.map(cliente => `
                                    <tr>
                                        <td>
                                            <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                                                    class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                                                    title="Clicar para ver informações completas">
                                                <i data-lucide="user" class="w-4 h-4"></i>
                                                ${cliente.nome}
                                            </button>
                                        </td>
                                        <td class="group/cell">
                                            ${cliente.email}
                                            ${cliente.email ? `<button type="button" data-copiar="${escaparHtml(cliente.email)}" class="copy-btn ml-1 opacity-0 group-hover/cell:opacity-100 inline-flex p-0.5 rounded hover:bg-gray-200 text-gray-500 hover:text-gray-700" title="Copiar email"><i data-lucide="copy" class="w-3.5 h-3.5" style="pointer-events:none"></i></button>` : ''}
                                        </td>
                                        <td class="group/cell">
                                            ${cliente.telefone || '-'}
                                            ${cliente.telefone ? `<button type="button" data-copiar="${escaparHtml(cliente.telefone)}" class="copy-btn ml-1 opacity-0 group-hover/cell:opacity-100 inline-flex p-0.5 rounded hover:bg-gray-200 text-gray-500 hover:text-gray-700" title="Copiar telefone"><i data-lucide="copy" class="w-3.5 h-3.5" style="pointer-events:none"></i></button>` : ''}
                                        </td>
                                        <td>${cliente.nif || '-'}</td>
                                        <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
                                        <td>${typeof obterRotuloCriadorCliente === 'function' ? obterRotuloCriadorCliente(cliente) : (cliente.tipoUsuario === 'convidado' ? 'Convidado' : 'Admin')}</td>
                                        <td>
                                            <button type="button" data-cliente-id="${String(cliente.id).replace(/"/g, '&quot;')}" data-cliente-acao="editar" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button type="button" data-cliente-id="${String(cliente.id).replace(/"/g, '&quot;')}" data-cliente-acao="duplicar" class="text-green-600 hover:text-green-800 mr-2" title="Duplicar cliente">
                                                <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button type="button" data-cliente-id="${String(cliente.id).replace(/"/g, '&quot;')}" data-cliente-acao="excluir" class="text-red-600 hover:text-red-800" title="Excluir">
                                                <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('');
                                    const verMais = total > limit ? `<tr><td colspan="7" class="text-center py-3 border-t"><button type="button" onclick="window.__clientesLimit = (window.__clientesLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosClientes();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></td></tr>` : '';
                                    return rows + verMais;
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function gerarPagamentos() {
    const lista = Array.isArray(pagamentos) ? pagamentos : [];
    const faturasLista = obterFaturas();
    const valorTotal = lista.reduce((s, p) => s + (parseFloat(p.valor) || 0), 0);

    const obterFaturaInfo = (fid) => {
        const f = faturasLista.find(x => String(x.id) === String(fid));
        return f ? `${f.numero || f.id} - ${f.clienteNome || ''} (€${(parseFloat(f.valorTotal || f.valor) || 0).toFixed(2)})` : `Fatura ${fid}`;
    };

    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">Registo de Pagamentos</h3>
                <button onclick="abrirModalNovoPagamento()" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Pagamento
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-4">
                    <p class="text-sm text-gray-600">Total de pagamentos</p>
                    <p class="text-2xl font-bold">${lista.length}</p>
                </div>
                <div class="card p-4">
                    <p class="text-sm text-gray-600">Valor total recebido</p>
                    <p class="text-2xl font-bold text-green-700">€${valorTotal.toFixed(2)}</p>
                </div>
            </div>
            <div class="card p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Fatura</th>
                                <th class="text-left py-2">Valor</th>
                                <th class="text-left py-2">Data</th>
                                <th class="text-left py-2">Método</th>
                                <th class="text-left py-2">Ref.</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lista.length === 0 ? '<tr><td colspan="5" class="text-center py-8 text-gray-500">Nenhum pagamento registado. Clique em "Novo Pagamento" para registar.</td></tr>' : lista.map(p => `
                                <tr>
                                    <td class="py-2">${obterFaturaInfo(p.faturaId)}</td>
                                    <td class="py-2 font-medium">€${(parseFloat(p.valor) || 0).toFixed(2)}</td>
                                    <td class="py-2">${(p.dataPagamento || p.data || '').toString().split('T')[0]}</td>
                                    <td class="py-2">${p.metodoPagamento || p.metodo || '-'}</td>
                                    <td class="py-2 text-sm text-gray-600">${p.referencia || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function obterProcessosParaDespesa() {
    const lista = [];
    (obterHerancasAtual?.() || []).forEach(h => {
        lista.push({ processoTipo: 'herancas', processoId: h.id, label: `Herança: ${h.clienteNome || h.id} (${h.tipo || '-'})` });
    });
    (obterMigracoesAtual?.() || []).forEach(m => {
        lista.push({ processoTipo: 'migracoes', processoId: m.id, label: `Migração: ${m.clienteNome || m.id} (${m.tipo || '-'})` });
    });
    (obterRegistosAtual?.() || []).forEach(r => {
        lista.push({ processoTipo: 'registos', processoId: r.id, label: `Registo: ${r.clienteNome || r.id} (${r.tipo || '-'})` });
    });
    return lista;
}

function obterProcessoInfo(processoTipo, processoId) {
    const tipos = { herancas: 'Herança', migracoes: 'Migração', registos: 'Registo' };
    let proc = null;
    if (processoTipo === 'herancas') proc = (obterHerancasAtual?.() || []).find(h => String(h.id) === String(processoId));
    else if (processoTipo === 'migracoes') proc = (obterMigracoesAtual?.() || []).find(m => String(m.id) === String(processoId));
    else if (processoTipo === 'registos') proc = (obterRegistosAtual?.() || []).find(r => String(r.id) === String(processoId));
    const nome = proc ? (proc.clienteNome || proc.id) : processoId;
    return `${tipos[processoTipo] || processoTipo}: ${nome}`;
}

function gerarDespesas() {
    const lista = Array.isArray(despesas) ? despesas : [];
    const valorTotal = lista.reduce((s, d) => s + (parseFloat(d.valor) || 0), 0);

    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">Gestão de Despesas</h3>
                <button onclick="abrirModalNovaDespesa()" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Nova Despesa
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="card p-4">
                    <p class="text-sm text-gray-600">Total de despesas</p>
                    <p class="text-2xl font-bold">${lista.length}</p>
                </div>
                <div class="card p-4">
                    <p class="text-sm text-gray-600">Valor total</p>
                    <p class="text-2xl font-bold text-red-700">€${valorTotal.toFixed(2)}</p>
                </div>
            </div>
            <div class="card p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Processo</th>
                                <th class="text-left py-2">Descrição</th>
                                <th class="text-left py-2">Tipo</th>
                                <th class="text-left py-2">Valor</th>
                                <th class="text-left py-2">Data</th>
                                <th class="text-left py-2">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lista.length === 0 ? '<tr><td colspan="6" class="text-center py-8 text-gray-500">Nenhuma despesa registada. Associe despesas a processos (heranças, migrações, registos).</td></tr>' : lista.map(d => `
                                <tr>
                                    <td class="py-2">${obterProcessoInfo(d.processoTipo, d.processoId)}</td>
                                    <td class="py-2">${(d.descricao || '-').toString().substring(0, 50)}</td>
                                    <td class="py-2">${d.tipo || 'outro'}</td>
                                    <td class="py-2 font-medium">€${(parseFloat(d.valor) || 0).toFixed(2)}</td>
                                    <td class="py-2">${(d.data || '').toString().split('T')[0]}</td>
                                    <td class="py-2">
                                        <button onclick="anularDespesaUi(${JSON.stringify(d.id)})" class="text-red-600 hover:text-red-800 text-sm" title="Anular">Anular</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function abrirModalNovaDespesa() {
    const processosOpts = obterProcessosParaDespesa();
    if (processosOpts.length === 0) {
        mostrarNotificacao('Crie primeiro um processo (herança, migração ou registo).', 'info');
        return;
    }
    const hoje = new Date().toISOString().split('T')[0];
    const opts = processosOpts.map(p => `<option value="${p.processoTipo}|${p.processoId}">${p.label}</option>`).join('');
    const tipoOpts = DESPESA_TIPOS.map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');
    const html = `
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Registar Despesa</h3>
            <form id="formNovaDespesa" onsubmit="guardarNovaDespesa(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Processo *</label>
                    <select name="processo" required class="w-full p-2 border rounded-lg">
                        <option value="">Selecione o processo</option>
                        ${opts}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Descrição *</label>
                    <input type="text" name="descricao" required class="w-full p-2 border rounded-lg" placeholder="Ex: Taxa IRN">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Tipo</label>
                    <select name="tipo" class="w-full p-2 border rounded-lg">${tipoOpts}</select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Valor (€) *</label>
                    <input type="number" name="valor" step="0.01" min="0" required class="w-full p-2 border rounded-lg" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Data *</label>
                    <input type="date" name="data" required class="w-full p-2 border rounded-lg" value="${hoje}">
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    `;
    mostrarModalRobusto(html);
}

async function guardarNovaDespesa(event) {
    event.preventDefault();
    const form = event.target;
    const processoVal = form.processo?.value;
    if (!processoVal) { mostrarNotificacao('Selecione o processo.', 'error'); return; }
    const [processoTipo, processoId] = processoVal.split('|');
    const valor = parseFloat(form.valor?.value || 0);
    if (valor < 0) { mostrarNotificacao('Valor inválido.', 'error'); return; }
    try {
        await criarDespesaCloud({
            processoTipo: processoTipo || 'herancas',
            processoId,
            descricao: form.descricao?.value || '',
            tipo: form.tipo?.value || 'outro',
            valor,
            data: form.data?.value || new Date().toISOString().split('T')[0]
        });
        fecharModalRobusto();
        mostrarNotificacao('Despesa registada.', 'success');
        carregarSecao('despesas');
    } catch (e) {
        mostrarNotificacao('Erro: ' + (e?.message || e), 'error');
    }
}

async function anularDespesaUi(id) {
    if (!confirm('Anular esta despesa? (ficará registada como anulada)')) return;
    try {
        await anularDespesaCloud(id);
        mostrarNotificacao('Despesa anulada.', 'success');
        carregarSecao('despesas');
    } catch (e) {
        mostrarNotificacao('Erro: ' + (e?.message || e), 'error');
    }
}

function abrirModalNovoPagamento() {
    const faturas = obterFaturas().filter(f => (f.estado || f.status) !== 'pago');
    if (faturas.length === 0) {
        mostrarNotificacao('Não há faturas pendentes para registar pagamento.', 'info');
        return;
    }
    const opcoes = faturas.map(f => `<option value="${f.id}">${f.numero || f.id} - ${f.clienteNome || ''} - €${(parseFloat(f.valorTotal || f.valor) || 0).toFixed(2)} (${f.estado || f.status || 'pendente'})</option>`).join('');
    const hoje = new Date().toISOString().split('T')[0];
    const html = `
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Registar Pagamento</h3>
            <form id="formNovoPagamento" onsubmit="guardarNovoPagamento(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Fatura *</label>
                    <select name="faturaId" required class="w-full p-2 border rounded-lg">
                        <option value="">Selecione a fatura</option>
                        ${opcoes}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Valor (€) *</label>
                    <input type="number" name="valor" step="0.01" min="0.01" required class="w-full p-2 border rounded-lg" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Data do pagamento *</label>
                    <input type="date" name="dataPagamento" required class="w-full p-2 border rounded-lg" value="${hoje}">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Método</label>
                    <select name="metodoPagamento" class="w-full p-2 border rounded-lg">
                        <option value="transferencia">Transferência</option>
                        <option value="numerario">Numerário</option>
                        <option value="cheque">Cheque</option>
                        <option value="multibanco">Multibanco</option>
                        <option value="outro">Outro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Referência</label>
                    <input type="text" name="referencia" class="w-full p-2 border rounded-lg" placeholder="Nº referência ou descrição">
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>
    `;
    mostrarModalRobusto(html);
}

async function guardarNovoPagamento(event) {
    event.preventDefault();
    const form = event.target;
    const faturaId = form.faturaId?.value;
    const valor = parseFloat(form.valor?.value || 0);
    if (!faturaId || valor <= 0) {
        mostrarNotificacao('Preencha fatura e valor.', 'error');
        return;
    }
    try {
        await criarPagamentoCloud({
            faturaId,
            valor,
            dataPagamento: form.dataPagamento?.value || new Date().toISOString().split('T')[0],
            metodoPagamento: form.metodoPagamento?.value || 'transferencia',
            referencia: form.referencia?.value || ''
        });
        fecharModalRobusto();
        mostrarNotificacao('Pagamento registado.', 'success');
        carregarSecao('pagamentos');
    } catch (e) {
        mostrarNotificacao('Erro: ' + (e?.message || e), 'error');
    }
}

function formatarStatusHonorario(status) {
    if (status === 'parcial') return 'Parcial';
    if (status === 'pago') return 'Pago';
    if (status === 'pendente') return 'Pendente';
    if (status === 'vencido') return 'Vencido';
    return status || 'pendente';
}

function isHonorarioEmAberto(h) {
    return h.status === 'pendente' || h.status === 'parcial';
}

function gerarHonorarios() {
    const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
    const honorariosPendentes = honorarios.filter(h => isHonorarioEmAberto(h)).length;
    const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;
    const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const mostrarDicaHonorario = tipoUsuario === 'admin' && honorarios.length === 0 && clientes.length > 0 && !appStorage.getItem('guiaHonorarioVisto');

    return `
        <div class="space-y-6">
            ${mostrarDicaHonorario ? `
            <div id="dicaPrimeiroHonorario" class="card p-4 border-2 border-amber-200 bg-amber-50 flex items-center justify-between gap-4" role="region" aria-label="Dica de honorários">
                <p class="text-sm text-amber-800"><strong>Próximo passo:</strong> Crie o seu primeiro honorário clicando em "Novo Honorário".</p>
                <button type="button" onclick="document.getElementById('dicaPrimeiroHonorario')?.remove(); appStorage.setItem('guiaHonorarioVisto', 'true');" class="text-amber-600 hover:text-amber-800 text-xs whitespace-nowrap" aria-label="Fechar dica">Ocultar</button>
            </div>
            ` : ''}
            <div class="flex flex-wrap justify-between items-center gap-2">
                <button onclick="abrirModal('honorario')" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Honorário
                </button>
                <button onclick="gerarFaturasAutomaticas()" class="btn btn-secondary" title="Cria faturas a partir de honorários que ainda não têm fatura">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    Gerar faturas
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Pagos</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosPagos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Pendentes</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosPendentes}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Vencidos</p>
                            <p class="text-2xl font-bold text-gray-900">${honorariosVencidos}</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${(Math.round(valorTotal * 100) / 100).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaHonorarios" placeholder="Buscar por nome do cliente, serviço ou valor..." 
                           class="search-input" onkeyup="filtrarHonorarios()" title="Pode escrever o nome do cliente, o serviço ou o valor">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="parcial">Parcial</option>
                            <option value="pago">Pago</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mínimo</label>
                        <input type="number" id="filtroValorMinHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máximo</label>
                        <input type="number" id="filtroValorMaxHonorario" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                        <select id="filtroVencimentoHonorario" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHonorarios()">
                            <option value="">Todas as datas</option>
                            <option value="hoje">Vence hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="vencido">Vencidos</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosHonorarios()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorHonorarios">0</span> honorários encontrados
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="p-6">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarHonorarios('cliente')" title="Ordenar por cliente">Cliente <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarHonorarios('servico')" title="Ordenar por serviço">Serviço <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarHonorarios('valor')" title="Ordenar por valor">Valor <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarHonorarios('status')" title="Ordenar por status">Status <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarHonorarios('vencimento')" title="Ordenar por vencimento">Vencimento <span class="text-xs text-blue-500">↕</span></th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaHonorarios">
                                ${(function() {
                                    const limitH = Math.max(LISTA_PAGINA_TAMANHO, window.__honorariosLimit || LISTA_PAGINA_TAMANHO);
                                    const totalH = honorarios.length;
                                    const mostrarH = honorarios.slice(0, limitH);
                                    const rowsH = mostrarH.map(honorario => `
                                    <tr class="js-honorario-row" data-cliente-id="${honorario.clienteId || ''}" data-cliente-nome="${String(honorario.cliente || honorario.clienteNome || '').replace(/"/g, '&quot;')}" style="cursor: pointer;">
                                        <td>
                                            ${renderClienteLink(honorario.clienteId, honorario.cliente || honorario.clienteNome)}
                                            ${renderMetaAuditoria('honorario', honorario)}
                                        </td>
                                        <td>${honorario.servico}</td>
                                        <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
                                        <td><span class="status-badge status-${honorario.status}">${formatarStatusHonorario(honorario.status)}</span></td>
                                        <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
                                        <td>
                                            <button onclick="editarItem('honorario', ${JSON.stringify(honorario.id)})" class="text-blue-600 hover:text-blue-800">
                                                <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="excluirItem('honorario', ${JSON.stringify(honorario.id)})" class="text-red-600 hover:text-red-800 ml-2">
                                                <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('');
                                    const verMaisH = totalH > limitH ? `<tr><td colspan="6" class="text-center py-3 border-t"><button type="button" onclick="window.__honorariosLimit = (window.__honorariosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosHonorarios();" class="btn btn-secondary text-sm">Ver mais (${totalH - limitH} restantes)</button></td></tr>` : '';
                                    return rowsH + verMaisH;
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function gerarContratos() {
    const contratosAtivos = contratos.filter(c => c.status === 'ativo').length;
    const contratosSuspensos = contratos.filter(c => c.status === 'suspenso').length;
    const contratosTerminados = contratos.filter(c => c.status === 'terminado').length;
    const valorTotalContratos = contratos.reduce((sum, c) => {
        const valor = parseFloat(c.valor) || 0;
        return sum + valor;
    }, 0);

    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <button onclick="abrirModal('contrato')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    Novo Contrato
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${contratosAtivos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Suspensos</p>
                            <p class="text-2xl font-bold text-gray-900">${contratosSuspensos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Terminados</p>
                            <p class="text-2xl font-bold text-gray-900">${contratosTerminados}</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${Math.round(valorTotalContratos * 100) / 100}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaContratos" placeholder="Buscar contratos..." 
                           class="search-input" onkeyup="filtrarContratos()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="filtroClienteContrato" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                            <option value="">Todos os clientes</option>
                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                        </select>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                        <input type="text" id="filtroNifContrato" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosContratos()">
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosContratos()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorContratos">0</span> contratos encontrados
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="p-6">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="font-bold cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarContratos('clienteNome')" title="Ordenar por cliente">Cliente <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="font-bold cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarContratos('tipo')" title="Ordenar por tipo">Tipo <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="font-bold">Descrição</th>
                                    <th class="font-bold cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarContratos('valor')" title="Ordenar por valor">Valor <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="font-bold cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarContratos('status')" title="Ordenar por status">Status <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="font-bold cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarContratos('dataInicio')" title="Ordenar por data">Data Início <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="font-bold">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaContratos">
                                ${(function() {
                                    const limitC = Math.max(LISTA_PAGINA_TAMANHO, window.__contratosLimit || LISTA_PAGINA_TAMANHO);
                                    const totalC = contratos.length;
                                    const mostrarC = contratos.slice(0, limitC);
                                    const rowsC = mostrarC.map(contrato => `
                                    <tr>
                                        <td>
                                            ${renderClienteLink(contrato.clienteId, contrato.clienteNome)}
                                            ${renderMetaAuditoria('contrato', contrato)}
                                        </td>
                                        <td>${contrato.tipo}</td>
                                        <td>${contrato.descricao}</td>
                                        <td>
                                            <div class="flex flex-col">
                                                <div class="text-sm font-medium text-gray-900">€${(Math.round((parseFloat(contrato.valor) || 0) * 100) / 100).toFixed(2)}</div>
                                                <div class="text-xs text-gray-500">
                                                    <span class="text-gray-400">+ ${contrato.iva || 0}% IVA:</span>
                                                    <span class="font-medium text-gray-700">€${(Math.round((parseFloat(contrato.valorTotal || contrato.valor) || 0) * 100) / 100).toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
                                        <td>${new Date(contrato.dataInicio).toLocaleDateString('pt-PT')}</td>
                                        <td>
                                            <button onclick="editarContratoDireto(${JSON.stringify(contrato.id)})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                                                <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="duplicarContrato(${JSON.stringify(contrato.id)})" class="text-green-600 hover:text-green-800 mr-2" title="Duplicar">
                                                <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="abrirAnexosContrato(${JSON.stringify(contrato.id)})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                                                <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="excluirContratoDireto(${JSON.stringify(contrato.id)})" class="text-red-600 hover:text-red-800" title="Excluir">
                                                <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('');
                                    const verMaisC = totalC > limitC ? `<tr><td colspan="7" class="text-center py-3 border-t"><button type="button" onclick="window.__contratosLimit = (window.__contratosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosContratos();" class="btn btn-secondary text-sm">Ver mais (${totalC - limitC} restantes)</button></td></tr>` : '';
                                    return rowsC + verMaisC;
                                })()}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function gerarPrazos() {
    const listaPrazos = obterPrazosAtual();
    const prazosAtivos = listaPrazos.filter(p => p.status === 'ativo').length;
    const prazosVencidos = listaPrazos.filter(p => p.status === 'vencido').length;
    const prazosUrgentes = listaPrazos.filter(p => p.prioridade === 'alta' || p.prioridade === 'critica').length;
    const prazosHoje = listaPrazos.filter(p => {
        try {
            if (!p.dataLimite) return false;
            const hoje = new Date().toISOString().split('T')[0];
            const dataLimite = new Date(p.dataLimite).toISOString().split('T')[0];
            return dataLimite === hoje && p.status === 'ativo';
        } catch (error) {
            console.warn('Erro ao processar data do prazo:', p.dataLimite);
            return false;
        }
    }).length;

    return `
        <div class="space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="text-sm text-gray-600 bg-blue-50 px-3 py-2 rounded-lg">
                    <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                    Prazos criados automaticamente pelas áreas de execução
                </div>
                <button type="button" onclick="abrirModalCriarPrazo()" class="btn btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Novo Prazo
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosAtivos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Vencidos</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosVencidos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-orange-100 rounded-lg">
                            <i data-lucide="zap" class="w-6 h-6 text-orange-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Urgentes</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosUrgentes}</p>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="calendar" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Hoje</p>
                            <p class="text-2xl font-bold text-gray-900">${prazosHoje}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informação sobre prazos automáticos -->
            <div class="card p-6 bg-blue-50 border-l-4 border-blue-400">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i data-lucide="clock" class="w-6 h-6 text-blue-600"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Prazos Automáticos</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>Os prazos são criados automaticamente quando você adiciona itens nas áreas de execução:</p>
                            <ul class="mt-2 list-disc list-inside space-y-1">
                                <li><strong>Contratos:</strong> Prazo de 30 dias</li>
                                <li><strong>Heranças:</strong> Prazo de 60 dias</li>
                                <li><strong>Migração:</strong> Prazo de 90 dias</li>
                                <li><strong>Registos:</strong> Prazo de 15 dias</li>
                            </ul>
                            <p class="mt-2 text-xs text-blue-600">Você pode editar ou excluir prazos conforme necessário.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaPrazos" placeholder="Buscar prazos..." 
                           class="search-input" onkeyup="filtrarPrazos()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                            <option value="">Todos os tipos</option>
                            <option value="contrato">Contrato</option>
                            <option value="heranca">Herança</option>
                            <option value="migracao">Migração</option>
                            <option value="registo">Registo</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                        <select id="filtroVencimentoPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                            <option value="">Todas as datas</option>
                            <option value="hoje">Vence hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="vencido">Vencidos</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="filtroPrioridadePrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosPrazos()">
                            <option value="">Todas as prioridades</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosPrazos()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorPrazos">0</span> prazos encontrados
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="p-6">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('cliente')" title="Ordenar por cliente">Cliente <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('tipo')" title="Ordenar por tipo">Tipo <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('descricao')" title="Ordenar por descrição">Descrição <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('dataLimite')" title="Ordenar por data">Data Limite <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('prioridade')" title="Ordenar por prioridade">Prioridade <span class="text-xs text-blue-500">↕</span></th>
                                    <th class="cursor-pointer hover:bg-gray-100 select-none" onclick="ordenarPrazos('status')" title="Ordenar por status">Status <span class="text-xs text-blue-500">↕</span></th>
                                    <th>Criado por</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaPrazos">
                                ${listaPrazos.length === 0
                                    ? '<tr><td colspan="8" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum prazo registado.</p><button type="button" onclick="abrirModalCriarPrazo()" class="btn btn-primary text-sm">Adicionar prazo</button></td></tr>'
                                    : listaPrazos.map(prazo => `
                                    <tr>
                                        <td>
                                            ${renderClienteLink(prazo.clienteId, prazo.clienteNome)}
                                            ${renderMetaAuditoria('prazo', prazo)}
                                        </td>
                                        <td>${prazo.tipo}</td>
                                        <td>${prazo.descricao}</td>
                                        <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                        <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
                                        <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
                                        <td>${prazo.criadoPor || '-'}</td>
                                        <td>
                                            <button onclick="editarItem('prazo', ${JSON.stringify(prazo.id)})" class="text-blue-600 hover:text-blue-800 mr-2">
                                                <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="abrirAnexosPrazo(${JSON.stringify(prazo.id)})" class="text-green-600 hover:text-green-800 mr-2">
                                                <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                            <button onclick="excluirItem('prazo', ${JSON.stringify(prazo.id)})" class="text-red-600 hover:text-red-800">
                                                <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function gerarNotificacoes() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const convidadoId = appStorage.getItem('convidadoId');
    
    // Filtrar notificações baseado no tipo de usuário
    let notificacoesFiltradas = obterNotificacoesAtual();
    
    if (tipoUsuario === 'convidado') {
        // Para convidados: apenas notificações direcionadas a eles
        notificacoesFiltradas = notificacoesFiltradas.filter(n => 
            n.destinatarioId === parseInt(convidadoId) || 
            n.destinatarioId === 'todos' ||
            n.tipo === 'cliente_autorizado' ||
            n.tipo === 'documento_anexado' ||
            n.tipo === 'prazo_proximo'
        );
    }
    
    const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
    const notificacoesHoje = notificacoesFiltradas.filter(n => {
        try {
            if (!n.dataCriacao) return false;
            const hoje = new Date().toISOString().split('T')[0];
            const dataNotificacao = new Date(n.dataCriacao).toISOString().split('T')[0];
            return dataNotificacao === hoje;
        } catch (error) {
            console.warn('Erro ao processar data da notificação:', n.dataCriacao);
            return false;
        }
    }).length;

    return `
        <div class="space-y-6">
    <div class="flex justify-between items-center">
        <div class="flex space-x-3">
            ${tipoUsuario === 'admin' ? `
                ${(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') ? `<button onclick="criarNotificacaoTeste()" class="btn btn-info">
                    <i data-lucide="flask-conical" class="w-4 h-4"></i>
                    Teste Aleatório
                </button>` : ''}
                <button onclick="criarNotificacaoPersonalizada()" class="btn btn-warning">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                    Criar Personalizada
                </button>
            ` : `
                <div class="text-sm text-gray-600">
                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                    Suas notificações automáticas e mensagens do administrador
                </div>
            `}
        </div>
        <div class="flex space-x-3">
            <button onclick="marcarTodasComoLidas()" class="btn btn-secondary">
                <i data-lucide="check" class="w-4 h-4"></i>
                Marcar Todas como Lidas
            </button>
            ${tipoUsuario === 'admin' ? `
                <button onclick="limparNotificacoes()" class="btn btn-error">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    Limpar Todas
                </button>
            ` : ''}
        </div>
    </div>
    
    <div class="card p-6">
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
            <div>
                <h3 class="text-lg font-semibold">Alertas Automáticos (v2)</h3>
                <p class="text-sm text-gray-600">Enviar resumo de prazos e honorários por Email ou WhatsApp.</p>
            </div>
            <div class="flex flex-wrap items-center gap-2">
                <button onclick="enviarAlertasEmail()" class="btn btn-primary">
                    <i data-lucide="mail" class="w-4 h-4"></i>
                    Enviar por Email
                </button>
                <button onclick="enviarAlertasWhatsApp()" class="btn btn-success">
                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                    Enviar por WhatsApp
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email de destino</label>
                <input id="alertasEmailDestino" type="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: cliente@email.com">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp (com indicativo)</label>
                <input id="alertasWhatsAppDestino" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: 351912345678">
            </div>
        </div>
        <div class="mt-3 text-xs text-gray-500">
            Dica: o envio usa o seu cliente de email/WhatsApp Web (sem serviços externos).
        </div>
    </div>
    
    <div class="card p-6 border-blue-200 bg-blue-50">
        <h3 class="text-lg font-semibold mb-2 text-blue-800">
            <i data-lucide="bell" class="w-5 h-5 inline mr-1"></i> Alertas do navegador
        </h3>
        <p class="text-sm text-blue-700 mb-3">
            Receba notificações de prazos, tarefas e honorários vencidos mesmo quando o site está em background.
        </p>
        ${typeof Notification !== 'undefined' ? (Notification.permission === 'granted'
            ? '<p class="text-sm text-green-700 font-medium">✓ Notificações ativadas</p>'
            : Notification.permission === 'denied'
                ? '<p class="text-sm text-gray-600">Notificações bloqueadas. Ative nas definições do browser.</p>'
                : '<button onclick="solicitarPermissaoNotificacoes()" class="btn btn-primary"><i data-lucide="bell-ring" class="w-4 h-4"></i> Ativar notificações</button>'
        ) : '<p class="text-sm text-gray-500">O seu browser não suporta notificações.</p>'}
    </div>
    
    <!-- Filtros Inteligentes -->
    <div class="card p-6">
        <h3 class="text-lg font-semibold mb-4">Filtros Inteligentes</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                <select id="filtroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                    <option value="">Todas as prioridades</option>
                    <option value="alta">Alta</option>
                    <option value="media">Média</option>
                    <option value="baixa">Baixa</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                <select id="filtroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                    <option value="">Todos os tipos</option>
                    <option value="mensagem_admin">Mensagem do Admin</option>
                    <option value="resposta_convidado">Resposta do Convidado</option>
                    <option value="cliente_autorizado">Cliente Autorizado</option>
                    <option value="documento_anexado">Documento Anexado</option>
                    <option value="prazo_proximo">Prazo Próximo</option>
                    <option value="honorario">Honorário</option>
                    <option value="prazo">Prazo</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="filtroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                    <option value="">Todas</option>
                    <option value="nao_lida">Não Lidas</option>
                    <option value="lida">Lidas</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                <select id="filtroPeriodo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosNotificacoes()">
                    <option value="">Todos</option>
                    <option value="hoje">Hoje</option>
                    <option value="semana">Esta Semana</option>
                    <option value="mes">Este Mês</option>
                </select>
            </div>
        </div>
        
        <div class="flex justify-between items-center mt-4">
            <button onclick="limparFiltrosNotificacoes()" class="btn btn-secondary">
                <i data-lucide="x" class="w-4 h-4"></i>
                Limpar Filtros
            </button>
            <div class="text-sm text-gray-600">
                <span id="contadorFiltros">${notificacoesFiltradas.length} notificações encontradas</span>
            </div>
        </div>
    </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i data-lucide="bell" class="w-6 h-6 text-red-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Não Lidas</p>
                            <p class="text-2xl font-bold text-gray-900">${notificacoesNaoLidas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="calendar" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Hoje</p>
                            <p class="text-2xl font-bold text-gray-900">${notificacoesHoje}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total</p>
                            <p class="text-2xl font-bold text-gray-900">${notificacoesFiltradas.length}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                ${notificacoesFiltradas.length === 0 ? `
                    <div class="card p-8 text-center">
                        <i data-lucide="bell-off" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">Nenhuma notificação</h3>
                        <p class="text-gray-500">Você está em dia! Não há notificações pendentes.</p>
                    </div>
                ` : notificacoesFiltradas.map(notificacao => `
                    <div class="card p-4 ${notificacao.lida ? 'opacity-60' : 'border-l-4 border-blue-500'}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="status-badge status-${notificacao.tipo}">${notificacao.tipo}</span>
                                    ${notificacao.prioridade === 'alta' ? '<span class="status-badge status-alta">Urgente</span>' : ''}
                                    ${notificacao.origem === 'admin' ? '<span class="status-badge status-info">Admin</span>' : ''}
                                    ${notificacao.origem === 'convidado' ? '<span class="status-badge status-success">Convidado</span>' : ''}
                                    <span class="text-xs font-bold text-orange-600">${typeof obterRotuloDestinatarioNotificacao === 'function' ? obterRotuloDestinatarioNotificacao(notificacao.destinatarioId) : (notificacao.destinatarioId === 'admin' ? 'Para: Admin' : notificacao.destinatarioId === 'todos' ? 'Para: Todos' : 'Para: Convidado')}</span>
                                </div>
                                <h4 class="font-semibold text-gray-800">${notificacao.titulo}</h4>
                                <p class="text-gray-600 text-sm mt-1">${notificacao.mensagem}</p>
                                <p class="text-gray-400 text-xs mt-2">${notificacao.dataCriacao ? new Date(notificacao.dataCriacao).toLocaleString('pt-PT') : 'Data não disponível'}</p>
                                
                                ${notificacao.origem === 'admin' && tipoUsuario === 'convidado' ? `
                                    <div class="mt-3 pt-3 border-t border-gray-200">
                                        <button onclick="responderMensagem(${notificacao.id})" class="btn btn-sm btn-primary">
                                            <i data-lucide="reply" class="w-4 h-4"></i>
                                            Responder
                                        </button>
                                    </div>
                                ` : ''}
                                
                                ${notificacao.respostas && notificacao.respostas.length > 0 ? `
                                    <div class="mt-3">
                                        <h5 class="text-sm font-medium text-gray-700 mb-2">Respostas (${notificacao.respostas.length})</h5>
                                        ${notificacao.respostas.map(resposta => `
                                            <div class="bg-gray-50 p-3 rounded-lg mb-2">
                                                <div class="flex items-center justify-between mb-1">
                                                    <span class="text-xs font-medium text-gray-600">${resposta.origem === 'admin' ? 'Admin' : 'Você'}</span>
                                                    <span class="text-xs text-gray-400">${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}</span>
                                                </div>
                                                <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                ${!notificacao.lida ? `
                                    <button onclick="marcarComoLida(${JSON.stringify(notificacao.id)})" class="text-blue-600 hover:text-blue-800">
                                        <i data-lucide="check" class="w-4 h-4" style="pointer-events:none"></i>
                                    </button>
                                ` : ''}
                                <button onclick="excluirNotificacao(${JSON.stringify(notificacao.id)})" class="text-red-600 hover:text-red-800">
                                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

function salvarTarefasLocal(novos, options = {}) {
    tarefas = (novos || []).map(tarefa => ({
        ...tarefa,
        anexos: tarefa.anexos || []
    }));
    window.tarefas = tarefas;
    salvarDados('tarefas', tarefas, options);
    try {
        appStorage.setItem('tarefasBackup', JSON.stringify(tarefas));
    } catch (error) {
        console.warn('Erro ao salvar backup de tarefas:', error);
    }
}

function obterFiltroSoComPrazo() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const salvo = appStorage.getItem('tarefasFiltroSoComPrazo') === 'true';
    return tipoUsuario === 'admin' ? false : salvo;
}

/** Cria ou atualiza tarefa na nuvem. isNew: true para criar (serverTimestamp), false para atualizar. */
async function salvarTarefaCloud(tarefa, isNew = false) {
    if (!isCloudReady() || !tarefa) return;
    try {
        if (isNew) {
            await criarTarefaCloud(tarefa);
        } else {
            await atualizarTarefaCloud(tarefa.id, tarefa);
        }
    } catch (err) {
        console.warn('Erro ao salvar tarefa na nuvem:', err);
        window.__cloudSyncError = err;
    }
}

/** Soft delete na nuvem. */
async function excluirTarefaCloud(id) {
    if (!isCloudReady() || !id) return;
    try {
        await apagarTarefaCloud(id);
    } catch (err) {
        console.warn('Erro ao apagar tarefa na nuvem:', err);
        window.__cloudSyncError = err;
    }
}

/** Lista clientes: APENAS Firestore (atualizada por ouvirClientes). Sem appStorage. */
function obterClientesAtual() {
    return Array.isArray(clientes) ? clientes : [];
}

/** Atualiza clientes em memória e persiste no Firestore. */
function atualizarClientesEmMemoria(lista) {
    if (!Array.isArray(lista)) return;
    clientes = lista;
    window.clientes = clientes;
    try {
        appStorage.setItem('clientes', JSON.stringify(lista));
    } catch (e) { console.warn('LocalStorage clientes:', e?.message); }
}

/** Lista tarefas: Firestore (global) ou appStorage só offline. */
/** Lista tarefas: apenas Firestore. Sem localStorage. */
function obterTarefasAtual() {
    return Array.isArray(tarefas) ? tarefas : [];
}

/** Lista prazos: Firestore (global) ou appStorage só offline. */
/** Lista prazos: apenas Firestore. Sem localStorage. */
function obterPrazosAtual() {
    return Array.isArray(prazos) ? prazos : [];
}

/** Lista notificações: Firestore (global) ou appStorage só offline. */
/** Lista notificações: apenas Firestore. Sem localStorage. */
function obterNotificacoesAtual() {
    return Array.isArray(notificacoes) ? notificacoes : [];
}

/** Lista documentos: Firestore (global) ou appStorage só offline. */
/** Lista documentos: apenas Firestore. Sem localStorage. */
function obterDocumentosAtual() {
    return Array.isArray(documentos) ? documentos : [];
}

/** Lista convidados: Firestore (global) ou appStorage só offline. */
/** Lista convidados: apenas Firestore. Sem localStorage. */
function obterConvidadosAtual() {
    return Array.isArray(convidados) ? convidados : [];
}

async function sincronizarTarefasNuvem() {
    await sincronizarEntidadeNuvem('tarefas');
}

function normalizarLinkTarefa(url) {
    const valor = String(url || '').trim();
    if (!valor) return '';
    if (!/^(https?:)?\/\//i.test(valor)) {
        return `https://${valor}`;
    }
    return valor;
}

function baixarAnexoTarefa(tarefaId, anexoId) {
    const lista = obterTarefasAtual();
    const tarefa = lista.find(t => String(t.id) === String(tarefaId));
    const anexo = tarefa && Array.isArray(tarefa.anexos) ? tarefa.anexos.find(a => a.id === anexoId) : null;
    if (!anexo || !anexo.conteudo) {
        mostrarNotificacao('Anexo não encontrado.', 'error');
        return;
    }
    const link = document.createElement('a');
    link.href = anexo.conteudo;
    link.download = anexo.nome || 'anexo';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function finalizarCriacaoTarefa(tarefa) {
    const lista = Array.isArray(tarefas) ? tarefas : [];
    lista.unshift(tarefa);
    try {
        if (isCloudReady()) {
            await salvarTarefaCloud(tarefa, true);
            salvarTarefasLocal(lista, { skipCloudSync: true });
        } else {
            salvarTarefasLocal(lista);
        }
    } catch (err) {
        salvarTarefasLocal(lista);
    }
    registrarAuditoria('criar', 'tarefa', `Tarefa criada: ${tarefa.titulo}`, null, tarefa);
    mostrarNotificacao('Tarefa criada com sucesso!', 'success');

    const ids = ['tarefaCliente', 'tarefaTitulo', 'tarefaDescricao', 'tarefaObservacoes', 'tarefaLinks', 'tarefaDataLimite', 'tarefaLembrete', 'tarefaAnexos'];
    const elEntidade = document.getElementById('tarefaEntidade');
    if (elEntidade) elEntidade.value = '';
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    const prioridadeEl = document.getElementById('tarefaPrioridade');
    if (prioridadeEl) prioridadeEl.value = 'media';
    aplicarFiltrosTarefas();
}

function gerarTarefas() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const isConvidado = tipoUsuario === 'convidado' || !!appStorage.getItem('convidadoId');
    let clientesParaSelect = Array.isArray(clientes) ? clientes : [];
    let tarefasParaMostrar = obterTarefasAtual();
    const convidadosLista = obterConvidados();
    
    if (isConvidado) {
        clientesParaSelect = clientesParaSelect.filter(c => verificarPermissaoCliente(c.id));
        const convidadoAtualRaw = appStorage.getItem('convidadoId');
        const convidadoAtualId = parseInt(convidadoAtualRaw);
        const convidadosAtuais = obterConvidados();
        const convidadoAtual = convidadosAtuais.find(c =>
            String(c.id) === String(convidadoAtualRaw) || String(c.codigo) === String(convidadoAtualRaw)
        );
        tarefasParaMostrar = tarefasParaMostrar.filter(t =>
            t.responsavelTipo === 'convidado' &&
            (
                (Number.isFinite(convidadoAtualId) && parseInt(t.responsavelId) === convidadoAtualId) ||
                (t.responsavelCodigo && String(t.responsavelCodigo) === String(convidadoAtualRaw)) ||
                (convidadoAtual && String(t.responsavelId) === String(convidadoAtual.id)) ||
                (convidadoAtual && String(t.responsavelCodigo) === String(convidadoAtual.codigo)) ||
                (convidadoAtual && t.responsavelNome && t.responsavelNome === convidadoAtual.nome)
            )
        );
    }
    
    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Tarefas</h2>
                ${isConvidado ? '' : `
                    <button onclick="criarTarefa()" class="btn btn-primary">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Adicionar Tarefa
                    </button>
                `}
            </div>
            
            ${isConvidado ? '' : `
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Nova Tarefa</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="tarefaCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecione</option>
                                ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                            <select id="tarefaProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="contrato">Contrato</option>
                                <option value="heranca">Herança</option>
                                <option value="migracao">Migração</option>
                                <option value="registo">Registo</option>
                                <option value="prazo">Prazo</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                            <select id="tarefaEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" title="Instituição em Portugal (Finanças, IRN, IMT, etc.)">
                                ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                            </select>
                        </div>
                    <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                            <select id="tarefaPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="baixa">Baixa</option>
                                <option value="media" selected>Média</option>
                                <option value="alta">Alta</option>
                                <option value="critica">Crítica</option>
                            </select>
                        </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Responsável</label>
                        <select id="tarefaResponsavel" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="admin">Admin</option>
                            ${convidadosLista.map(c => `<option value="convidado:${c.id}">${c.nome}</option>`).join('')}
                        </select>
                    </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
                            <input id="tarefaTitulo" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: Recolher documentação do cliente">
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                            <textarea id="tarefaDescricao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="3" placeholder="Detalhes adicionais"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="tarefaObservacoes" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="2" placeholder="Observações internas"></textarea>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Links (separados por vírgula)</label>
                            <input id="tarefaLinks" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: https://..., https://...">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Anexos</label>
                            <input id="tarefaAnexos" type="file" multiple class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <p class="text-xs text-gray-500 mt-1">Recomendado até 5 MB por anexo.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data limite</label>
                            <input id="tarefaDataLimite" type="date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lembrete</label>
                            <input id="tarefaLembrete" type="datetime-local" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                    </div>
                </div>
            `}
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros rápidos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                        <input id="filtroTarefasTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="título, cliente, processo..." oninput="aplicarFiltrosTarefas()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="filtroTarefasCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="">Todos</option>
                            ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroTarefasStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="">Todos</option>
                            <option value="aberta">Aberta</option>
                            <option value="concluida">Concluída</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="filtroTarefasPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="">Todas</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="critica">Crítica</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prazo</label>
                        <select id="filtroTarefasPrazo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="">Todos</option>
                            <option value="vencidas">Vencidas</option>
                            <option value="hoje">Hoje</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mês</option>
                            <option value="sem_prazo">Sem prazo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                        <select id="filtroTarefasEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="">Todas</option>
                            ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL.filter(e => e.id) : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por</label>
                        <select id="filtroTarefasOrdenacao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosTarefas()">
                            <option value="prazo">Prazo (data limite)</option>
                            <option value="prioridade">Prioridade</option>
                            <option value="titulo">Título</option>
                            <option value="cliente">Cliente</option>
                            <option value="prioridade_prazo">Prioridade + Prazo</option>
                            <option value="prazo_prioridade">Prazo + Prioridade</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-wrap items-center gap-2 mt-4">
                    <button id="btnSoComPrazo" onclick="alternarFiltroSoComPrazo()" class="btn ${obterFiltroSoComPrazo() ? 'btn-primary' : 'btn-secondary'}" data-ativo="${obterFiltroSoComPrazo() ? 'true' : 'false'}">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        ${obterFiltroSoComPrazo() ? 'Só com prazo: ON' : 'Só com prazo'}
                    </button>
                    <button onclick="aplicarFiltrosTarefas()" class="btn btn-primary">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        Aplicar filtros
                    </button>
                    <button onclick="limparFiltrosTarefas()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Limpar
                    </button>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Tarefas</h3>
                    <div class="text-sm text-gray-600"><span id="contadorTarefas">0</span> tarefas</div>
                </div>
                <div id="listaTarefas" class="space-y-3"></div>
            </div>
        </div>
    `;
}

function limparFiltrosTarefas() {
    ['filtroTarefasTexto', 'filtroTarefasCliente', 'filtroTarefasStatus', 'filtroTarefasPrioridade', 'filtroTarefasPrazo', 'filtroTarefasEntidade'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    const elOrdenar = document.getElementById('filtroTarefasOrdenacao');
    if (elOrdenar) elOrdenar.value = 'prazo';
    const btnSoComPrazo = document.getElementById('btnSoComPrazo');
    if (btnSoComPrazo) {
        btnSoComPrazo.dataset.ativo = 'false';
        btnSoComPrazo.classList.remove('btn-primary');
        btnSoComPrazo.classList.add('btn-secondary');
        btnSoComPrazo.innerHTML = '<i data-lucide="clock" class="w-4 h-4"></i> Só com prazo';
    }
    appStorage.setItem('tarefasFiltroSoComPrazo', 'false');
    aplicarFiltrosTarefas();
}

function alternarFiltroSoComPrazo() {
    const btn = document.getElementById('btnSoComPrazo');
    if (!btn) return;
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const ativo = btn.dataset.ativo === 'true';
    btn.dataset.ativo = ativo ? 'false' : 'true';
    btn.classList.toggle('btn-primary', !ativo);
    btn.classList.toggle('btn-secondary', ativo);
    btn.innerHTML = `<i data-lucide="clock" class="w-4 h-4"></i> ${ativo ? 'Só com prazo' : 'Só com prazo: ON'}`;
    if (tipoUsuario !== 'admin') {
        appStorage.setItem('tarefasFiltroSoComPrazo', ativo ? 'false' : 'true');
    }
    aplicarFiltrosTarefas();
}

function aplicarFiltrosTarefas() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    let lista = Array.isArray(tarefas) ? tarefas : [];
    if (tipoUsuario === 'convidado') {
        const convidadoAtualRaw = appStorage.getItem('convidadoId');
        const convidadoAtualId = parseInt(convidadoAtualRaw);
        const convidadosAtuais = obterConvidados();
        const convidadoAtual = convidadosAtuais.find(c =>
            String(c.id) === String(convidadoAtualRaw) || String(c.codigo) === String(convidadoAtualRaw)
        );
        lista = lista.filter(t =>
            t.responsavelTipo === 'convidado' &&
            (
                (Number.isFinite(convidadoAtualId) && parseInt(t.responsavelId) === convidadoAtualId) ||
                (t.responsavelCodigo && String(t.responsavelCodigo) === String(convidadoAtualRaw)) ||
                (convidadoAtual && String(t.responsavelId) === String(convidadoAtual.id)) ||
                (convidadoAtual && String(t.responsavelCodigo) === String(convidadoAtual.codigo)) ||
                (convidadoAtual && t.responsavelNome && t.responsavelNome === convidadoAtual.nome)
            )
        );
    }
    
    const texto = (document.getElementById('filtroTarefasTexto')?.value || '').toLowerCase();
    const clienteId = document.getElementById('filtroTarefasCliente')?.value || '';
    const status = document.getElementById('filtroTarefasStatus')?.value || '';
    const prioridade = document.getElementById('filtroTarefasPrioridade')?.value || '';
    const prazo = document.getElementById('filtroTarefasPrazo')?.value || '';
    const entidade = document.getElementById('filtroTarefasEntidade')?.value || '';
    const ordenacao = document.getElementById('filtroTarefasOrdenacao')?.value || 'prazo';
    const soComPrazo = document.getElementById('btnSoComPrazo')?.dataset?.ativo === 'true';
    
    if (clienteId) lista = lista.filter(t => String(t.clienteId) === clienteId);
    if (status) lista = lista.filter(t => t.status === status);
    if (prioridade) lista = lista.filter(t => t.prioridade === prioridade);
    if (entidade) lista = lista.filter(t => (t.entidade || '') === entidade);
    if (soComPrazo) lista = lista.filter(t => !!t.dataLimite);
    if (prazo) {
        const agora = new Date();
        const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
        const inicioSemana = new Date(hoje);
        inicioSemana.setDate(hoje.getDate() - hoje.getDay());
        const fimSemana = new Date(inicioSemana);
        fimSemana.setDate(inicioSemana.getDate() + 6);
        const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
        const fimMes = new Date(agora.getFullYear(), agora.getMonth() + 1, 0);
        
        lista = lista.filter(t => {
            if (!t.dataLimite) return prazo === 'sem_prazo';
            const dataLimite = new Date(t.dataLimite);
            if (isNaN(dataLimite.getTime())) return false;
            
            switch (prazo) {
                case 'vencidas':
                    return dataLimite < hoje;
                case 'hoje':
                    return dataLimite.toDateString() === hoje.toDateString();
                case 'semana':
                    return dataLimite >= inicioSemana && dataLimite <= fimSemana;
                case 'mes':
                    return dataLimite >= inicioMes && dataLimite <= fimMes;
                case 'sem_prazo':
                    return false;
                default:
                    return true;
            }
        });
    }
    
    if (texto) {
        lista = lista.filter(t => {
            const alvo = [
                t.titulo,
                t.descricao,
                t.observacoes,
                t.clienteNome,
                t.processoTipo,
                ...(t.links || [])
            ].filter(Boolean).join(' ').toLowerCase();
            return alvo.includes(texto);
        });
    }
    
    const prioridadePeso = (valor) => {
        switch (valor) {
            case 'critica':
                return 4;
            case 'alta':
                return 3;
            case 'media':
                return 2;
            case 'baixa':
                return 1;
            default:
                return 0;
        }
    };
    
    lista = lista.sort((a, b) => {
        if (ordenacao === 'titulo') return (String(a.titulo || '').toLowerCase()).localeCompare(String(b.titulo || '').toLowerCase());
        if (ordenacao === 'cliente') return (String(a.clienteNome || a.cliente || '').toLowerCase()).localeCompare(String(b.clienteNome || b.cliente || '').toLowerCase());
        
        const ordenarPorPrioridade = ordenacao === 'prioridade' || ordenacao === 'prioridade_prazo';
        const ordenarPorPrazo = ordenacao === 'prazo' || ordenacao === 'prazo_prioridade';
        
        if (ordenarPorPrioridade) {
            const pesoA = prioridadePeso(a.prioridade);
            const pesoB = prioridadePeso(b.prioridade);
            if (pesoA !== pesoB) return pesoB - pesoA;
        }
        
        const dataA = a.dataLimite ? new Date(a.dataLimite) : null;
        const dataB = b.dataLimite ? new Date(b.dataLimite) : null;
        if (ordenarPorPrazo || ordenacao === 'prioridade_prazo') {
            if (dataA && dataB) return dataA - dataB;
            if (dataA && !dataB) return -1;
            if (!dataA && dataB) return 1;
        }
        
        if (ordenacao === 'prazo_prioridade') {
            const pesoA = prioridadePeso(a.prioridade);
            const pesoB = prioridadePeso(b.prioridade);
            if (pesoA !== pesoB) return pesoB - pesoA;
        }
        return (b.dataCriacao || '').localeCompare(a.dataCriacao || '');
    });
    
    const limit = Math.max(LISTA_PAGINA_TAMANHO, window.__tarefasLimit || LISTA_PAGINA_TAMANHO);
    const mostrar = lista.slice(0, limit);
    renderizarListaTarefas(mostrar, lista.length, limit);
}

function renderizarListaTarefas(lista, total, limit) {
    total = total ?? lista.length;
    limit = limit ?? lista.length;
    const container = document.getElementById('listaTarefas');
    const contador = document.getElementById('contadorTarefas');
    if (contador) contador.textContent = total;
    if (!container) return;
    
    if (lista.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">Nenhuma tarefa encontrada.</div>';
        return;
    }
    
    const isConvidado = appStorage.getItem('tipoUsuario') === 'convidado' || !!appStorage.getItem('convidadoId');
    const formatarDataHora = (valor) => {
        if (!valor) return '';
        const data = new Date(valor);
        if (isNaN(data.getTime())) return '';
        return data.toLocaleString('pt-PT');
    };
    container.innerHTML = lista.map(tarefa => `
        <div class="flex flex-col gap-2 border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start gap-3">
                <div class="flex-1">
                    <div class="text-sm font-semibold text-gray-800">${tarefa.titulo}</div>
                    <div class="text-xs text-gray-500">${tarefa.descricao || 'Sem descrição'}</div>
                    ${tarefa.observacoes ? `<div class="text-xs text-gray-500">Observações: ${tarefa.observacoes}</div>` : ''}
                    <div class="text-xs text-gray-500">${renderClienteLink(tarefa.clienteId, tarefa.clienteNome || 'Cliente')} • ${tarefa.processoTipo || 'outro'}${tarefa.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? ' • ' + (ENTIDADES_PORTUGAL.find(e => e.id === tarefa.entidade)?.nome || tarefa.entidade) : ''}</div>
                    ${tarefa.responsavelNome ? `<div class="text-xs text-gray-400">Responsável: <span class="font-bold text-gray-700">${escaparHtml(tarefa.responsavelNome)}</span></div>` : ''}
                    ${renderMetaAuditoria('tarefa', tarefa)}
                    ${tarefa.dataLimite ? `<div class="text-xs text-gray-400">Prazo: ${new Date(tarefa.dataLimite).toLocaleDateString('pt-PT')}</div>` : ''}
                    ${tarefa.concluidaPorNome ? `<div class="text-xs text-gray-400">Concluída por: ${escaparHtml(tarefa.concluidaPorNome)}${tarefa.concluidaEm ? ` em ${new Date(tarefa.concluidaEm).toLocaleString('pt-PT')}` : ''}</div>` : ''}
                    ${tarefa.lembreteEm ? `<div class="text-xs text-gray-400">Lembrete: ${formatarDataHora(tarefa.lembreteEm)}</div>` : ''}
                    ${tarefa.links && tarefa.links.length ? `
                        <div class="text-xs text-gray-400">
                            Links:
                            ${tarefa.links.map(link => {
                                const href = normalizarLinkTarefa(link);
                                return href ? `<a href="${href}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline mr-2">${link}</a>` : '';
                            }).join('')}
                        </div>
                    ` : ''}
                    ${tarefa.anexos && tarefa.anexos.length ? `
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${tarefa.anexos.map(anexo => `
                                <button onclick="baixarAnexoTarefa(${JSON.stringify(tarefa.id)}, ${JSON.stringify(anexo.id)})" class="text-xs text-blue-600 hover:text-blue-800 underline">
                                    ${anexo.nome}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="flex items-center gap-2">
                    <span class="status-badge status-${tarefa.prioridade || 'media'}">${tarefa.prioridade || 'media'}</span>
                    <span class="status-badge status-${tarefa.status}">${tarefa.status === 'concluida' ? 'Concluída' : 'Aberta'}</span>
                </div>
            </div>
            ${isConvidado ? `
                <div class="flex items-center gap-2">
                    <button type="button" data-tarefa-id="${String(tarefa.id).replace(/"/g, '&quot;')}" data-tarefa-acao="concluir" class="btn btn-secondary btn-acao-tarefa" ${tarefa.status === 'concluida' ? 'disabled' : ''}>
                        <i data-lucide="check" class="w-4 h-4" style="pointer-events:none"></i>
                        ${tarefa.status === 'concluida' ? 'Concluída' : 'Concluir'}
                    </button>
                </div>
            ` : `
                <div class="flex items-center gap-2">
                    <button type="button" data-tarefa-id="${String(tarefa.id).replace(/"/g, '&quot;')}" data-tarefa-acao="editar" class="btn btn-secondary btn-acao-tarefa">
                        <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                        Editar
                    </button>
                    <button type="button" data-tarefa-id="${String(tarefa.id).replace(/"/g, '&quot;')}" data-tarefa-acao="alterar-status" class="btn btn-secondary btn-acao-tarefa">
                        <i data-lucide="${tarefa.status === 'concluida' ? 'rotate-ccw' : 'check'}" class="w-4 h-4" style="pointer-events:none"></i>
                        ${tarefa.status === 'concluida' ? 'Reabrir' : 'Concluir'}
                    </button>
                    <button type="button" data-tarefa-id="${String(tarefa.id).replace(/"/g, '&quot;')}" data-tarefa-acao="excluir" class="btn btn-danger btn-acao-tarefa">
                        <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                        Excluir
                    </button>
                </div>
            `}
        </div>
    `).join('');
    const verMais = total > limit ? `<div class="flex justify-center py-4"><button type="button" onclick="window.__tarefasLimit = (window.__tarefasLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosTarefas();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></div>` : '';
    container.innerHTML = container.innerHTML + verMais;
    lucide.createIcons();
    removerBotoesAnexos();
    // Listener de clique nos botões (delegação no contentor)
    const listaEl = document.getElementById('listaTarefas');
    if (listaEl && !listaEl._tarefaListener) {
        listaEl._tarefaListener = true;
        listaEl.addEventListener('click', function(ev) {
            const btn = ev.target.closest('[data-tarefa-acao][data-tarefa-id]');
            if (!btn || btn.disabled) return;
            const id = btn.getAttribute('data-tarefa-id');
            const acao = btn.getAttribute('data-tarefa-acao');
            if (!id || !acao) return;
            ev.preventDefault();
            if (acao === 'editar') abrirModalEditarTarefa(id);
            else if (acao === 'alterar-status') alterarStatusTarefa(id);
            else if (acao === 'excluir') excluirTarefa(id);
            else if (acao === 'concluir') concluirTarefaConvidado(id);
        });
    }
}

function criarTarefa() {
    if (!exigirPermissaoAcao('criar', 'tarefa')) {
        return;
    }
    const clienteId = parseIdSafe(document.getElementById('tarefaCliente')?.value || '');
    const processoTipo = document.getElementById('tarefaProcessoTipo')?.value || 'outro';
    const entidade = document.getElementById('tarefaEntidade')?.value || '';
    const prioridade = document.getElementById('tarefaPrioridade')?.value || 'media';
    const responsavelRaw = document.getElementById('tarefaResponsavel')?.value || 'admin';
    const titulo = document.getElementById('tarefaTitulo')?.value?.trim() || '';
    const descricao = document.getElementById('tarefaDescricao')?.value?.trim() || '';
    const observacoes = document.getElementById('tarefaObservacoes')?.value?.trim() || '';
    const linksRaw = document.getElementById('tarefaLinks')?.value || '';
    const links = linksRaw.split(',').map(item => item.trim()).filter(Boolean);
    const dataLimite = document.getElementById('tarefaDataLimite')?.value || '';
    const lembreteValor = document.getElementById('tarefaLembrete')?.value || '';
    const lembreteData = lembreteValor ? new Date(lembreteValor) : null;
    if (lembreteValor && (!lembreteData || isNaN(lembreteData.getTime()))) {
        mostrarNotificacao('Data/hora do lembrete inválida.', 'warning');
        return;
    }
    const anexosInput = document.getElementById('tarefaAnexos');
    const arquivos = anexosInput && anexosInput.files ? Array.from(anexosInput.files) : [];
    const maxAnexo = 5 * 1024 * 1024;
    const anexoGrande = arquivos.find(arquivo => arquivo.size > maxAnexo);
    if (anexoGrande) {
        mostrarNotificacao('Anexo acima de 5 MB. Tente um ficheiro menor.', 'error');
        return;
    }
    
    if (!clienteId) {
        mostrarNotificacao('Selecione o cliente da tarefa.', 'warning');
        return;
    }
    if (!titulo) {
        mostrarNotificacao('Informe o título da tarefa.', 'warning');
        return;
    }
    
    const cliente = clientes.find(c => c.id === clienteId);
    let responsavelTipo = 'admin';
    let responsavelId = null;
    let responsavelCodigo = null;
    let responsavelNome = 'Admin';
    if (responsavelRaw.startsWith('convidado:')) {
        responsavelTipo = 'convidado';
        responsavelId = responsavelRaw.split(':')[1]; // manter string (UUID ou número)
        const convidado = obterConvidados().find(c => String(c.id) === String(responsavelId) || String(c.codigo) === String(responsavelId));
        responsavelCodigo = convidado ? (convidado.codigo || null) : null;
        responsavelNome = convidado ? convidado.nome : 'Convidado';
    }

    const tarefa = {
        id: gerarIdImutavel(),
        clienteId,
        clienteNome: cliente ? cliente.nome : '',
        processoTipo,
        entidade,
        titulo,
        descricao,
        observacoes,
        links,
        prioridade,
        responsavelTipo,
        responsavelId,
        responsavelCodigo,
        responsavelNome,
        status: 'aberta',
        dataLimite: dataLimite || null,
        lembreteEm: lembreteData ? lembreteData.toISOString() : null,
        lembreteDisparado: false,
        anexos: [],
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D',
        dataCriacao: new Date().toISOString()
    };

    if (arquivos.length === 0) {
        finalizarCriacaoTarefa(tarefa);
        return;
    }

    mostrarNotificacao('Anexos em tarefas foram desativados para evitar perda de dados.', 'warning');
    tarefa.anexos = [];
    finalizarCriacaoTarefa(tarefa);
}

function formatarDataHoraLocal(valor) {
    if (!valor) return '';
    const data = new Date(valor);
    if (isNaN(data.getTime())) return '';
    const pad = (n) => String(n).padStart(2, '0');
    return `${data.getFullYear()}-${pad(data.getMonth() + 1)}-${pad(data.getDate())}T${pad(data.getHours())}:${pad(data.getMinutes())}`;
}

function abrirModalEditarTarefa(id) {
    const lista = Array.isArray(tarefas) ? tarefas : [];
    const tarefa = lista.find(t => String(t.id) === String(id));
    if (!tarefa) {
        mostrarNotificacao('Tarefa não encontrada.', 'error');
        return;
    }
    if (!exigirPermissaoAcaoItem('editar', 'tarefa', tarefa)) return;

    const clientesParaSelect = Array.isArray(clientes) ? clientes : [];
    const convidadosLista = obterConvidados();
    const linksValor = Array.isArray(tarefa.links) ? tarefa.links.join(', ') : '';
    const responsavelAtual = tarefa.responsavelTipo === 'convidado' && tarefa.responsavelId
        ? `convidado:${tarefa.responsavelId}`
        : 'admin';
    const modal = `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content" style="max-width: 720px;" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Editar Tarefa</h3>
                <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form onsubmit="atualizarTarefa(event, ${JSON.stringify(tarefa.id)})" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                        <select id="editarTarefaCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Selecione</option>
                            ${clientesParaSelect.map(cliente => `<option value="${cliente.id}" ${cliente.id === tarefa.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                        <select id="editarTarefaProcesso" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="contrato" ${tarefa.processoTipo === 'contrato' ? 'selected' : ''}>Contrato</option>
                            <option value="heranca" ${tarefa.processoTipo === 'heranca' ? 'selected' : ''}>Herança</option>
                            <option value="migracao" ${tarefa.processoTipo === 'migracao' ? 'selected' : ''}>Migração</option>
                            <option value="registo" ${tarefa.processoTipo === 'registo' ? 'selected' : ''}>Registo</option>
                            <option value="prazo" ${tarefa.processoTipo === 'prazo' ? 'selected' : ''}>Prazo</option>
                            <option value="outro" ${tarefa.processoTipo === 'outro' ? 'selected' : ''}>Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="editarTarefaPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="baixa" ${tarefa.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                            <option value="media" ${tarefa.prioridade === 'media' ? 'selected' : ''}>Média</option>
                            <option value="alta" ${tarefa.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                            <option value="critica" ${tarefa.prioridade === 'critica' ? 'selected' : ''}>Crítica</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                        <select id="editarTarefaEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}" ${(tarefa.entidade || '') === e.id ? 'selected' : ''}>${e.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Responsável</label>
                        <select id="editarTarefaResponsavel" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="admin" ${responsavelAtual === 'admin' ? 'selected' : ''}>Admin</option>
                            ${convidadosLista.map(c => `<option value="convidado:${c.id}" ${responsavelAtual === `convidado:${c.id}` ? 'selected' : ''}>${c.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="editarTarefaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="aberta" ${tarefa.status === 'aberta' ? 'selected' : ''}>Aberta</option>
                            <option value="concluida" ${tarefa.status === 'concluida' ? 'selected' : ''}>Concluída</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
                        <input id="editarTarefaTitulo" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" value="${escaparHtml(tarefa.titulo || '')}" required>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                        <textarea id="editarTarefaDescricao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="3">${escaparHtml(tarefa.descricao || '')}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea id="editarTarefaObservacoes" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" rows="2">${escaparHtml(tarefa.observacoes || '')}</textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Links (separados por vírgula)</label>
                        <input id="editarTarefaLinks" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" value="${escaparHtml(linksValor)}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data limite</label>
                        <input id="editarTarefaDataLimite" type="date" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" value="${tarefa.dataLimite ? new Date(tarefa.dataLimite).toISOString().split('T')[0] : ''}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Lembrete</label>
                        <input id="editarTarefaLembrete" type="datetime-local" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" value="${formatarDataHoraLocal(tarefa.lembreteEm)}">
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
            </div>
        </div>
    `;
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('modalContainer não encontrado!');
        return;
    }
    modalContainer.innerHTML = modal;
    modalContainer.classList.add('show');
    lucide.createIcons();
}

async function atualizarTarefa(event, id) {
    event.preventDefault();
    const lista = obterTarefasAtual();
    const index = lista.findIndex(t => String(t.id) === String(id));
    if (index === -1) {
        mostrarNotificacao('Tarefa não encontrada.', 'error');
        return;
    }
    if (!exigirPermissaoAcaoItem('editar', 'tarefa', lista[index])) return;

    const clienteId = parseIdSafe(document.getElementById('editarTarefaCliente')?.value || '');
    const processoTipo = document.getElementById('editarTarefaProcesso')?.value || 'outro';
    const entidade = document.getElementById('editarTarefaEntidade')?.value || '';
    const prioridade = document.getElementById('editarTarefaPrioridade')?.value || 'media';
    const responsavelRaw = document.getElementById('editarTarefaResponsavel')?.value || 'admin';
    const status = document.getElementById('editarTarefaStatus')?.value || 'aberta';
    const titulo = document.getElementById('editarTarefaTitulo')?.value?.trim() || '';
    const descricao = document.getElementById('editarTarefaDescricao')?.value?.trim() || '';
    const observacoes = document.getElementById('editarTarefaObservacoes')?.value?.trim() || '';
    const linksRaw = document.getElementById('editarTarefaLinks')?.value || '';
    const links = linksRaw.split(',').map(item => item.trim()).filter(Boolean);
    const dataLimite = document.getElementById('editarTarefaDataLimite')?.value || '';
    const lembreteValor = document.getElementById('editarTarefaLembrete')?.value || '';
    const lembreteData = lembreteValor ? new Date(lembreteValor) : null;
    if (lembreteValor && (!lembreteData || isNaN(lembreteData.getTime()))) {
        mostrarNotificacao('Data/hora do lembrete inválida.', 'warning');
        return;
    }
    if (!clienteId) {
        mostrarNotificacao('Selecione o cliente da tarefa.', 'warning');
        return;
    }
    if (!titulo) {
        mostrarNotificacao('Informe o título da tarefa.', 'warning');
        return;
    }

    const cliente = clientes.find(c => c.id === clienteId);
    let responsavelTipo = 'admin';
    let responsavelId = null;
    let responsavelCodigo = null;
    let responsavelNome = 'Admin';
    if (responsavelRaw.startsWith('convidado:')) {
        responsavelTipo = 'convidado';
        responsavelId = responsavelRaw.split(':')[1]; // manter string (codigo ou id)
        const convidado = obterConvidados().find(c => String(c.id) === String(responsavelId) || String(c.codigo) === String(responsavelId));
        responsavelCodigo = convidado ? (convidado.codigo || null) : null;
        responsavelNome = convidado ? convidado.nome : 'Convidado';
    }
    const antes = { ...lista[index] };
    lista[index] = {
        ...lista[index],
        clienteId,
        clienteNome: cliente ? cliente.nome : (lista[index].clienteNome || ''),
        processoTipo,
        entidade,
        prioridade,
        status,
        titulo,
        descricao,
        observacoes,
        links,
        responsavelTipo,
        responsavelId,
        responsavelCodigo,
        responsavelNome,
        dataLimite,
        lembreteEm: lembreteData ? lembreteData.toISOString() : null,
        dataAtualizacao: new Date().toISOString()
    };
    if (lembreteData) {
        lista[index].lembreteDisparado = false;
    }
    try {
        if (isCloudReady()) {
            await salvarTarefaCloud(lista[index]);
            salvarTarefasLocal(lista, { skipCloudSync: true });
        } else {
            salvarTarefasLocal(lista);
        }
    } catch (err) {
        salvarTarefasLocal(lista);
    }
    registrarAuditoria('editar', 'tarefa', `Tarefa atualizada: ${lista[index].titulo}`, antes, lista[index]);
    mostrarNotificacao('Tarefa atualizada com sucesso!', 'success');
    fecharModalRobusto();
    aplicarFiltrosTarefas();
}

async function alterarStatusTarefa(id) {
    const lista = obterTarefasAtual();
    const index = lista.findIndex(t => String(t.id) === String(id));
    if (index === -1) {
        mostrarNotificacao('Tarefa não encontrada.', 'error');
        return;
    }
    if (!exigirPermissaoAcaoItem('editar', 'tarefa', lista[index])) return;
    const antes = { ...lista[index] };
    lista[index].status = lista[index].status === 'concluida' ? 'aberta' : 'concluida';
    if (lista[index].status === 'concluida') {
        lista[index].concluidaEm = new Date().toISOString();
        lista[index].concluidaPorTipo = appStorage.getItem('tipoUsuario') || 'admin';
        lista[index].concluidaPorNome = appStorage.getItem('usuarioNome') || 'Admin';
    } else {
        lista[index].concluidaEm = null;
        lista[index].concluidaPorTipo = null;
        lista[index].concluidaPorNome = null;
    }
    try {
        if (isCloudReady()) {
            await salvarTarefaCloud(lista[index]);
            salvarTarefasLocal(lista, { skipCloudSync: true });
        } else {
            salvarTarefasLocal(lista);
        }
    } catch (err) {
        salvarTarefasLocal(lista);
    }
    registrarAuditoria('editar', 'tarefa', `Status da tarefa: ${lista[index].titulo}`, antes, lista[index]);
    aplicarFiltrosTarefas();
}

async function concluirTarefaConvidado(id) {
    const lista = obterTarefasAtual();
    const index = lista.findIndex(t => String(t.id) === String(id));
    if (index === -1) return;
    if (!exigirPermissaoAcaoItem('editar', 'tarefa', lista[index])) return;
    if (lista[index].status === 'concluida') {
        mostrarNotificacao('Tarefa já está concluída.', 'info');
        return;
    }
    const antes = { ...lista[index] };
    lista[index].status = 'concluida';
    lista[index].concluidaEm = new Date().toISOString();
    lista[index].concluidaPorTipo = appStorage.getItem('tipoUsuario') || 'convidado';
    lista[index].concluidaPorNome = appStorage.getItem('usuarioNome') || 'Convidado';
    try {
        if (isCloudReady()) {
            await salvarTarefaCloud(lista[index]);
            salvarTarefasLocal(lista, { skipCloudSync: true });
        } else {
            salvarTarefasLocal(lista);
        }
    } catch (err) {
        salvarTarefasLocal(lista);
    }
    registrarAuditoria('editar', 'tarefa', `Tarefa concluída pelo convidado: ${lista[index].titulo}`, antes, lista[index]);
    mostrarNotificacao('Tarefa marcada como concluída.', 'success');
    aplicarFiltrosTarefas();
}

async function excluirTarefa(id) {
    if (!exigirPermissaoAcao('apagar', 'tarefa')) return;
    const lista = obterTarefasAtual();
    const tarefa = lista.find(t => String(t.id) === String(id));
    if (!tarefa) {
        mostrarNotificacao('Tarefa não encontrada.', 'error');
        return;
    }
    if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
    const novas = lista.filter(t => String(t.id) !== String(id));
    try {
        if (isCloudReady()) {
            await apagarTarefaCloud(id);
            tarefas = novas;
            window.tarefas = tarefas;
            salvarTarefasLocal(novas, { skipCloudSync: true });
        } else {
            salvarTarefasLocal(novas);
        }
        registrarAuditoria('excluir', 'tarefa', `Tarefa excluída: ${tarefa.titulo}`, tarefa, null);
        aplicarFiltrosTarefas();
        mostrarNotificacao('Tarefa excluída com sucesso!', 'success');
    } catch (err) {
        console.warn('Erro ao apagar tarefa na nuvem:', err);
        salvarTarefasLocal(novas);
        registrarAuditoria('excluir', 'tarefa', `Tarefa excluída: ${tarefa.titulo}`, tarefa, null);
        aplicarFiltrosTarefas();
        mostrarNotificacao('Tarefa excluída com sucesso!', 'success');
    }
}

function formatarDataLocalCalendario(data) {
    const ano = data.getFullYear();
    const mes = String(data.getMonth() + 1).padStart(2, '0');
    const dia = String(data.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
}

function normalizarDataCalendario(valor) {
    if (!valor) return null;
    const data = new Date(valor);
    if (isNaN(data)) return null;
    return new Date(data.getFullYear(), data.getMonth(), data.getDate());
}

function obterPrazosDoDia(data) {
    const alvo = formatarDataLocalCalendario(data);
    const lista = obterPrazosAtual();
    return lista.filter(prazo => {
        if (!prazo.dataLimite) return false;
        if (calendarioFiltroCliente) {
            const clienteId = String(prazo.clienteId || '');
            if (clienteId !== String(calendarioFiltroCliente)) return false;
        }
        if (calendarioFiltroStatus) {
            if (String(prazo.status || '') !== String(calendarioFiltroStatus)) return false;
        }
        if (calendarioFiltroTipo) {
            const tipo = String(prazo.tipo || '').toLowerCase();
            if (tipo !== String(calendarioFiltroTipo)) return false;
        }
        if (calendarioFiltroPrioridade) {
            const prioridade = String(prazo.prioridade || '').toLowerCase();
            if (prioridade !== String(calendarioFiltroPrioridade)) return false;
        }
        const dataPrazo = normalizarDataCalendario(prazo.dataLimite);
        if (!dataPrazo) return false;
        return formatarDataLocalCalendario(dataPrazo) === alvo;
    });
}

function gerarCalendarioPrazos() {
    return `
        <div class="space-y-6">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <h2 class="text-2xl font-bold">Calendário de Prazos</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="abrirModalCriarPrazo()" class="btn btn-primary">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Novo Prazo
                    </button>
                    <button onclick="moverCalendario(-1)" class="btn btn-secondary">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                    <button onclick="irHojeCalendario()" class="btn btn-secondary">Hoje</button>
                    <button onclick="moverCalendario(1)" class="btn btn-secondary">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                    <button onclick="alterarModoCalendario('mensal')" class="btn btn-primary">Mês</button>
                    <button onclick="alterarModoCalendario('semanal')" class="btn btn-secondary">Semana</button>
                </div>
            </div>
            
            <div class="card p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="calendarioFiltroCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                            <option value="">Todos os clientes</option>
                            ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="calendarioFiltroStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativo</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="vencido">Vencido</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="calendarioFiltroTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                            <option value="">Todos os tipos</option>
                            <option value="contrato">Contrato</option>
                            <option value="heranca">Herança</option>
                            <option value="migracao">Migração</option>
                            <option value="registo">Registo</option>
                            <option value="prazo">Prazo</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                        <select id="calendarioFiltroPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosCalendario()">
                            <option value="">Todas</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="critica">Crítica</option>
                        </select>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-4">
                    <div class="flex items-center gap-2">
                        <span class="calendario-item calendario-prioridade-baixa">Baixa</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="calendario-item calendario-prioridade-media">Média</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="calendario-item calendario-prioridade-alta">Alta</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="calendario-item calendario-prioridade-critica">Crítica</span>
                    </div>
                </div>
                <div id="calendarioTitulo" class="text-lg font-semibold mb-4"></div>
                <div id="calendarioGrid"></div>
            </div>
        </div>
    `;
}

function inicializarCalendarioPrazos() {
    const select = document.getElementById('calendarioFiltroCliente');
    if (select) {
        select.value = calendarioFiltroCliente || '';
    }
    const selectStatus = document.getElementById('calendarioFiltroStatus');
    if (selectStatus) {
        selectStatus.value = calendarioFiltroStatus || '';
    }
    const selectTipo = document.getElementById('calendarioFiltroTipo');
    if (selectTipo) {
        selectTipo.value = calendarioFiltroTipo || '';
    }
    const selectPrioridade = document.getElementById('calendarioFiltroPrioridade');
    if (selectPrioridade) {
        selectPrioridade.value = calendarioFiltroPrioridade || '';
    }
    atualizarCalendarioPrazos();
    lucide.createIcons();
}

function aplicarFiltrosCalendario() {
    const select = document.getElementById('calendarioFiltroCliente');
    const selectStatus = document.getElementById('calendarioFiltroStatus');
    const selectTipo = document.getElementById('calendarioFiltroTipo');
    const selectPrioridade = document.getElementById('calendarioFiltroPrioridade');
    calendarioFiltroCliente = select ? select.value : '';
    calendarioFiltroStatus = selectStatus ? selectStatus.value : '';
    calendarioFiltroTipo = selectTipo ? selectTipo.value : '';
    calendarioFiltroPrioridade = selectPrioridade ? selectPrioridade.value : '';
    window.calendarioFiltroCliente = calendarioFiltroCliente;
    window.calendarioFiltroStatus = calendarioFiltroStatus;
    window.calendarioFiltroTipo = calendarioFiltroTipo;
    window.calendarioFiltroPrioridade = calendarioFiltroPrioridade;
    atualizarCalendarioPrazos();
}

function alterarModoCalendario(modo) {
    calendarioModo = modo;
    window.calendarioModo = calendarioModo;
    atualizarCalendarioPrazos();
}

function moverCalendario(direcao) {
    const atual = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
    if (calendarioModo === 'semanal') {
        atual.setDate(atual.getDate() + (direcao * 7));
    } else {
        atual.setMonth(atual.getMonth() + direcao);
    }
    calendarioDataRef = atual;
    window.calendarioDataRef = calendarioDataRef;
    atualizarCalendarioPrazos();
}

function irHojeCalendario() {
    calendarioDataRef = new Date();
    window.calendarioDataRef = calendarioDataRef;
    atualizarCalendarioPrazos();
}

function atualizarCalendarioPrazos() {
    const titulo = document.getElementById('calendarioTitulo');
    const grid = document.getElementById('calendarioGrid');
    if (!titulo || !grid) return;
    
    if (calendarioModo === 'semanal') {
        const dataRef = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
        const diaSemana = (dataRef.getDay() + 6) % 7;
        const inicioSemana = new Date(dataRef.getFullYear(), dataRef.getMonth(), dataRef.getDate() - diaSemana);
        const fimSemana = new Date(inicioSemana.getFullYear(), inicioSemana.getMonth(), inicioSemana.getDate() + 6);
        titulo.textContent = `Semana de ${inicioSemana.toLocaleDateString('pt-PT')} até ${fimSemana.toLocaleDateString('pt-PT')}`;
        grid.innerHTML = gerarSemanaCalendario(inicioSemana);
    } else {
        const dataRef = calendarioDataRef instanceof Date ? calendarioDataRef : new Date(calendarioDataRef);
        const mesExtenso = dataRef.toLocaleDateString('pt-PT', { month: 'long', year: 'numeric' });
        titulo.textContent = mesExtenso.charAt(0).toUpperCase() + mesExtenso.slice(1);
        grid.innerHTML = gerarMesCalendario(dataRef.getFullYear(), dataRef.getMonth());
    }
}

function gerarMesCalendario(ano, mes) {
    const primeiroDia = new Date(ano, mes, 1);
    const offset = (primeiroDia.getDay() + 6) % 7;
    const inicio = new Date(ano, mes, 1 - offset);
    const hoje = formatarDataLocalCalendario(new Date());
    
    const diasSemana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
    let html = `
        <div class="grid grid-cols-7 text-xs text-gray-500 mb-2">
            ${diasSemana.map(dia => `<div class="text-center font-semibold">${dia}</div>`).join('')}
        </div>
        <div class="grid grid-cols-7 gap-2">
    `;
    
    for (let i = 0; i < 42; i++) {
        const dataAtual = new Date(inicio.getFullYear(), inicio.getMonth(), inicio.getDate() + i);
        const dataLocal = formatarDataLocalCalendario(dataAtual);
        const pertenceMes = dataAtual.getMonth() === mes;
        const prazosDia = obterPrazosDoDia(dataAtual);
        const extra = prazosDia.length > 3 ? prazosDia.length - 3 : 0;
        
        html += `
            <div class="border rounded-lg p-2 min-h-[90px] ${pertenceMes ? 'bg-white' : 'bg-gray-50 text-gray-400'} ${dataLocal === hoje ? 'border-blue-400' : 'border-gray-200'}" onclick="abrirModalCriarPrazo('${dataLocal}')">
                <div class="text-xs font-semibold mb-1">${dataAtual.getDate()}</div>
                <div class="space-y-1">
                    ${prazosDia.slice(0, 3).map(prazo => `
                        <button type="button" onclick="event.stopPropagation(); editarItem('prazo', ${JSON.stringify(prazo.id)})" class="text-[11px] text-gray-700 truncate calendario-item calendario-prioridade-${prazo.prioridade || 'media'}" style="cursor: pointer; width: 100%; text-align: left;">
                            <span class="status-badge status-${prazo.prioridade || 'media'}">${prazo.prioridade || 'media'}</span>
                            ${prazo.descricao || prazo.tipo || 'Prazo'}
                        </button>
                    `).join('')}
                    ${extra > 0 ? `<div class="text-[11px] text-gray-400">+${extra} mais</div>` : ''}
                </div>
            </div>
        `;
    }
    html += '</div>';
    return html;
}

function gerarSemanaCalendario(inicioSemana) {
    const diasSemana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
    const hoje = formatarDataLocalCalendario(new Date());
    let html = '<div class="grid grid-cols-7 gap-2">';
    
    for (let i = 0; i < 7; i++) {
        const dataAtual = new Date(inicioSemana.getFullYear(), inicioSemana.getMonth(), inicioSemana.getDate() + i);
        const dataLocal = formatarDataLocalCalendario(dataAtual);
        const prazosDia = obterPrazosDoDia(dataAtual);
        
        html += `
            <div class="border rounded-lg p-3 min-h-[140px] ${dataLocal === hoje ? 'border-blue-400' : 'border-gray-200'}" onclick="abrirModalCriarPrazo('${dataLocal}')">
                <div class="text-xs font-semibold text-gray-500 mb-2">${diasSemana[i]} • ${dataAtual.toLocaleDateString('pt-PT')}</div>
                <div class="space-y-2">
                    ${prazosDia.length ? prazosDia.map(prazo => `
                        <button type="button" onclick="event.stopPropagation(); editarItem('prazo', ${JSON.stringify(prazo.id)})" class="text-xs text-gray-700 border border-gray-200 rounded p-2 calendario-item calendario-prioridade-${prazo.prioridade || 'media'}" style="cursor: pointer; width: 100%; text-align: left;">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="status-badge status-${prazo.prioridade || 'media'}">${prazo.prioridade || 'media'}</span>
                                <span class="font-semibold">${prazo.descricao || prazo.tipo || 'Prazo'}</span>
                            </div>
                            <div class="text-[11px] text-gray-500">${renderClienteLink(prazo.clienteId, prazo.clienteNome || prazo.cliente || '')}</div>
                        </button>
                    `).join('') : '<div class="text-xs text-gray-400">Sem prazos</div>'}
                </div>
            </div>
        `;
    }
    html += '</div>';
    return html;
}

function gerarRelatorios() {
    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Relatórios</h2>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Relatório Financeiro por Cliente</h3>
                    <p class="text-gray-600 mb-4">Relatório financeiro personalizado por cliente específico</p>
                    <button onclick="gerarRelatorioFinanceiroCliente()" class="btn btn-warning">
                        <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                        Gerar
                    </button>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Relatório Geral</h3>
                    <p class="text-gray-600 mb-4">Relatório completo do sistema</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="gerarRelatorioCompleto()" class="btn btn-secondary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            PDF
                        </button>
                        <button onclick="imprimirRelatorioCompletoComoPdf()" class="btn btn-primary" title="Imprimir ou guardar como PDF">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            PDF / Imprimir
                        </button>
                    </div>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Relatório por Cliente</h3>
                    <p class="text-gray-600 mb-4">Relatório personalizado por cliente específico</p>
                    <button onclick="gerarRelatorioCliente()" class="btn btn-secondary">
                        <i data-lucide="user-check" class="w-4 h-4"></i>
                        Gerar
                    </button>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Relatório Geral por Cliente</h3>
                    <p class="text-gray-600 mb-4">Relatório geral personalizado por cliente específico</p>
                    <button onclick="gerarRelatorioGeralCliente()" class="btn btn-info">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        Gerar
                    </button>
                </div>
                
                <div class="card p-6 md:col-span-2 lg:col-span-3">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-semibold">Relatórios Avançados</h3>
                            <p class="text-gray-600">Filtros por datas, cliente e tipo com exportação em Excel (CSV) e PDF.</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="btnExportarCsvRelatorio" class="btn btn-secondary" aria-label="Exportar relatório em formato Excel (CSV)">
                                <i data-lucide="table" class="w-4 h-4"></i>
                                Exportar Excel
                            </button>
                            <button id="btnExportarPdfRelatorio" class="btn btn-primary" aria-label="Exportar relatório em formato PDF">
                                <i data-lucide="file-text" class="w-4 h-4"></i>
                                Exportar PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                            <select id="relatorioAvancadoCliente" class="form-control" aria-label="Filtrar por cliente">
                                <option value="">Todos os clientes</option>
                                ${(Array.isArray(clientes) ? clientes : []).map(cliente => 
                                    `<option value="${String(cliente.nome || '').replace(/"/g, '&quot;')}">${escaparHtml(cliente.nome || '')}${cliente.email ? ' (' + escaparHtml(cliente.email) + ')' : ''}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                            <select id="relatorioAvancadoTipo" class="form-control" aria-label="Filtrar por tipo de registo">
                                <option value="todos">Todos</option>
                                <option value="honorarios">Honorários</option>
                                <option value="contratos">Contratos</option>
                                <option value="herancas">Heranças</option>
                                <option value="migracoes">Migrações</option>
                                <option value="registos">Registos</option>
                                <option value="prazos">Prazos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="relatorioAvancadoDataInicio">Data início</label>
                            <input type="date" id="relatorioAvancadoDataInicio" class="form-control" aria-label="Data de início do relatório" max="${new Date().toISOString().slice(0,10)}" title="Selecione a data inicial">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" for="relatorioAvancadoDataFim">Data fim</label>
                            <input type="date" id="relatorioAvancadoDataFim" class="form-control" aria-label="Data de fim do relatório" max="${new Date().toISOString().slice(0,10)}" title="Selecione a data final (não pode ser antes da data início)">
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap items-center gap-3 mb-4">
                        <button id="btnAplicarFiltrosRelatorio" class="btn btn-success" aria-label="Aplicar filtros ao relatório">
                            <i data-lucide="filter" class="w-4 h-4"></i>
                            Aplicar filtros
                        </button>
                        <button id="btnLimparFiltrosRelatorio" type="button" class="btn btn-secondary" aria-label="Limpar todos os filtros do relatório">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            Limpar filtros
                        </button>
                        <span id="relatorioAvancadoResumo" class="text-sm text-gray-500">Nenhum filtro aplicado.</span>
                    </div>
                    
                    <div id="relatorioAvancadoResultados" class="overflow-x-auto text-sm text-gray-600" role="region" aria-live="polite" aria-label="Resultados do relatório avançado">
                        Aplique filtros para visualizar os resultados.
                    </div>
                </div>
            </div>
        </div>
    `;
}

function formatarTamanhoArquivo(bytes) {
    if (!bytes && bytes !== 0) return 'N/D';
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}

function salvarDocumentosLocal(novos) {
    documentos = novos;
    window.documentos = documentos;
    salvarDados('documentos', documentos);
}

/** Logos para documentos PDF — tenta logo.png primeiro, depois ana.jpg (relativo à raiz do site). */
const LOGO_EMPRESA_URLS = ['logo.png', 'ana.jpg'];

/** Carrega a logo como base64 para incluir em PDFs. Devolve null se falhar. */
function carregarLogoBase64() {
    return new Promise((resolve) => {
        const base = (document.querySelector('base')?.href || window.location.origin + '/').replace(/\/$/, '') + '/';
        const urls = LOGO_EMPRESA_URLS.map(nome => base + nome);
        let idx = 0;
        function tentarProximo() {
            if (idx >= urls.length) { resolve(null); return; }
            try {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth || img.width;
                        canvas.height = img.naturalHeight || img.height;
                        const ctx = canvas.getContext('2d');
                        if (ctx) {
                            ctx.drawImage(img, 0, 0);
                            const isPng = (urls[idx] || '').toLowerCase().endsWith('.png');
                            resolve(canvas.toDataURL(isPng ? 'image/png' : 'image/jpeg', 0.9));
                        } else resolve(null);
                    } catch (e) { resolve(null); }
                };
                img.onerror = () => { idx++; tentarProximo(); };
                img.src = urls[idx];
            } catch (e) { idx++; tentarProximo(); }
        }
        tentarProximo();
    });
}

/** Adiciona a logo ao topo do PDF e devolve o y onde deve começar o conteúdo. */
async function adicionarLogoAoPdf(doc, margin) {
    const marginY = margin || 20;
    const logoData = await carregarLogoBase64();
    if (!logoData || !doc) return marginY;
    try {
        const pageWidth = doc.internal.pageSize.getWidth();
        const logoLargura = 40;
        const logoAltura = 22;
        const x = (pageWidth - logoLargura) / 2;
        const formato = logoData.indexOf('data:image/png') === 0 ? 'PNG' : 'JPEG';
        doc.addImage(logoData, formato, x, marginY - 5, logoLargura, logoAltura);
        return marginY + logoAltura + 10;
    } catch (e) { return marginY; }
}

/** Dados da solicitadora — edite aqui para personalizar procurações, faturas e rodapé. */
const DADOS_SOLICITADORA = {
    nome: 'Dra. Ana Paula Pinto Medina',
    titulo: 'Solicitadora',
    cedula: '9738',
    sede: 'Av. Aquilino Ribeiro Machado, n.º 8, 1800-399 Lisboa',
    nif: '288132335',
    morada: 'Rua Melo Antunes, número 34, 3º DTO, 2526-728 Vialonga',
    contacto: '+351 938057340',
    email: 'anapaulamedina09738@osae.pt',
    iban: 'PT50 0193 0000 10514937886 86',
    website: 'Solicitadora Ana Paula'
};

/** Converte valor em euros para texto por extenso (simplificado). */
function valorPorExtenso(valor) {
    const v = Math.round((parseFloat(valor) || 0) * 100) / 100;
    const inteiro = Math.floor(v);
    const centavos = Math.round((v - inteiro) * 100);
    if (inteiro === 0 && centavos === 0) return 'zero euros';
    const unidades = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
    const especiais = ['dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezasseis', 'dezassete', 'dezoito', 'dezanove'];
    const dezenas = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
    const centenas = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];
    function ate999(n) {
        if (n === 0) return '';
        if (n < 10) return unidades[n];
        if (n < 20) return especiais[n - 10];
        if (n < 100) return (dezenas[Math.floor(n / 10)] + (n % 10 ? ' e ' + unidades[n % 10] : '')).trim();
        return (centenas[Math.floor(n / 100)] + (n % 100 ? ' e ' + ate999(n % 100) : '')).trim();
    }
    const milhares = Math.floor(inteiro / 1000);
    const restante = inteiro % 1000;
    let txt = '';
    if (milhares > 0) txt += ate999(milhares) + (milhares === 1 ? ' mil' : ' mil');
    if (restante > 0) txt += (txt ? ' e ' : '') + ate999(restante);
    if (inteiro === 1) txt += ' euro';
    else txt += ' euros';
    if (centavos > 0) txt += ' e ' + ate999(centavos) + (centavos === 1 ? ' cêntimo' : ' cêntimos');
    return txt;
}

/** Gera conteúdo da Fatura/Recibo profissional (com logo e rodapé no PDF). */
function gerarConteudoFaturaRecibo(dados) {
    const fatura = dados.fatura;
    const cliente = dados.cliente || {};
    const sol = dados.solicitadora || {};
    const pagamentos = dados.pagamentos || [];
    if (!fatura) return 'Selecione uma fatura.';

    const numero = fatura.numero || fatura.id || 'FAC-';
    const ano = new Date().getFullYear();
    const numeroFmt = (numero + '').replace('FAT-', 'FAC ' + ano + 'FAC').replace(/\//g, '/') || `FAC ${ano}FAC001/1`;
    const dataEmissao = (fatura.dataEmissao || fatura.data || new Date().toISOString()).toString().split('T')[0];
    const dataFmt = dataEmissao.split('-').reverse().join('-');
    const vencimento = (fatura.vencimento || fatura.dataEmissao || fatura.data || dataEmissao).toString().split('T')[0];
    const vencFmt = vencimento.split('-').reverse().join('-');
    const atcud = fatura.atcud || 'ATCUD: ' + (Math.random().toString(36).substring(2, 10).toUpperCase() + '-1');

    const valorTotal = parseFloat(fatura.valorTotal || fatura.valor || 0);
    const valorBase = parseFloat(fatura.valorBase || fatura.valor || valorTotal);
    const iva = parseFloat(fatura.valorIva || fatura.iva || 0);
    const retencao = parseFloat(fatura.retencao || 0);
    const valorPagar = Math.max(0, valorTotal - (parseFloat(fatura.somaPagamentos || 0) || 0));
    const somaPagamentos = pagamentos.reduce((s, p) => s + (parseFloat(p.valor) || 0), 0);
    const valorRecebido = somaPagamentos || valorPagar;
    const descricaoServico = fatura.observacoes || fatura.notas || 'Assessoria Jurídica - AIMA';

    const nifCliente = (cliente.nif || cliente.documento || '').replace(/\s/g, '');
    const nifFormatado = nifCliente ? nifCliente.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3') : '__________';
    const nifSolicitadora = (sol.nif || '288132335').replace(/\s/g, '').replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
    const moradaCliente = (cliente.morada || cliente.endereco || '').toString().replace(/\n/g, ', ') || '[Morada]';

    const linhas = [
        'SOLICITADORA ANA PAULA MEDINA',
        `Contribuinte n.º ${nifSolicitadora}  |  Tlm: ${sol.contacto || '+351 938057340'}  |  Email: ${sol.email || 'anapaulamedina09738@osae.pt'}`,
        `IBAN: ${sol.iban || 'PT50 0193 0000 10514937886 86'}`,
        `V/ n.º contribuinte: ${nifFormatado}`,
        '',
        `Fatura/Recibo: ${numeroFmt} (Original)`,
        `Data de Emissão: ${dataFmt}  |  Vencimento: ${vencFmt}  |  ${atcud}`,
        '',
        'Exmo(s) Sr(s)',
        cliente.nome || '[Nome do Cliente]',
        moradaCliente,
        '',
        'Descrição                                    | Art. | Qt    | Incidência | IVA% | Total (€)',
        `Acto #1 ${descricaoServico.substring(0, 35).padEnd(35)} | 7    | 1,00  | ${valorBase.toFixed(2).padStart(8)} | (1)  | ${valorBase.toFixed(2)}`,
        `Taxa de IVA Base de Incidência 0,00%                                              | 0,00`,
        '',
        `Serviços/Produtos: ${valorBase.toFixed(2)}  |  IVA: ${iva.toFixed(2)}  |  TOTAL: ${valorTotal.toFixed(2)}`,
        `Retenção na fonte: ${retencao.toFixed(2)}  |  Valor a Pagar: €${valorPagar.toFixed(2)}`,
        '',
        `Recebemos por este documento ${valorPorExtenso(valorRecebido).replace(/^./, c => c.toUpperCase())}.`,
        '',
        'Artigo 7 Honorários: ' + valorBase.toFixed(2) + '  |  Impostos: ' + iva.toFixed(2) + '  |  Total: ' + valorTotal.toFixed(2),
        '',
        '(1) Artigo 16.º, n.º 6 do CIVA',
        '',
        'Recibos:',
        ...(pagamentos.length > 0 ? pagamentos.map((p, i) => `  Recibo REC ${ano}REC${String(i + 1).padStart(3, '0')}/1 | ${(p.dataPagamento || p.data || '').toString().split('T')[0]} | Valor Recebido: ${(parseFloat(p.valor) || 0).toFixed(2)} | Retenção: ${retencao.toFixed(2)}`) : ['  (Nenhum recibo registado)']),
        obterRodapeDocumento()
    ];
    return linhas.join('\n');
}

/** Rodapé padrão — aparece no fim de todos os documentos PDF gerados. */
function obterRodapeDocumento() {
    const s = typeof DADOS_SOLICITADORA !== 'undefined' ? DADOS_SOLICITADORA : {};
    return [
        '',
        '---',
        '',
        `Contacto: ${s.contacto || '+351 938057340'}`,
        `Endereço: ${s.sede || 'Av. Aquilino Ribeiro Machado, n.º 8, 1800-399 Lisboa'}`,
        `Email: ${s.email || 'anapaulamedina09738@osae.pt'}`,
        `Website: ${s.website || 'Solicitadora Ana Paula'}`
    ].join('\n');
}

function obterModelosDocumentos() {
    return [
        { id: 'procuracao_simples', nome: 'Procuração Simples', arquivo: 'procuracao_simples', tipo: 'procuracao' },
        { id: 'procuracao_aima', nome: 'Procuração para AIMA / Residência', arquivo: 'procuracao_aima', tipo: 'procuracao' },
        { id: 'procuracao_irn', nome: 'Procuração para IRN', arquivo: 'procuracao_irn', tipo: 'procuracao' },
        { id: 'procuracao_financas', nome: 'Procuração para Finanças', arquivo: 'procuracao_financas', tipo: 'procuracao' },
        { id: 'procuracao_geral', nome: 'Procuração Geral', arquivo: 'procuracao_geral', tipo: 'procuracao' },
        { id: 'declaracao_comparecimento', nome: 'Declaração de Comparecimento', arquivo: 'declaracao_comparecimento', tipo: 'outro' },
        { id: 'declaracao_residencia', nome: 'Declaração de Residência', arquivo: 'declaracao_residencia', tipo: 'outro' },
        { id: 'declaracao_conhecimento', nome: 'Declaração de Conhecimento', arquivo: 'declaracao_conhecimento', tipo: 'outro' },
        { id: 'recibo_honorarios', nome: 'Recibo de Honorários', arquivo: 'recibo_honorarios', tipo: 'outro' },
        { id: 'fatura_recibo', nome: 'Fatura/Recibo (Profissional)', arquivo: 'fatura_recibo', tipo: 'fatura' }
    ];
}

function normalizarNomeArquivo(valor) {
    return String(valor || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');
}

/** Mostra/oculta campos extras consoante o modelo selecionado. */
function toggleCamposProcuracaoAima() {
    const modeloId = document.getElementById('templateModelo')?.value || '';
    const containerNum = document.getElementById('containerNumeroProcesso');
    const containerObj = document.getElementById('containerObjetoProcuracao');
    const containerCliente = document.getElementById('containerTemplateCliente');
    const containerFatura = document.getElementById('containerTemplateFatura');
    const hintSemFaturas = document.getElementById('hintSemFaturas');
    const selectFatura = document.getElementById('templateFatura');
    const isAima = modeloId === 'procuracao_aima';
    const isFaturaRecibo = modeloId === 'fatura_recibo';
    if (containerNum) containerNum.classList.toggle('hidden', !isAima);
    if (containerNum) containerNum.classList.toggle('md:col-span-2', isAima);
    if (containerObj) containerObj.classList.toggle('hidden', !isAima);
    if (containerObj) containerObj.classList.toggle('md:col-span-3', isAima);
    if (containerCliente) containerCliente.classList.toggle('hidden', isFaturaRecibo);
    if (containerFatura) containerFatura.classList.toggle('hidden', !isFaturaRecibo);
    const faturas = (typeof obterFaturas === 'function' ? obterFaturas() : []).filter(f => f.id !== 'seed-inicial');
    const numFaturas = faturas.length;
    if (hintSemFaturas) hintSemFaturas.classList.toggle('hidden', !isFaturaRecibo || numFaturas > 0);
    // Atualiza o dropdown de faturas com dados em tempo real (importante após "Gerar faturas")
    if (isFaturaRecibo && selectFatura) {
        const valorSel = selectFatura.value;
        selectFatura.innerHTML = '<option value="">Selecione a fatura</option>' + faturas.map(f => 
            `<option value="${f.id}">${f.numero || f.id} - ${f.clienteNome || ''} - €${(parseFloat(f.valorTotal || f.valor) || 0).toFixed(2)}</option>`
        ).join('');
        if (valorSel && faturas.some(f => String(f.id) === String(valorSel))) selectFatura.value = valorSel;
    }
}

/** Atualiza a área de texto com o conteúdo do modelo selecionado (permite adaptar antes de gerar PDF). */
function atualizarPreviewTemplateDocumento() {
    const modeloId = document.getElementById('templateModelo')?.value || '';
    if (!modeloId) {
        const ta = document.getElementById('templateConteudoAdaptavel');
        if (ta) ta.value = '';
        return;
    }
    const dados = obterDadosTemplateDocumento(true);
    const dadosPreview = dados || {
        cliente: null,
        fatura: null,
        modeloId,
        numeroProcesso: document.getElementById('templateNumeroProcesso')?.value?.trim() || '',
        objetoProcuracao: document.getElementById('templateObjetoProcuracao')?.value?.trim() || '',
        pagamentos: [],
        hoje: new Date(),
        solicitadora: typeof DADOS_SOLICITADORA !== 'undefined' ? DADOS_SOLICITADORA : {}
    };
    if (!dadosPreview.cliente) {
        dadosPreview.cliente = { nome: '[Nome do Cliente]', nif: '[NIF]', morada: '[Morada]', endereco: '[Endereço]' };
    }
    const conteudo = gerarConteudoTemplateDocumento(dadosPreview.modeloId, dadosPreview);
    const ta = document.getElementById('templateConteudoAdaptavel');
    if (ta) ta.value = conteudo;
    setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons(); }, 50);
}

function obterDadosTemplateDocumento(apenasPreview) {
    const clienteId = parseIdSafe(document.getElementById('templateCliente')?.value || '');
    const faturaId = document.getElementById('templateFatura')?.value?.trim() || '';
    const modeloId = document.getElementById('templateModelo')?.value || '';
    const processoTipo = document.getElementById('templateProcessoTipo')?.value || 'outro';
    const numeroProcesso = document.getElementById('templateNumeroProcesso')?.value?.trim() || '';
    const objetoProcuracao = document.getElementById('templateObjetoProcuracao')?.value?.trim() || '';

    if (!modeloId) return null;
    if (modeloId === 'fatura_recibo') {
        if (!apenasPreview && !faturaId) {
            mostrarNotificacao('Selecione a fatura.', 'warning');
            return null;
        }
        const faturas = typeof obterFaturas === 'function' ? obterFaturas() : [];
        const fatura = faturaId ? faturas.find(f => String(f.id) === String(faturaId)) : null;
        const cliente = fatura && fatura.clienteId ? clientes.find(c => String(c.id) === String(fatura.clienteId)) : { nome: 'N/D', nif: 'N/D', morada: 'N/D', endereco: '' };
        const pagamentosFatura = (Array.isArray(pagamentos) ? pagamentos : []).filter(p => String(p.faturaId) === String(faturaId));
        return { faturaId, fatura, cliente, clienteId: fatura?.clienteId, processoTipo, modeloId, numeroProcesso, objetoProcuracao, hoje: new Date(), solicitadora: typeof DADOS_SOLICITADORA !== 'undefined' ? DADOS_SOLICITADORA : {}, pagamentos: pagamentosFatura };
    }
    if (!apenasPreview && !clienteId) {
        mostrarNotificacao('Selecione o cliente do modelo.', 'warning');
        return null;
    }

    const cliente = clienteId ? clientes.find(c => c.id === clienteId) : { nome: 'N/D', nif: 'N/D', morada: 'N/D', endereco: '', documento: '' };
    return {
        clienteId,
        cliente,
        processoTipo,
        modeloId,
        numeroProcesso,
        objetoProcuracao,
        hoje: new Date(),
        solicitadora: typeof DADOS_SOLICITADORA !== 'undefined' ? DADOS_SOLICITADORA : {}
    };
}

function gerarConteudoTemplateDocumento(modeloId, dados) {
    const nomeCliente = dados.cliente?.nome || 'N/D';
    const nif = dados.cliente?.nif || dados.cliente?.documento || 'N/D';
    const morada = dados.cliente?.morada || dados.cliente?.endereco || dados.cliente?.morada || 'N/D';
    const dataHoje = dados.hoje.toLocaleDateString('pt-PT', { day: 'numeric', month: 'long', year: 'numeric' });
    const sol = dados.solicitadora || {};
    const numProc = dados.numeroProcesso || '__________';
    const objCustom = dados.objetoProcuracao;

    switch (modeloId) {
        case 'procuracao_aima':
            return [
                'PROCURAÇÃO',
                '',
                `Por mim outorgado, ${nomeCliente}, NF ${nif}, solteiro(a), maior, residente em ${morada}, portador(a) do passaporte n.º __________ da República da ________________, válido até __________,`,
                '',
                `concedo poderes a ${sol.nome || 'Dra. Ana Paula Pinto Medina'}, ${sol.titulo || 'Solicitadora'}, com cédula profissional n.º ${sol.cedula || '9738'}, com sede em ${sol.sede || 'Av. Aquilino Ribeiro Machado n.º 8, 1800-399 Lisboa'}, NIF ${sol.nif || '288132335'}, solteira, maior, residente em ${sol.morada || 'Rua Melo Antunes, número 34, 3º DTO, 2526-728 Vialonga'},`,
                '',
                objCustom ? objCustom : `confere poderes para, em seu nome, acompanhar e praticar todos os atos necessários à Concessão do título de residência em Portugal com base no processo número ${numProc} ao abrigo do artigo 88º da Lei 23/2007 de 04 de Julho na sua redação atual, junto das competentes entidades portuguesas, nomeadamente Agência para Integração, Migração e Asilo (AIMA) podendo para o efeito declarar, praticar e assinar tudo o que seja necessário ao indicado fim, se necessário, substabelecer os poderes que lhe forem conferidos.`,
                '',
                `Lisboa, ${dataHoje}`,
                obterRodapeDocumento()
            ].join('\n');
        case 'procuracao_simples':
            return [
                'PROCURAÇÃO SIMPLES',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                'pelo presente instrumento, nomeio e constituo como meu bastante procurador(a)',
                'o(a) Dr(a). ________________________, para me representar junto das entidades competentes.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'procuracao_irn':
            return [
                'PROCURAÇÃO PARA INSTITUTO DOS REGISTOS E NOTARIADO',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                'pelo presente instrumento particular, nomeio e constituo como meu bastante procurador(a)',
                'o(a) Dr(a). ________________________, para me representar junto do IRN e Conservatórias,',
                'com poderes para praticar actos de registo civil, predial e comercial, requerer certidões,',
                'autenticar documentos e demais actos inerentes ao âmbito notarial e registral.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'procuracao_financas':
            return [
                'PROCURAÇÃO PARA AUTORIDADE TRIBUTÁRIA',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                'pelo presente instrumento, nomeio e constituo como meu bastante procurador(a)',
                'o(a) Dr(a). ________________________, para me representar junto das Finanças / AT,',
                'com poderes para consultar e submeter declarações fiscais, obter certidões,',
                'tratar de matéria contributiva e aduaneira, e demais actos necessários.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'procuracao_geral':
            return [
                'PROCURAÇÃO GERAL',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                'pelo presente instrumento, nomeio e constituo como meu bastante procurador(a)',
                'o(a) Dr(a). ________________________, para me representar junto de quaisquer entidades,',
                'com poderes genéricos para praticar todos os actos que no meu interesse entender,',
                'incluindo representação em organismos públicos, bancos e serviços administrativos.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'declaracao_comparecimento':
            return [
                'DECLARAÇÃO DE COMPARECIMENTO',
                '',
                `Declaro que ${nomeCliente}, NIF ${nif}, compareceu neste escritório no dia ${dataHoje}.`,
                '',
                'Para os devidos efeitos, assino a presente declaração.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'declaracao_residencia':
            return [
                'DECLARAÇÃO DE RESIDÊNCIA',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, declaro que resido em ${morada}.`,
                '',
                'Declaro, sob compromisso de honra, que as informações acima são verdadeiras.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'declaracao_conhecimento':
            return [
                'DECLARAÇÃO DE CONHECIMENTO',
                '',
                `Eu, ${nomeCliente}, NIF ${nif}, residente em ${morada},`,
                'declaro, sob compromisso de honra, que tomei conhecimento do conteúdo',
                'dos documentos que me foram apresentados e que as informações prestadas',
                'correspondem à verdade dos factos.',
                '',
                'Para os devidos efeitos legais, assino a presente declaração.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'recibo_honorarios':
            return [
                'RECIBO DE HONORÁRIOS',
                '',
                `Recebi de ${nomeCliente}, NIF ${nif}, a quantia de €__________`,
                'referente a honorários profissionais.',
                '',
                `Local e data: _____________________, ${dataHoje}`,
                '',
                'Assinatura: ________________________________',
                obterRodapeDocumento()
            ].join('\n');
        case 'fatura_recibo':
            return gerarConteudoFaturaRecibo(dados);
        default:
            return 'Modelo não encontrado.';
    }
}

async function gerarTemplateDocumento(acao) {
    if (!exigirPermissaoAcao('criar', 'documento')) {
        return;
    }
    const dados = obterDadosTemplateDocumento();
    if (!dados) return;

    const modelos = obterModelosDocumentos();
    const modelo = modelos.find(m => m.id === dados.modeloId);
    if (!modelo) {
        mostrarNotificacao('Modelo não encontrado.', 'error');
        return;
    }

    const conteudoAdaptado = document.getElementById('templateConteudoAdaptavel')?.value?.trim();
    const conteudo = conteudoAdaptado || gerarConteudoTemplateDocumento(modelo.id, dados);
    const nomeBase = normalizarNomeArquivo(`${modelo.arquivo}_${dados.cliente?.nome || 'cliente'}`);
    const nomeArquivo = `${nomeBase || modelo.arquivo}.pdf`;

    if (acao === 'baixar' || acao === 'imprimir') {
        try {
            const jsPDF = (window.jspdf && window.jspdf.jsPDF) || (window.jspdf && window.jspdf.default) || window.jsPDF;
            if (!jsPDF) {
                mostrarNotificacao('Biblioteca PDF não carregada. Faça Ctrl+F5 para recarregar a página.', 'error');
                return;
            }
            const doc = new jsPDF({ format: 'a4', unit: 'mm' });
            const margin = 20;
            let y = await adicionarLogoAoPdf(doc, margin);
            doc.setFont('times', 'normal');
            doc.setFontSize(12);
            const pageWidth = doc.internal.pageSize.getWidth();
            const maxWidth = pageWidth - margin * 2;
            const lineHeight = 7;
            const blocos = conteudo.split('\n');
            blocos.forEach(bloco => {
                const linhas = doc.splitTextToSize(bloco || ' ', maxWidth);
                linhas.forEach(linha => {
                    if (y > 277) { doc.addPage(); y = margin; }
                    doc.text(linha, margin, y);
                    y += lineHeight;
                });
            });
            if (acao === 'baixar') {
                doc.save(nomeArquivo);
                mostrarNotificacao('Documento PDF gerado com sucesso!', 'success');
                return;
            }
            if (acao === 'imprimir') {
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);
                const janela = window.open(url, '_blank');
                if (janela) {
                    janela.addEventListener('load', () => setTimeout(() => { janela.print(); URL.revokeObjectURL(url); }, 500));
                } else {
                    mostrarNotificacao('Permita abrir a janela para imprimir.', 'warning');
                    doc.save(nomeArquivo);
                    URL.revokeObjectURL(url);
                }
                return;
            }
        } catch (e) {
            console.error('Erro ao gerar PDF:', e);
            mostrarNotificacao('Erro ao gerar PDF. Verifique a consola.', 'error');
            return;
        }
    }

    const dataUri = `data:text/plain;charset=utf-8,${encodeURIComponent(conteudo)}`;
    const tamanho = new Blob([conteudo]).size;
        const documento = {
            id: gerarIdImutavel(),
        clienteId: dados.clienteId,
        clienteNome: dados.cliente?.nome || '',
        processoTipo: dados.processoTipo,
        descricao: `Modelo: ${modelo.nome}`,
        tags: ['template', modelo.nome],
        nomeArquivo,
        tipoArquivo: 'application/pdf',
        tamanho,
        conteudo: dataUri,
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D',
        dataCriacao: new Date().toISOString()
    };
    const lista = obterDocumentosAtual();
    lista.unshift(documento);
    salvarDocumentosLocal(lista);
    registrarAuditoria('criar', 'documento', `Documento modelo criado: ${documento.nomeArquivo}`, null, documento);
    mostrarNotificacao('Modelo gerado e guardado com sucesso!', 'success');
    aplicarFiltrosDocumentos();
}

function gerarIntegracoes() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const isAdmin = tipoUsuario === 'admin';
    const clientesLista = obterClientesAtual();
    const entidadesLista = obterEntidadesParaSelect().filter(e => e.id);
    const lista = obterIntegracoesExternasAtual();
    const processosTipos = [
        { value: 'heranca', label: 'Herança' },
        { value: 'migracao', label: 'Migração' },
        { value: 'registo', label: 'Registo' }
    ];
    const estadosLista = [
        { value: 'pendente', label: 'Pendente' },
        { value: 'enviado', label: 'Enviado' },
        { value: 'concluido', label: 'Concluído' },
        { value: 'indeferido', label: 'Indeferido' },
        { value: 'cancelado', label: 'Cancelado' }
    ];
    const canaisLista = [
        { value: 'online', label: 'Online' },
        { value: 'presencial', label: 'Presencial' },
        { value: 'email', label: 'Email' },
        { value: 'portal', label: 'Portal' },
        { value: 'correio', label: 'Correio' }
    ];
    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Integrações Externas</h2>
                ${isAdmin ? `
                    <button onclick="abrirModalNovaIntegracao()" class="btn btn-primary">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Nova Integração
                    </button>
                ` : ''}
            </div>
            ${isAdmin ? `
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Entidades</h3>
                    <p class="text-gray-600 mb-3">Gestão de entidades (Finanças, IRN, IMT, etc.). As entidades são carregadas do Firestore ou da lista padrão.</p>
                    <button onclick="seedEntidadesSeVazio()" class="btn btn-secondary">
                        <i data-lucide="database" class="w-4 h-4"></i>
                        Inicializar entidades (se vazio)
                    </button>
                </div>
            ` : ''}
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="filtroIntCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosIntegracoes()">
                            <option value="">Todos</option>
                            ${clientesLista.map(c => `<option value="${c.id}">${escaparHtml(c.nome)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                        <select id="filtroIntEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosIntegracoes()">
                            <option value="">Todas</option>
                            ${entidadesLista.map(e => `<option value="${e.id}">${escaparHtml(e.nome)}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                        <select id="filtroIntEstado" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosIntegracoes()">
                            <option value="">Todos</option>
                            ${estadosLista.map(s => `<option value="${s.value}">${s.label}</option>`).join('')}
                        </select>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Interações</h3>
                    <span class="text-sm text-gray-600" id="contadorIntegracoes">${lista.length}</span> integrações
                </div>
                <div id="listaIntegracoes" class="space-y-3"></div>
            </div>
        </div>
    `;
}
function aplicarFiltrosIntegracoes() {
    const clienteId = document.getElementById('filtroIntCliente')?.value || '';
    const entidadeId = document.getElementById('filtroIntEntidade')?.value || '';
    const estado = document.getElementById('filtroIntEstado')?.value || '';
    let lista = obterIntegracoesExternasAtual();
    if (clienteId) lista = lista.filter(i => String(i.clienteId) === clienteId);
    if (entidadeId) lista = lista.filter(i => String(i.entidadeId) === entidadeId);
    if (estado) lista = lista.filter(i => (i.estado || '') === estado);
    lista = lista.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
    renderizarListaIntegracoes(lista);
}
function renderizarListaIntegracoes(lista) {
    const container = document.getElementById('listaIntegracoes');
    const contador = document.getElementById('contadorIntegracoes');
    if (contador) contador.textContent = lista.length;
    if (!container) return;
    if (lista.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500 py-4">Nenhuma integração encontrada.</div>';
        return;
    }
    container.innerHTML = lista.map(i => `
        <div class="flex flex-col gap-2 border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-sm font-semibold text-gray-800">${escaparHtml(i.descricao || 'Sem descrição')}</div>
                    <div class="text-xs text-gray-500">${renderClienteLink(i.clienteId, i.clienteNome || 'Cliente')} • ${escaparHtml(i.entidadeNome || i.entidadeId || '—')} • ${i.estado || 'pendente'}</div>
                    ${i.dataEnvio ? `<div class="text-xs text-gray-400">Enviado: ${new Date(i.dataEnvio).toLocaleDateString('pt-PT')}</div>` : ''}
                    ${i.referenciaExterna ? `<div class="text-xs text-gray-400">Ref. externa: ${escaparHtml(i.referenciaExterna)}</div>` : ''}
                </div>
                <span class="status-badge status-${i.estado || 'pendente'}">${i.estado || 'pendente'}</span>
            </div>
        </div>
    `).join('');
    lucide.createIcons();
}
async function seedEntidadesSeVazio() {
    if (!isCloudReady()) { mostrarNotificacao('Firestore não disponível.', 'error'); return; }
    const lista = obterEntidadesAtual();
    if (lista.length > 0) { mostrarNotificacao('Entidades já existem. Nada a fazer.', 'info'); return; }
    const padrao = (typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).filter(e => e.id);
    for (const e of padrao) {
        await criarEntidadeCloud({ id: e.id, nome: e.nome, tipo: e.id.replace(/_/g, '-'), ativo: true });
    }
    mostrarNotificacao(padrao.length + ' entidades inicializadas.', 'success');
}
function abrirModalNovaIntegracao() {
    const clientesLista = obterClientesAtual();
    const entidadesLista = obterEntidadesParaSelect().filter(e => e.id);
    const processosTipos = [{ value: 'heranca', label: 'Herança' }, { value: 'migracao', label: 'Migração' }, { value: 'registo', label: 'Registo' }];
    const estadosLista = [{ value: 'pendente', label: 'Pendente' }, { value: 'enviado', label: 'Enviado' }, { value: 'concluido', label: 'Concluído' }];
    const canaisLista = [{ value: 'online', label: 'Online' }, { value: 'presencial', label: 'Presencial' }, { value: 'email', label: 'Email' }];
    const modal = `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content" style="max-width: 640px;" onclick="event.stopPropagation()">
                <h3 class="text-lg font-semibold mb-4">Nova Integração Externa</h3>
                <form onsubmit="criarIntegracaoExterna(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="intCliente" required class="w-full border border-gray-300 rounded px-3 py-2">
                                <option value="">Selecione</option>
                                ${clientesLista.map(c => `<option value="${c.id}">${escaparHtml(c.nome)}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entidade *</label>
                            <select id="intEntidade" required class="w-full border border-gray-300 rounded px-3 py-2">
                                ${entidadesLista.map(e => `<option value="${e.id}">${escaparHtml(e.nome)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo processo</label>
                                <select id="intProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${processosTipos.map(p => `<option value="${p.value}">${p.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Processo (ID)</label>
                                <input id="intProcessoId" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="ID do processo">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                            <textarea id="intDescricao" required rows="2" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
                                <select id="intEstado" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${estadosLista.map(s => `<option value="${s.value}">${s.label}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Canal</label>
                                <select id="intCanal" class="w-full border border-gray-300 rounded px-3 py-2">
                                    ${canaisLista.map(c => `<option value="${c.value}">${c.label}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ref. externa</label>
                            <input id="intRefExterna" type="text" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Nº pedido no portal">
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-4">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Criar</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    document.getElementById('modalContainer').classList.add('show');
    lucide.createIcons();
}
async function criarIntegracaoExterna(event) {
    event.preventDefault();
    const clienteId = document.getElementById('intCliente')?.value || '';
    const entidadeId = document.getElementById('intEntidade')?.value || '';
    const cliente = clientes.find(c => String(c.id) === String(clienteId));
    const entidade = entidades.find(e => String(e.id) === String(entidadeId)) || { nome: entidadeId };
    if (!clienteId || !entidadeId) { mostrarNotificacao('Cliente e Entidade são obrigatórios.', 'warning'); return; }
    const item = {
        entidadeId,
        entidadeNome: entidade.nome,
        clienteId,
        clienteNome: cliente ? cliente.nome : '',
        processoTipo: document.getElementById('intProcessoTipo')?.value || 'heranca',
        processoId: document.getElementById('intProcessoId')?.value || '',
        tipoInteracao: 'pedido',
        descricao: document.getElementById('intDescricao')?.value?.trim() || '',
        estado: document.getElementById('intEstado')?.value || 'pendente',
        canal: document.getElementById('intCanal')?.value || 'online',
        referenciaExterna: document.getElementById('intRefExterna')?.value?.trim() || '',
        utilizadorId: appStorage.getItem('usuarioLogado') || null,
        utilizadorNome: ''
    };
    try {
        await criarIntegracaoCloud(item);
        mostrarNotificacao('Integração criada com sucesso!', 'success');
        fecharModalRobusto();
        aplicarFiltrosIntegracoes();
    } catch (err) {
        mostrarNotificacao('Erro ao criar: ' + (err.message || err), 'error');
    }
}

function gerarDocumentos() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const isConvidado = tipoUsuario === 'convidado';
    const podeCriarDocumento = tipoUsuario === 'admin' || tipoUsuario === 'convidado';
    let clientesParaSelect = Array.isArray(clientes) ? clientes : [];
    let documentosParaMostrar = obterDocumentosAtual();
    
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        const clientesAutorizados = convidado && convidado.ativo ? convidado.clientesAutorizados : [];
        const clientesAutorizadosNorm = (clientesAutorizados || []).map(id => String(id));
        clientesParaSelect = clientesParaSelect.filter(c => clientesAutorizadosNorm.includes(String(c.id)));
        documentosParaMostrar = documentosParaMostrar.filter(d => clientesAutorizadosNorm.includes(String(d.clienteId)));
    }
    
    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Documentos</h2>
                ${podeCriarDocumento ? `
                    <button onclick="uploadDocumento()" class="btn btn-primary">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Adicionar Documento
                    </button>
                ` : ''}
            </div>
            
            ${podeCriarDocumento ? `
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Novo Documento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="docCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecione</option>
                                ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                            <select id="docProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="contrato">Contrato</option>
                                <option value="heranca">Herança</option>
                                <option value="migracao">Migração</option>
                                <option value="registo">Registo</option>
                                <option value="prazo">Prazo</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                            <select id="docEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" title="Instituição em Portugal">
                                ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição</label>
                            <input id="docDescricao" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: Contrato assinado">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tags (separadas por vírgula)</label>
                            <input id="docTags" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: contrato, assinatura">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ficheiro *</label>
                            <input id="docArquivo" type="file" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <p class="text-xs text-gray-500 mt-1">Recomendado até 5 MB.</p>
                        </div>
                    </div>
                </div>
            ` : ''}

            ${podeCriarDocumento ? `
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Modelos de documentos</h3>
                    <p class="text-gray-600 mb-4">Documentos gerados em PDF a partir de modelos (Procuração, Declarações, Recibos)</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                        <div id="containerTemplateCliente">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="templateCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="atualizarPreviewTemplateDocumento()">
                                <option value="">Selecione</option>
                                ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div id="containerTemplateFatura" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Fatura *</label>
                            <select id="templateFatura" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="atualizarPreviewTemplateDocumento()">
                                <option value="">Selecione a fatura</option>
                                ${(typeof obterFaturas === 'function' ? obterFaturas() : []).filter(f => f.id !== 'seed-inicial').map(f => `<option value="${f.id}">${f.numero || f.id} - ${f.clienteNome || ''} - €${(parseFloat(f.valorTotal || f.valor) || 0).toFixed(2)}</option>`).join('')}
                            </select>
                            <p id="hintSemFaturas" class="text-xs text-amber-600 mt-1 hidden">Sem faturas? Vá a <strong>Honorários</strong> e clique em <strong>Gerar faturas</strong>.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                            <select id="templateProcessoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="atualizarPreviewTemplateDocumento()">
                                <option value="contrato">Contrato</option>
                                <option value="heranca">Herança</option>
                                <option value="migracao">Migração</option>
                                <option value="registo">Registo</option>
                                <option value="prazo">Prazo</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Modelo *</label>
                            <select id="templateModelo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="atualizarPreviewTemplateDocumento(); toggleCamposProcuracaoAima();" onload="toggleCamposProcuracaoAima();">
                                ${obterModelosDocumentos().map(modelo => `<option value="${modelo.id}">${modelo.nome}</option>`).join('')}
                            </select>
                        </div>
                        <div id="containerNumeroProcesso" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">N.º do processo (AIMA)</label>
                            <input id="templateNumeroProcesso" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: 6222911" onchange="atualizarPreviewTemplateDocumento()" oninput="atualizarPreviewTemplateDocumento()">
                        </div>
                        <div id="containerObjetoProcuracao" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Objeto personalizado (opcional)</label>
                            <textarea id="templateObjetoProcuracao" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black text-sm" placeholder="Deixe vazio para usar o texto padrão AIMA. Ou escreva o objeto da procuração..." onchange="atualizarPreviewTemplateDocumento()" oninput="atualizarPreviewTemplateDocumento()"></textarea>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Adaptar texto antes de gerar PDF</label>
                        <textarea id="templateConteudoAdaptavel" rows="12" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black font-mono text-sm" placeholder="Selecione Cliente e Modelo para pré-preencher. Pode editar o texto antes de gerar o PDF."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Edite o conteúdo conforme necessário. Os dados da solicitadora estão em DADOS_SOLICITADORA no script.js</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="gerarTemplateDocumento('baixar')" class="btn btn-secondary">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            PDF
                        </button>
                        <button onclick="gerarTemplateDocumento('imprimir')" class="btn btn-primary" title="Imprimir ou guardar como PDF">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            PDF / Imprimir
                        </button>
                    </div>
                </div>
            ` : ''}
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Filtros</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pesquisa</label>
                        <input id="filtroDocTexto" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="nome, descrição, tag...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                        <select id="filtroDocCliente" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todos</option>
                            ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Processo</label>
                        <select id="filtroDocProcesso" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todos</option>
                            <option value="contrato">Contrato</option>
                            <option value="heranca">Herança</option>
                            <option value="migracao">Migração</option>
                            <option value="registo">Registo</option>
                            <option value="prazo">Prazo</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tag</label>
                        <input id="filtroDocTag" type="text" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="ex: assinatura">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                        <select id="filtroDocEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            <option value="">Todas</option>
                            ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL.filter(e => e.id) : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-2 mt-4">
                    <button onclick="aplicarFiltrosDocumentos()" class="btn btn-primary">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        Aplicar filtros
                    </button>
                    <button onclick="limparFiltrosDocumentos()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Limpar
                    </button>
                </div>
                </div>
                
                <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Documentos guardados</h3>
                    <div class="text-sm text-gray-600"><span id="contadorDocumentos">0</span> documentos</div>
                </div>
                <div id="listaDocumentos" class="space-y-3"></div>
            </div>
        </div>
    `;
}

function limparFiltrosDocumentos() {
    const ids = ['filtroDocTexto', 'filtroDocCliente', 'filtroDocProcesso', 'filtroDocTag', 'filtroDocEntidade'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    aplicarFiltrosDocumentos();
}

function aplicarFiltrosDocumentos() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    let lista = obterDocumentosAtual();
    
    if (tipoUsuario === 'convidado') {
        const convidadoId = appStorage.getItem('convidadoId');
        const convidados = obterConvidados();
        const convidado = convidados.find(c => String(c.id) === String(convidadoId) || String(c.codigo) === String(convidadoId));
        const clientesAutorizados = convidado && convidado.ativo ? convidado.clientesAutorizados : [];
        const clientesAutorizadosNorm = (clientesAutorizados || []).map(id => String(id));
        lista = lista.filter(doc => clientesAutorizadosNorm.includes(String(doc.clienteId)));
    }
    
    const texto = (document.getElementById('filtroDocTexto')?.value || '').toLowerCase();
    const clienteId = document.getElementById('filtroDocCliente')?.value || '';
    const processo = document.getElementById('filtroDocProcesso')?.value || '';
    const entidade = document.getElementById('filtroDocEntidade')?.value || '';
    const tag = (document.getElementById('filtroDocTag')?.value || '').toLowerCase();
    
    if (clienteId) lista = lista.filter(doc => String(doc.clienteId) === clienteId);
    if (processo) lista = lista.filter(doc => doc.processoTipo === processo);
    if (entidade) lista = lista.filter(doc => (doc.entidade || '') === entidade);
    if (texto) {
        lista = lista.filter(doc => {
            const alvo = [
                doc.nomeArquivo,
                doc.descricao,
                doc.clienteNome,
                doc.processoTipo,
                ...(doc.tags || [])
            ].filter(Boolean).join(' ').toLowerCase();
            return alvo.includes(texto);
        });
    }
    if (tag) {
        lista = lista.filter(doc => (doc.tags || []).some(t => t.toLowerCase().includes(tag)));
    }
    
    lista = lista.sort((a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao));
    renderizarListaDocumentos(lista);
}

function renderizarListaDocumentos(lista) {
    const container = document.getElementById('listaDocumentos');
    const contador = document.getElementById('contadorDocumentos');
    if (contador) contador.textContent = lista.length;
    if (!container) return;
    
    if (lista.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500">Nenhum documento encontrado.</div>';
        return;
    }
    
    const isConvidado = appStorage.getItem('tipoUsuario') === 'convidado';
    container.innerHTML = lista.map(doc => `
        <div class="flex flex-col gap-2 border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-start">
                <div>
                    <div class="text-sm font-semibold text-gray-800">${doc.nomeArquivo}</div>
                    <div class="text-xs text-gray-500">${doc.descricao || 'Sem descrição'}</div>
                    <div class="text-xs text-gray-500">${renderClienteLink(doc.clienteId, doc.clienteNome || 'Cliente')} • ${doc.processoTipo || 'outro'}${doc.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? ' • ' + (ENTIDADES_PORTUGAL.find(e => e.id === doc.entidade)?.nome || doc.entidade) : ''} • ${formatarTamanhoArquivo(doc.tamanho)}</div>
                    ${renderMetaAuditoria('documento', doc)}
                    <div class="text-xs text-gray-400">${doc.dataCriacao ? new Date(doc.dataCriacao).toLocaleString('pt-PT') : ''}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="baixarDocumento(${JSON.stringify(doc.id)})" class="text-blue-600 hover:text-blue-800" title="Baixar">
                        <i data-lucide="download" class="w-4 h-4" style="pointer-events:none"></i>
                    </button>
                    <button onclick="imprimirDocumento(${JSON.stringify(doc.id)})" class="text-gray-600 hover:text-gray-800" title="Imprimir">
                        <i data-lucide="printer" class="w-4 h-4" style="pointer-events:none"></i>
                    </button>
                    ${isConvidado ? '' : `
                        <button onclick="excluirDocumento(${JSON.stringify(doc.id)})" class="text-red-600 hover:text-red-800" title="Excluir">
                            <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                        </button>
                    `}
                    </div>
                </div>
            ${doc.tags && doc.tags.length ? `
                <div class="flex flex-wrap gap-2">
                    ${doc.tags.map(tag => `<span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${tag}</span>`).join('')}
            </div>
            ` : ''}
        </div>
    `).join('');
    lucide.createIcons();
}

function uploadDocumento() {
    if (!exigirPermissaoAcao('criar', 'documento')) {
        return;
    }
    const arquivoInput = document.getElementById('docArquivo');
    const clienteId = parseIdSafe(document.getElementById('docCliente')?.value || '');
    const processoTipo = document.getElementById('docProcessoTipo')?.value || 'outro';
    const entidade = document.getElementById('docEntidade')?.value || '';
    const descricao = document.getElementById('docDescricao')?.value?.trim() || '';
    const tagsRaw = document.getElementById('docTags')?.value || '';
    const tags = tagsRaw.split(',').map(t => t.trim()).filter(Boolean);
    
    if (!clienteId) {
        mostrarNotificacao('Selecione o cliente do documento.', 'warning');
        return;
    }
    if (!arquivoInput || !arquivoInput.files || arquivoInput.files.length === 0) {
        mostrarNotificacao('Selecione um ficheiro.', 'warning');
        return;
    }
    const arquivo = arquivoInput.files[0];
    if (arquivo.size > 5 * 1024 * 1024) {
        mostrarNotificacao('Ficheiro acima de 5 MB. Tente um ficheiro menor.', 'error');
        return;
    }
    
    const cliente = clientes.find(c => c.id === clienteId);
    const reader = new FileReader();
    reader.onload = () => {
        const documento = {
            id: gerarIdImutavel(),
            clienteId,
            clienteNome: cliente ? cliente.nome : '',
            processoTipo,
            entidade,
            descricao,
            tags,
            nomeArquivo: arquivo.name,
            tipoArquivo: arquivo.type,
            tamanho: arquivo.size,
            conteudo: reader.result,
            criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
            tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D',
            dataCriacao: new Date().toISOString()
        };
        const lista = obterDocumentosAtual();
        lista.unshift(documento);
        salvarDocumentosLocal(lista);
        registrarAuditoria('criar', 'documento', `Documento adicionado: ${documento.nomeArquivo}`, null, documento);
        mostrarNotificacao('Documento adicionado com sucesso!', 'success');
        arquivoInput.value = '';
        const descInput = document.getElementById('docDescricao');
        const tagsInput = document.getElementById('docTags');
        if (descInput) descInput.value = '';
        if (tagsInput) tagsInput.value = '';
        aplicarFiltrosDocumentos();
    };
    reader.readAsDataURL(arquivo);
}

function baixarDocumento(id) {
    const doc = obterDocumentosAtual().find(d => d.id === id);
    if (!doc) {
        mostrarNotificacao('Documento não encontrado.', 'error');
        return;
    }
    const link = document.createElement('a');
    link.href = doc.conteudo;
    link.download = doc.nomeArquivo || 'documento';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function imprimirDocumento(id) {
    const doc = obterDocumentosAtual().find(d => d.id === id);
    if (!doc) {
        mostrarNotificacao('Documento não encontrado.', 'error');
        return;
    }
    let conteudo = '';
    if (doc.conteudo && doc.conteudo.startsWith('data:text/plain')) {
        try {
            conteudo = decodeURIComponent(doc.conteudo.split(',')[1] || '');
        } catch (e) {
            conteudo = 'Conteúdo não disponível para impressão.';
        }
    } else {
        conteudo = doc.descricao || 'Conteúdo do documento.';
    }
    const janela = window.open('', '_blank');
    janela.document.write(`
        <!DOCTYPE html>
        <html><head>
            <meta charset="UTF-8">
            <title>${doc.nomeArquivo || 'documento'}</title>
            <style>
                body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; max-width: 21cm; margin: 2cm auto; padding: 0 1cm; white-space: pre-wrap; }
                @media print { body { margin: 0; padding: 1cm; } }
            </style>
        </head><body>${conteudo.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</body></html>
    `);
    janela.document.close();
    janela.focus();
    setTimeout(() => { janela.print(); }, 250);
}

async function excluirDocumento(id) {
    if (!exigirPermissaoAcao('apagar', 'documento')) {
        return;
    }
    const listaDoc = obterDocumentosAtual();
    const doc = listaDoc.find(d => d.id === id);
    if (!doc) {
        mostrarNotificacao('Documento não encontrado.', 'error');
        return;
    }
    if (!confirm('Tem certeza que deseja excluir este documento?')) return;
    const lista = listaDoc.filter(d => d.id !== id);
    salvarDocumentosLocal(lista);
    if (isCloudReady() && typeof apagarDocumentoCloud === 'function') {
        try {
            await apagarDocumentoCloud(id);
        } catch (err) {
            console.warn('Erro ao apagar documento na nuvem:', err);
            salvarDocumentosLocal(listaDoc);
            aplicarFiltrosDocumentos();
            mostrarNotificacao('Erro ao eliminar na nuvem. Documento restaurado.', 'error');
            return;
        }
    }
    registrarAuditoria('excluir', 'documento', `Documento excluído: ${doc.nomeArquivo}`, doc, null);
    aplicarFiltrosDocumentos();
    mostrarNotificacao('Documento excluído com sucesso!', 'success');
}

function inicializarRelatoriosAvancados() {
    const btnAplicar = document.getElementById('btnAplicarFiltrosRelatorio');
    const btnCsv = document.getElementById('btnExportarCsvRelatorio');
    const btnPdf = document.getElementById('btnExportarPdfRelatorio');
    
    if (btnAplicar) {
        btnAplicar.addEventListener('click', aplicarFiltrosRelatorioAvancado);
    }
    if (btnCsv) {
        btnCsv.addEventListener('click', exportarRelatorioAvancadoCsv);
    }
    if (btnPdf) {
        btnPdf.addEventListener('click', exportarRelatorioAvancadoPdf);
    }
    const btnLimpar = document.getElementById('btnLimparFiltrosRelatorio');
    if (btnLimpar) {
        btnLimpar.addEventListener('click', limparFiltrosRelatorioAvancado);
    }
    // Sincronizar min/max entre datas: início limita fim; fim limita início
    const elInicio = document.getElementById('relatorioAvancadoDataInicio');
    const elFim = document.getElementById('relatorioAvancadoDataFim');
    if (elInicio) elInicio.addEventListener('change', () => { if (elFim && elInicio.value) elFim.min = elInicio.value; });
    if (elFim) elFim.addEventListener('change', () => { if (elInicio && elFim.value) elInicio.max = elFim.value; });
    // Acessibilidade: aria-labels nos filtros
    if (elInicio) elInicio.setAttribute('aria-label', 'Data de início do relatório');
    if (elFim) elFim.setAttribute('aria-label', 'Data de fim do relatório');
}

function limparFiltrosRelatorioAvancado() {
    const elCliente = document.getElementById('relatorioAvancadoCliente');
    const elTipo = document.getElementById('relatorioAvancadoTipo');
    const elDataInicio = document.getElementById('relatorioAvancadoDataInicio');
    const elDataFim = document.getElementById('relatorioAvancadoDataFim');
    const resumo = document.getElementById('relatorioAvancadoResumo');
    const container = document.getElementById('relatorioAvancadoResultados');
    if (elCliente) elCliente.value = '';
    if (elTipo) elTipo.value = 'todos';
    if (elDataInicio) { elDataInicio.value = ''; elDataInicio.removeAttribute('min'); elDataInicio.removeAttribute('max'); }
    if (elDataFim) { elDataFim.value = ''; elDataFim.removeAttribute('min'); elDataFim.removeAttribute('max'); }
    if (resumo) resumo.textContent = 'Nenhum filtro aplicado.';
    if (container) container.innerHTML = 'Aplique filtros para visualizar os resultados.';
    relatorioAvancadoUltimosResultados = [];
    if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
}

function normalizarDataRelatorio(valor) {
    if (!valor) return null;
    if (valor instanceof Date) return valor;
    if (typeof valor === 'number') return new Date(valor);
    if (typeof valor === 'string') {
        if (/^\d{4}-\d{2}-\d{2}/.test(valor)) {
            return new Date(valor);
        }
        if (/^\d{2}\/\d{2}\/\d{4}/.test(valor)) {
            const [dia, mes, ano] = valor.split('/');
            return new Date(`${ano}-${mes}-${dia}`);
        }
        return new Date(valor);
    }
    return null;
}

function extrairDataRelatorio(item) {
    if (!item) return null;
    const campos = ['data', 'dataCriacao', 'dataInicio', 'dataRegisto', 'dataEntrada', 'dataLimite', 'vencimento'];
    for (const campo of campos) {
        if (item[campo]) {
            const data = normalizarDataRelatorio(item[campo]);
            if (data && !isNaN(data.getTime())) {
                return data;
            }
        }
    }
    return null;
}

function obterNomeClienteRelatorio(item) {
    if (!item) return 'N/D';
    if (item.clienteNome) return item.clienteNome;
    if (item.cliente) return item.cliente;
    if (item.clienteId) {
        const cliente = clientes.find(c => c.id === item.clienteId);
        return cliente ? cliente.nome : 'N/D';
    }
    return 'N/D';
}

function formatarDataRelatorio(data) {
    return data ? data.toLocaleDateString('pt-PT') : 'N/D';
}

function aplicarFiltrosRelatorioAvancado() {
    const clienteFiltro = document.getElementById('relatorioAvancadoCliente')?.value || '';
    const tipoFiltro = document.getElementById('relatorioAvancadoTipo')?.value || 'todos';
    const dataInicioValor = document.getElementById('relatorioAvancadoDataInicio')?.value || '';
    const dataFimValor = document.getElementById('relatorioAvancadoDataFim')?.value || '';
    
    // Validar datas: data início não pode ser depois da data fim
    if (dataInicioValor && dataFimValor) {
        const dI = new Date(dataInicioValor);
        const dF = new Date(dataFimValor);
        if (dI > dF) {
            mostrarNotificacao('A data de início não pode ser posterior à data de fim. Ajuste a data de fim para ser igual ou depois da data de início.', 'error');
            document.getElementById('relatorioAvancadoDataFim')?.focus();
            return;
        }
    }
    
    const dataInicio = normalizarDataRelatorio(dataInicioValor);
    const dataFim = normalizarDataRelatorio(dataFimValor);
    if (dataInicio && isNaN(dataInicio.getTime())) {
        mostrarNotificacao('Data de início inválida. Use o formato correto.', 'error');
        return;
    }
    if (dataFim && isNaN(dataFim.getTime())) {
        mostrarNotificacao('Data de fim inválida. Use o formato correto.', 'error');
        return;
    }
    if (dataFim) {
        dataFim.setHours(23, 59, 59, 999);
    }
    
    const fontes = [
        { tipo: 'honorarios', label: 'Honorários', itens: Array.isArray(honorarios) ? honorarios : [], map: (item, cliente, data) => ({
            tipo: 'Honorários',
            cliente,
            descricao: item.descricao || item.servico || item.tipo || 'Honorário',
            valor: item.valor,
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) },
        { tipo: 'contratos', label: 'Contratos', itens: Array.isArray(contratos) ? contratos : [], map: (item, cliente, data) => ({
            tipo: 'Contratos',
            cliente,
            descricao: item.tipo || item.descricao || 'Contrato',
            valor: item.valor,
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) },
        { tipo: 'herancas', label: 'Heranças', itens: Array.isArray(herancas) ? herancas : [], map: (item, cliente, data) => ({
            tipo: 'Heranças',
            cliente,
            descricao: item.tipo || item.descricao || 'Herança',
            valor: item.valor,
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) },
        { tipo: 'migracoes', label: 'Migrações', itens: Array.isArray(migracoes) ? migracoes : [], map: (item, cliente, data) => ({
            tipo: 'Migrações',
            cliente,
            descricao: item.tipo || item.descricao || 'Migração',
            valor: item.valor,
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) },
        { tipo: 'registos', label: 'Registos', itens: Array.isArray(registos) ? registos : [], map: (item, cliente, data) => ({
            tipo: 'Registos',
            cliente,
            descricao: item.tipo || item.descricao || 'Registo',
            valor: item.valor,
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) },
        { tipo: 'prazos', label: 'Prazos', itens: Array.isArray(prazos) ? prazos : [], map: (item, cliente, data) => ({
            tipo: 'Prazos',
            cliente,
            descricao: item.descricao || item.tipo || 'Prazo',
            valor: item.valor || '',
            status: item.status || 'N/D',
            data: formatarDataRelatorio(data),
            _data: data
        }) }
    ];
    
    let resultados = [];
    fontes.forEach(fonte => {
        if (tipoFiltro !== 'todos' && tipoFiltro !== fonte.tipo) {
            return;
        }
        fonte.itens.forEach(item => {
            const clienteNome = obterNomeClienteRelatorio(item);
            if (clienteFiltro && clienteNome !== clienteFiltro) return;
            
            const dataItem = extrairDataRelatorio(item);
            if ((dataInicio || dataFim) && (!dataItem || isNaN(dataItem.getTime()))) return;
            if (dataInicio && dataItem < dataInicio) return;
            if (dataFim && dataItem > dataFim) return;
            
            resultados.push(fonte.map(item, clienteNome, dataItem));
        });
    });
    
    resultados.sort((a, b) => {
        if (!a._data && !b._data) return 0;
        if (!a._data) return 1;
        if (!b._data) return -1;
        return b._data - a._data;
    });
    
    relatorioAvancadoUltimosResultados = resultados;
    window.relatorioAvancadoUltimosResultados = resultados;
    
    const resumo = document.getElementById('relatorioAvancadoResumo');
    if (resumo) {
        const filtrosAplicados = [
            clienteFiltro ? `Cliente: ${clienteFiltro}` : null,
            tipoFiltro !== 'todos' ? `Tipo: ${tipoFiltro}` : null,
            dataInicioValor ? `De: ${dataInicioValor}` : null,
            dataFimValor ? `Até: ${dataFimValor}` : null
        ].filter(Boolean).join(' | ');
        resumo.textContent = `Resultados: ${resultados.length}${filtrosAplicados ? ` • ${filtrosAplicados}` : ''}`;
    }
    
    const container = document.getElementById('relatorioAvancadoResultados');
    if (!container) return;
    
    if (resultados.length === 0) {
        container.innerHTML = '<div class="text-gray-500">Nenhum resultado encontrado para os filtros selecionados.</div>';
        return;
    }
    
    const limite = Math.min(resultados.length, 200);
    const linhas = resultados.slice(0, limite).map(item => `
        <tr class="border-b border-gray-200">
            <td class="py-2 pr-4 font-medium text-gray-700">${item.tipo}</td>
            <td class="py-2 pr-4">
                ${renderClienteLink(item.clienteId, item.cliente || item.clienteNome)}
                ${renderMetaAuditoria(item.tipo, item)}
            </td>
            <td class="py-2 pr-4">${item.descricao}</td>
            <td class="py-2 pr-4">${item.valor !== undefined && item.valor !== '' ? `€${(parseFloat(item.valor) || 0).toFixed(2)}` : '—'}</td>
            <td class="py-2 pr-4">${item.status}</td>
            <td class="py-2">${item.data}</td>
        </tr>
    `).join('');
    
    container.innerHTML = `
        <table class="min-w-full">
            <thead>
                <tr class="text-left text-xs uppercase tracking-wider text-gray-500 border-b border-gray-200">
                    <th class="py-2 pr-4">Tipo</th>
                    <th class="py-2 pr-4">Cliente</th>
                    <th class="py-2 pr-4">Descrição</th>
                    <th class="py-2 pr-4">Valor</th>
                    <th class="py-2 pr-4">Status</th>
                    <th class="py-2">Data</th>
                </tr>
            </thead>
            <tbody>
                ${linhas}
            </tbody>
        </table>
        ${resultados.length > limite ? `<div class="mt-2 text-xs text-gray-400">Mostrando ${limite} de ${resultados.length} resultados.</div>` : ''}
    `;
}

function exportarRelatorioAvancadoCsv() {
    if (!Array.isArray(relatorioAvancadoUltimosResultados) || relatorioAvancadoUltimosResultados.length === 0) {
        mostrarNotificacao('Aplique filtros para gerar resultados antes de exportar.', 'warning');
        return;
    }
    
    const headers = ['Tipo', 'Cliente', 'Descrição', 'Valor', 'Status', 'Data'];
    const escapeCsv = (valor) => {
        const texto = valor === null || valor === undefined ? '' : String(valor);
        if (texto.includes(';') || texto.includes('"') || texto.includes('\n')) {
            return `"${texto.replace(/"/g, '""')}"`;
        }
        return texto;
    };
    
    const linhas = relatorioAvancadoUltimosResultados.map(item => [
        item.tipo,
        item.cliente,
        item.descricao,
        item.valor !== undefined && item.valor !== '' ? (parseFloat(item.valor) || 0).toFixed(2) : '',
        item.status,
        item.data
    ].map(escapeCsv).join(';'));
    
    const csv = '\uFEFF' + [headers.join(';'), ...linhas].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `relatorio_avancado_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    mostrarNotificacao('Exportação Excel (CSV) concluída!', 'success');
}

function exportarRelatorioAvancadoPdf() {
    if (!Array.isArray(relatorioAvancadoUltimosResultados) || relatorioAvancadoUltimosResultados.length === 0) {
        mostrarNotificacao('Aplique filtros para gerar resultados antes de exportar.', 'warning');
        return;
    }
    
    const janela = window.open('', '_blank');
    if (!janela) {
        mostrarNotificacao('Bloqueio de pop-up: permita abrir a janela para exportar PDF.', 'warning');
        return;
    }
    
    const dataRelatorio = new Date().toLocaleString('pt-PT');
    const linhas = relatorioAvancadoUltimosResultados.slice(0, 500).map(item => `
        <tr>
            <td>${item.tipo}</td>
            <td>
                ${renderClienteLink(item.clienteId, item.cliente || item.clienteNome)}
                ${renderMetaAuditoria(item.tipo, item)}
            </td>
            <td>${item.descricao}</td>
            <td>${item.valor !== undefined && item.valor !== '' ? `€${(parseFloat(item.valor) || 0).toFixed(2)}` : '—'}</td>
            <td>${item.status}</td>
            <td>${item.data}</td>
        </tr>
    `).join('');
    
    janela.document.write(`
        <html>
        <head>
            <title>Relatório Avançado</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 24px; color: #111827; }
                h1 { font-size: 20px; margin-bottom: 6px; }
                p { font-size: 12px; color: #6b7280; margin-top: 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 12px; }
                th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: left; }
                th { background: #f3f4f6; }
            </style>
        </head>
        <body>
            <h1>Relatório Avançado</h1>
            <p>Gerado em ${dataRelatorio}</p>
            <table>
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Cliente</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody>
                    ${linhas}
                </tbody>
            </table>
            ${relatorioAvancadoUltimosResultados.length > 500 ? `<p>Mostrando 500 de ${relatorioAvancadoUltimosResultados.length} resultados.</p>` : ''}
        </body>
        </html>
    `);
    janela.document.close();
    setTimeout(() => {
        janela.focus();
        janela.print();
    }, 400);
}

function inicializarSecao(secao) {
    lucide.createIcons();
    
    if (secao === 'dashboard') {
        setTimeout(() => {
            criarGraficoHonorarios();
        }, 100);
    }
    if (secao === 'relatorios') {
        setTimeout(() => {
            inicializarRelatoriosAvancados();
        }, 100);
    }
    if (secao === 'notificacoes') {
        setTimeout(() => {
            inicializarAlertasAutomaticos();
        }, 100);
    }
    if (secao === 'documentos') {
        setTimeout(() => {
            aplicarFiltrosDocumentos();
            if (typeof toggleCamposProcuracaoAima === 'function') toggleCamposProcuracaoAima();
        }, 100);
    }
    if (secao === 'tarefas') {
        setTimeout(async () => {
            await sincronizarTarefasNuvem();
            aplicarFiltrosTarefas();
        }, 100);
    }
    if (secao === 'historico') {
        setTimeout(async () => {
            if (!window.__auditoriaCloudCarregada) {
                await sincronizarAuditoriaNuvem();
                const conteudoElement = document.getElementById('conteudoDinamico');
                if (conteudoElement) {
                    conteudoElement.innerHTML = gerarConteudoSecao('historico');
                }
            }
            aplicarFiltrosHistorico();
        }, 100);
    }
    if (secao === 'backup') {
        firestoreGetBackupLogs().then(logs => {
            window.__backupLogsCache = logs;
            if (secaoAtiva === 'backup') {
                const el = document.getElementById('conteudoDinamico');
                if (el) el.innerHTML = gerarConteudoSecao('backup');
            }
        });
        const btnExport = document.getElementById('btnExportBackup');
        if (btnExport) {
            btnExport.onclick = (typeof window.exportBackup === 'function') ? window.exportBackup : (typeof exportBackupFirestore === 'function' ? exportBackupFirestore : () => mostrarNotificacao('Módulo backup não carregado', 'warning'));
        }
        const inputImport = document.getElementById('inputImportBackup');
        const btnImport = document.getElementById('btnImportBackup');
        if (inputImport && typeof window.importBackup === 'function') {
            inputImport.onchange = (e) => {
                const f = e.target.files && e.target.files[0];
                if (f) window.importBackup(f, window.startAllListeners);
                e.target.value = '';
            };
        }
        if (btnImport && inputImport) {
            btnImport.onclick = () => inputImport.click();
        }
    }
}

function criarGraficoHonorarios() {
    const ctx = document.getElementById('chartHonorarios');
    if (!ctx) return;

    const chartAntigo = typeof Chart !== 'undefined' && Chart.getChart ? Chart.getChart(ctx) : null;
    if (chartAntigo) chartAntigo.destroy();

    const honorariosPagos = honorarios.filter(h => h.status === 'pago').length;
    const honorariosPendentes = honorarios.filter(h => isHonorarioEmAberto(h)).length;
    const honorariosVencidos = honorarios.filter(h => h.status === 'vencido').length;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Pagos', 'Pendentes', 'Vencidos'],
            datasets: [{
                data: [honorariosPagos, honorariosPendentes, honorariosVencidos],
                backgroundColor: [
                    '#10b981',
                    '#f59e0b',
                    '#ef4444'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function abrirModal(tipo) {
    const modal = criarModal(tipo);
    document.getElementById('modalContainer').innerHTML = modal;
    document.getElementById('modalContainer').classList.add('show');
    lucide.createIcons();
}

function abrirModalEdicaoCliente(cliente) {
    const modal = criarModalEdicaoCliente(cliente);
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('❌ modalContainer não encontrado!');
        return;
    }
    modalContainer.innerHTML = modal;
    modalContainer.classList.add('show');
    lucide.createIcons();
    
    // Adicionar listener direto no formulário após criá-lo
    setTimeout(() => {
        const form = document.getElementById(`formEditarCliente_${cliente.id}`);
        const btnSalvar = form ? form.querySelector('button[type="submit"]') : null;
        
        if (form) {
            
            // Adicionar listener no formulário
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const resultado = atualizarCliente(e, cliente.id);
                return false;
            }, false);
            
        } else {
            console.error('❌ Formulário não encontrado após criar modal (versão criarModalEdicaoCliente)!');
        }
        
        if (btnSalvar) {
            btnSalvar.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                if (form) {
                    const resultado = atualizarCliente(e, cliente.id);
                }
            }, false);
        } else {
            console.error('❌ Botão Salvar não encontrado após criar modal (versão criarModalEdicaoCliente)!');
        }
    }, 100);
}

function abrirModalEdicaoContrato(contrato) {
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    // Criar modal diretamente no body
    const modal = document.createElement('div');
    modal.id = 'modalEdicaoContrato';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = fecharModal;
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form onsubmit="atualizarContrato(event, ${JSON.stringify(contrato.id)})">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `
                                    <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                            <input type="text" id="editarContratoTipo" value="${contrato.tipo || ''}" list="tiposContratoEdicao2" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                            <datalist id="tiposContratoEdicao2">
                                <option value="Alteração de pactos sociais">
                                <option value="Análise e revisão de contratos">
                                <option value="Cessão de quotas">
                                <option value="Constituição de sociedades">
                                <option value="Contratos de arrendamento">
                                <option value="Contratos de compra e venda">
                                <option value="Contratos de prestação de serviços">
                                <option value="Contratos de trabalho">
                                <option value="Pactos sociais">
                                <option value="Consultoria">
                                <option value="Assessoria">
                                <option value="Representação">
                                <option value="Compra e Venda">
                                <option value="Arrendamento">
                                <option value="Prestação de Serviços">
                                <option value="Empréstimo">
                                <option value="Outro">
                            </datalist>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                            <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                    <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                    <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                    <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Adicionar ao body
    document.body.appendChild(modal);
    lucide.createIcons();
}

/** Escape fecha modais; foco no primeiro campo quando um modal abre; focus trap (acessibilidade). */
function inicializarAcessibilidadeModais() {
    let focusAntesModal = null;
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const mc = document.getElementById('modalContainer');
            if (mc && mc.children.length > 0) {
                if (typeof fecharModalRobusto === 'function') fecharModalRobusto();
                e.preventDefault();
                if (focusAntesModal && typeof focusAntesModal.focus === 'function') {
                    try { focusAntesModal.focus(); } catch (err) {}
                }
                return;
            }
            if (document.getElementById('modalAlterarSenha')) {
                if (typeof fecharModalAlterarSenha === 'function') fecharModalAlterarSenha();
                e.preventDefault();
            }
            return;
        }
        if (e.key !== 'Tab') return;
        const mc = document.getElementById('modalContainer');
        if (!mc || mc.children.length === 0 || mc.getAttribute('aria-hidden') === 'true') return;
        const focaveis = mc.querySelectorAll('input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), [tabindex="0"], a[href]');
        if (focaveis.length === 0) return;
        const first = focaveis[0];
        const last = focaveis[focaveis.length - 1];
        const active = document.activeElement;
        if (e.shiftKey) {
            if (active === first) { e.preventDefault(); try { last.focus(); } catch (err) {} }
        } else {
            if (active === last) { e.preventDefault(); try { first.focus(); } catch (err) {} }
        }
    });
    const mc = document.getElementById('modalContainer');
    if (mc && typeof MutationObserver !== 'undefined') {
        const obs = new MutationObserver(() => {
            if (mc.children.length === 0) return;
            focusAntesModal = document.activeElement;
            setTimeout(() => {
                const first = mc.querySelector('input:not([type="hidden"]), select, textarea, button[tabindex="0"], button:not([disabled])');
                if (first) try { first.focus(); } catch (err) {}
            }, 150);
        });
        obs.observe(mc, { childList: true, subtree: false });
    }
}

function fecharModal() {
    
    // Remover todos os modais com classe 'modal' PRIMEIRO
    const todosModais = document.querySelectorAll('.modal');
    todosModais.forEach(modal => {
        modal.remove();
    });
    
    // Limpar modalContainer
    const modalContainer = document.getElementById('modalContainer');
    if (modalContainer) {
        modalContainer.classList.remove('show');
        modalContainer.innerHTML = '';
    }
    
    // Remover qualquer modal que possa estar no body
    const modalsNoBody = document.querySelectorAll('.fixed.inset-0');
    modalsNoBody.forEach(modal => {
        modal.remove();
    });
    
    // Remover modais específicos
    const modalHeranca = document.getElementById('modalEdicaoHeranca');
    if (modalHeranca) {
        modalHeranca.remove();
    }
    
    const modalMigracao = document.getElementById('modalEdicaoMigracao');
    if (modalMigracao) {
        modalMigracao.remove();
    }
    
    const modalRegisto = document.getElementById('modalEdicaoRegisto');
    if (modalRegisto) {
        modalRegisto.remove();
    }
    
    // Remover qualquer modal de edição
    const modaisEdicao = document.querySelectorAll('[id^="modalEdicao"]');
    modaisEdicao.forEach(modal => {
        modal.remove();
    });
    
}

function criarModal(tipo) {
    const modais = {
        cliente: criarModalCliente(),
        honorario: criarModalHonorario(),
        contrato: criarModalContrato(),
        migracao: criarModalMigracao()
    };
    return modais[tipo] || '<div class="modal-content p-6">Modal não encontrado</div>';
}

function criarModalEdicaoCliente(cliente) {
    return `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Editar Cliente</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formEditarCliente_${String(cliente.id).replace(/"/g, '&quot;')}" onsubmit="return atualizarCliente(event, ${JSON.stringify(cliente.id)});">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                            <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                            <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                            <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                            <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6">
                        <div class="flex space-x-3">
                            <button type="button" onclick="excluirCliente(${JSON.stringify(cliente.id)})" class="btn btn-error">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Excluir
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function criarModalCliente() {
    return `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content p-6" style="max-width: 500px;" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Novo Cliente</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formCliente" onsubmit="salvarCliente(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                            <input type="text" id="clienteNome" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="clienteEmail" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                            <input type="tel" id="clienteTelefone" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                            <input type="text" id="clienteNIF" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                            <textarea id="clienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="clienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                                <option value="suspenso">Suspenso</option>
                            </select>
                        </div>
                        ${appStorage.getItem('tipoUsuario') === 'admin' ? `
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Convidados que podem ver este cliente</label>
                            <p class="text-xs text-gray-500 mb-2">Selecione os convidados a quem autorizar o acesso a este cliente</p>
                            <div id="convidadosAutorizarCliente" class="space-y-2 max-h-32 overflow-y-auto">
                                ${(obterConvidadosAtual() || []).filter(c => c.ativo).map(c => `
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" value="${c.codigo || c.id}" class="convidadoAutorizarCliente rounded border-gray-300">
                                        <span class="text-sm text-gray-700">${c.nome} (${c.codigo || ''})</span>
                                    </label>
                                `).join('')}
                            </div>
                            ${(obterConvidadosAtual() || []).filter(c => c.ativo).length === 0 ? '<p class="text-xs text-gray-500">Nenhum convidado ativo. Crie em Gestão de Convidados.</p>' : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function criarModalHonorario() {
    return `
        <div class="modal show">
            <div class="modal-content p-6" style="max-width: 500px;">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Novo Honorário</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formHonorario" onsubmit="salvarHonorario(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="honorarioCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `
                                    <option value="${cliente.id}">${cliente.nome}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                            <input type="text" id="honorarioServico" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                            <input type="number" id="honorarioValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="pendente">Pendente</option>
                                <option value="parcial">Parcial</option>
                                <option value="pago">Pago</option>
                                <option value="vencido">Vencido</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                            <input type="date" id="honorarioVencimento" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Honorário
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function criarModalContrato() {
    return `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Novo Contrato</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formContrato" onsubmit="salvarContrato(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="contratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `
                                    <option value="${cliente.id}" data-nome="${cliente.nome}">${cliente.nome}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                            <select id="contratoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Tipo</option>
                                <option value="Alteração de pactos sociais">Alteração de pactos sociais</option>
                                <option value="Análise e revisão de contratos">Análise e revisão de contratos</option>
                                <option value="Cessão de quotas">Cessão de quotas</option>
                                <option value="Constituição de sociedades">Constituição de sociedades</option>
                                <option value="Contratos de arrendamento">Contratos de arrendamento</option>
                                <option value="Contratos de compra e venda">Contratos de compra e venda</option>
                                <option value="Contratos de prestação de serviços">Contratos de prestação de serviços</option>
                                <option value="Contratos de trabalho">Contratos de trabalho</option>
                                <option value="Pactos sociais">Pactos sociais</option>
                                <option value="Consultoria">Consultoria</option>
                                <option value="Assessoria">Assessoria</option>
                                <option value="Representação">Representação</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="contratoValor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <select id="contratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="0">0% (Isento)</option>
                                    <option value="6">6% (Reduzida)</option>
                                    <option value="13">13% (Intermédia)</option>
                                    <option value="23" selected>23% (Normal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                <select id="contratoParceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('contrato')">
                                    <option value="sem">Sem parceria</option>
                                    <option value="empresa">Empresa</option>
                                    <option value="pessoa">Pessoa</option>
                                </select>
                            </div>
                            
                            <div id="contratoParceriaNomeDiv" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                <input type="text" id="contratoParceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                <input type="number" id="contratoPercentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                <input type="date" id="contratoDataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Contrato
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function criarModalEdicaoContrato(contrato) {
    return `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Editar Contrato</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formEditarContrato" onsubmit="atualizarContrato(event, ${JSON.stringify(contrato.id)})">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="editarContratoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `
                                    <option value="${cliente.id}" data-nome="${cliente.nome}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Serviço *</label>
                            <input type="text" id="editarContratoTipo" value="${contrato.tipo || ''}" list="tiposContratoEdicao2" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                            <datalist id="tiposContratoEdicao2">
                                <option value="Alteração de pactos sociais">
                                <option value="Análise e revisão de contratos">
                                <option value="Cessão de quotas">
                                <option value="Constituição de sociedades">
                                <option value="Contratos de arrendamento">
                                <option value="Contratos de compra e venda">
                                <option value="Contratos de prestação de serviços">
                                <option value="Contratos de trabalho">
                                <option value="Pactos sociais">
                                <option value="Consultoria">
                                <option value="Assessoria">
                                <option value="Representação">
                                <option value="Compra e Venda">
                                <option value="Arrendamento">
                                <option value="Prestação de Serviços">
                                <option value="Empréstimo">
                                <option value="Outro">
                            </datalist>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                            <textarea id="editarContratoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descreva os serviços a serem prestados...">${contrato.descricao || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="editarContratoValor" step="0.01" value="${contrato.valor || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <select id="editarContratoIVA" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="0" ${contrato.iva === 0 ? 'selected' : ''}>0% (Isento)</option>
                                    <option value="6" ${contrato.iva === 6 ? 'selected' : ''}>6% (Reduzida)</option>
                                    <option value="13" ${contrato.iva === 13 ? 'selected' : ''}>13% (Intermédia)</option>
                                    <option value="23" ${contrato.iva === 23 ? 'selected' : ''}>23% (Normal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="editarContratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="ativo" ${contrato.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                    <option value="suspenso" ${contrato.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                    <option value="terminado" ${contrato.status === 'terminado' ? 'selected' : ''}>Terminado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                                <input type="date" id="editarContratoDataInicio" value="${contrato.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="editarContratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o contrato...">${contrato.observacoes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-6">
                        <div class="flex space-x-3">
                            <button type="button" onclick="excluirContrato(${JSON.stringify(contrato.id)})" class="btn btn-error">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                Excluir
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Salvar Alterações
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    `;
}

async function salvarCliente(event) {
    event.preventDefault();
    
    
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const convidadoId = appStorage.getItem('convidadoId');
    
    // Validar dados únicos
    const nome = document.getElementById('clienteNome').value.trim();
    const email = document.getElementById('clienteEmail').value.trim();
    const telefone = document.getElementById('clienteTelefone').value.trim();
    const nif = document.getElementById('clienteNIF').value.trim();

    if (!nome || !email || !telefone || !nif) {
        mostrarNotificacao('Por favor, preencha todos os campos obrigatórios!', 'warning');
        return;
    }
    if (!validarEmail(email)) {
        mostrarNotificacao('Email inválido. Verifique o formato.', 'error');
        return;
    }
    if (!validarTelefone(telefone)) {
        mostrarNotificacao('Telefone inválido. Use apenas números (9 a 15 dígitos).', 'error');
        return;
    }
    if (!validarNIF(nif)) {
        mostrarNotificacao('NIF inválido. Verifique o número.', 'error');
        return;
    }
    
    // Verificar se já existe cliente com os mesmos dados
    const clienteExistente = clientes.find(c => 
        c.nome.toLowerCase() === nome.toLowerCase() ||
        (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
        (telefone && c.telefone && c.telefone === telefone) ||
        (nif && c.nif && c.nif === nif)
    );
    
    if (clienteExistente) {
        let mensagemErro = 'Já existe um cliente com:';
        if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
            mensagemErro += ' • Nome igual';
        }
        if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
            mensagemErro += ' • Email igual';
        }
        if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
            mensagemErro += ' • Telefone igual';
        }
        if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
            mensagemErro += ' • NIF igual';
        }
        
        mostrarNotificacao(mensagemErro, 'error');
        return;
    }
    
    const cliente = {
        id: gerarIdImutavel(),
        nome: nome,
        email: email,
        telefone: telefone,
        nif: nif,
        endereco: document.getElementById('clienteEndereco').value,
        status: document.getElementById('clienteStatus').value,
        dataCriacao: new Date().toISOString(),
        criadoPorConvidado: tipoUsuario === 'convidado' ? parseIdSafe(convidadoId) : null,
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        criadoPorTipo: tipoUsuario || 'N/D',
        criadoPorNome: appStorage.getItem('usuarioNome') || (tipoUsuario === 'convidado' ? 'Convidado' : 'Admin'),
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    clientes.push(cliente);
    
    if (isCloudReady()) {
        try {
            await criarClienteCloud(cliente);
            atualizarClientesEmMemoria(clientes);
        } catch (err) {
            console.warn('Erro ao criar cliente na nuvem, a guardar localmente:', err);
            atualizarClientesEmMemoria(clientes);
        }
    } else {
        atualizarClientesEmMemoria(clientes);
    }
    registrarAuditoria('criar', 'cliente', `Cliente criado: ${cliente.nome}`, null, cliente);
    
    // Se admin selecionou convidados, adicionar cliente às permissões deles
    const convidadosCheck = document.querySelectorAll('.convidadoAutorizarCliente:checked');
    if (convidadosCheck.length > 0 && tipoUsuario === 'admin') {
        const codigosSelecionados = Array.from(convidadosCheck).map(cb => String(cb.value));
        const listaConvidados = obterConvidadosAtual();
        listaConvidados.forEach(c => {
            if (codigosSelecionados.includes(String(c.codigo)) || codigosSelecionados.includes(String(c.id))) {
                const ids = new Set((c.clientesAutorizados || []).map(a => String(a)));
                ids.add(String(cliente.id));
                c.clientesAutorizados = Array.from(ids);
                if (isCloudReady()) salvarConvidadoCloud(c);
            }
        });
        convidados = listaConvidados;
        window.convidados = convidados;
        salvarDados('convidados', listaConvidados);
    }
    
    mostrarNotificacao('Cliente salvo com sucesso!', 'success');
    
    fecharModal();
    setTimeout(() => {
        carregarSecao('clientes');
    }, 100);
}

async function salvarHonorario(event) {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'honorario')) return;
    
    const valorHonorario = parseFloat(document.getElementById('honorarioValor').value);
    const clienteHonorario = document.getElementById('honorarioCliente').value.trim();
    const servicoHonorario = document.getElementById('honorarioServico').value.trim();
    const vencimentoHonorario = document.getElementById('honorarioVencimento').value;
    
    if (!clienteHonorario || !servicoHonorario || !vencimentoHonorario || !valorHonorario || valorHonorario <= 0) {
        mostrarNotificacao('Preencha os campos obrigatórios do honorário.', 'warning');
        return;
    }
    
    const clienteIdHon = parseIdSafe(document.getElementById('honorarioCliente')?.value) || clienteHonorario;
    const clienteHon = clientes.find(c => String(c.id) === String(clienteIdHon));
    const honorario = {
        id: gerarIdImutavel(),
        cliente: clienteHon?.nome || clienteHonorario,
        clienteId: clienteIdHon,
        clienteNome: clienteHon?.nome || clienteHonorario,
        servico: servicoHonorario,
        valor: valorHonorario,
        status: document.getElementById('honorarioStatus').value,
        vencimento: vencimentoHonorario,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    try {
        if (isCloudReady()) {
            await criarHonorarioCloud(honorario);
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios, { skipCloudSync: true });
        } else {
            honorarios.push(honorario);
            salvarDados('honorarios', honorarios);
        }
    } catch (err) {
        console.warn('Erro ao criar honorário na nuvem, a guardar localmente:', err);
        honorarios.push(honorario);
        salvarDados('honorarios', honorarios);
    }
    registrarAuditoria('criar', 'honorario', `Honorário criado: ${honorario.cliente}`, null, honorario);
    mostrarNotificacao('Honorário salvo com sucesso!', 'success');
    
    // Fechar modal imediatamente
    fecharModal();
    
    // Recarregar seção após um pequeno delay
    setTimeout(() => {
        carregarSecao('honorarios');
    }, 100);
}

async function salvarContrato(event) {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'contrato')) return;
    
    const clienteId = parseIdSafe(document.getElementById('contratoCliente').value);
    const clienteSelecionado = clientes.find(c => c.id === clienteId);
    
    const valor = parseFloat(document.getElementById('contratoValor').value);
    const ivaPercent = parseFloat(document.getElementById('contratoIVA').value);
    const percentagem = parseFloat(document.getElementById('contratoPercentagem').value) || 0;
    const valorIVA = (valor * ivaPercent) / 100;
    const valorTotal = valor + valorIVA;
    const tipoContrato = document.getElementById('contratoTipo').value.trim();
    const dataInicio = document.getElementById('contratoDataInicio').value;
    
    if (!clienteId || !tipoContrato || !dataInicio || !valor || valor <= 0) {
        mostrarNotificacao('Preencha os campos obrigatórios do contrato.', 'warning');
        return;
    }

    const contrato = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
        tipo: tipoContrato,
        valor: valor,
        iva: ivaPercent,
        percentagem: percentagem,
        valorIVA: valorIVA,
        valorTotal: valorTotal,
        status: document.getElementById('contratoStatus').value,
        dataInicio: dataInicio,
        observacoes: document.getElementById('contratoObservacoes').value,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };

    try {
        if (isCloudReady()) {
            await criarContratoCloud(contrato);
            contratos.push(contrato);
            salvarDados('contratos', contratos, { skipCloudSync: true });
        } else {
            contratos.push(contrato);
            salvarDados('contratos', contratos);
        }
    } catch (err) {
        console.warn('Erro ao criar contrato na nuvem, a guardar localmente:', err);
        contratos.push(contrato);
        salvarDados('contratos', contratos);
    }
    registrarAuditoria('criar', 'contrato', `Contrato criado: ${contrato.clienteNome}`, null, contrato);
    
    // Criar prazo automático para o contrato
    // Carregar prazos em memória antes de adicionar
    const prazosSalvos = appStorage.getItem('prazos');
    if (prazosSalvos) {
        prazos = JSON.parse(prazosSalvos);
        window.prazos = prazos;
    }
    
    const prazoContrato = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
        descricao: `Prazo para ${contrato.tipo}`,
        dataLimite: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 dias
        status: 'ativo',
        tipo: 'contrato',
        prioridade: 'media',
        referenciaId: contrato.id,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    prazos.push(prazoContrato);
    window.prazos = prazos;
    salvarDados('prazos', prazos);
    registrarAuditoria('criar', 'prazo', `Prazo criado para contrato: ${contrato.clienteNome}`, null, prazoContrato);
    
    mostrarNotificacao('Contrato e prazo criados com sucesso!', 'success');
    
    // Fechar modal imediatamente
    fecharModal();
    
    // Recarregar seção após um pequeno delay
    setTimeout(() => {
        carregarSecao('contratos');
    }, 100);
}

async function atualizarCliente(event, id) {
    
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        const clienteId = parseIdSafe(id);
        if (clienteId == null || clienteId === '') {
            console.error('❌ ID inválido:', id);
            mostrarNotificacao('ID de cliente inválido!', 'error');
            return false;
        }
        
        // Verificar se clientes está definido
        if (!clientes || !Array.isArray(clientes)) {
            console.error('❌ Array de clientes não está definido');
            // Tentar carregar dados
            const clientesAtual = obterClientesAtual();
            if (clientesAtual.length > 0) {
                clientes = clientesAtual;
                window.clientes = clientes;
            } else {
                mostrarNotificacao('Erro: Clientes não carregados!', 'error');
                return false;
            }
        }
        
        const clienteIndex = clientes.findIndex(c => String(c.id) === String(clienteId));
        
        if (clienteIndex === -1) {
            console.error('❌ Cliente não encontrado com ID:', clienteId);
            mostrarNotificacao('Cliente não encontrado!', 'error');
            return false;
        }
        
        if (!exigirPermissaoAcao('editar', 'cliente')) {
            return false;
        }
        
        // Obter valores do formulário
        const nomeInput = document.getElementById('editarClienteNome');
        const emailInput = document.getElementById('editarClienteEmail');
        const telefoneInput = document.getElementById('editarClienteTelefone');
        const nifInput = document.getElementById('editarClienteNIF');
        const enderecoInput = document.getElementById('editarClienteEndereco');
        const statusInput = document.getElementById('editarClienteStatus');
        
        if (!nomeInput || !emailInput || !telefoneInput || !nifInput) {
            console.error('❌ Campos do formulário não encontrados');
            mostrarNotificacao('Erro: Formulário não encontrado!', 'error');
            return false;
        }
        
        const nome = nomeInput.value.trim();
        const email = emailInput.value.trim();
        const telefone = telefoneInput.value.trim();
        const nif = nifInput.value.trim();
        const endereco = enderecoInput ? enderecoInput.value.trim() : '';
        const status = statusInput ? statusInput.value : 'ativo';
        
        
        // Validar campos obrigatórios
        if (!nome || !email || !telefone || !nif) {
            console.error('❌ Campos obrigatórios não preenchidos');
            mostrarNotificacao('Por favor, preencha todos os campos obrigatórios!', 'error');
            return false;
        }
        if (!validarEmail(email)) {
            mostrarNotificacao('Email inválido. Verifique o formato.', 'error');
            return false;
        }
        if (!validarTelefone(telefone)) {
            mostrarNotificacao('Telefone inválido. Use apenas números (9 a 15 dígitos).', 'error');
            return false;
        }
        if (!validarNIF(nif)) {
            mostrarNotificacao('NIF inválido. Verifique o número.', 'error');
            return false;
        }
        
        // Verificar se já existe outro cliente com os mesmos dados (excluindo o cliente atual)
        const clienteExistente = clientes.find(c => 
            String(c.id) !== String(clienteId) && (
                c.nome.toLowerCase() === nome.toLowerCase() ||
                (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                (telefone && c.telefone && c.telefone === telefone) ||
                (nif && c.nif && c.nif === nif)
            )
        );
        
        if (clienteExistente) {
            let mensagemErro = 'Já existe outro cliente com:';
            if (clienteExistente.nome.toLowerCase() === nome.toLowerCase()) {
                mensagemErro += ' • Nome igual';
            }
            if (email && clienteExistente.email && clienteExistente.email.toLowerCase() === email.toLowerCase()) {
                mensagemErro += ' • Email igual';
            }
            if (telefone && clienteExistente.telefone && clienteExistente.telefone === telefone) {
                mensagemErro += ' • Telefone igual';
            }
            if (nif && clienteExistente.nif && clienteExistente.nif === nif) {
                mensagemErro += ' • NIF igual';
            }
            
            console.warn('⚠️ Cliente duplicado encontrado:', clienteExistente);
            mostrarNotificacao(mensagemErro, 'error');
            return false;
        }
        
        // Atualizar cliente
        const clienteAntes = { ...clientes[clienteIndex] };
        const clienteAtualizado = {
            ...clientes[clienteIndex],
            nome: nome,
            email: email,
            telefone: telefone,
            nif: nif,
            endereco: endereco,
            status: status,
            dataAtualizacao: new Date().toISOString()
        };
        
        clientes[clienteIndex] = clienteAtualizado;
        
        try {
            if (isCloudReady()) {
                await atualizarClienteCloud(clienteId, clienteAtualizado);
                atualizarClientesEmMemoria(clientes);
            } else {
                atualizarClientesEmMemoria(clientes);
            }
            registrarAuditoria('atualizar', 'cliente', `Cliente atualizado: ${clienteAtualizado.nome}`, clienteAntes, clienteAtualizado);
        } catch (saveError) {
            console.error('❌ Erro ao salvar:', saveError);
            mostrarNotificacao('Erro ao salvar dados: ' + saveError.message, 'error');
            return false;
        }
        
        // Mostrar notificação
        mostrarNotificacao('Cliente atualizado com sucesso!', 'success');
        
        // Fechar modal usando fecharModalRobusto para garantir que funciona
        fecharModalRobusto();
        
        // Recarregar seção após um pequeno delay
        setTimeout(() => {
            carregarSecao('clientes');
        }, 300);
        
        return true;
        
    } catch (error) {
        console.error('❌ Erro ao atualizar cliente:', error);
        console.error('❌ Stack trace:', error.stack);
        mostrarNotificacao('Erro ao atualizar cliente: ' + error.message, 'error');
        return false;
    }
}

// Garantir que atualizarCliente seja globalmente acessível
window.atualizarCliente = atualizarCliente;

async function excluirCliente(id) {
    if (!confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) return;
    if (!exigirAdmin('exclusão de clientes')) return;

    const clienteAntes = clientes.find(c => String(c.id) === String(id));
    if (!clienteAntes) {
        mostrarNotificacao('Cliente não encontrado.', 'error');
        return;
    }

    try {
        if (isCloudReady()) {
            await apagarClienteCloud(id);
            clientes = clientes.filter(c => String(c.id) !== String(id));
            atualizarClientesEmMemoria(clientes);
        } else {
            clientes = clientes.filter(c => String(c.id) !== String(id));
            atualizarClientesEmMemoria(clientes);
        }
        registrarAuditoria('excluir', 'cliente', `Cliente excluído: ${clienteAntes.nome}`, clienteAntes, null);
        mostrarNotificacao('Cliente excluído com sucesso!', 'success');
        fecharModal();
        setTimeout(() => carregarSecao('clientes'), 100);
    } catch (err) {
        console.warn('Erro ao apagar cliente na nuvem:', err);
        clientes = clientes.filter(c => String(c.id) !== String(id));
        atualizarClientesEmMemoria(clientes);
        registrarAuditoria('excluir', 'cliente', `Cliente excluído: ${clienteAntes.nome}`, clienteAntes, null);
        mostrarNotificacao('Cliente excluído com sucesso!', 'success');
        fecharModal();
        setTimeout(() => carregarSecao('clientes'), 100);
    }
}

async function excluirClienteDireto(id) {
    
    if (!exigirPermissaoAcao('apagar', 'cliente')) return;
    if (!confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) return;

    let clientesAtual = obterClientesAtual();
    const clientesAtualizados = clientesAtual.filter(c => String(c.id) !== String(id));
    
    try {
        if (isCloudReady()) {
            await apagarClienteCloud(id);
            clientes = clientesAtualizados;
            window.clientes = clientes;
            atualizarClientesEmMemoria(clientesAtualizados);
        } else {
            atualizarClientesEmMemoria(clientesAtualizados);
        }
        mostrarNotificacao('Cliente excluído com sucesso!', 'success');
        setTimeout(() => {
            carregarSecao('clientes');
            if (typeof atualizarListaClientes === 'function') atualizarListaClientes(clientesAtualizados);
        }, 100);
    } catch (err) {
        console.warn('Erro ao apagar na nuvem, a guardar localmente:', err);
        atualizarClientesEmMemoria(clientesAtualizados);
        mostrarNotificacao('Cliente excluído com sucesso!', 'success');
        setTimeout(() => carregarSecao('clientes'), 100);
    }
}

async function atualizarContrato(event, id) {
    event.preventDefault();
    const contratoIndex = contratos.findIndex(c => String(c.id) === String(id));
    if (contratoIndex === -1) {
        mostrarNotificacao('Contrato não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('editar', 'contrato')) return;

    // Suporta dois modais: editarContrato* (secção contratos) ou contrato* (secção calendário)
    const useEditar = !!document.getElementById('editarContratoCliente');
    const prefix = useEditar ? 'editarContrato' : 'contrato';
    const sufixoCliente = useEditar ? 'Cliente' : 'ClienteId';
    const sufixoValor = useEditar ? 'Valor' : 'Valor';
    const sufixoIva = useEditar ? 'IVA' : 'Iva';

    const elCliente = document.getElementById(prefix + sufixoCliente);
    const clienteId = parseIdSafe(elCliente?.value);
    const clienteSelecionado = clientes.find(c => String(c.id) === String(clienteId));
    const valor = parseFloat(document.getElementById(prefix + sufixoValor)?.value) || 0;
    const ivaPercent = parseFloat(document.getElementById(prefix + sufixoIva)?.value) || 0;
    const valorIVA = (valor * ivaPercent) / 100;
    const valorTotal = valor + valorIVA;

    const dados = {
        ...contratos[contratoIndex],
        clienteId, clienteNome: clienteSelecionado ? clienteSelecionado.nome : '',
        tipo: document.getElementById(prefix + 'Tipo')?.value,
        descricao: document.getElementById(prefix + 'Descricao')?.value || '',
        valor, iva: ivaPercent, valorIVA, valorTotal,
        status: document.getElementById(prefix + 'Status')?.value,
        dataInicio: document.getElementById(prefix + 'DataInicio')?.value,
        dataFim: document.getElementById(prefix + 'DataFim')?.value || null,
        observacoes: document.getElementById(prefix + 'Observacoes')?.value || '',
        dataAtualizacao: new Date().toISOString()
    };

    try {
        if (isCloudReady()) {
            await atualizarContratoCloud(String(id), dados);
            contratos[contratoIndex] = dados;
            salvarDados('contratos', contratos, { skipCloudSync: true });
        } else {
            contratos[contratoIndex] = dados;
            salvarDados('contratos', contratos);
        }
        mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
        (typeof fecharModalRobusto === 'function' ? fecharModalRobusto : fecharModal)();
        setTimeout(() => carregarSecao('contratos'), useEditar ? 100 : 300);
    } catch (err) {
        console.warn('Erro ao atualizar contrato na nuvem:', err);
        contratos[contratoIndex] = dados;
        salvarDados('contratos', contratos);
        mostrarNotificacao('Contrato atualizado com sucesso!', 'success');
        (typeof fecharModalRobusto === 'function' ? fecharModalRobusto : fecharModal)();
        setTimeout(() => carregarSecao('contratos'), useEditar ? 100 : 300);
    }
}

async function excluirContrato(id) {
    if (!confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) return;

    const contratoAntes = contratos.find(c => String(c.id) === String(id));
    const contratosAtualizados = contratos.filter(c => String(c.id) !== String(id));

    try {
        if (isCloudReady()) {
            await apagarContratoCloud(id);
            contratos = contratosAtualizados;
            salvarDados('contratos', contratos, { skipCloudSync: true });
        } else {
            contratos = contratosAtualizados;
            salvarDados('contratos', contratos);
        }
        if (contratoAntes) registrarAuditoria('excluir', 'contrato', `Contrato excluído: ${contratoAntes.tipo}`, contratoAntes, null);
        mostrarNotificacao('Contrato excluído com sucesso!', 'success');
        fecharModal();
        setTimeout(() => carregarSecao('contratos'), 100);
    } catch (err) {
        console.warn('Erro ao apagar contrato na nuvem:', err);
        contratos = contratosAtualizados;
        salvarDados('contratos', contratos);
        if (contratoAntes) registrarAuditoria('excluir', 'contrato', `Contrato excluído: ${contratoAntes.tipo}`, contratoAntes, null);
        mostrarNotificacao('Contrato excluído com sucesso!', 'success');
        fecharModal();
        setTimeout(() => carregarSecao('contratos'), 100);
    }
}

function filtrarClientes() {
    aplicarFiltrosClientes();
}

function ordenarClientes(col) {
    let o = window.__clientesOrdenar;
    if (!o) try { o = JSON.parse(appStorage.getItem('ordenarClientes') || '{}'); } catch(e) {}
    o = o && o.col ? o : { col: 'nome', dir: 1 };
    if (o.col === col) o.dir = o.dir === 1 ? -1 : 1;
    else { o.col = col; o.dir = 1; }
    window.__clientesOrdenar = o;
    try { appStorage.setItem('ordenarClientes', JSON.stringify(o)); } catch (e) {}
    aplicarFiltrosClientes();
}
function aplicarFiltrosClientes() {
    const busca = document.getElementById('buscaClientes')?.value.toLowerCase() || '';
    const buscaNif = document.getElementById('buscaNifClientes')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusCliente')?.value || '';
    const dataFiltro = document.getElementById('filtroDataCliente')?.value || '';
    
    let clientesFiltrados = clientes.filter(cliente => {
        // Filtro por busca de texto (nome, email, telefone)
        const matchBusca = !busca || 
            cliente.nome.toLowerCase().includes(busca) || 
            cliente.email.toLowerCase().includes(busca) ||
            cliente.telefone.toLowerCase().includes(busca);
        
        // Filtro por NIF
        const matchNif = !buscaNif || 
            (cliente.nif && cliente.nif.toLowerCase().includes(buscaNif));
        
        // Filtro por status
        const matchStatus = !status || cliente.status === status;
        
        // Filtro por data
        let matchData = true;
        if (dataFiltro) {
            const dataCliente = new Date(cliente.dataCriacao);
            const hoje = new Date();
            
            switch (dataFiltro) {
                case 'hoje':
                    matchData = dataCliente.toDateString() === hoje.toDateString();
                    break;
                case 'semana':
                    const inicioSemana = new Date(hoje);
                    inicioSemana.setDate(hoje.getDate() - hoje.getDay());
                    matchData = dataCliente >= inicioSemana;
                    break;
                case 'mes':
                    matchData = dataCliente.getMonth() === hoje.getMonth() && 
                                dataCliente.getFullYear() === hoje.getFullYear();
                    break;
                case 'ano':
                    matchData = dataCliente.getFullYear() === hoje.getFullYear();
                    break;
            }
        }
        
        return matchBusca && matchNif && matchStatus && matchData;
    });
    let ord = window.__clientesOrdenar;
    if (!ord || !ord.col) try { ord = JSON.parse(appStorage.getItem('ordenarClientes') || '{}'); } catch(e) {}
    ord = ord && ord.col ? ord : { col: 'nome', dir: 1 };
    const k = ord.col; const d = ord.dir;
    clientesFiltrados = clientesFiltrados.slice().sort((a, b) => {
        let va = a[k] ?? ''; let vb = b[k] ?? '';
        if (k === 'dataCriacao') { va = new Date(va).getTime(); vb = new Date(vb).getTime(); return d * (va - vb); }
        va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
        return d * (va < vb ? -1 : va > vb ? 1 : 0);
    });
    atualizarListaClientes(clientesFiltrados);
    document.getElementById('contadorClientes').textContent = clientesFiltrados.length;
    try { appStorage.setItem('filtrosClientes', JSON.stringify({ busca, buscaNif, status, dataFiltro })); } catch (e) {}
}

function restaurarFiltrosClientes() {
    const set = (id, val) => { const el = document.getElementById(id); if (el && val != null) el.value = val; };
    try {
        const s = appStorage.getItem('filtrosClientes');
        if (!s) {
            set('filtroStatusCliente', 'ativo');
            return;
        }
        const o = JSON.parse(s);
        set('buscaClientes', o.busca);
        set('buscaNifClientes', o.buscaNif);
        // Por defeito mostrar apenas Ativo; evitar "Todos" guardado em sessões antigas
        set('filtroStatusCliente', (o.status && o.status !== '') ? o.status : 'ativo');
        set('filtroDataCliente', o.dataFiltro);
    } catch (e) {
        set('filtroStatusCliente', 'ativo');
    }
}

function limparFiltrosClientes() {
    document.getElementById('buscaClientes').value = '';
    document.getElementById('buscaNifClientes').value = '';
    document.getElementById('filtroStatusCliente').value = '';
    document.getElementById('filtroDataCliente').value = '';
    aplicarFiltrosClientes();
}

function ordenarHonorarios(col) {
    let o = window.__honorariosOrdenar;
    if (!o) try { o = JSON.parse(appStorage.getItem('ordenarHonorarios') || '{}'); } catch(e) {}
    o = o && o.col ? o : { col: 'vencimento', dir: 1 };
    if (o.col === col) o.dir = o.dir === 1 ? -1 : 1;
    else { o.col = col; o.dir = 1; }
    window.__honorariosOrdenar = o;
    try { appStorage.setItem('ordenarHonorarios', JSON.stringify(o)); } catch (e) {}
    aplicarFiltrosHonorarios();
}
function filtrarHonorarios() {
    aplicarFiltrosHonorarios();
}

function aplicarFiltrosHonorarios() {
    const busca = document.getElementById('buscaHonorarios')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusHonorario')?.value || '';
    const valorMin = parseFloat(document.getElementById('filtroValorMinHonorario')?.value) || 0;
    const valorMax = parseFloat(document.getElementById('filtroValorMaxHonorario')?.value) || Infinity;
    const vencimento = document.getElementById('filtroVencimentoHonorario')?.value || '';
    
    
    let honorariosFiltrados = honorarios.filter(honorario => {
        // Filtro por busca de texto (nome do cliente, serviço, valor)
        const nomeCliente = (honorario.cliente || honorario.clienteNome || (typeof obterNomeClienteRelatorio === 'function' ? obterNomeClienteRelatorio(honorario) : '') || '').toString().toLowerCase();
        const servico = (honorario.servico || '').toString().toLowerCase();
        const valorStr = (honorario.valor != null ? String(honorario.valor) : '').toLowerCase();
        const matchBusca = !busca || 
            nomeCliente.includes(busca) || 
            servico.includes(busca) ||
            valorStr.includes(busca);
        
        // Filtro por status
        const matchStatus = !status || honorario.status === status;
        
        // Filtro por valor
        const valor = parseFloat(honorario.valor) || 0;
        const matchValor = valor >= valorMin && valor <= valorMax;
        
        // Filtro por vencimento
        let matchVencimento = true;
        if (vencimento && honorario.vencimento) {
            const dataVencimento = new Date(honorario.vencimento);
            const hoje = new Date();
            
            switch (vencimento) {
                case 'hoje':
                    matchVencimento = dataVencimento.toDateString() === hoje.toDateString();
                    break;
                case 'semana':
                    const fimSemana = new Date(hoje);
                    fimSemana.setDate(hoje.getDate() + 7);
                    matchVencimento = dataVencimento >= hoje && dataVencimento <= fimSemana;
                    break;
                case 'mes':
                    const fimMes = new Date(hoje);
                    fimMes.setMonth(hoje.getMonth() + 1);
                    matchVencimento = dataVencimento >= hoje && dataVencimento <= fimMes;
                    break;
                case 'vencido':
                    matchVencimento = dataVencimento < hoje;
                    break;
            }
        }
        
        return matchBusca && matchStatus && matchValor && matchVencimento;
    });
    let ordH = window.__honorariosOrdenar;
    if (!ordH || !ordH.col) try { ordH = JSON.parse(appStorage.getItem('ordenarHonorarios') || '{}'); } catch(e) {}
    ordH = ordH && ordH.col ? ordH : { col: 'vencimento', dir: 1 };
    const kH = ordH.col; const dH = ordH.dir;
    honorariosFiltrados = honorariosFiltrados.slice().sort((a, b) => {
        if (kH === 'valor') return dH * ((parseFloat(a.valor) || 0) - (parseFloat(b.valor) || 0));
        if (kH === 'vencimento') return dH * (new Date(a.vencimento || 0).getTime() - new Date(b.vencimento || 0).getTime());
        if (kH === 'status') return dH * (String(a.status || '').localeCompare(String(b.status || '')));
        if (kH === 'cliente') return dH * (String(a.cliente || a.clienteNome || '').toLowerCase().localeCompare(String(b.cliente || b.clienteNome || '').toLowerCase()));
        if (kH === 'servico') return dH * (String(a.servico || '').toLowerCase().localeCompare(String(b.servico || '').toLowerCase()));
        return 0;
    });
    atualizarListaHonorarios(honorariosFiltrados);
    
    const contador = document.getElementById('contadorHonorarios');
    if (contador) {
        contador.textContent = honorariosFiltrados.length;
    }
    
    // Reinicializar ícones Lucide após aplicar filtros
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100);
    try { appStorage.setItem('filtrosHonorarios', JSON.stringify({ busca, status, valorMin: valorMin || '', valorMax: valorMax === Infinity ? '' : valorMax, vencimento })); } catch (e) {}
}

function restaurarFiltrosHonorarios() {
    try {
        const s = appStorage.getItem('filtrosHonorarios');
        if (!s) return;
        const o = JSON.parse(s);
        const set = (id, val) => { const el = document.getElementById(id); if (el && val != null && val !== '') el.value = val; };
        set('buscaHonorarios', o.busca);
        set('filtroStatusHonorario', o.status);
        set('filtroValorMinHonorario', o.valorMin);
        set('filtroValorMaxHonorario', o.valorMax);
        set('filtroVencimentoHonorario', o.vencimento);
    } catch (e) {}
}

function limparFiltrosHonorarios() {
    document.getElementById('buscaHonorarios').value = '';
    document.getElementById('filtroStatusHonorario').value = '';
    document.getElementById('filtroValorMinHonorario').value = '';
    document.getElementById('filtroValorMaxHonorario').value = '';
    document.getElementById('filtroVencimentoHonorario').value = '';
    aplicarFiltrosHonorarios();
}

function ordenarContratos(col) {
    let o = window.__contratosOrdenar;
    if (!o) try { o = JSON.parse(appStorage.getItem('ordenarContratos') || '{}'); } catch(e) {}
    o = o && o.col ? o : { col: 'clienteNome', dir: 1 };
    if (o.col === col) o.dir = o.dir === 1 ? -1 : 1;
    else { o.col = col; o.dir = 1; }
    window.__contratosOrdenar = o;
    try { appStorage.setItem('ordenarContratos', JSON.stringify(o)); } catch (e) {}
    aplicarFiltrosContratos();
}
function filtrarContratos() {
    aplicarFiltrosContratos();
}

function aplicarFiltrosContratos() {
    const busca = document.getElementById('buscaContratos')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusContrato')?.value || '';
    const clienteId = document.getElementById('filtroClienteContrato')?.value || '';
    const valorMin = parseFloat(document.getElementById('filtroValorMinContrato')?.value) || 0;
    const valorMax = parseFloat(document.getElementById('filtroValorMaxContrato')?.value) || Infinity;
    const nif = document.getElementById('filtroNifContrato')?.value || '';
    
    let contratosFiltrados = contratos.filter(contrato => {
        // Filtro por busca de texto
        const matchBusca = !busca || 
            contrato.clienteNome.toLowerCase().includes(busca) || 
            contrato.tipo.toLowerCase().includes(busca) ||
            (contrato.observacoes && contrato.observacoes.toLowerCase().includes(busca));
        
        // Filtro por status
        const matchStatus = !status || contrato.status === status;
        
        // Filtro por cliente
        const matchCliente = !clienteId || contrato.clienteId == clienteId;
        
        // Filtro por valor
        const valor = parseFloat(contrato.valor) || 0;
        const matchValor = valor >= valorMin && valor <= valorMax;
        
        // Filtro por NIF
        const cliente = clientes.find(c => c.id === contrato.clienteId);
        const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
        
        return matchBusca && matchStatus && matchCliente && matchValor && matchNif;
    });
    let ordC = window.__contratosOrdenar;
    if (!ordC || !ordC.col) try { ordC = JSON.parse(appStorage.getItem('ordenarContratos') || '{}'); } catch(e) {}
    ordC = ordC && ordC.col ? ordC : { col: 'clienteNome', dir: 1 };
    const kC = ordC.col; const dC = ordC.dir;
    contratosFiltrados = contratosFiltrados.slice().sort((a, b) => {
        if (kC === 'valor') return dC * ((parseFloat(a.valor) || 0) - (parseFloat(b.valor) || 0));
        if (kC === 'dataInicio') return dC * (new Date(a.dataInicio || 0).getTime() - new Date(b.dataInicio || 0).getTime());
        if (kC === 'status') return dC * (String(a.status || '').localeCompare(String(b.status || '')));
        if (kC === 'clienteNome' || kC === 'tipo') return dC * (String(a[kC] || '').toLowerCase().localeCompare(String(b[kC] || '').toLowerCase()));
        return 0;
    });
    atualizarListaContratos(contratosFiltrados);
    
    const contador = document.getElementById('contadorContratos');
    if (contador) {
        contador.textContent = contratosFiltrados.length;
    }
    
    // Reinicializar ícones Lucide após aplicar filtros
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100);
    try { appStorage.setItem('filtrosContratos', JSON.stringify({ busca, status, clienteId, valorMin: valorMin || '', valorMax: valorMax === Infinity ? '' : valorMax, nif })); } catch (e) {}
}

function restaurarFiltrosContratos() {
    try {
        const s = appStorage.getItem('filtrosContratos');
        if (!s) return;
        const o = JSON.parse(s);
        const set = (id, val) => { const el = document.getElementById(id); if (el && val != null && val !== '') el.value = val; };
        set('buscaContratos', o.busca);
        set('filtroStatusContrato', o.status);
        set('filtroClienteContrato', o.clienteId);
        set('filtroValorMinContrato', o.valorMin);
        set('filtroValorMaxContrato', o.valorMax);
        set('filtroNifContrato', o.nif);
    } catch (e) {}
}

function limparFiltrosContratos() {
    document.getElementById('buscaContratos').value = '';
    document.getElementById('filtroStatusContrato').value = '';
    document.getElementById('filtroClienteContrato').value = '';
    document.getElementById('filtroValorMinContrato').value = '';
    document.getElementById('filtroValorMaxContrato').value = '';
    document.getElementById('filtroNifContrato').value = '';
    aplicarFiltrosContratos();
}

function atualizarListaClientes(clientesFiltrados) {
    const tbody = document.getElementById('listaClientes');
    if (!tbody) return;
    if (clientesFiltrados.length === 0) {
        const temFiltros = (document.getElementById('buscaClientes')?.value?.trim() || document.getElementById('buscaNifClientes')?.value?.trim() || document.getElementById('filtroStatusCliente')?.value || document.getElementById('filtroDataCliente')?.value);
        const msg = clientes.length > 0 && temFiltros
            ? '<tr><td colspan="7" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum cliente corresponde aos filtros.</p><button type="button" onclick="limparFiltrosClientes()" class="btn btn-secondary text-sm">Limpar Filtros</button></td></tr>'
            : '<tr><td colspan="7" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum cliente ainda.</p><button type="button" onclick="abrirModal(\'cliente\')" class="btn btn-primary text-sm">Adicionar primeiro cliente</button></td></tr>';
        tbody.innerHTML = msg;
        setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons(); }, 50);
        return;
    }
    const limit = Math.max(LISTA_PAGINA_TAMANHO, window.__clientesLimit || LISTA_PAGINA_TAMANHO);
    const mostrar = clientesFiltrados.slice(0, limit);
    const rows = mostrar.map(cliente => `
        <tr>
            <td>
                <button onclick="mostrarInformacoesCompletasCliente(${JSON.stringify(cliente).replace(/"/g, '&quot;')})" 
                        class="text-blue-600 hover:text-blue-800 font-medium cursor-pointer hover:underline flex items-center gap-1" 
                        title="Clicar para ver informações completas">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    ${cliente.nome}
                </button>
            </td>
            <td>${cliente.email}</td>
            <td>${cliente.telefone}</td>
            <td>${cliente.nif || '-'}</td>
            <td><span class="status-badge status-${cliente.status || 'ativo'}">${cliente.status || 'Ativo'}</span></td>
            <td>${obterRotuloCriadorCliente(cliente)}</td>
            <td>
                <button type="button" data-cliente-id="${String(cliente.id).replace(/"/g, '&quot;')}" data-cliente-acao="editar" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button type="button" data-cliente-id="${String(cliente.id).replace(/"/g, '&quot;')}" data-cliente-acao="excluir" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('');
    const verMais = clientesFiltrados.length > limit ? `<tr><td colspan="7" class="text-center py-3 border-t"><button type="button" onclick="window.__clientesLimit = (window.__clientesLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosClientes();" class="btn btn-secondary text-sm">Ver mais (${clientesFiltrados.length - limit} restantes)</button></td></tr>` : '';
    tbody.innerHTML = rows + verMais;
    
    // Reinicializar ícones Lucide
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 50);
}

function atualizarListaHonorarios(honorariosFiltrados) {
    const tbody = document.getElementById('listaHonorarios');
    if (!tbody) return;
    if (honorariosFiltrados.length === 0) {
        const temFiltros = (document.getElementById('buscaHonorarios')?.value?.trim() || document.getElementById('filtroStatusHonorario')?.value || document.getElementById('filtroValorMinHonorario')?.value || document.getElementById('filtroValorMaxHonorario')?.value || document.getElementById('filtroVencimentoHonorario')?.value);
        const msg = honorarios.length > 0 && temFiltros
            ? '<tr><td colspan="6" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum honorário corresponde aos filtros.</p><button type="button" onclick="limparFiltrosHonorarios()" class="btn btn-secondary text-sm">Limpar Filtros</button></td></tr>'
            : '<tr><td colspan="6" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum honorário registado.</p><button type="button" onclick="abrirModal(\'honorario\')" class="btn btn-primary text-sm">Adicionar honorário</button></td></tr>';
        tbody.innerHTML = msg;
        setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons(); }, 50);
        return;
    }
    const limitH = Math.max(LISTA_PAGINA_TAMANHO, window.__honorariosLimit || LISTA_PAGINA_TAMANHO);
    const mostrarH = honorariosFiltrados.slice(0, limitH);
    const rowsH = mostrarH.map(honorario => `
        <tr class="js-honorario-row" data-cliente-id="${honorario.clienteId || ''}" data-cliente-nome="${String(honorario.cliente || honorario.clienteNome || '').replace(/"/g, '&quot;')}" style="cursor: pointer;">
            <td>
                ${renderClienteLink(honorario.clienteId, honorario.cliente || honorario.clienteNome)}
            </td>
            <td>${honorario.servico}</td>
            <td>€${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}</td>
            <td><span class="status-badge status-${honorario.status}">${formatarStatusHonorario(honorario.status)}</span></td>
            <td>${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}</td>
            <td>
                <button class="btn-editar-honorario text-blue-600 hover:text-blue-800 mr-2" data-id="${String(honorario.id).replace(/"/g, '&quot;')}" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button class="btn-duplicar-honorario text-green-600 hover:text-green-800 mr-2" data-id="${String(honorario.id).replace(/"/g, '&quot;')}" title="Duplicar">
                    <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button class="btn-excluir-honorario text-red-600 hover:text-red-800" data-id="${String(honorario.id).replace(/"/g, '&quot;')}" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('');
    const verMaisH = honorariosFiltrados.length > limitH ? `<tr><td colspan="6" class="text-center py-3 border-t"><button type="button" onclick="window.__honorariosLimit = (window.__honorariosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosHonorarios();" class="btn btn-secondary text-sm">Ver mais (${honorariosFiltrados.length - limitH} restantes)</button></td></tr>` : '';
    tbody.innerHTML = rowsH + verMaisH;
    
    // Adicionar event listeners
    tbody.querySelectorAll('.btn-editar-honorario').forEach(btn => {
        btn.addEventListener('click', function() { editarHonorarioDireto(this.getAttribute('data-id')); });
    });
    
    tbody.querySelectorAll('.btn-duplicar-honorario').forEach(btn => {
        btn.addEventListener('click', function(e) { e.stopPropagation(); duplicarHonorario(this.getAttribute('data-id')); });
    });
    
    tbody.querySelectorAll('.btn-excluir-honorario').forEach(btn => {
        btn.addEventListener('click', function() {
            excluirHonorarioDireto(this.getAttribute('data-id'));
        });
    });
    
    // Reinicializar ícones Lucide
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 50);
}

function atualizarListaContratos(contratosFiltrados) {
    const tbody = document.getElementById('listaContratos');
    if (!tbody) return;
    if (contratosFiltrados.length === 0) {
        const temFiltros = (document.getElementById('buscaContratos')?.value?.trim() || document.getElementById('filtroStatusContrato')?.value || document.getElementById('filtroClienteContrato')?.value || document.getElementById('filtroValorMinContrato')?.value || document.getElementById('filtroValorMaxContrato')?.value || document.getElementById('filtroNifContrato')?.value);
        const msg = contratos.length > 0 && temFiltros
            ? '<tr><td colspan="7" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum contrato corresponde aos filtros.</p><button type="button" onclick="limparFiltrosContratos()" class="btn btn-secondary text-sm">Limpar Filtros</button></td></tr>'
            : '<tr><td colspan="7" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum contrato registado.</p><button type="button" onclick="abrirModal(\'contrato\')" class="btn btn-primary text-sm">Adicionar contrato</button></td></tr>';
        tbody.innerHTML = msg;
        setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons(); }, 50);
        return;
    }
    const limitC = Math.max(LISTA_PAGINA_TAMANHO, window.__contratosLimit || LISTA_PAGINA_TAMANHO);
    const mostrarC = contratosFiltrados.slice(0, limitC);
    const rowsC = mostrarC.map(contrato => `
        <tr>
            <td>${renderClienteLink(contrato.clienteId, contrato.clienteNome)}</td>
            <td>${contrato.tipo}</td>
            <td>${contrato.descricao || '-'}</td>
            <td>
                ${(() => {
                    const valor = parseFloat(contrato.valor) || 0;
                    const iva = parseFloat(contrato.iva) || 0;
                    const valorComIVA = Number(valor) + (Number(valor) * Number(iva) / 100);
                    const valorFormatado = Math.round(valor * 100) / 100;
                    const valorComIVAFormatado = Math.round(valorComIVA * 100) / 100;
                    return `
                        <div class="text-sm font-bold text-black">€${valorFormatado.toFixed(2)}</div>
                        <div class="text-xs font-bold text-red-600">+ IVA: €${valorComIVAFormatado.toFixed(2)}</div>
                    `;
                })()}
            </td>
            <td><span class="status-badge status-${contrato.status}">${contrato.status === 'concluido' ? 'Concluído' : contrato.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span></td>
            <td>${contrato.dataInicio ? new Date(contrato.dataInicio).toLocaleDateString('pt-PT') : '-'}</td>
            <td>
                <button onclick="editarContratoDireto(${JSON.stringify(contrato.id)})" class="text-blue-600 hover:text-blue-800 mr-2" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="duplicarContrato(${JSON.stringify(contrato.id)})" class="text-green-600 hover:text-green-800 mr-2" title="Duplicar">
                    <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="abrirAnexosContrato(${JSON.stringify(contrato.id)})" class="text-green-600 hover:text-green-800 mr-2" title="Documentos">
                    <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirContratoDireto(${JSON.stringify(contrato.id)})" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('');
    const verMaisC = contratosFiltrados.length > limitC ? `<tr><td colspan="7" class="text-center py-3 border-t"><button type="button" onclick="window.__contratosLimit = (window.__contratosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosContratos();" class="btn btn-secondary text-sm">Ver mais (${contratosFiltrados.length - limitC} restantes)</button></td></tr>` : '';
    tbody.innerHTML = rowsC + verMaisC;
    
    // Reinicializar ícones Lucide após atualizar a lista
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
    }, 100);
}

function mostrarNotificacao(mensagem, tipo = 'info') {
    const container = document.getElementById('notificationsContainer');
    if (!container) {
        // Se não há container, criar notificação temporária
        const notificacao = document.createElement('div');
        notificacao.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
        
        const cores = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            warning: 'bg-yellow-500 text-white',
            info: 'bg-blue-500 text-white'
        };
        
        notificacao.className += ` ${cores[tipo] || cores.info}`;
        notificacao.textContent = mensagem;
        
        document.body.appendChild(notificacao);
        
        // Remover após 5 segundos
        setTimeout(() => {
            if (notificacao.parentNode) {
                notificacao.parentNode.removeChild(notificacao);
            }
        }, 5000);
        return;
    }
    
    const notification = document.createElement('div');
    notification.className = `notification ${tipo}`;
    notification.textContent = mensagem;
    
    container.appendChild(notification);
    
    setTimeout(() => notification.classList.add('show'), 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function atualizarInterface() {
    lucide.createIcons();
    atualizarContadoresSidebar();
    atualizarDataHeader();
}

/** Atualiza a data no header (ex: "15 fev. 2026"). */
function atualizarDataHeader() {
    const el = document.getElementById('headerData');
    if (!el) return;
    el.textContent = new Date().toLocaleDateString('pt-PT', { day: 'numeric', month: 'short', year: 'numeric' });
}

/** Mostra contadores (ex: 12) nos itens da sidebar para dar visão rápida dos dados. */
function atualizarContadoresSidebar() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const obterPrazos = typeof obterPrazosAtual === 'function' ? obterPrazosAtual : () => (prazos || []);
    const obterTarefas = typeof obterTarefasAtual === 'function' ? obterTarefasAtual : () => (tarefas || []);

    const mapa = [
        { secao: 'clientes', navId: 'nav-clientes', count: () => (Array.isArray(clientes) ? clientes.filter(c => (c.status || 'ativo') === 'ativo') : []).length },
        { secao: 'honorarios', navId: 'nav-honorarios', count: () => (Array.isArray(honorarios) ? honorarios : []).length, extra: 'honorarios' },
        { secao: 'pagamentos', navId: 'nav-pagamentos', count: () => (Array.isArray(pagamentos) ? pagamentos : []).length },
        { secao: 'despesas', navId: 'nav-despesas', count: () => (Array.isArray(despesas) ? despesas : []).length },
        { secao: 'contratos', navId: 'nav-contratos', count: () => (Array.isArray(contratos) ? contratos : []).length },
        { secao: 'herancas', navId: 'nav-herancas', count: () => (Array.isArray(herancas) ? herancas : []).length },
        { secao: 'migracoes', navId: 'nav-migracao', count: () => (Array.isArray(migracoes) ? migracoes : []).length },
        { secao: 'registos', navId: 'nav-registos', count: () => (Array.isArray(registos) ? registos : []).length },
        { secao: 'prazos', navId: 'nav-prazos', count: () => obterPrazos().length, extra: 'prazos' },
        { secao: 'tarefas', navId: 'nav-tarefas', count: () => obterTarefas().length, extra: 'tarefas' },
        { secao: 'documentos', navId: 'nav-documentos', count: () => (Array.isArray(documentos) ? documentos : []).length },
        { secao: 'integracoes', navId: 'nav-integracoes', count: () => (Array.isArray(integracoesExternas) ? integracoesExternas : []).length }
    ];

    mapa.forEach(({ navId, count, extra }) => {
        const el = document.getElementById(navId);
        if (!el) return;
        let badge = el.querySelector('.sidebar-count');
        const n = count();
        if (n > 0) {
            if (!badge) {
                badge = document.createElement('span');
                badge.className = 'sidebar-count ml-auto text-xs bg-white/20 rounded-full px-2 py-0.5 min-w-[1.5rem] text-center';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.appendChild(badge);
            }
            if (extra === 'prazos') {
                const lista = obterPrazos();
                const hoje = new Date();
                const vencidos = lista.filter(p => p.status === 'ativo' && p.dataLimite && new Date(p.dataLimite) < hoje);
                if (vencidos.length > 0) {
                    badge.textContent = `${n} (${vencidos.length} venc.)`;
                    badge.classList.add('!bg-red-500/90', '!text-white');
                } else {
                    badge.textContent = n;
                    badge.classList.remove('!bg-red-500/90', '!text-white');
                }
            } else if (extra === 'honorarios') {
                const lista = Array.isArray(honorarios) ? honorarios : [];
                const hoje = new Date();
                const vencidos = lista.filter(h => {
                    if (!h || (h.status === 'pago')) return false;
                    if (!h.vencimento) return false;
                    return new Date(h.vencimento) < hoje;
                });
                if (vencidos.length > 0) {
                    badge.textContent = `${n} (${vencidos.length} venc.)`;
                    badge.classList.add('!bg-red-500/90', '!text-white');
                } else {
                    badge.textContent = n;
                    badge.classList.remove('!bg-red-500/90', '!text-white');
                }
            } else if (extra === 'tarefas') {
                const lista = obterTarefas();
                const pendentes = lista.filter(t => !(t.concluida === true || t.status === 'concluida'));
                if (pendentes.length > 0) {
                    badge.textContent = `${n} (${pendentes.length} pend.)`;
                    badge.classList.add('!bg-amber-500/90', '!text-white');
                } else {
                    badge.textContent = n;
                    badge.classList.remove('!bg-amber-500/90', '!text-white');
                }
            } else {
                badge.textContent = n;
                badge.classList.remove('!bg-red-500/90', '!text-white');
            }
            badge.style.display = '';
        } else if (badge) {
            badge.style.display = 'none';
        }
    });
}

// Função fecharModal duplicada removida

function editarItem(tipo, id) {
    
    // Fechar qualquer modal aberto primeiro
    fecharModal();
    
    if (tipo === 'cliente') {
        const cliente = clientes.find(c => c.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'cliente', cliente)) return;
        if (cliente) {
            abrirModalEdicaoCliente(cliente);
        }
    } else if (tipo === 'contrato') {
        const contrato = contratos.find(c => c.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'contrato', contrato)) return;
        if (contrato) {
            // Aguardar um pouco para garantir que o modal anterior foi fechado
            setTimeout(() => {
                abrirModalEdicaoContrato(contrato);
            }, 100);
        } else {
            console.error('Contrato não encontrado com ID:', id);
            mostrarNotificacao('Contrato não encontrado!', 'error');
        }
    } else if (tipo === 'honorario') {
        const honorario = honorarios.find(h => h.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'honorario', honorario)) return;
        if (honorario) {
            abrirModalEdicaoHonorario(honorario);
        }
    } else if (tipo === 'heranca') {
        const heranca = herancas.find(h => h.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'heranca', heranca)) return;
        if (heranca) {
            abrirModalEdicaoHeranca(heranca);
        }
    } else if (tipo === 'migracao') {
        const migracao = migracoes.find(m => m.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'migracao', migracao)) return;
        if (migracao) {
            abrirModalEdicaoMigracao(migracao);
        }
    } else if (tipo === 'registo') {
        const registo = registos.find(r => r.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'registo', registo)) return;
        if (registo) {
            abrirModalEdicaoRegisto(registo);
        }
    } else if (tipo === 'prazo') {
        const prazo = prazos.find(p => p.id === id);
        if (!exigirPermissaoAcaoItem('editar', 'prazo', prazo)) return;
        if (prazo) {
            abrirModalEdicaoPrazo(prazo);
        }
    } else {
        mostrarNotificacao('Funcionalidade de edição em desenvolvimento', 'info');
    }
}

function excluirItem(tipo, id) {

    if (!exigirPermissaoAcao('apagar', tipo)) {
        return;
    }
    // Cliente: usa excluirClienteDireto (permite convidados, tem seu próprio confirm)
    if (tipo === 'cliente') {
        excluirClienteDireto(id);
        return;
    }
    if (!exigirAdmin('exclusão de dados')) {
        return;
    }
    if (confirm('Tem certeza que deseja excluir este item?')) {
        if (tipo === 'honorario') {
            const itemAntes = honorarios.find(item => String(item.id) === String(id));
            const honorariosAtualizados = honorarios.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarHonorarioCloud(id).then(() => {
                    honorarios = honorariosAtualizados;
                    salvarDados('honorarios', honorarios, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'honorario', `Honorário excluído: ${itemAntes.cliente || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar honorário na nuvem:', err);
                    honorarios = honorariosAtualizados;
                    salvarDados('honorarios', honorarios);
                    if (itemAntes) registrarAuditoria('excluir', 'honorario', `Honorário excluído: ${itemAntes.cliente || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            honorarios = honorariosAtualizados;
            salvarDados('honorarios', honorarios);
            if (itemAntes) registrarAuditoria('excluir', 'honorario', `Honorário excluído: ${itemAntes.cliente || id}`, itemAntes, null);
        } else if (tipo === 'contrato') {
            const itemAntes = contratos.find(item => String(item.id) === String(id));
            const contratosAtualizados = contratos.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarContratoCloud(id).then(() => {
                    contratos = contratosAtualizados;
                    salvarDados('contratos', contratos, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'contrato', `Contrato excluído: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar contrato na nuvem:', err);
                    contratos = contratosAtualizados;
                    salvarDados('contratos', contratos);
                    if (itemAntes) registrarAuditoria('excluir', 'contrato', `Contrato excluído: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            contratos = contratosAtualizados;
            salvarDados('contratos', contratos);
            if (itemAntes) registrarAuditoria('excluir', 'contrato', `Contrato excluído: ${itemAntes.clienteNome || id}`, itemAntes, null);
        } else if (tipo === 'heranca') {
            const itemAntes = herancas.find(item => String(item.id) === String(id));
            const herancasAtualizadas = herancas.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarProcessoCloud('herancas', id).then(() => {
                    herancas = herancasAtualizadas;
                    window.herancas = herancas;
                    salvarDados('herancas', herancas, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'heranca', `Herança excluída: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar herança na nuvem:', err);
                    herancas = herancasAtualizadas;
                    salvarDados('herancas', herancas);
                    if (itemAntes) registrarAuditoria('excluir', 'heranca', `Herança excluída: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            herancas = herancasAtualizadas;
            salvarDados('herancas', herancas);
            if (itemAntes) registrarAuditoria('excluir', 'heranca', `Herança excluída: ${itemAntes?.clienteNome || id}`, itemAntes, null);
        } else if (tipo === 'migracao') {
            const itemAntes = migracoes.find(item => String(item.id) === String(id));
            const migracoesAtualizadas = migracoes.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarProcessoCloud('migracoes', id).then(() => {
                    migracoes = migracoesAtualizadas;
                    window.migracoes = migracoes;
                    salvarDados('migracoes', migracoes, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'migracao', `Migração excluída: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar migração na nuvem:', err);
                    migracoes = migracoesAtualizadas;
                    salvarDados('migracoes', migracoes);
                    if (itemAntes) registrarAuditoria('excluir', 'migracao', `Migração excluída: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            migracoes = migracoesAtualizadas;
            salvarDados('migracoes', migracoes);
            if (itemAntes) registrarAuditoria('excluir', 'migracao', `Migração excluída: ${itemAntes?.clienteNome || id}`, itemAntes, null);
        } else if (tipo === 'registo') {
            const itemAntes = registos.find(item => String(item.id) === String(id));
            const registosAtualizados = registos.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarProcessoCloud('registos', id).then(() => {
                    registos = registosAtualizados;
                    window.registos = registos;
                    salvarDados('registos', registos, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'registo', `Registo excluído: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar registo na nuvem:', err);
                    registos = registosAtualizados;
                    salvarDados('registos', registos);
                    if (itemAntes) registrarAuditoria('excluir', 'registo', `Registo excluído: ${itemAntes.clienteNome || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            registos = registosAtualizados;
            salvarDados('registos', registos);
            if (itemAntes) registrarAuditoria('excluir', 'registo', `Registo excluído: ${itemAntes?.clienteNome || id}`, itemAntes, null);
        } else if (tipo === 'prazo') {
            const itemAntes = prazos.find(item => String(item.id) === String(id));
            const prazosAtualizados = prazos.filter(item => String(item.id) !== String(id));
            if (isCloudReady()) {
                apagarPrazoCloud(id).then(() => {
                    prazos = prazosAtualizados;
                    window.prazos = prazos;
                    salvarDados('prazos', prazos, { skipCloudSync: true });
                    if (itemAntes) registrarAuditoria('excluir', 'prazo', `Prazo excluído: ${itemAntes.descricao || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                }).catch((err) => {
                    console.warn('Erro ao apagar prazo na nuvem:', err);
                    prazos = prazosAtualizados;
                    salvarDados('prazos', prazos);
                    if (itemAntes) registrarAuditoria('excluir', 'prazo', `Prazo excluído: ${itemAntes.descricao || id}`, itemAntes, null);
                    mostrarNotificacao('Item excluído com sucesso!', 'success');
                    carregarSecao(secaoAtiva);
                });
                return;
            }
            prazos = prazosAtualizados;
            salvarDados('prazos', prazos);
            if (itemAntes) registrarAuditoria('excluir', 'prazo', `Prazo excluído: ${itemAntes?.descricao || id}`, itemAntes, null);
        }
        mostrarNotificacao('Item excluído com sucesso!', 'success');
        carregarSecao(secaoAtiva);
    }
}

function exportarDados() {
    exportarDadosCompletos();
}

function importarDados() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario !== 'admin' && tipoUsuario !== 'convidado') {
        mostrarNotificacao('Acesso restrito: não pode importar dados.', 'error');
        return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const reporListeners = () => { if (isCloudReady()) listenerManager.resume(iniciarListenersFirestore); };
                try {
                    if (isCloudReady()) listenerManager.pause();
                    const dados = JSON.parse(e.target.result);
                    if (dados.dados) {
                        clientes = dados.dados.clientes || [];
                        honorarios = dados.dados.honorarios || [];
                        contratos = dados.dados.contratos || [];
                        atualizarClientesEmMemoria(clientes);
                        salvarDados('honorarios', honorarios);
                        salvarDados('contratos', contratos);
                        registrarAuditoria('importar', 'backup', 'Importação parcial (clientes/honorários/contratos)');
                        if (typeof logBackup === 'function') logBackup('Importação parcial (clientes/honorários/contratos)');
                        mostrarNotificacao('Dados importados com sucesso!', 'success');
                        reporListeners();
                        carregarSecao(secaoAtiva);
                    } else {
                        reporListeners();
                    }
                } catch (error) {
                    mostrarNotificacao('Erro ao importar dados', 'error');
                    registrarErro('importarDados', error);
                    if (typeof logBackup === 'function') logBackup('Erro importar parcial: ' + (error?.message || error));
                    reporListeners();
                }
            };
            reader.readAsText(file);
        }
    };
    input.click();
}

function gerarRelatorioClientes() {
    const relatorio = `
RELATÓRIO DE CLIENTES
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

Total de Clientes: ${clientes.length}

CLIENTES CADASTRADOS:
${clientes.map((cliente, index) => `
${index + 1}. ${cliente.nome}
   Email: ${cliente.email}
   Telefone: ${cliente.telefone}
   Status: ${cliente.status}
   Data: ${new Date(cliente.dataCriacao).toLocaleDateString('pt-PT')}
`).join('')}
    `;
    
    downloadRelatorio(relatorio, 'relatorio_clientes.pdf');
}

function gerarRelatorioFinanceiro() {
    const valorTotal = honorarios.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    const honorariosPagos = honorarios.filter(h => h.status === 'pago');
    const valorPago = honorariosPagos.reduce((sum, h) => sum + (parseFloat(h.valor) || 0), 0);
    
    const relatorio = `
RELATÓRIO FINANCEIRO
====================
Data: ${new Date().toLocaleDateString('pt-PT')}

RESUMO FINANCEIRO:
- Total de Honorários: ${honorarios.length}
- Valor Total: €${(Math.round(valorTotal * 100) / 100).toFixed(2)}
- Valor Pago: €${Number(valorPago).toFixed(2)}
- Valor Pendente: €${Number(valorTotal - valorPago).toFixed(2)}

HONORÁRIOS POR STATUS:
- Pagos: ${honorarios.filter(h => h.status === 'pago').length}
- Pendentes: ${honorarios.filter(h => isHonorarioEmAberto(h)).length}
- Vencidos: ${honorarios.filter(h => h.status === 'vencido').length}

DETALHES DOS HONORÁRIOS:
${honorarios.map((honorario, index) => `
${index + 1}. ${honorario.cliente} - ${honorario.servico}
   Valor: €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)}
   Status: ${formatarStatusHonorario(honorario.status)}
   Vencimento: ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}
`).join('')}
    `;
    
    downloadRelatorio(relatorio, 'relatorio_financeiro.pdf');
}


function downloadRelatorio(conteudo, nomeArquivo) {
    const nomePdf = (nomeArquivo || 'relatorio.pdf').replace(/\.txt$/i, '.pdf');
    textoParaPdf('Relatório', conteudo, 'baixar', nomePdf);
}

// === SISTEMA DE BACKUP AUTOMÁTICO ===

const BACKUP_CONFIG = {
    intervaloMs: 15 * 60 * 1000,
    downloadIntervalMs: 24 * 60 * 60 * 1000
};
let backupInterval;
let persistenciaInterval;
let ultimoBackup = null;
let ultimoBackupDownload = appStorage.getItem('ultimoBackupDownload') || null;
let backupAutoDownloadAtivo = JSON.parse(appStorage.getItem('backupAutoDownloadAtivo') || 'true');
let persistenciaAtiva = JSON.parse(appStorage.getItem('persistenciaAtiva') || 'false');
let persistenciaUltimoSalvamento = appStorage.getItem('persistenciaUltimoSalvamento') || null;

function iniciarSistemaBackup() {
    
    // Backup inicial
    criarBackupAutomatico();
    
    // Backup a cada 5 minutos
    backupInterval = setInterval(() => {
        criarBackupAutomatico();
    }, BACKUP_CONFIG.intervaloMs);
    
    // Backup antes de fechar a página
    window.addEventListener('beforeunload', () => {
        criarBackupAutomatico();
    });
    
    if (persistenciaAtiva) {
        iniciarPersistenciaExterna();
    }
}

function criarBackupAutomatico() {
    try {
        const backup = {
            timestamp: new Date().toISOString(),
            dados: {
                clientes: clientes,
                honorarios: honorarios,
                contratos: contratos,
                prazos: prazos,
                notificacoes: notificacoes,
                herancas: herancas,
                migracoes: migracoes,
                registos: registos
            },
            versao: '1.0',
            tipo: 'automatico'
        };
        
        // Salvar backup (exportação)
        const backupKey = `backup_${Date.now()}`;
        appStorage.setItem(backupKey, JSON.stringify(backup));
        
        // Manter apenas os últimos 10 backups
        limparBackupsAntigos();
        
        ultimoBackup = backup.timestamp;
        verificarDownloadAutomatico(backup);
        if (typeof logBackup === 'function') logBackup('Backup automático criado: ' + backup.timestamp);
        
    } catch (error) {
        console.error('❌ Erro ao criar backup automático:', error);
        registrarErro('criarBackupAutomatico', error);
        if (typeof logBackup === 'function') logBackup('Erro backup: ' + (error?.message || error));
    }
}

function verificarDownloadAutomatico(backup) {
    if (!backupAutoDownloadAtivo) return;
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario !== 'admin') return;
    const agora = Date.now();
    const ultimo = ultimoBackupDownload ? new Date(ultimoBackupDownload).getTime() : 0;
    if (agora - ultimo >= BACKUP_CONFIG.downloadIntervalMs) {
        baixarBackupAutomatico(backup);
    }
}

function baixarBackupAutomatico(backup) {
    try {
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_automatico_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        ultimoBackupDownload = new Date().toISOString();
        appStorage.setItem('ultimoBackupDownload', ultimoBackupDownload);
        registrarAuditoria('backup', 'sistema', 'Backup automático com download');
        if (typeof logBackup === 'function') logBackup('Download automático realizado');
    } catch (error) {
        console.error('❌ Erro ao baixar backup automático:', error);
        registrarErro('baixarBackupAutomatico', error);
        if (typeof logBackup === 'function') logBackup('Erro download automático: ' + (error?.message || error));
    }
}

function toggleBackupAutoDownload(ativo) {
    backupAutoDownloadAtivo = !!ativo;
    appStorage.setItem('backupAutoDownloadAtivo', JSON.stringify(backupAutoDownloadAtivo));
    mostrarNotificacao(`Backup automático com download ${backupAutoDownloadAtivo ? 'ativado' : 'desativado'}.`, 'info');
}

async function ativarPersistenciaExterna() {
    if (!exigirAdmin('persistência externa')) return;
    if (!('showSaveFilePicker' in window)) {
        mostrarNotificacao('Seu navegador não suporta persistência externa automática.', 'warning');
        return;
    }
    try {
        const handle = await window.showSaveFilePicker({
            suggestedName: `backup_persistente_${new Date().toISOString().split('T')[0]}.json`,
            types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
        });
        window._persistenciaHandle = handle;
        persistenciaAtiva = true;
        appStorage.setItem('persistenciaAtiva', 'true');
        salvarPersistenciaExterna();
        iniciarPersistenciaExterna();
        mostrarNotificacao('Persistência externa ativada.', 'success');
    } catch (error) {
        console.error('❌ Erro ao ativar persistência externa:', error);
        registrarErro('ativarPersistenciaExterna', error);
    }
}

function desativarPersistenciaExterna() {
    persistenciaAtiva = false;
    appStorage.setItem('persistenciaAtiva', 'false');
    if (persistenciaInterval) clearInterval(persistenciaInterval);
    mostrarNotificacao('Persistência externa desativada.', 'info');
}

function iniciarPersistenciaExterna() {
    if (!persistenciaAtiva) return;
    if (persistenciaInterval) clearInterval(persistenciaInterval);
    persistenciaInterval = setInterval(() => {
        salvarPersistenciaExterna();
    }, 10 * 60 * 1000);
}

async function salvarPersistenciaExterna() {
    try {
        if (!persistenciaAtiva || !window._persistenciaHandle) {
            return;
        }
        const dadosCompletos = {
            timestamp: new Date().toISOString(),
            versao: '1.0',
            dados: {
                clientes: clientes,
                honorarios: honorarios,
                contratos: contratos,
                prazos: prazos,
                notificacoes: notificacoes,
                herancas: herancas,
                migracoes: migracoes,
                registos: registos
            }
        };
        const writable = await window._persistenciaHandle.createWritable();
        await writable.write(JSON.stringify(dadosCompletos, null, 2));
        await writable.close();
        persistenciaUltimoSalvamento = new Date().toISOString();
        appStorage.setItem('persistenciaUltimoSalvamento', persistenciaUltimoSalvamento);
    } catch (error) {
        console.error('❌ Erro ao salvar persistência externa:', error);
        registrarErro('salvarPersistenciaExterna', error);
    }
}

function limparBackupsAntigos() {
    const chaves = Object.keys(appStorage);
    const backups = chaves.filter(chave => chave.startsWith('backup_'));
    
    if (backups.length > 10) {
        // Ordenar por timestamp (mais antigos primeiro)
        const backupsOrdenados = backups.sort((a, b) => {
            const timestampA = parseInt(a.split('_')[1]);
            const timestampB = parseInt(b.split('_')[1]);
            return timestampA - timestampB;
        });
        
        // Remover os mais antigos
        const paraRemover = backupsOrdenados.slice(0, backups.length - 10);
        paraRemover.forEach(chave => {
            appStorage.removeItem(chave);
        });
        
    }
}

function exportarDadosCompletos() {
    try {
        const tipoUsuario = appStorage.getItem('tipoUsuario');
        if (tipoUsuario !== 'admin' && tipoUsuario !== 'convidado') {
            mostrarNotificacao('Acesso restrito: não pode exportar dados.', 'error');
            return;
        }
        const dadosCompletos = {
            timestamp: new Date().toISOString(),
            versao: '1.0',
            dados: {
                clientes: clientes,
                honorarios: honorarios,
                contratos: contratos,
                prazos: prazos,
                notificacoes: notificacoes,
                herancas: herancas,
                migracoes: migracoes,
                registos: registos
            },
            estatisticas: {
                totalClientes: clientes.length,
                totalHonorarios: honorarios.length,
                totalContratos: contratos.length,
                totalPrazos: prazos.length,
                totalNotificacoes: notificacoes.length,
                totalHerancas: herancas.length,
                totalMigracoes: migracoes.length,
                totalRegistos: registos.length
            }
        };
        
        const blob = new Blob([JSON.stringify(dadosCompletos, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_sistema_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        mostrarNotificacao('Backup exportado com sucesso!', 'success');
        registrarAuditoria('exportar', 'backup', 'Exportação completa da base de dados');
        try { appStorage.setItem('backupExportUltimo', new Date().toISOString()); } catch (e) {}
        if (typeof logBackup === 'function') logBackup('Exportação completa realizada');
    } catch (error) {
        console.error('❌ Erro ao exportar dados:', error);
        mostrarNotificacao('Erro ao exportar backup', 'error');
        registrarErro('exportarDadosCompletos', error);
        if (typeof logBackup === 'function') logBackup('Erro exportar: ' + (error?.message || error));
    }
}

/** Lembrete periódico (1x por semana) para exportar backup. */
function verificarLembreteBackup() {
    const CHAVE_EXPORT = 'backupExportUltimo';
    const CHAVE_LEMBRETE = 'backupLembreteUltimaVez';
    const INTERVALO_MS = 7 * 24 * 60 * 60 * 1000; // 7 dias
    try {
        const agora = Date.now();
        const ultimoExport = appStorage.getItem(CHAVE_EXPORT);
        const ultimoLembrete = appStorage.getItem(CHAVE_LEMBRETE);
        const haExportRecent = ultimoExport && (agora - new Date(ultimoExport).getTime() < INTERVALO_MS);
        const haLembreteRecent = ultimoLembrete && (agora - new Date(ultimoLembrete).getTime() < INTERVALO_MS);
        if (haExportRecent || haLembreteRecent) return;
        appStorage.setItem(CHAVE_LEMBRETE, new Date().toISOString());
        if (typeof mostrarNotificacao === 'function') {
            mostrarNotificacao('Recomendamos exportar um backup dos seus dados. Use o botão Exportar no menu.', 'info');
        }
    } catch (e) { console.warn('Lembrete backup:', e); }
}

/** Mostra notificação nativa do browser (reutilizável). secaoAoClique: 'dashboard' | 'tarefas' | 'prazos' | etc. */
function mostrarNotificacaoBrowser(titulo, corpo, tag, secaoAoClique) {
    if (typeof Notification === 'undefined' || Notification.permission !== 'granted') return;
    try {
        const notif = new Notification(titulo, {
            body: corpo,
            tag: tag || 'sistema-legal',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">⚖</text></svg>'
        });
        const secao = secaoAoClique || 'dashboard';
        notif.onclick = () => { window.focus(); notif.close(); if (typeof carregarSecao === 'function') carregarSecao(secao); };
    } catch (e) { console.warn('Notificação browser:', e); }
}

/** Notificação nativa do browser para prazos, tarefas e vencimentos do dia (mostra no máximo 1x por dia). */
function verificarNotificacaoBrowserPrazos() {
    if (typeof Notification === 'undefined') return;
    if (Notification.permission === 'denied') return;
    const CHAVE_ULTIMA = 'notificacaoBrowserUltimaVez';
    const hojeStr = new Date().toDateString();
    try {
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        const mesmoDia = (d) => {
            const x = new Date(d);
            x.setHours(0, 0, 0, 0);
            return x.getTime() === hoje.getTime();
        };
        const antesDeHoje = (d) => new Date(d).setHours(0, 0, 0, 0) < hoje.getTime();
        const prazosHoje = (window.prazos || []).filter(p => p.dataLimite && (p.status !== 'cancelado' && p.status !== 'concluido') && mesmoDia(p.dataLimite));
        const prazosVencidos = (window.prazos || []).filter(p => p.dataLimite && (p.status !== 'cancelado' && p.status !== 'concluido') && antesDeHoje(p.dataLimite));
        const tarefasHoje = (window.tarefas || []).filter(t => t.dataLimite && t.status !== 'concluida' && mesmoDia(t.dataLimite));
        const honorariosVencidos = (window.honorarios || []).filter(h => h.vencimento && antesDeHoje(h.vencimento) && h.status !== 'pago');
        const total = prazosHoje.length + tarefasHoje.length + prazosVencidos.length + honorariosVencidos.length;
        if (total === 0) return;
        if (appStorage.getItem(CHAVE_ULTIMA) === hojeStr) return;
        const partes = [];
        if (prazosHoje.length) partes.push(`${prazosHoje.length} prazo(s) hoje`);
        if (tarefasHoje.length) partes.push(`${tarefasHoje.length} tarefa(s) hoje`);
        if (prazosVencidos.length) partes.push(`${prazosVencidos.length} prazo(s) vencido(s)`);
        if (honorariosVencidos.length) partes.push(`${honorariosVencidos.length} honorário(s) vencido(s)`);
        const msg = 'Tem ' + partes.join(', ') + '.';
        const secao = (prazosHoje.length + prazosVencidos.length) > 0 ? 'prazos' : (tarefasHoje.length > 0 ? 'tarefas' : (honorariosVencidos.length > 0 ? 'honorarios' : 'dashboard'));
        const mostrar = () => {
            try {
                appStorage.setItem(CHAVE_ULTIMA, hojeStr);
                mostrarNotificacaoBrowser('Sistema Legal – Alertas', msg, 'sistema-legal-alertas', secao);
            } catch (e) { console.warn('Notificação browser:', e); }
        };
        if (Notification.permission === 'granted') {
            mostrar();
        } else {
            Notification.requestPermission().then(p => { if (p === 'granted') mostrar(); });
        }
    } catch (e) { console.warn('Verificar notificação browser:', e); }
}

function importarDadosCompletos() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    if (tipoUsuario !== 'admin' && tipoUsuario !== 'convidado') {
        mostrarNotificacao('Acesso restrito: não pode importar dados.', 'error');
        return;
    }
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (event) => {
        const arquivo = event.target.files[0];
        if (!arquivo) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            let fezPause = false;
            const reporListeners = () => { if (fezPause && isCloudReady()) { listenerManager.resume(iniciarListenersFirestore); fezPause = false; } };
            try {
                const dadosImportados = JSON.parse(e.target.result);
                
                // Validar estrutura do arquivo
                if (!dadosImportados.dados || !dadosImportados.versao) {
                    throw new Error('Arquivo de backup inválido');
                }
                
                // Confirmar importação
                if (confirm('⚠️ ATENÇÃO: Esta ação irá substituir TODOS os dados atuais!\n\nTem certeza que deseja continuar?')) {
                    if (isCloudReady()) { listenerManager.pause(); fezPause = true; }
                    
                    // Criar backup antes de importar
                    criarBackupAutomatico();
                    
                    // Importar dados
                    clientes = dadosImportados.dados.clientes || [];
                    honorarios = dadosImportados.dados.honorarios || [];
                    contratos = dadosImportados.dados.contratos || [];
                    prazos = dadosImportados.dados.prazos || [];
                    notificacoes = dadosImportados.dados.notificacoes || [];
                    herancas = dadosImportados.dados.herancas || [];
                    migracoes = dadosImportados.dados.migracoes || [];
                    registos = dadosImportados.dados.registos || [];
                    
                    // Salvar dados importados
                    atualizarClientesEmMemoria(clientes);
                    salvarDados('honorarios', honorarios);
                    salvarDados('contratos', contratos);
                    salvarDados('prazos', prazos);
                    salvarDados('notificacoes', notificacoes);
                    salvarDados('herancas', herancas);
                    salvarDados('migracoes', migracoes);
                    salvarDados('registos', registos);
                    
                    mostrarNotificacao('Dados importados com sucesso!', 'success');
                    registrarAuditoria('importar', 'backup', 'Importação completa da base de dados');
                    if (typeof logBackup === 'function') logBackup('Importação completa realizada');
                    
                    reporListeners();
                    // Recarregar seção atual
                    carregarSecao(secaoAtiva);
                }
                
            } catch (error) {
                console.error('❌ Erro ao importar dados:', error);
                mostrarNotificacao('Erro ao importar backup: ' + error.message, 'error');
                registrarErro('importarDadosCompletos', error);
                if (typeof logBackup === 'function') logBackup('Erro importar completa: ' + (error?.message || error));
                reporListeners();
            }
        };
        reader.readAsText(arquivo);
    };
    input.click();
}

function gerarBackup() {
    const chaves = Object.keys(appStorage);
    const backups = chaves.filter(chave => chave.startsWith('backup_'));
    const ultimoBackupTexto = ultimoBackup ? new Date(ultimoBackup).toLocaleString('pt-PT') : 'Nunca';
    const ultimoDownloadTexto = ultimoBackupDownload ? new Date(ultimoBackupDownload).toLocaleString('pt-PT') : 'Nunca';
    const ultimoPersistenciaTexto = persistenciaUltimoSalvamento ? new Date(persistenciaUltimoSalvamento).toLocaleString('pt-PT') : 'Nunca';
    const ultimoSyncSucesso = appStorage.getItem('cloudSyncUltimoSucesso');
    const ultimoSyncErro = appStorage.getItem('cloudSyncUltimoErro');
    const ultimoSyncTexto = ultimoSyncSucesso ? new Date(ultimoSyncSucesso).toLocaleString('pt-PT') : 'Nunca';
    const ultimoErroTexto = ultimoSyncErro ? new Date(ultimoSyncErro).toLocaleString('pt-PT') : 'Sem erros';
    const statusSync = (window.__cloudSyncError ? 'Erro' : (isCloudReady() ? 'Online' : 'Offline'));
    const ultimaEntidade = appStorage.getItem('cloudSyncUltimaEntidade');
    const ultimaEntidadeEm = appStorage.getItem('cloudSyncUltimaEntidadeEm');
    const ultimaEntidadeTexto = ultimaEntidade ? ultimaEntidade : 'Nenhuma';
    const ultimaEntidadeEmTexto = ultimaEntidadeEm ? new Date(ultimaEntidadeEm).toLocaleString('pt-PT') : 'Nunca';
    const freqMin = Math.round(BACKUP_CONFIG.intervaloMs / 60000);
    const freqTexto = `A cada ${freqMin} minutos`;
    const auditoria = obterAuditoria().slice(0, 10);
    const backupLogs = (typeof getBackupLogs === 'function' ? getBackupLogs() : []).slice(-20).reverse();
    const ultimoExport = appStorage.getItem('backupExportUltimo');
    const diasDesdeExport = ultimoExport ? Math.floor((Date.now() - new Date(ultimoExport).getTime()) / (24 * 60 * 60 * 1000)) : null;
    const mostrarLembreteExport = diasDesdeExport === null || diasDesdeExport >= 7;
    const textoLembrete = diasDesdeExport === null ? 'Nunca exportou um backup.' : `Última exportação há ${diasDesdeExport} dias.`;
    
    return `
        <div class="space-y-6">
            ${mostrarLembreteExport ? `
            <div class="card p-4 border-2 border-amber-400 bg-amber-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-circle" class="w-8 h-8 text-amber-600 flex-shrink-0"></i>
                    <div class="flex-1">
                        <p class="font-medium text-amber-900">Recomendamos exportar um backup</p>
                        <p class="text-sm text-amber-800">${textoLembrete}</p>
                    </div>
                    <button onclick="exportarDadosCompletos()" class="btn btn-primary whitespace-nowrap">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>Exportar agora
                    </button>
                </div>
            </div>
            ` : ''}
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Status da Sincronização</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Estado:</span>
                        <span class="font-medium">${statusSync}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Última sincronização:</span>
                        <span class="font-medium">${ultimoSyncTexto}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Último erro:</span>
                        <span class="font-medium">${ultimoErroTexto}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Última entidade:</span>
                        <span class="font-medium">${ultimaEntidadeTexto}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Atualizado em:</span>
                        <span class="font-medium">${ultimaEntidadeEmTexto}</span>
                    </div>
                    <div class="pt-2 flex flex-wrap gap-2">
                        <button onclick="forcarSincronizacaoNuvem()" class="btn btn-primary">
                            <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                            Forçar sincronização agora
                        </button>
                        <button onclick="executarMigracaoLocalParaFirebase()" class="btn btn-secondary" title="Migra dados em localStorage/sessionStorage para Firebase e limpa o storage local">
                            <i data-lucide="cloud-upload" class="w-4 h-4"></i>
                            Migrar dados locais para Firebase
                        </button>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Status do Sistema de Backup</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Último backup automático:</span>
                        <span class="font-medium">${ultimoBackupTexto}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Total de backups:</span>
                        <span class="font-medium">${backups.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Frequência:</span>
                        <span class="font-medium">${freqTexto}</span>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Backup Automático com Download</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Ativo:</span>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" ${backupAutoDownloadAtivo ? 'checked' : ''} onchange="toggleBackupAutoDownload(this.checked)" />
                            <span class="text-sm">${backupAutoDownloadAtivo ? 'Sim' : 'Não'}</span>
                        </label>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Último download:</span>
                        <span class="font-medium">${ultimoDownloadTexto}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                        Intervalo: a cada 24 horas (quando o sistema está aberto)
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Persistência Externa (Ficheiro)</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Status:</span>
                        <span class="font-medium">${persistenciaAtiva ? 'Ativa' : 'Inativa'}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Último salvamento:</span>
                        <span class="font-medium">${ultimoPersistenciaTexto}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="ativarPersistenciaExterna()" class="btn btn-primary flex-1">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                            Ativar
                        </button>
                        <button onclick="desativarPersistenciaExterna()" class="btn btn-secondary flex-1">
                            <i data-lucide="pause" class="w-4 h-4 mr-2"></i>
                            Desativar
                        </button>
                    </div>
                    <p class="text-xs text-gray-500">
                        Requer um navegador compatível. Você precisará escolher o ficheiro.
                    </p>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Ações de Backup</h3>
                <div class="space-y-3">
                    <button onclick="criarBackupAutomatico(); mostrarNotificacao('Backup manual criado!', 'success')" 
                            class="w-full btn btn-primary">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Criar Backup Manual
                    </button>
                    <button onclick="exportarDadosCompletos()" 
                            class="w-full btn btn-success">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                        Exportar Backup Completo
                    </button>
                    <button id="btnExportBackup" class="w-full btn btn-outline" title="Exporta diretamente do Firestore (módulo backup)">
                        <i data-lucide="cloud-download" class="w-4 h-4 mr-2"></i>
                        Exportar do Firestore
                    </button>
                    <button onclick="typeof exportarBackupFirestore==='function'?exportarBackupFirestore():mostrarNotificacao('Módulo backupExport não carregado','warning')" 
                            class="w-full btn btn-secondary">
                        <i data-lucide="cloud-download" class="w-4 h-4 mr-2"></i>
                        Exportar do Firestore (nuvem)
                    </button>
                    <button onclick="if(typeof exportBackupFromFirestore==='function')exportBackupFromFirestore();else mostrarNotificacao('backupExport.js não carregado','warning')" 
                            class="w-full btn btn-primary">
                        <i data-lucide="cloud-download" class="w-4 h-4 mr-2"></i>
                        Exportar do Firestore
                    </button>
                    <button onclick="importarDadosCompletos()" 
                            class="w-full btn btn-warning">
                        <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                        Importar Backup
                    </button>
                    <input type="file" id="inputImportBackup" accept=".json" style="display:none">
                    <button id="btnImportBackup" class="w-full btn btn-outline" title="Importa JSON directamente para o Firestore (substitui todos os dados)">
                        <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i>
                        Importar para Firestore
                    </button>
                    <button onclick="exportarAuditoria()" 
                            class="w-full btn btn-secondary">
                        <i data-lucide="clipboard" class="w-4 h-4 mr-2"></i>
                        Exportar Auditoria
                    </button>
                </div>
            </div>

            <div class="card p-6 border-blue-200 bg-blue-50/50">
                <h3 class="text-lg font-semibold mb-2">🔔 Notificações do browser</h3>
                <p class="text-sm text-gray-700 mb-3">Receba alertas de prazos e tarefas mesmo com o site em segundo plano.</p>
                <button onclick="solicitarPermissaoNotificacoes()" class="btn btn-secondary w-full">
                    <i data-lucide="bell" class="w-4 h-4 mr-2"></i>
                    Ativar notificações
                </button>
            </div>

            <div class="card p-6 border-gray-200">
                <h3 class="text-lg font-semibold mb-4">📋 Logs de Backup</h3>
                <div class="space-y-1 max-h-40 overflow-y-auto text-sm mb-3">
                    ${(typeof getBackupLogs === 'function' ? getBackupLogs() : []).slice(-15).reverse().map(l =>
                        '<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-gray-700">' + (l.message || '') + '</span><span class="text-xs text-gray-500 whitespace-nowrap ml-2">' + (l.timestamp ? new Date(l.timestamp).toLocaleString('pt-PT') : '') + '</span></div>'
                    ).join('') || '<p class="text-gray-500 py-2">Nenhum log registado</p>'}
                </div>
                <button onclick="if(typeof clearBackupLogs==='function'){clearBackupLogs();carregarSecao('backup');mostrarNotificacao('Logs limpos','info')}" 
                        class="btn btn-secondary w-full text-sm">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Limpar logs
                </button>
            </div>

            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Histórico de Alterações (Últimas 10)</h3>
                <div class="space-y-2">
                    ${auditoria.length > 0 ? auditoria.map(item => `
                        <div class="flex justify-between items-start p-3 bg-gray-50 rounded">
                            <div>
                                <p class="text-sm font-medium">${item.acao.toUpperCase()} ${item.entidade}</p>
                                <p class="text-xs text-gray-600">${item.descricao}</p>
                                <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString('pt-PT')}</p>
                            </div>
                            <span class="text-xs text-gray-500">${item.usuario}</span>
                        </div>
                    `).join('') : `
                        <div class="text-center py-4 text-sm text-gray-500">Nenhuma alteração registrada</div>
                    `}
                </div>
                <div class="mt-3">
                    <button onclick="limparAuditoria()" class="btn btn-danger w-full">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                        Limpar Auditoria
                    </button>
                </div>
            </div>
            
            <div class="card p-6 border-blue-200 bg-blue-50">
                <h3 class="text-lg font-semibold mb-4 text-blue-800">🔑 Alterar senha (Admin)</h3>
                <p class="text-sm text-blue-700 mb-4">
                    Altere a senha de acesso do administrador. Recomendado após o primeiro acesso.
                </p>
                <button onclick="abrirModalAlterarSenha()" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 flex items-center justify-center">
                    <i data-lucide="key" class="w-4 h-4 mr-2"></i>
                    Alterar senha
                </button>
            </div>
            
            <div class="card p-6 border-amber-200 bg-amber-50/50">
                <h3 class="text-lg font-semibold mb-4 text-amber-900">🧹 Limpar base de dados (itens eliminados)</h3>
                <p class="text-sm text-amber-800 mb-4">
                    Remove da base de dados <strong>definitivamente</strong> apenas clientes, convidados, documentos, etc. que já foram "apagados" no sistema. Os dados ativos ficam intactos. Ideal para não ver mais criações antigas e convidados eliminados na consola do Firestore.
                </p>
                <button onclick="purgarDocumentosEliminadosFirestore()" 
                        class="w-full bg-amber-600 text-white py-3 px-4 rounded-md hover:bg-amber-700 flex items-center justify-center">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Remover itens eliminados da base de dados
                </button>
            </div>
            
            <div class="card p-6 border-orange-300 bg-orange-50 border-2">
                <h3 class="text-lg font-semibold mb-4 text-orange-900">🧹 Manter só DACIANA e WILSON</h3>
                <p class="text-sm text-orange-800 mb-4">
                    Apaga <strong>tudo</strong> excepto o cliente DACIANA e o convidado WILSON. Elimina honorários, contratos, prazos e dados fantasma que reaparecem.
                </p>
                <button onclick="limparBaseManterApenasDacianaWilson()" 
                        class="w-full bg-orange-600 text-white py-3 px-4 rounded-md hover:bg-orange-700 flex items-center justify-center">
                    <i data-lucide="user-check" class="w-4 h-4 mr-2"></i>
                    Limpar base – manter apenas DACIANA e WILSON
                </button>
            </div>
            <div class="card p-6 border-red-300 bg-red-100 border-2">
                <h3 class="text-lg font-semibold mb-4 text-red-900">🚨 Começar do zero absoluto</h3>
                <p class="text-sm text-red-800 mb-4">
                    Apaga <strong>tudo</strong>: Firestore e memória. Ideal para não ver mais nenhum dado antigo. Irreversível.
                </p>
                <button onclick="comecarDoZeroAbsoluto()" 
                        class="w-full bg-red-700 text-white py-3 px-4 rounded-md hover:bg-red-800 flex items-center justify-center font-semibold">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Começar do zero absoluto
                </button>
            </div>
            <div class="card p-6 border-red-200 bg-red-50">
                <h3 class="text-lg font-semibold mb-4 text-red-800">⚠️ Limpeza Profissional (só local)</h3>
                <p class="text-sm text-red-700 mb-4">
                    Limpa dados locais apenas. Para apagar tudo (incluindo Firestore), use o botão acima.
                </p>
                <button onclick="limparDadosParaUsoProfissional()" 
                        class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                    <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                    Limpar dados locais
                </button>
            </div>
            
            <div class="card p-6">
                <h3 class="text-lg font-semibold mb-4">Informações do Sistema</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Clientes:</span>
                        <span class="font-medium">${clientes.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Contratos:</span>
                        <span class="font-medium">${contratos.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Honorários:</span>
                        <span class="font-medium">${honorarios.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Prazos:</span>
                        <span class="font-medium">${prazos.length}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}


// === SISTEMA RESTAURADO - SEM LOGIN ===


// Carregar usuários (convidados do Firestore)


// Sistema restaurado - sem login




// Processar login
function processarLogin(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    
    if (fazerLogin(email, senha)) {
        // Login bem-sucedido
    }
}

// Mostrar sistema principal
function mostrarSistema() {
    document.body.innerHTML = `
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar -->
            <div id="sidebar" class="w-64 bg-gray-800 shadow-lg">
                <div class="p-6">
                    <div class="flex items-center">
                        <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center">
                            <i data-lucide="scale" class="h-5 w-5 text-white"></i>
                        </div>
                        <h1 class="ml-3 text-xl font-bold text-white">Sistema Jurídico</h1>
                    </div>
                </div>
                
                <nav class="mt-6">
                    <a href="#" onclick="carregarSecao('dashboard')" class="sidebar-item" id="nav-dashboard">
                        <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                        Dashboard
                    </a>
                    <a href="#" onclick="carregarSecao('clientes')" class="sidebar-item" id="nav-clientes">
                        <i data-lucide="users" class="w-5 h-5 mr-3"></i>
                        Gestão de Clientes
                    </a>
                    <a href="#" onclick="carregarSecao('honorarios')" class="sidebar-item" id="nav-honorarios">
                        <i data-lucide="dollar-sign" class="w-5 h-5 mr-3"></i>
                        Gestão de Honorários
                    </a>
                    <a href="#" onclick="carregarSecao('contratos')" class="sidebar-item" id="nav-contratos">
                        <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                        Gestão de Contratos
                    </a>
                    <a href="#" onclick="carregarSecao('herancas')" class="sidebar-item" id="nav-herancas">
                        <i data-lucide="home" class="w-5 h-5 mr-3"></i>
                        Gestão de Heranças
                    </a>
                    <a href="#" onclick="carregarSecao('migracao')" class="sidebar-item" id="nav-migracao">
                        <i data-lucide="globe" class="w-5 h-5 mr-3"></i>
                        Gestão de Migração
                    </a>
                    <a href="#" onclick="carregarSecao('registos')" class="sidebar-item" id="nav-registos">
                        <i data-lucide="clipboard" class="w-5 h-5 mr-3"></i>
                        Gestão de Registos
                    </a>
                    <a href="#" onclick="carregarSecao('prazos')" class="sidebar-item" id="nav-prazos">
                        <i data-lucide="calendar" class="w-5 h-5 mr-3"></i>
                        Gestão de Prazos
                    </a>
                    <a href="#" onclick="carregarSecao('relatorios')" class="sidebar-item" id="nav-relatorios">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                        Gestão de Relatórios
                    </a>
                    <a href="#" onclick="carregarSecao('backup')" class="sidebar-item" id="nav-backup">
                        <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                        Backup
                    </a>
                </nav>
                
                <div class="absolute bottom-0 w-64 p-4">
                    <div class="bg-gray-700 rounded-lg p-3">
                        <div class="flex items-center">
                            <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center">
                                <i data-lucide="user" class="h-4 w-4 text-gray-300"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-white">${usuarioLogado ? usuarioLogado.nome : 'Usuário'}</p>
                                <p class="text-xs text-gray-300">${usuarioLogado ? usuarioLogado.email : ''}</p>
                            </div>
                        </div>
                        <button onclick="fazerLogout()" class="mt-2 w-full text-left text-sm text-red-400 hover:text-red-300">
                            <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Conteúdo Principal -->
            <div class="flex-1 flex flex-col overflow-hidden bg-gray-100">
                <!-- Header -->
                <header class="bg-white shadow-sm border-b border-gray-200">
                    <div class="px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 id="tituloSecao" class="text-2xl font-bold text-gray-900">Sistema Legal</h2>
                                <p id="subtituloSecao" class="text-sm text-gray-600">Visão geral do sistema</p>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                                    <i data-lucide="menu" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Conteúdo -->
                <main class="flex-1 overflow-y-auto">
                    <div class="p-6">
                        <div id="conteudoDinamico">
                            <!-- Conteúdo será carregado aqui -->
                        </div>
                    </div>
                </main>
            </div>
        </div>
        
        <!-- Modal Container -->
        <div id="modalContainer"></div>
        
        <!-- Notifications Container -->
        <div id="notificationsContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
    `;
    lucide.createIcons();
}

// Mostrar modal para criar usuário
function mostrarCriarUsuario() {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Criar Novo Usuário</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="criarUsuario(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                <input type="text" id="novoNome" required 
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="novoEmail" required 
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                                <input type="password" id="novaSenha" required 
                                       class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuário</label>
                                <select id="novoTipo" required 
                                        class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-blue-500">
                                    <option value="admin">Administrador</option>
                                    <option value="usuario">Usuário</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Criar Usuário
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modal);
    lucide.createIcons();
}

// Criar novo usuário
function criarUsuario(event) {
    event.preventDefault();
    
    const nome = document.getElementById('novoNome').value;
    const email = document.getElementById('novoEmail').value;
    const senha = document.getElementById('novaSenha').value;
    const tipo = document.getElementById('novoTipo').value;
    
    // Verificar se email já existe
    if (usuarios.find(u => u.email === email)) {
        mostrarNotificacao('Email já cadastrado', 'error');
        return;
    }
    
    const novoUsuario = {
        id: gerarIdImutavel(),
        nome: nome,
        email: email,
        senha: senha,
        tipo: tipo,
        ativo: true,
        dataCriacao: new Date().toISOString()
    };
    
    usuarios.push(novoUsuario);
    salvarUsuarios();
    
    mostrarNotificacao('Usuário criado com sucesso!', 'success');
    fecharModal();
}


// === FUNÇÃO GENÉRICA PARA CONVERTER ARQUIVO ===
function converterArquivoParaBase64(arquivo, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        callback(e.target.result);
    };
    reader.readAsDataURL(arquivo);
}

// === FUNÇÃO ESPECÍFICA PARA REGISTOS ===
function adicionarAnexoRegistoReal(event, registoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const registo = registos.find(r => r.id === registoId);
        if (registo) {
            if (!registo.anexos) registo.anexos = [];
            registo.anexos.push(anexo);
            salvarDados('registos', registos);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosRegisto(registoId);
        }
    });
}

// === SISTEMA DE ANEXOS PARA REGISTOS ===

function abrirAnexosRegisto(registoId) {
    const registo = registos.find(r => r.id === registoId);
    if (!registo) return;
    
    if (!registo.anexos) {
        registo.anexos = [];
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Documentos do Registo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                        <form onsubmit="adicionarAnexoRegisto(event, ${registoId})" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                    <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                    <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('registo')">
                                        <option value="">Selecione o tipo</option>
                                        <option value="certidao">Certidão</option>
                                        <option value="documento">Documento</option>
                                        <option value="comprovativo">Comprovativo</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <div id="tipoPersonalizadoRegisto" class="mt-2 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                        <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-4">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                            </div>
                        </form>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${registo.anexos.length})</h4>
                        ${registo.anexos.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                <p>Nenhum documento anexado ainda</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${registo.anexos.map(anexo => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="p-2 bg-blue-100 rounded-lg">
                                                <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="removerAnexoRegisto(${registoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
    removerBotoesAnexos();
}

function adicionarAnexoRegisto(event, registoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const registo = registos.find(r => r.id === registoId);
        if (registo) {
            if (!registo.anexos) registo.anexos = [];
            registo.anexos.push(anexo);
            salvarDados('registos', registos);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosRegisto(registoId);
        }
    });
}

function removerAnexoRegisto(registoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaRegistos = carregarListaLocal('registos', registos);
        const registo = listaRegistos.find(r => r.id === registoId);
        if (registo && registo.anexos) {
            registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
            salvarDados('registos', listaRegistos);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosRegisto(registoId);
        }
    }
}

// === SISTEMA DE ANEXOS PARA PRAZOS ===

function abrirAnexosPrazo(prazoId) {
    const prazo = prazos.find(p => p.id === prazoId);
    if (!prazo) return;
    
    if (!prazo.anexos) {
        prazo.anexos = [];
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Documentos do Prazo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                        <form onsubmit="adicionarAnexoPrazo(event, ${prazoId})" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                    <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                    <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('prazo')">
                                        <option value="">Selecione o tipo</option>
                                        <option value="documento">Documento</option>
                                        <option value="comprovativo">Comprovativo</option>
                                        <option value="certidao">Certidão</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <div id="tipoPersonalizadoPrazo" class="mt-2 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                        <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-4">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                            </div>
                        </form>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${prazo.anexos.length})</h4>
                        ${prazo.anexos.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                <p>Nenhum documento anexado ainda</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${prazo.anexos.map(anexo => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="p-2 bg-blue-100 rounded-lg">
                                                <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="removerAnexoPrazo(${prazoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function adicionarAnexoPrazo(event, prazoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    const anexo = {
        id: gerarIdImutavel(),
        nome: nome,
        tipo: tipo,
        descricao: descricao,
        nomeArquivo: arquivo.name,
        tamanho: formatarTamanho(arquivo.size),
        dataUpload: new Date().toISOString(),
        tipoArquivo: arquivo.type,
        conteudo: 'CONVERSAO_REAL_IMPLEMENTADA_FINAL...'
    };
    
    const prazo = prazos.find(p => p.id === prazoId);
    if (prazo) {
        if (!prazo.anexos) prazo.anexos = [];
        prazo.anexos.push(anexo);
        salvarDados('prazos', prazos);
        mostrarNotificacao('Documento adicionado com sucesso!', 'success');
        abrirAnexosPrazo(prazoId);
    }
}

function removerAnexoPrazo(prazoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaPrazos = carregarListaLocal('prazos', prazos);
        const prazo = listaPrazos.find(p => p.id === prazoId);
        if (prazo && prazo.anexos) {
            prazo.anexos = prazo.anexos.filter(a => a.id !== anexoId);
            salvarDados('prazos', listaPrazos);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosPrazo(prazoId);
        }
    }
}

// === SISTEMA DE NOTIFICAÇÕES AUTOMÁTICAS ===

function iniciarSistemaNotificacoes() {
    verificarHonorariosVencidos();
    verificarPrazosUrgentes();
    verificarLembretesTarefas();
    atualizarBadgeNotificacoes();
    
    // Verificar a cada 5 minutos (inclui notificações do browser para prazos/tarefas)
    setInterval(() => {
        verificarHonorariosVencidos();
        verificarPrazosUrgentes();
        verificarLembretesTarefas();
        verificarNotificacaoBrowserPrazos();
        atualizarBadgeNotificacoes();
    }, 5 * 60 * 1000);
}

function inicializarAlertasAutomaticos() {
    const emailInput = document.getElementById('alertasEmailDestino');
    const whatsappInput = document.getElementById('alertasWhatsAppDestino');
    if (emailInput) {
        emailInput.value = appStorage.getItem('alertasEmailDestino') || '';
        emailInput.addEventListener('change', () => {
            appStorage.setItem('alertasEmailDestino', emailInput.value.trim());
        });
    }
    if (whatsappInput) {
        whatsappInput.value = appStorage.getItem('alertasWhatsAppDestino') || '';
        whatsappInput.addEventListener('change', () => {
            whatsappInput.value = whatsappInput.value.replace(/\D/g, '');
            appStorage.setItem('alertasWhatsAppDestino', whatsappInput.value.trim());
        });
    }
}

function gerarResumoAlertasAutomaticos() {
    const hoje = new Date();
    const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);
    const honorariosVencidos = honorarios.filter(h => {
        if (!h.vencimento) return false;
        const dataVenc = new Date(h.vencimento);
        return !isNaN(dataVenc.getTime()) && dataVenc < hoje && h.status !== 'pago';
    });
    const prazosVencidos = prazos.filter(p => {
        if (!p.dataLimite) return false;
        const dataLimite = new Date(p.dataLimite);
        return !isNaN(dataLimite.getTime()) && dataLimite < hoje && p.status === 'ativo';
    });
    const prazosHoje = prazos.filter(p => {
        if (!p.dataLimite) return false;
        const dataLimite = new Date(p.dataLimite);
        return !isNaN(dataLimite.getTime()) && dataLimite.toDateString() === hoje.toDateString() && p.status === 'ativo';
    });
    const prazos3Dias = prazos.filter(p => {
        if (!p.dataLimite) return false;
        const dataLimite = new Date(p.dataLimite);
        return !isNaN(dataLimite.getTime()) && dataLimite > hoje && dataLimite <= proximos3Dias && p.status === 'ativo';
    });
    
    const linhas = [];
    linhas.push(`Resumo de alertas (${hoje.toLocaleDateString('pt-PT')})`);
    linhas.push('');
    linhas.push(`Honorários vencidos: ${honorariosVencidos.length}`);
    honorariosVencidos.slice(0, 10).forEach(h => {
        const data = new Date(h.vencimento);
        linhas.push(`- ${h.cliente} | €${(parseFloat(h.valor) || 0).toFixed(2)} | venc. ${data.toLocaleDateString('pt-PT')}`);
    });
    linhas.push('');
    linhas.push(`Prazos vencidos: ${prazosVencidos.length}`);
    prazosVencidos.slice(0, 10).forEach(p => {
        linhas.push(`- ${p.clienteNome} | ${p.descricao} | venc. ${new Date(p.dataLimite).toLocaleDateString('pt-PT')}`);
    });
    linhas.push('');
    linhas.push(`Prazos hoje: ${prazosHoje.length}`);
    prazosHoje.slice(0, 10).forEach(p => {
        linhas.push(`- ${p.clienteNome} | ${p.descricao}`);
    });
    linhas.push('');
    linhas.push(`Prazos em até 3 dias: ${prazos3Dias.length}`);
    prazos3Dias.slice(0, 10).forEach(p => {
        linhas.push(`- ${p.clienteNome} | ${p.descricao} | ${new Date(p.dataLimite).toLocaleDateString('pt-PT')}`);
    });
    return linhas.join('\n');
}

function enviarAlertasEmail() {
    const destino = (document.getElementById('alertasEmailDestino')?.value || '').trim();
    if (!destino) {
        mostrarNotificacao('Informe o email de destino.', 'warning');
        return;
    }
    const corpo = gerarResumoAlertasAutomaticos();
    const assunto = `Alertas Automáticos - ${new Date().toLocaleDateString('pt-PT')}`;
    const link = `mailto:${encodeURIComponent(destino)}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
    window.location.href = link;
}

function enviarAlertasWhatsApp() {
    const destino = (document.getElementById('alertasWhatsAppDestino')?.value || '').trim();
    if (!destino) {
        mostrarNotificacao('Informe o número de WhatsApp (com indicativo).', 'warning');
        return;
    }
    const corpo = gerarResumoAlertasAutomaticos();
    const link = `https://wa.me/${encodeURIComponent(destino)}?text=${encodeURIComponent(corpo)}`;
    window.open(link, '_blank');
}


function verificarHonorariosVencidos() {
    const hoje = new Date();
    const honorariosVencidos = honorarios.filter(h => {
        try {
            if (!h.vencimento) return false;
            const dataVencimento = new Date(h.vencimento);
            if (isNaN(dataVencimento.getTime())) {
                console.warn('Data de vencimento inválida no honorário:', h.vencimento);
                return false;
            }
        return dataVencimento < hoje && isHonorarioEmAberto(h);
        } catch (error) {
            console.warn('Erro ao processar honorário:', h.id, error);
            return false;
        }
    });

    honorariosVencidos.forEach(honorario => {
        // Atualizar status para vencido
        const index = honorarios.findIndex(h => h.id === honorario.id);
        if (index !== -1) {
            honorarios[index].status = 'vencido';
        }

        // Criar notificação se não existir
        const notificacaoExistente = obterNotificacoesAtual().find(n => 
            n.tipo === 'honorario' && 
            n.referenciaId === honorario.id && 
            n.titulo.includes('Vencido')
        );

        if (!notificacaoExistente) {
            criarNotificacao({
                tipo: 'honorario',
                titulo: 'Honorário Vencido',
                mensagem: `O honorário de €${(Math.round((parseFloat(honorario.valor) || 0) * 100) / 100).toFixed(2)} do cliente ${honorario.cliente} está vencido desde ${new Date(honorario.vencimento).toLocaleDateString('pt-PT')}`,
                prioridade: 'alta',
                referenciaId: honorario.id,
                acao: 'ver_honorario'
            });
            
        }
    });

    salvarDados('honorarios', honorarios);
}

function verificarPrazosUrgentes() {
    const hoje = new Date();
    const amanha = new Date(hoje.getTime() + 24 * 60 * 60 * 1000);
    const proximos3Dias = new Date(hoje.getTime() + 3 * 24 * 60 * 60 * 1000);

    prazos.forEach(prazo => {
        try {
            if (!prazo.dataLimite) return;
            const dataLimite = new Date(prazo.dataLimite);
            if (isNaN(dataLimite.getTime())) {
                console.warn('Data inválida no prazo:', prazo.dataLimite);
                return;
            }
            const diasRestantes = Math.ceil((dataLimite - hoje) / (1000 * 60 * 60 * 24));

        // Prazos vencidos
        if (dataLimite < hoje && prazo.status === 'ativo') {
            const notificacaoExistente = obterNotificacoesAtual().find(n => 
                n.tipo === 'prazo' && 
                n.referenciaId === prazo.id && 
                n.titulo.includes('Vencido')
            );

            if (!notificacaoExistente) {
                criarNotificacao({
                    tipo: 'prazo',
                    titulo: 'Prazo Vencido',
                    mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} venceu em ${dataLimite.toLocaleDateString('pt-PT')}`,
                    prioridade: 'critica',
                    referenciaId: prazo.id,
                    acao: 'ver_prazo'
                });
            }
        }
        // Prazos que vencem hoje
        else if (dataLimite.toDateString() === hoje.toDateString() && prazo.status === 'ativo') {
            const notificacaoExistente = obterNotificacoesAtual().find(n => 
                n.tipo === 'prazo' && 
                n.referenciaId === prazo.id && 
                n.titulo.includes('Hoje')
            );

            if (!notificacaoExistente) {
                criarNotificacao({
                    tipo: 'prazo',
                    titulo: 'Prazo Vence Hoje',
                    mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence hoje!`,
                    prioridade: 'alta',
                    referenciaId: prazo.id,
                    acao: 'ver_prazo'
                });
            }
        }
        // Prazos que vencem em 3 dias
        else if (dataLimite <= proximos3Dias && dataLimite > amanha && prazo.status === 'ativo') {
            const notificacaoExistente = obterNotificacoesAtual().find(n => 
                n.tipo === 'prazo' && 
                n.referenciaId === prazo.id && 
                n.titulo.includes('3 dias')
            );

            if (!notificacaoExistente) {
                criarNotificacao({
                    tipo: 'prazo',
                    titulo: 'Prazo em 3 Dias',
                    mensagem: `O prazo "${prazo.descricao}" do cliente ${prazo.clienteNome} vence em ${diasRestantes} dias`,
                    prioridade: 'media',
                    referenciaId: prazo.id,
                    acao: 'ver_prazo'
                });
            }
        }
        } catch (error) {
            console.warn('Erro ao processar prazo:', prazo.id, error);
        }
    });
}

function verificarLembretesTarefas() {
    const agora = new Date();
    const lista = Array.isArray(tarefas) ? tarefas : [];
    let atualizou = false;

    lista.forEach(tarefa => {
        if (!tarefa.lembreteEm || tarefa.lembreteDisparado) return;
        if (tarefa.status === 'concluida') return;
        const dataLembrete = new Date(tarefa.lembreteEm);
        if (isNaN(dataLembrete.getTime())) return;
        if (dataLembrete <= agora) {
            const msg = `Tarefa "${tarefa.titulo}"${tarefa.clienteNome ? ` do cliente ${tarefa.clienteNome}` : ''}`;
            criarNotificacao({
                tipo: 'tarefa',
                titulo: 'Lembrete de Tarefa',
                mensagem: msg + ` — lembrete para ${dataLembrete.toLocaleString('pt-PT')}`,
                prioridade: tarefa.prioridade || 'media',
                referenciaId: tarefa.id,
                acao: 'ver_tarefa'
            });
            mostrarNotificacaoBrowser('Lembrete: ' + tarefa.titulo, msg, 'lembrete-tarefa-' + String(tarefa.id), 'tarefas');
            tarefa.lembreteDisparado = true;
            atualizou = true;
        }
    });

    if (atualizou) {
        salvarTarefasLocal(lista);
    }
}

function criarNotificacao(dados) {
    const listaNotif = obterNotificacoesAtual();
    const notificacaoExistente = listaNotif.find(n => 
        n.tipo === dados.tipo && 
        n.referenciaId === dados.referenciaId && 
        !n.lida &&
        n.titulo === dados.titulo
    );

    if (notificacaoExistente) {
        // Se já existe, apenas atualizar a data e mostrar lembrete visual (exceto cliente_autorizado ou suprimirToast)
        notificacaoExistente.dataCriacao = new Date().toISOString();
        salvarDados('notificacoes', listaNotif);
        if (!dados.suprimirToast && dados.tipo !== 'cliente_autorizado') {
            mostrarLembreteNotificacao(dados.titulo);
        }
        return;
    }

    const notificacao = {
        id: gerarIdImutavel(),
        tipo: dados.tipo,
        titulo: dados.titulo,
        mensagem: dados.mensagem,
        prioridade: dados.prioridade,
        referenciaId: dados.referenciaId,
        acao: dados.acao,
        destinatarioId: dados.destinatarioId || 'todos',
        origem: dados.origem || 'sistema',
        lida: false,
        dataCriacao: new Date().toISOString(),
        clienteId: dados.clienteId,
        clienteNome: dados.clienteNome,
        cliente: dados.cliente
    };

    listaNotif.unshift(notificacao);
    salvarDados('notificacoes', listaNotif);
    
    // Mostrar notificação visual (exceto cliente_autorizado ou suprimirToast: o admin já vê "Permissões atualizadas")
    if (!dados.suprimirToast && dados.tipo !== 'cliente_autorizado') {
        mostrarNotificacao(notificacao.titulo, 'warning');
    }
}

function mostrarLembreteNotificacao(titulo) {
    // Criar lembrete visual no canto superior direito
    const lembrete = document.createElement('div');
    lembrete.className = 'fixed top-4 right-4 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2 animate-pulse';
    lembrete.innerHTML = `
        <i data-lucide="bell" class="w-4 h-4"></i>
        <span>Lembrete: ${titulo}</span>
    `;
    
    document.body.appendChild(lembrete);
    lucide.createIcons();
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (lembrete.parentNode) {
            lembrete.parentNode.removeChild(lembrete);
        }
    }, 3000);
}

// === SISTEMA DE TESTE DE NOTIFICAÇÕES ===

function criarNotificacaoTeste() {
    const tipos = ['prazo', 'honorario', 'contrato', 'heranca', 'migracao', 'registo'];
    const titulos = [
        'Prazo Vencido',
        'Honorário Vencido', 
        'Contrato Pendente',
        'Herança em Andamento',
        'Migração Urgente',
        'Registo Pendente'
    ];
    const mensagens = [
        'O prazo para entrega de documentos vence hoje!',
        'O honorário de €500 está vencido há 3 dias',
        'O contrato precisa ser assinado até amanhã',
        'A herança está aguardando documentação',
        'O processo de migração está atrasado',
        'O registo precisa ser finalizado esta semana'
    ];
    
    const tipoAleatorio = tipos[Math.floor(Math.random() * tipos.length)];
    const tituloAleatorio = titulos[Math.floor(Math.random() * titulos.length)];
    const mensagemAleatoria = mensagens[Math.floor(Math.random() * mensagens.length)];
    
    criarNotificacao({
        tipo: tipoAleatorio,
        titulo: tituloAleatorio,
        mensagem: mensagemAleatoria,
        prioridade: 'alta',
        referenciaId: Date.now(),
        acao: 'ver_detalhes'
    });
    
    mostrarNotificacao('Notificação de teste criada!', 'success');
}

/** Criar notificação de teste associada a um cliente (para ver na ficha do cliente) */
function criarNotificacaoTesteParaCliente(clienteId, clienteNome) {
    criarNotificacao({
        tipo: 'prazo',
        titulo: 'Notificação de teste - ' + (clienteNome || 'Cliente'),
        mensagem: 'Esta é uma notificação de teste criada para verificar se aparece na ficha do cliente.',
        prioridade: 'media',
        referenciaId: clienteId || Date.now(),
        acao: 'ver_detalhes',
        clienteId: clienteId,
        clienteNome: clienteNome || '',
        cliente: clienteNome || ''
    });
    mostrarNotificacao('Notificação de teste criada! Feche e reabra a ficha do cliente para ver.', 'success');
}
window.criarNotificacaoTesteParaCliente = criarNotificacaoTesteParaCliente;

function criarNotificacaoPersonalizada() {
    
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('❌ modalContainer não encontrado!');
        mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
        return;
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Criar Notificação Personalizada</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formNotificacaoPersonalizada" onsubmit="salvarNotificacaoPersonalizada(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
                                <input type="text" id="notificacaoTitulo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite o título da notificação">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem *</label>
                                <textarea id="notificacaoMensagem" rows="4" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite a mensagem da notificação"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="notificacaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="prazo">Prazo</option>
                                    <option value="honorario">Honorário</option>
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Herança</option>
                                    <option value="migracao">Migração</option>
                                    <option value="registo">Registo</option>
                                    <option value="geral">Geral</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="notificacaoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="baixa">Baixa</option>
                                    <option value="media" selected>Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i data-lucide="check" class="w-4 h-4"></i>
                                Criar Notificação
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modal;
    lucide.createIcons();
}

function salvarNotificacaoPersonalizada(event) {
    event.preventDefault();
    event.stopPropagation();
    
    const titulo = document.getElementById('notificacaoTitulo').value.trim();
    const mensagem = document.getElementById('notificacaoMensagem').value.trim();
    const tipo = document.getElementById('notificacaoTipo').value;
    const prioridade = document.getElementById('notificacaoPrioridade').value;
    
    if (!titulo || !mensagem || !tipo) {
        mostrarNotificacao('Por favor, preencha todos os campos obrigatórios!', 'error');
        return;
    }
    
    // Carregar notificações
    const notificacoesSalvas = appStorage.getItem('notificacoes');
    let notificacoesAtual = notificacoes;
    if (notificacoesSalvas) {
        notificacoesAtual = JSON.parse(notificacoesSalvas);
        notificacoes = notificacoesAtual;
        window.notificacoes = notificacoes;
    }
    
    criarNotificacao({
        tipo: tipo,
        titulo: titulo,
        mensagem: mensagem,
        prioridade: prioridade || 'media',
        referenciaId: Date.now(),
        acao: 'ver_detalhes'
    });
    
    fecharModalRobusto();
    mostrarNotificacao('Notificação personalizada criada com sucesso!', 'success');
    
    // Atualizar UI após criação
    setTimeout(() => {
        atualizarAposNotificacoes();
    }, 300);
}

// Garantir que as funções sejam globalmente acessíveis
window.salvarNotificacaoPersonalizada = salvarNotificacaoPersonalizada;
window.criarNotificacaoPersonalizada = criarNotificacaoPersonalizada;

function atualizarAposNotificacoes() {
    atualizarBadgeNotificacoes();
    if (secaoAtiva === 'notificacoes') {
        carregarSecao('clientes');
    }
}

function atualizarBadgeNotificacoes() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const convidadoId = appStorage.getItem('convidadoId');
    
    // Filtrar notificações baseado no tipo de usuário (igual ao gerarNotificacoes)
    let notificacoesFiltradas = obterNotificacoesAtual();
    
    if (tipoUsuario === 'convidado') {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => 
            n.destinatarioId === parseInt(convidadoId) || 
            n.destinatarioId === 'todos' ||
            n.tipo === 'cliente_autorizado' ||
            n.tipo === 'documento_anexado' ||
            n.tipo === 'prazo_proximo'
        );
    }
    
    const notificacoesNaoLidas = notificacoesFiltradas.filter(n => !n.lida).length;
    const badge = document.getElementById('badgeNotificacoes');
    
    if (badge) {
        if (notificacoesNaoLidas > 0) {
            badge.textContent = notificacoesNaoLidas;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
}

function marcarComoLida(notificacaoId) {
    const listaNotif = obterNotificacoesAtual();
    const notificacao = listaNotif.find(n => n.id === notificacaoId);
    if (notificacao) {
        notificacao.lida = true;
        salvarDados('notificacoes', listaNotif);
        atualizarAposNotificacoes();
    }
}

function marcarTodasComoLidas() {
    const listaNotif = obterNotificacoesAtual();
    listaNotif.forEach(n => n.lida = true);
    salvarDados('notificacoes', listaNotif);
    atualizarAposNotificacoes();
    mostrarNotificacao('Todas as notificações foram marcadas como lidas', 'success');
}

function excluirNotificacao(notificacaoId) {
    const listaNotif = obterNotificacoesAtual().filter(n => n.id !== notificacaoId);
    notificacoes = listaNotif;
    window.notificacoes = listaNotif;
    salvarDados('notificacoes', listaNotif);
    atualizarAposNotificacoes();
}

function limparNotificacoes() {
    if (confirm('Tem certeza que deseja limpar todas as notificações?')) {
        notificacoes = [];
        window.notificacoes = notificacoes;
        salvarDados('notificacoes', notificacoes);
        atualizarAposNotificacoes();
        mostrarNotificacao('Todas as notificações foram removidas', 'success');
    }
}

// === SISTEMA HÍBRIDO DE NOTIFICAÇÕES ===

function enviarMensagemConvidado() {
    
    const convidados = obterConvidados();
    
    const convidadosAtivos = convidados.filter(c => c.ativo);
    
    if (convidadosAtivos.length === 0) {
        console.warn('⚠️ Nenhum convidado ativo encontrado!');
        mostrarNotificacao('Nenhum convidado ativo encontrado! Crie um convidado na seção "Gestão de Convidados" primeiro.', 'warning');
        // Não retornar - permitir abrir modal mesmo sem convidados para mostrar mensagem mais clara
    }
    
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('❌ modalContainer não encontrado!');
        mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
        return;
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Enviar Mensagem para Convidado</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formEnviarMensagemConvidado" onsubmit="salvarMensagemConvidado(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Destinatário *</label>
                                ${convidadosAtivos.length === 0 ? `
                                    <div class="bg-yellow-50 border border-yellow-200 rounded px-4 py-3 mb-3">
                                        <p class="text-sm text-yellow-800">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>
                                            Nenhum convidado ativo encontrado. Vá para "Gestão de Convidados" para criar um convidado primeiro.
                                        </p>
                                    </div>
                                    <select id="convidadoDestinatario" required disabled class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black bg-gray-100">
                                        <option value="">Nenhum convidado disponível</option>
                                    </select>
                                ` : `
                                    <select id="convidadoDestinatario" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="">Selecione um convidado</option>
                                        ${convidadosAtivos.map(c => `
                                            <option value="${c.id}">${c.nome} ${c.email ? '(' + c.email + ')' : ''}</option>
                                        `).join('')}
                                        ${convidadosAtivos.length > 1 ? '<option value="todos">Todos os Convidados</option>' : ''}
                                    </select>
                                `}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
                                <input type="text" id="mensagemTitulo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Título da mensagem">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mensagem *</label>
                                <textarea id="mensagemConteudo" rows="4" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua mensagem..."></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="mensagemPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="baixa">Baixa</option>
                                    <option value="media" selected>Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" ${convidadosAtivos.length === 0 ? 'disabled' : ''}>
                                <i data-lucide="send" class="w-4 h-4"></i>
                                ${convidadosAtivos.length === 0 ? 'Nenhum Convidado Disponível' : 'Enviar Mensagem'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modal;
    lucide.createIcons();
}

function salvarMensagemConvidado(event) {
    event.preventDefault();
    event.stopPropagation();
    
    // Verificar se há convidados ativos
    const convidados = obterConvidados();
    const convidadosAtivos = convidados.filter(c => c.ativo);
    
    if (convidadosAtivos.length === 0) {
        mostrarNotificacao('Nenhum convidado ativo encontrado! Crie um convidado na seção "Gestão de Convidados" primeiro.', 'error');
        return;
    }
    
    const destinatarioId = document.getElementById('convidadoDestinatario').value;
    const titulo = document.getElementById('mensagemTitulo').value.trim();
    const conteudo = document.getElementById('mensagemConteudo').value.trim();
    const prioridade = document.getElementById('mensagemPrioridade').value;
    
    if (!destinatarioId || !titulo || !conteudo) {
        mostrarNotificacao('Por favor, preencha todos os campos obrigatórios!', 'error');
        return;
    }
    
    // Carregar notificações
    const notificacoesSalvas = appStorage.getItem('notificacoes');
    let notificacoesAtual = notificacoes;
    if (notificacoesSalvas) {
        notificacoesAtual = JSON.parse(notificacoesSalvas);
        notificacoes = notificacoesAtual;
        window.notificacoes = notificacoes;
    }
    
    const notificacao = {
        id: gerarIdImutavel(),
        tipo: 'mensagem_admin',
        titulo: titulo,
        mensagem: conteudo,
        prioridade: prioridade || 'media',
        destinatarioId: destinatarioId === 'todos' ? 'todos' : parseIdSafe(destinatarioId),
        lida: false,
        dataCriacao: new Date().toISOString(),
        origem: 'admin'
    };
    
    notificacoesAtual.unshift(notificacao);
    notificacoes = notificacoesAtual;
    window.notificacoes = notificacoes;
    
    salvarDados('notificacoes', notificacoesAtual);
    
    mostrarNotificacao('Mensagem enviada com sucesso!', 'success');
    fecharModalRobusto();
    
    setTimeout(() => {
        atualizarAposNotificacoes();
    }, 300);
}

// Garantir que as funções sejam globalmente acessíveis
window.enviarMensagemConvidado = enviarMensagemConvidado;
window.salvarMensagemConvidado = salvarMensagemConvidado;
// Alias para compatibilidade
window.enviarMensagemConfirmar = salvarMensagemConvidado;

// === FILTROS INTELIGENTES DE NOTIFICAÇÕES ===

function aplicarFiltrosNotificacoes() {
    const tipoUsuario = appStorage.getItem('tipoUsuario');
    const convidadoId = appStorage.getItem('convidadoId');
    
    // Obter filtros
    const filtroPrioridade = document.getElementById('filtroPrioridade')?.value || '';
    const filtroTipo = document.getElementById('filtroTipo')?.value || '';
    const filtroStatus = document.getElementById('filtroStatus')?.value || '';
    const filtroPeriodo = document.getElementById('filtroPeriodo')?.value || '';
    
    // Filtrar notificações baseado no tipo de usuário
    let notificacoesFiltradas = obterNotificacoesAtual();
    
    if (tipoUsuario === 'convidado') {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => 
            n.destinatarioId === parseInt(convidadoId) || 
            n.destinatarioId === 'todos' ||
            n.tipo === 'cliente_autorizado' ||
            n.tipo === 'documento_anexado' ||
            n.tipo === 'prazo_proximo'
        );
    }
    
    // Aplicar filtros adicionais
    if (filtroPrioridade) {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => n.prioridade === filtroPrioridade);
    }
    
    if (filtroTipo) {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => n.tipo === filtroTipo);
    }
    
    if (filtroStatus === 'nao_lida') {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => !n.lida);
    } else if (filtroStatus === 'lida') {
        notificacoesFiltradas = notificacoesFiltradas.filter(n => n.lida);
    }
    
    if (filtroPeriodo) {
        const agora = new Date();
        const hoje = new Date(agora.getFullYear(), agora.getMonth(), agora.getDate());
        const inicioSemana = new Date(hoje);
        inicioSemana.setDate(hoje.getDate() - hoje.getDay());
        const inicioMes = new Date(agora.getFullYear(), agora.getMonth(), 1);
        
        notificacoesFiltradas = notificacoesFiltradas.filter(n => {
            if (!n.dataCriacao) return false;
            const dataNotificacao = new Date(n.dataCriacao);
            
            switch (filtroPeriodo) {
                case 'hoje':
                    return dataNotificacao >= hoje;
                case 'semana':
                    return dataNotificacao >= inicioSemana;
                case 'mes':
                    return dataNotificacao >= inicioMes;
                default:
                    return true;
            }
        });
    }
    
    // Atualizar contador
    const contador = document.getElementById('contadorFiltros');
    if (contador) {
        contador.textContent = `${notificacoesFiltradas.length} notificações encontradas`;
    }
    
    // Notificações agora ficam nos detalhes do cliente
    atualizarAposNotificacoes();
}

function limparFiltrosNotificacoes() {
    document.getElementById('filtroPrioridade').value = '';
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroStatus').value = '';
    document.getElementById('filtroPeriodo').value = '';
    
    atualizarAposNotificacoes();
}

// === SISTEMA DE COMUNICAÇÃO BIDIRECIONAL ===

function responderMensagem(notificacaoId) {
    const notificacao = obterNotificacoesAtual().find(n => n.id === notificacaoId);
    if (!notificacao) {
        mostrarNotificacao('Notificação não encontrada!', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Responder Mensagem</h3>
            
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                    <textarea id="respostaMensagem" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="fecharModalRobusto()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                    Cancelar
                </button>
                <button onclick="enviarResposta(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enviar Resposta
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function enviarResposta(notificacaoId) {
    const resposta = document.getElementById('respostaMensagem').value;
    
    if (!resposta.trim()) {
        mostrarNotificacao('Digite uma resposta!', 'error');
        return;
    }
    
    const listaNotif = obterNotificacoesAtual();
    const notificacao = listaNotif.find(n => n.id === notificacaoId);
    if (notificacao) {
        // Inicializar array de respostas se não existir
        if (!notificacao.respostas) {
            notificacao.respostas = [];
        }
        
        // Adicionar resposta
        const novaResposta = {
            id: gerarIdImutavel(),
            mensagem: resposta,
            origem: 'convidado',
            dataCriacao: new Date().toISOString(),
            convidadoId: appStorage.getItem('convidadoId')
        };
        
        notificacao.respostas.push(novaResposta);
        
        // Salvar dados
        salvarDados('notificacoes', listaNotif);
        
        // Criar notificação para o admin sobre a resposta
        const notificacaoAdmin = {
            id: gerarIdImutavel(),
            tipo: 'resposta_convidado',
            titulo: 'Resposta Recebida',
            mensagem: `Convidado respondeu: "${resposta.substring(0, 50)}${resposta.length > 50 ? '...' : ''}"`,
            prioridade: 'media',
            destinatarioId: 'admin',
            referenciaId: notificacaoId,
            lida: false,
            dataCriacao: new Date().toISOString(),
            origem: 'sistema'
        };
        
        listaNotif.unshift(notificacaoAdmin);
        salvarDados('notificacoes', listaNotif);
        
        mostrarNotificacao('Resposta enviada com sucesso!', 'success');
        fecharModal();
        atualizarAposNotificacoes();
    }
}

// === VISUALIZAÇÃO DE CONVERSAS PARA ADMIN ===

function verConversas() {
    // Filtrar notificações que têm respostas
    const conversas = obterNotificacoesAtual().filter(n => 
        n.respostas && n.respostas.length > 0 && 
        (n.origem === 'admin' || n.tipo === 'mensagem_admin')
    );
    
    if (conversas.length === 0) {
        mostrarNotificacao('Nenhuma conversa encontrada!', 'info');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Conversas com Convidados</h3>
                <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                ${conversas.map(conversa => `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${conversa.titulo}</h4>
                                <p class="text-sm text-gray-600">${conversa.mensagem}</p>
                                <p class="text-xs text-gray-400 mt-1">
                                    ${new Date(conversa.dataCriacao).toLocaleString('pt-PT')}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                    ${conversa.respostas.length} resposta${conversa.respostas.length > 1 ? 's' : ''}
                                </span>
                                <button onclick="responderComoAdmin(${conversa.id})" class="btn btn-sm btn-primary">
                                    <i data-lucide="reply" class="w-4 h-4"></i>
                                    Responder
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${conversa.respostas.map(resposta => `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-sm font-medium text-gray-600">
                                            ${resposta.origem === 'admin' ? 'Admin' : 'Convidado'}
                                        </span>
                                        <span class="text-xs text-gray-400">
                                            ${new Date(resposta.dataCriacao).toLocaleString('pt-PT')}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-800">${resposta.mensagem}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function responderComoAdmin(notificacaoId) {
    const notificacao = obterNotificacoesAtual().find(n => n.id === notificacaoId);
    if (!notificacao) {
        mostrarNotificacao('Notificação não encontrada!', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Responder como Admin</h3>
            
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <h4 class="font-medium text-gray-800">${notificacao.titulo}</h4>
                <p class="text-sm text-gray-600 mt-1">${notificacao.mensagem}</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sua Resposta</label>
                    <textarea id="respostaAdmin" rows="4" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite sua resposta..."></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="fecharModalRobusto()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50">
                    Cancelar
                </button>
                <button onclick="enviarRespostaAdmin(${notificacaoId})" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Enviar Resposta
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function enviarRespostaAdmin(notificacaoId) {
    const resposta = document.getElementById('respostaAdmin').value;
    
    if (!resposta.trim()) {
        mostrarNotificacao('Digite uma resposta!', 'error');
        return;
    }
    
    const listaNotif = obterNotificacoesAtual();
    const notificacao = listaNotif.find(n => n.id === notificacaoId);
    if (notificacao) {
        // Inicializar array de respostas se não existir
        if (!notificacao.respostas) {
            notificacao.respostas = [];
        }
        
        // Adicionar resposta do admin
        const novaResposta = {
            id: gerarIdImutavel(),
            mensagem: resposta,
            origem: 'admin',
            dataCriacao: new Date().toISOString()
        };
        
        notificacao.respostas.push(novaResposta);
        
        // Salvar dados
        salvarDados('notificacoes', listaNotif);
        
        mostrarNotificacao('Resposta enviada com sucesso!', 'success');
        fecharModal();
        atualizarAposNotificacoes();
    }
}

function filtrarPrazos() {
    const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
    
    const prazosFiltrados = prazos.filter(prazo => {
        return prazo.clienteNome.toLowerCase().includes(busca) || 
               prazo.tipo.toLowerCase().includes(busca) ||
               prazo.descricao.toLowerCase().includes(busca);
    });
    
    atualizarListaPrazos(prazosFiltrados);
}

function atualizarListaPrazos(prazosFiltrados) {
    const tbody = document.getElementById('listaPrazos');
    if (!tbody) return;
    
    tbody.innerHTML = prazosFiltrados.map(prazo => `
        <tr>
            <td>${renderClienteLink(prazo.clienteId, prazo.clienteNome)}</td>
            <td>${prazo.tipo}</td>
            <td>${prazo.descricao}</td>
            <td>${prazo.dataLimite ? new Date(prazo.dataLimite).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
            <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
            <td><span class="status-badge status-${prazo.status}">${prazo.status}</span></td>
            <td>
                <button onclick="editarItem('prazo', ${JSON.stringify(prazo.id)})" class="text-blue-600 hover:text-blue-800">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirItem('prazo', ${JSON.stringify(prazo.id)})" class="text-red-600 hover:text-red-800 ml-2">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Sistema de inicialização movido para dentro da verificação de login

// === FUNÇÕES DAS NOVAS SEÇÕES ===

function gerarHerancas() {
    const totalHerancas = herancas.length;
    const herancasAtivas = herancas.filter(h => h.status === 'em_andamento').length;
    const herancasSuspensas = herancas.filter(h => h.status === 'pendente').length;
    const herancasTerminadas = herancas.filter(h => h.status === 'concluido').length;
    const valorTotalHerancas = herancas.reduce((total, h) => total + (h.valorComIva || h.valor || 0), 0);

    return `
        <div class="space-y-6">
            <!-- Header único com botões de ação -->
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="abrirModalHeranca()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Nova Herança
                    </button>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${herancasAtivas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Suspensos</p>
                            <p class="text-2xl font-bold text-gray-900">${herancasSuspensas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Terminados</p>
                            <p class="text-2xl font-bold text-gray-900">${herancasTerminadas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalHerancas).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barra de busca -->
            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaHerancas" placeholder="Buscar heranças..." 
                           class="search-input" onkeyup="filtrarHerancas()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipoHeranca" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                            <option value="">Todos os tipos</option>
                            <option value="Aceitação da herança">Aceitação da herança</option>
                            <option value="Doações">Doações</option>
                            <option value="Escrituras de partilha">Escrituras de partilha</option>
                            <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                            <option value="Partilhas em vida">Partilhas em vida</option>
                            <option value="Partilhas por óbito">Partilhas por óbito</option>
                            <option value="Processo de inventário">Processo de inventário</option>
                            <option value="Renúncia à herança">Renúncia à herança</option>
                            <option value="Testamentos">Testamentos</option>
                        </select>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                        <input type="text" id="filtroNifHeranca" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosHerancas()">
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosHerancas()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorHerancas">0</span> heranças encontradas
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Prioridade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Entidade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
        <tbody id="listaHerancas" class="bg-white divide-y divide-gray-200">
            <!-- Lista dinâmica de heranças -->
        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function gerarConvidados() {
    const convidados = limparConvidadosInativos();
    const convidadosAtivos = convidados.filter(c => c.ativo).length;
    const convidadosInativos = convidados.filter(c => !c.ativo).length;
    const totalConvidados = convidados.length;

    return `
        <div class="space-y-6">
            <!-- Header com botões de ação -->
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="abrirModalNovoConvidado()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>
                        Novo Convidado
                    </button>
                    <button onclick="enviarMensagemConvidado()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center" title="Enviar notificação ou mensagem para um convidado">
                        <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                        Enviar para Convidado
                    </button>
                    <button onclick="verConversas()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center" title="Ver conversas com convidados">
                        <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>
                        Ver Conversas
                    </button>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="users" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total</p>
                            <p class="text-2xl font-bold text-gray-900">${totalConvidados}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${convidadosAtivos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <i data-lucide="user-x" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Inativos</p>
                            <p class="text-2xl font-bold text-gray-900">${convidadosInativos}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Convidados -->
            <div class="card">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Lista de Convidados</h3>
                    
                    <div class="table-responsive">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clientes Autorizados</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data Criação</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="listaConvidados">
                                ${convidados.map(convidado => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${convidado.nome}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${convidado.codigo}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="status-badge status-${convidado.ativo ? 'ativo' : 'inativo'}">${convidado.ativo ? 'Ativo' : 'Inativo'}</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(convidado.clientesAutorizados || []).length} cliente(s)</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(convidado.dataCriacao).toLocaleDateString('pt-PT')}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="abrirModalEditarPermissoes('${String(convidado.codigo || convidado.id).replace(/'/g, "\\'")}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar Permissões">
                                                <i data-lucide="settings" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="ativarDesativarConvidado('${convidado.codigo}', ${!convidado.ativo})" class="text-${convidado.ativo ? 'red' : 'green'}-600 hover:text-${convidado.ativo ? 'red' : 'green'}-900 mr-2" title="${convidado.ativo ? 'Desativar' : 'Ativar'}">
                                                <i data-lucide="${convidado.ativo ? 'user-x' : 'user-check'}" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="copiarCodigoConvidado('${convidado.codigo}')" class="text-gray-600 hover:text-gray-900" title="Copiar Código">
                                                <i data-lucide="copy" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="excluirConvidado('${convidado.codigo || convidado.id}')" class="text-red-600 hover:text-red-900 ml-2" title="Eliminar">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// FUNÇÕES AUXILIARES PARA GESTÃO DE CONVIDADOS
function abrirModalNovoConvidado() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Novo Convidado</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formNovoConvidado" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Convidado</label>
                        <input type="text" id="nomeConvidado" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                        <div id="listaClientesConvidado" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Lista de clientes será carregada aqui -->
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="fecharModalRobusto()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Criar Convidado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Carregar lista de clientes
    carregarClientesParaConvidado();
    
    document.getElementById('formNovoConvidado').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nome = document.getElementById('nomeConvidado').value.trim();
        if (!nome) {
            mostrarNotificacao('Informe o nome do convidado.', 'warning');
            return;
        }
        const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesConvidado input[type="checkbox"]:checked'))
            .map(cb => parseInt(cb.value));
        
        const novoConvidado = await criarConvidado(nome, clientesSelecionados);
        mostrarNotificacao(`Convidado criado! Código: ${novoConvidado.codigo}`, 'success');
        fecharModal();
        carregarSecao('convidados');
    });
}

function carregarClientesParaConvidado() {
    const clientes = obterClientesAtual();
    const container = document.getElementById('listaClientesConvidado');
    
    if (clientes.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
        return;
    }
    
    container.innerHTML = clientes.map(cliente => `
        <label class="flex items-center space-x-2">
            <input type="checkbox" value="${cliente.id}" class="rounded border-gray-300">
            <span class="text-sm text-gray-700">${cliente.nome}</span>
        </label>
    `).join('');
}

function abrirModalEditarPermissoes(idOuCodigo) {
    const convidados = obterConvidados();
    const convidado = convidados.find(c => String(c.id) === String(idOuCodigo) || String(c.codigo) === String(idOuCodigo));
    
    if (!convidado) {
        mostrarNotificacao('Convidado não encontrado!', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Editar Permissões - ${convidado.nome}</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formEditarPermissoes" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Clientes Autorizados</label>
                        <div id="listaClientesEdicao" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Lista de clientes será carregada aqui -->
                        </div>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button type="button" onclick="fecharModalRobusto()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">
                            Cancelar
                        </button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                            Salvar Permissões
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Carregar lista de clientes com seleções atuais
    carregarClientesParaEdicao(convidado.clientesAutorizados);
    
    document.getElementById('formEditarPermissoes').addEventListener('submit', function(e) {
        e.preventDefault();
        const clientesSelecionados = Array.from(document.querySelectorAll('#listaClientesEdicao input[type="checkbox"]:checked'))
            .map(cb => cb.value); // manter string (IDs podem ser UUID)
        
        
        editarPermissoesConvidado(idOuCodigo, clientesSelecionados);
        mostrarNotificacao('Permissões atualizadas com sucesso!', 'success');
        fecharModal();
    });
}

function carregarClientesParaEdicao(clientesAutorizados) {
    const clientes = obterClientesAtual();
    const container = document.getElementById('listaClientesEdicao');
    
    if (clientes.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum cliente cadastrado</p>';
        return;
    }
    
    const idsAutorizadosNorm = (clientesAutorizados || []).map(a => String(a));
    container.innerHTML = clientes.map(cliente => `
        <label class="flex items-center space-x-2">
            <input type="checkbox" value="${cliente.id}" ${idsAutorizadosNorm.includes(String(cliente.id)) ? 'checked' : ''} class="rounded border-gray-300">
            <span class="text-sm text-gray-700">${cliente.nome}</span>
        </label>
    `).join('');
}

function ativarDesativarConvidado(id, ativo) {
    ativarDesativarConvidadoCore(id, ativo);
    mostrarNotificacao(`Convidado ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
    carregarSecao('convidados');
}

function copiarCodigoConvidado(codigo) {
    navigator.clipboard.writeText(codigo).then(() => {
        mostrarNotificacao('Código copiado para a área de transferência!', 'success');
    }).catch(() => {
        // Fallback para navegadores mais antigos
        const textArea = document.createElement('textarea');
        textArea.value = codigo;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        mostrarNotificacao('Código copiado para a área de transferência!', 'success');
    });
}

function gerarMigracao() {
    
    // Garantir que migracoes existe
    if (!migracoes) {
        migracoes = [];
    }
    
    const totalMigracoes = migracoes.length;
    const migracoesAtivas = migracoes.filter(m => m.status === 'em_andamento').length;
    const migracoesSuspensas = migracoes.filter(m => m.status === 'pendente').length;
    const migracoesTerminadas = migracoes.filter(m => m.status === 'concluido').length;
    const valorTotalMigracoes = migracoes.reduce((total, m) => {
        const valor = parseFloat(m.valor) || 0;
        return total + valor;
    }, 0);

    return `
        <div class="space-y-6">
            <!-- Header único com botões de ação -->
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="abrirModalMigracaoDireto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Nova Migração
                    </button>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${migracoesAtivas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Suspensos</p>
                            <p class="text-2xl font-bold text-gray-900">${migracoesSuspensas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Terminados</p>
                            <p class="text-2xl font-bold text-gray-900">${migracoesTerminadas}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalMigracoes).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barra de busca -->
            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaMigracoes" placeholder="Buscar migrações..." 
                           class="search-input" onkeyup="filtrarMigracoes()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipoMigracao" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                            <option value="">Todos os tipos</option>
                            <option value="Autorização de residência">Autorização de residência</option>
                            <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                            <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                            <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                            <option value="Renovação de autorizações">Renovação de autorizações</option>
                            <option value="Vistos D7">Vistos D7</option>
                            <option value="Vistos Gold">Vistos Gold</option>
                            <option value="Vistos para estudantes">Vistos para estudantes</option>
                            <option value="Vistos para trabalho">Vistos para trabalho</option>
                        </select>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                        <input type="text" id="filtroNifMigracao" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosMigracoes()">
                        <!-- Campo NIF adicionado -->
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosMigracoes()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorMigracoes">0</span> migrações encontradas
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Prioridade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Entidade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaMigracoes" class="bg-white divide-y divide-gray-200">
                            ${migracoes.map(migracao => `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${renderClienteLink(migracao.clienteId, migracao.clienteNome || 'N/A')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                                        <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge status-${migracao.prioridade || 'media'}">${migracao.prioridade || 'media'}</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? (ENTIDADES_PORTUGAL.find(e => e.id === migracao.entidade)?.nome || migracao.entidade) : '—'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="editarMigracaoDireto(${JSON.stringify(migracao.id)})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                                            <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                                        </button>
                                        <button onclick="duplicarMigracao(${JSON.stringify(migracao.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Duplicar">
                                            <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                                        </button>
                                        <button onclick="abrirAnexosMigracao(${JSON.stringify(migracao.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                                            <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                                        </button>
                                        <button onclick="excluirMigracaoDireto(${JSON.stringify(migracao.id)})" class="text-red-600 hover:text-red-900" title="Excluir">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}

function gerarRegistos() {
    const totalRegistos = registos.length;
    const registosAtivos = registos.filter(r => r.status === 'em_andamento').length;
    const registosSuspensos = registos.filter(r => r.status === 'pendente').length;
    const registosTerminados = registos.filter(r => r.status === 'concluido').length;
    const valorTotalRegistos = registos.reduce((total, r) => total + (r.valorComIva || r.valor || 0), 0);

    return `
        <div class="space-y-6">
            <!-- Header único com botões de ação -->
            <div class="flex justify-between items-center">
                <div class="flex space-x-3">
                    <button onclick="abrirModalRegisto()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                        Novo Registo
                    </button>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Ativos</p>
                            <p class="text-2xl font-bold text-gray-900">${registosAtivos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <i data-lucide="pause-circle" class="w-6 h-6 text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Suspensos</p>
                            <p class="text-2xl font-bold text-gray-900">${registosSuspensos}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-gray-100 rounded-lg">
                            <i data-lucide="x-circle" class="w-6 h-6 text-gray-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Terminados</p>
                            <p class="text-2xl font-bold text-gray-900">${registosTerminados}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i data-lucide="dollar-sign" class="w-6 h-6 text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Valor Total</p>
                            <p class="text-2xl font-bold text-gray-900">€${Number(valorTotalRegistos).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barra de busca -->
            <div class="card p-6">
                <div class="search-container mb-4">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="buscaRegistos" placeholder="Buscar registos..." 
                           class="search-input" onkeyup="filtrarRegistos()">
                </div>
                
                <!-- Filtros Avançados -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filtroStatusRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <select id="filtroTipoRegisto" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                            <option value="">Todos os tipos</option>
                            <option value="Autenticação de documentos">Autenticação de documentos</option>
                            <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                            <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                            <option value="Procurações">Procurações</option>
                            <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                            <option value="Registos automóveis">Registos automóveis</option>
                            <option value="Registos comerciais">Registos comerciais</option>
                            <option value="Registos de propriedade">Registos de propriedade</option>
                            <option value="Termos de autenticação">Termos de autenticação</option>
                        </select>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIF</label>
                        <input type="text" id="filtroNifRegisto" placeholder="Buscar por NIF..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="aplicarFiltrosRegistos()">
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-4">
                    <button onclick="limparFiltrosRegistos()" class="btn btn-secondary">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                        Limpar Filtros
                    </button>
                    <div class="text-sm text-gray-600">
                        <span id="contadorRegistos">0</span> registos encontrados
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="overflow-x-auto table-responsive">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Prioridade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Entidade</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Data Início</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
        <tbody id="listaRegistos" class="bg-white divide-y divide-gray-200">
            <!-- Conteúdo será carregado via atualizarListaRegistos() -->
        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
}


// === FUNÇÕES DE FILTRO ===

function filtrarHerancas() {
    aplicarFiltrosHerancas();
}

function aplicarFiltrosHerancas() {
    const busca = document.getElementById('buscaHerancas')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusHeranca')?.value || '';
    const tipo = document.getElementById('filtroTipoHeranca')?.value || '';
    const nif = document.getElementById('filtroNifHeranca')?.value || '';
    
    const herancasFiltradas = herancas.filter(heranca => {
        // Filtro por busca de texto
        const matchBusca = !busca || 
            (heranca.clienteNome || '').toLowerCase().includes(busca) || 
            (heranca.tipo || '').toLowerCase().includes(busca) ||
            (heranca.observacoes || '').toLowerCase().includes(busca);
        
        // Filtro por status
        const matchStatus = !status || heranca.status === status;
        
        // Filtro por tipo
        const matchTipo = !tipo || heranca.tipo === tipo;
        
        
        // Filtro por NIF
        const cliente = clientes.find(c => c.id === heranca.clienteId);
        const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
        
        return matchBusca && matchStatus && matchTipo && matchNif;
    });
    
    const limitH = Math.max(LISTA_PAGINA_TAMANHO, window.__herancasLimit || LISTA_PAGINA_TAMANHO);
    const mostrarH = herancasFiltradas.slice(0, limitH);
    atualizarListaHerancas(mostrarH, herancasFiltradas.length, limitH);
    document.getElementById('contadorHerancas').textContent = herancasFiltradas.length;
}

function limparFiltrosHerancas() {
    document.getElementById('buscaHerancas').value = '';
    document.getElementById('filtroStatusHeranca').value = '';
    document.getElementById('filtroTipoHeranca').value = '';
    document.getElementById('filtroValorMinHeranca').value = '';
    document.getElementById('filtroValorMaxHeranca').value = '';
    document.getElementById('filtroNifHeranca').value = '';
    aplicarFiltrosHerancas();
}

function filtrarMigracoes() {
    aplicarFiltrosMigracoes();
}

function aplicarFiltrosMigracoes() {
    const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusMigracao')?.value || '';
    const tipo = document.getElementById('filtroTipoMigracao')?.value || '';
    const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
    const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
    const nif = document.getElementById('filtroNifMigracao')?.value || '';
    
    const migracoesFiltradas = migracoes.filter(migracao => {
        // Filtro por busca de texto
        const matchBusca = !busca || 
            (migracao.clienteNome || '').toLowerCase().includes(busca) || 
            (migracao.tipo || '').toLowerCase().includes(busca) ||
            (migracao.observacoes || '').toLowerCase().includes(busca);
        
        // Filtro por status
        const matchStatus = !status || migracao.status === status;
        
        // Filtro por tipo
        const matchTipo = !tipo || migracao.tipo === tipo;
        
        // Filtro por valor
        const valor = parseFloat(migracao.valor) || 0;
        const matchValor = valor >= valorMin && valor <= valorMax;
        
        // Filtro por NIF
        const cliente = clientes.find(c => c.id === migracao.clienteId);
        const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
        
        return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
    });
    
    const limitM = Math.max(LISTA_PAGINA_TAMANHO, window.__migracoesLimit || LISTA_PAGINA_TAMANHO);
    const mostrarM = migracoesFiltradas.slice(0, limitM);
    atualizarListaMigracoes(mostrarM, migracoesFiltradas.length, limitM);
    document.getElementById('contadorMigracoes').textContent = migracoesFiltradas.length;
}

function limparFiltrosMigracoes() {
    document.getElementById('buscaMigracoes').value = '';
    document.getElementById('filtroStatusMigracao').value = '';
    document.getElementById('filtroTipoMigracao').value = '';
    document.getElementById('filtroValorMinMigracao').value = '';
    document.getElementById('filtroValorMaxMigracao').value = '';
    document.getElementById('filtroNifMigracao').value = '';
    aplicarFiltrosMigracoes();
}

function filtrarRegistos() {
    aplicarFiltrosRegistos();
}

function aplicarFiltrosRegistos() {
    const busca = document.getElementById('buscaRegistos')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusRegisto')?.value || '';
    const tipo = document.getElementById('filtroTipoRegisto')?.value || '';
    const valorMin = parseFloat(document.getElementById('filtroValorMinRegisto')?.value) || 0;
    const valorMax = parseFloat(document.getElementById('filtroValorMaxRegisto')?.value) || Infinity;
    const nif = document.getElementById('filtroNifRegisto')?.value || '';
    
    const registosFiltrados = registos.filter(registo => {
        // Filtro por busca de texto
        const matchBusca = !busca || 
            (registo.clienteNome || '').toLowerCase().includes(busca) || 
            (registo.tipo || '').toLowerCase().includes(busca) ||
            (registo.observacoes || '').toLowerCase().includes(busca);
        
        // Filtro por status
        const matchStatus = !status || registo.status === status;
        
        // Filtro por tipo
        const matchTipo = !tipo || registo.tipo === tipo;
        
        // Filtro por valor
        const valor = parseFloat(registo.valor) || 0;
        const matchValor = valor >= valorMin && valor <= valorMax;
        
        // Filtro por NIF
        const cliente = clientes.find(c => c.id === registo.clienteId);
        const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));
        
        return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
    });
    
    const limitR = Math.max(LISTA_PAGINA_TAMANHO, window.__registosLimit || LISTA_PAGINA_TAMANHO);
    const mostrarR = registosFiltrados.slice(0, limitR);
    atualizarListaRegistos(mostrarR, registosFiltrados.length, limitR);
    document.getElementById('contadorRegistos').textContent = registosFiltrados.length;
}

function limparFiltrosRegistos() {
    document.getElementById('buscaRegistos').value = '';
    document.getElementById('filtroStatusRegisto').value = '';
    document.getElementById('filtroTipoRegisto').value = '';
    document.getElementById('filtroValorMinRegisto').value = '';
    document.getElementById('filtroValorMaxRegisto').value = '';
    document.getElementById('filtroNifRegisto').value = '';
    aplicarFiltrosRegistos();
}

function ordenarPrazos(col) {
    let o = window.__prazosOrdenar;
    if (!o) try { o = JSON.parse(appStorage.getItem('ordenarPrazos') || '{}'); } catch(e) {}
    o = o && o.col ? o : { col: 'dataLimite', dir: 1 };
    if (o.col === col) o.dir = o.dir === 1 ? -1 : 1;
    else { o.col = col; o.dir = 1; }
    window.__prazosOrdenar = o;
    try { appStorage.setItem('ordenarPrazos', JSON.stringify(o)); } catch (e) {}
    aplicarFiltrosPrazos();
}

function filtrarPrazos() {
    aplicarFiltrosPrazos();
}

function aplicarFiltrosPrazos() {
    const busca = document.getElementById('buscaPrazos')?.value.toLowerCase() || '';
    const status = document.getElementById('filtroStatusPrazo')?.value || '';
    const tipo = document.getElementById('filtroTipoPrazo')?.value || '';
    const vencimento = document.getElementById('filtroVencimentoPrazo')?.value || '';
    const prioridade = document.getElementById('filtroPrioridadePrazo')?.value || '';
    
    let prazosFiltrados = prazos.filter(prazo => {
        // Filtro por busca de texto
        const matchBusca = !busca || 
            prazo.clienteNome.toLowerCase().includes(busca) || 
            prazo.descricao.toLowerCase().includes(busca) ||
            prazo.tipo.toLowerCase().includes(busca);
        
        // Filtro por status
        const matchStatus = !status || prazo.status === status;
        
        // Filtro por tipo
        const matchTipo = !tipo || prazo.tipo === tipo;
        
        // Filtro por vencimento
        let matchVencimento = true;
        if (vencimento && prazo.dataLimite) {
            const dataLimite = new Date(prazo.dataLimite);
            const hoje = new Date();
            
            switch (vencimento) {
                case 'hoje':
                    matchVencimento = dataLimite.toDateString() === hoje.toDateString();
                    break;
                case 'semana':
                    const fimSemana = new Date(hoje);
                    fimSemana.setDate(hoje.getDate() + 7);
                    matchVencimento = dataLimite >= hoje && dataLimite <= fimSemana;
                    break;
                case 'mes':
                    const fimMes = new Date(hoje);
                    fimMes.setMonth(hoje.getMonth() + 1);
                    matchVencimento = dataLimite >= hoje && dataLimite <= fimMes;
                    break;
                case 'vencido':
                    matchVencimento = dataLimite < hoje;
                    break;
            }
        }
        
        // Filtro por prioridade
        const matchPrioridade = !prioridade || prazo.prioridade === prioridade;
        
        return matchBusca && matchStatus && matchTipo && matchVencimento && matchPrioridade;
    });
    
    let ord = window.__prazosOrdenar;
    if (!ord || !ord.col) try { ord = JSON.parse(appStorage.getItem('ordenarPrazos') || '{}'); } catch(e) {}
    ord = ord && ord.col ? ord : { col: 'dataLimite', dir: 1 };
    const k = ord.col; const d = ord.dir;
    prazosFiltrados = prazosFiltrados.slice().sort((a, b) => {
        if (k === 'dataLimite') return d * ((new Date(a.dataLimite || 0).getTime()) - (new Date(b.dataLimite || 0).getTime()));
        if (k === 'cliente') return d * (String(a.clienteNome || '').toLowerCase().localeCompare(String(b.clienteNome || '').toLowerCase()));
        if (k === 'tipo') return d * (String(a.tipo || '').toLowerCase().localeCompare(String(b.tipo || '').toLowerCase()));
        if (k === 'descricao') return d * (String(a.descricao || '').toLowerCase().localeCompare(String(b.descricao || '').toLowerCase()));
        if (k === 'prioridade') return d * (String(a.prioridade || '').localeCompare(String(b.prioridade || '')));
        if (k === 'status') return d * (String(a.status || '').localeCompare(String(b.status || '')));
        return 0;
    });
    
    const limitP = Math.max(LISTA_PAGINA_TAMANHO, window.__prazosLimit || LISTA_PAGINA_TAMANHO);
    const mostrarP = prazosFiltrados.slice(0, limitP);
    atualizarListaPrazos(mostrarP, prazosFiltrados.length, limitP);
    document.getElementById('contadorPrazos').textContent = prazosFiltrados.length;
}

function limparFiltrosPrazos() {
    document.getElementById('buscaPrazos').value = '';
    document.getElementById('filtroStatusPrazo').value = '';
    document.getElementById('filtroTipoPrazo').value = '';
    document.getElementById('filtroVencimentoPrazo').value = '';
    document.getElementById('filtroPrioridadePrazo').value = '';
    aplicarFiltrosPrazos();
}

function atualizarListaPrazos(prazosFiltrados, total, limit) {
    const tbody = document.getElementById('listaPrazos');
    if (!tbody) return;
    total = total ?? prazosFiltrados.length;
    limit = limit ?? prazosFiltrados.length;
    const listaPrazosTotal = typeof obterPrazosAtual === 'function' ? obterPrazosAtual() : (prazos || []);
    if (prazosFiltrados.length === 0) {
        const temFiltros = (document.getElementById('buscaPrazos')?.value?.trim() || document.getElementById('filtroStatusPrazo')?.value || document.getElementById('filtroTipoPrazo')?.value || document.getElementById('filtroVencimentoPrazo')?.value || document.getElementById('filtroPrioridadePrazo')?.value || document.getElementById('filtroClientePrazo')?.value);
        const msg = listaPrazosTotal.length > 0 && temFiltros
            ? '<tr><td colspan="8" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum prazo corresponde aos filtros.</p><button type="button" onclick="limparFiltrosPrazos()" class="btn btn-secondary text-sm">Limpar Filtros</button></td></tr>'
            : '<tr><td colspan="8" class="text-center py-8 text-gray-500"><p class="mb-2">Nenhum prazo registado.</p><button type="button" onclick="abrirModalCriarPrazo()" class="btn btn-primary text-sm">Adicionar prazo</button></td></tr>';
        tbody.innerHTML = msg;
        setTimeout(() => { if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons(); }, 50);
        return;
    }
    const verMais = total > limit ? `<tr><td colspan="8" class="text-center py-3 border-t"><button type="button" onclick="window.__prazosLimit = (window.__prazosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosPrazos();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></td></tr>` : '';
    tbody.innerHTML = prazosFiltrados.map(prazo => `
        <tr>
            <td>${renderClienteLink(prazo.clienteId, prazo.clienteNome)}</td>
            <td>${prazo.tipo}</td>
            <td>${prazo.descricao}</td>
            <td>${new Date(prazo.dataLimite).toLocaleDateString('pt-PT')}</td>
            <td><span class="status-badge status-${prazo.prioridade}">${prazo.prioridade}</span></td>
            <td><span class="status-badge status-${prazo.status}">${prazo.status === 'concluido' ? 'Concluído' : prazo.status === 'vencido' ? 'Vencido' : prazo.status === 'cancelado' ? 'Cancelado' : 'Ativo'}</span></td>
            <td>
                <button onclick="editarItem('prazo', ${JSON.stringify(prazo.id)})" class="text-blue-600 hover:text-blue-800">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirItem('prazo', ${JSON.stringify(prazo.id)})" class="text-red-600 hover:text-red-800 ml-2">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('') + verMais;
}


// === FUNÇÕES DE ATUALIZAÇÃO DE LISTAS ===

function atualizarListaHerancas(herancasFiltradas, total, limit) {
    total = total ?? herancasFiltradas.length;
    limit = limit ?? herancasFiltradas.length;
    const tbody = document.getElementById('listaHerancas');
    if (!tbody) {
        return;
    }
    
    const verMais = total > limit ? `<tr><td colspan="9" class="text-center py-3 border-t"><button type="button" onclick="window.__herancasLimit = (window.__herancasLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosHerancas();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></td></tr>` : '';
    const html = herancasFiltradas.map(heranca => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${renderClienteLink(heranca.clienteId, heranca.clienteNome || 'N/A')}
                ${renderMetaAuditoria('heranca', heranca)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.tipo || 'N/A'}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${heranca.descricao || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="text-sm font-bold text-black">€${Number(heranca.valor || 0).toFixed(2)}</div>
                <div class="text-xs font-bold text-red-600">+ IVA: €${(Number(heranca.valor || 0) + (Number(heranca.valor || 0) * Number(heranca.iva || 0) / 100)).toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${heranca.status || 'pendente'}">${heranca.status || 'Pendente'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${heranca.prioridade || 'media'}">${heranca.prioridade || 'media'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? (ENTIDADES_PORTUGAL.find(e => e.id === heranca.entidade)?.nome || heranca.entidade) : '—'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${heranca.dataInicio || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editarHerancaDireto(${JSON.stringify(heranca.id)})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="duplicarHeranca(${JSON.stringify(heranca.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Duplicar">
                    <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="abrirAnexosHeranca(${JSON.stringify(heranca.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                    <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirHerancaDireto(${JSON.stringify(heranca.id)})" class="text-red-600 hover:text-red-900" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('') + verMais;
    
    tbody.innerHTML = html;
    
    // FORÇAR RENDERIZAÇÃO DOS ÍCONES
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100);
}

function atualizarListaMigracoes(migracoesFiltradas, total, limit) {
    total = total ?? migracoesFiltradas.length;
    limit = limit ?? migracoesFiltradas.length;
    const tbody = document.getElementById('listaMigracoes');
    if (!tbody) return;
    
    const verMais = total > limit ? `<tr><td colspan="9" class="text-center py-3 border-t"><button type="button" onclick="window.__migracoesLimit = (window.__migracoesLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosMigracoes();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></td></tr>` : '';
    tbody.innerHTML = migracoesFiltradas.map(migracao => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${renderClienteLink(migracao.clienteId, migracao.clienteNome)}
                ${renderMetaAuditoria('migracao', migracao)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${migracao.prioridade || 'media'}">${migracao.prioridade || 'media'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? (ENTIDADES_PORTUGAL.find(e => e.id === migracao.entidade)?.nome || migracao.entidade) : '—'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editarMigracaoSimples(${JSON.stringify(migracao.id)})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="abrirAnexosMigracao(${JSON.stringify(migracao.id)})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                    <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirMigracao(${JSON.stringify(migracao.id)})" class="text-red-600 hover:text-red-900" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('') + verMais;
}

function atualizarListaRegistos(registosFiltrados, total, limit) {
    total = total ?? registosFiltrados.length;
    limit = limit ?? registosFiltrados.length;
    
    const tbody = document.getElementById('listaRegistos');
    if (!tbody) {
        return;
    }
    
    const verMais = total > limit ? `<tr><td colspan="9" class="text-center py-3 border-t"><button type="button" onclick="window.__registosLimit = (window.__registosLimit || ${LISTA_PAGINA_TAMANHO}) + ${LISTA_PAGINA_TAMANHO}; aplicarFiltrosRegistos();" class="btn btn-secondary text-sm">Ver mais (${total - limit} restantes)</button></td></tr>` : '';
    const html = registosFiltrados.map(registo => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                ${renderClienteLink(registo.clienteId, registo.clienteNome || 'N/A')}
                ${renderMetaAuditoria('registo', registo)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.tipo || 'N/A'}</td>
            <td class="px-6 py-4 text-sm text-gray-500">${registo.descricao || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div class="text-sm font-bold text-black">€${Number(registo.valor || 0).toFixed(2)}</div>
                <div class="text-xs font-bold text-red-600">+ IVA: €${(Number(registo.valor || 0) + (Number(registo.valor || 0) * Number(registo.iva || 0) / 100)).toFixed(2)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${registo.status || 'pendente'}">${registo.status || 'Pendente'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="status-badge status-${registo.prioridade || 'media'}">${registo.prioridade || 'media'}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.entidade && typeof ENTIDADES_PORTUGAL !== 'undefined' ? (ENTIDADES_PORTUGAL.find(e => e.id === registo.entidade)?.nome || registo.entidade) : '—'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registo.dataInicio || 'N/A'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="editarRegistoDireto(${JSON.stringify(registo.id)})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">
                    <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="duplicarRegisto(${JSON.stringify(registo.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Duplicar">
                    <i data-lucide="copy" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="abrirAnexosRegisto(${JSON.stringify(registo.id)})" class="text-green-600 hover:text-green-900 mr-2" title="Documentos">
                    <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
                <button onclick="excluirRegistoDireto(${JSON.stringify(registo.id)})" class="text-red-600 hover:text-red-900" title="Excluir">
                    <i data-lucide="trash-2" class="w-4 h-4" style="pointer-events:none"></i>
                </button>
            </td>
        </tr>
    `).join('') + verMais;
    
    tbody.innerHTML = html;
    
    // FORÇAR RENDERIZAÇÃO DOS ÍCONES
    setTimeout(() => {
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }
    }, 100);
}


// === FUNÇÕES DE MODAL E CRUD ===

function abrirModalHeranca() {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Nova Herança</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formHeranca" onsubmit="salvarHeranca(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Aceitação da herança">Aceitação da herança</option>
                                    <option value="Doações">Doações</option>
                                    <option value="Escrituras de partilha">Escrituras de partilha</option>
                                    <option value="Habilitação de herdeiros">Habilitação de herdeiros</option>
                                    <option value="Partilhas em vida">Partilhas em vida</option>
                                    <option value="Partilhas por óbito">Partilhas por óbito</option>
                                    <option value="Processo de inventário">Processo de inventário</option>
                                    <option value="Renúncia à herança">Renúncia à herança</option>
                                    <option value="Testamentos">Testamentos</option>
                                    <option value="Inventário">Inventário</option>
                                    <option value="Partilha">Partilha</option>
                                    <option value="Testamento">Testamento</option>
                                    <option value="Doação">Doação</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0">0% (Isento)</option>
                                        <option value="6">6% (Reduzida)</option>
                                        <option value="13">13% (Intermédia)</option>
                                        <option value="23" selected>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="herancaParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="em_andamento">Em Andamento</option>
                                        <option value="concluido">Concluído</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select name="prioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>Média</option>
                                        <option value="alta">Alta</option>
                                        <option value="critica">Crítica</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                    <select name="entidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" title="Instituição em Portugal">
                                        ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a herança..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Herança
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function criarModalMigracao() {
    return `
        <div class="modal show" onclick="fecharModalRobusto()">
            <div class="modal-content p-6" style="max-width: 600px;" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Nova Migração</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <form id="formMigracao" onsubmit="salvarMigracao(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                            <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Tipo</option>
                                <option value="Autorização de residência">Autorização de residência</option>
                                <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                <option value="Renovação de autorizações">Renovação de autorizações</option>
                                <option value="Vistos D7">Vistos D7</option>
                                <option value="Vistos Gold">Vistos Gold</option>
                                <option value="Vistos para estudantes">Vistos para estudantes</option>
                                <option value="Vistos para trabalho">Vistos para trabalho</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Migração
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
}

function abrirModalMigracaoDireto() {
    
    // Fechar qualquer modal aberto
    fecharModal();
    
    // Criar modal diretamente no body
    const modal = document.createElement('div');
    modal.id = 'modalNovaMigracao';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                    <button onclick="document.getElementById('modalNovaMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form id="formMigracao" onsubmit="salvarMigracao(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                            <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Tipo</option>
                                <option value="Autorização de residência">Autorização de residência</option>
                                <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                <option value="Renovação de autorizações">Renovação de autorizações</option>
                                <option value="Vistos D7">Vistos D7</option>
                                <option value="Vistos Gold">Vistos Gold</option>
                                <option value="Vistos para estudantes">Vistos para estudantes</option>
                                <option value="Vistos para trabalho">Vistos para trabalho</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor (€) *</label>
                                <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="0.00">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <input type="number" name="iva" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="23" value="23">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                <select name="status" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente">Pendente</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select name="prioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="baixa">Baixa</option>
                                    <option value="media" selected>Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Crítica</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data de Início *</label>
                            <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                            <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('migracao')">
                                <option value="sem">Sem parceria</option>
                                <option value="empresa">Empresa</option>
                                <option value="pessoa">Pessoa</option>
                            </select>
                        </div>
                        
                        <div id="migracaoParceriaNomeDiv" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                            <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                            <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="document.getElementById('modalNovaMigracao').remove()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Migração
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    lucide.createIcons();
}

// Tornar função global
window.abrirModalMigracaoDireto = abrirModalMigracaoDireto;

function abrirModalMigracao() {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Nova Migração</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formMigracao" onsubmit="salvarMigracao(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autorização de residência">Autorização de residência</option>
                                    <option value="Certificados de residência permanente">Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa">Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar">Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações">Renovação de autorizações</option>
                                    <option value="Vistos D7">Vistos D7</option>
                                    <option value="Vistos Gold">Vistos Gold</option>
                                    <option value="Vistos para estudantes">Vistos para estudantes</option>
                                    <option value="Vistos para trabalho">Vistos para trabalho</option>
                                    <option value="Nacionalidade">Nacionalidade</option>
                                    <option value="Residência">Residência</option>
                                    <option value="Visto">Visto</option>
                                    <option value="Reagrupamento">Reagrupamento</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0">0% (Isento)</option>
                                        <option value="6">6% (Reduzida)</option>
                                        <option value="13">13% (Intermédia)</option>
                                        <option value="23" selected>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="herancaParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="em_andamento">Em Andamento</option>
                                        <option value="concluido">Concluído</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select name="prioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>Média</option>
                                        <option value="alta">Alta</option>
                                        <option value="critica">Crítica</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                    <select name="entidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" title="Instituição em Portugal">
                                        ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre a migração..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Migração
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function abrirModalRegisto() {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Novo Registo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formRegisto" onsubmit="salvarRegisto(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select name="clienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select name="tipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autenticação de documentos">Autenticação de documentos</option>
                                    <option value="Certificação de fotocópias">Certificação de fotocópias</option>
                                    <option value="Documentos para o estrangeiro">Documentos para o estrangeiro</option>
                                    <option value="Procurações">Procurações</option>
                                    <option value="Reconhecimento presencial de assinaturas">Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos automóveis">Registos automóveis</option>
                                    <option value="Registos comerciais">Registos comerciais</option>
                                    <option value="Registos de propriedade">Registos de propriedade</option>
                                    <option value="Termos de autenticação">Termos de autenticação</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" name="valor" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select name="iva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0">0% (Isento)</option>
                                        <option value="6">6% (Reduzida)</option>
                                        <option value="13">13% (Intermédia)</option>
                                        <option value="23" selected>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Parceria</label>
                                    <select name="parceria" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleParceriaNome('heranca')">
                                        <option value="sem">Sem parceria</option>
                                        <option value="empresa">Empresa</option>
                                        <option value="pessoa">Pessoa</option>
                                    </select>
                                </div>
                                
                                <div id="herancaParceriaNomeDiv" style="display: none;">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome da Parceria</label>
                                    <input type="text" name="parceriaNome" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Nome da empresa ou pessoa">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Percentagem (%)</label>
                                    <input type="number" name="percentagem" step="0.01" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Ex: 15">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select name="status" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente">Pendente</option>
                                        <option value="em_andamento">Em Andamento</option>
                                        <option value="concluido">Concluído</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select name="prioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>Média</option>
                                        <option value="alta">Alta</option>
                                        <option value="critica">Crítica</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                    <select name="entidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" title="Instituição em Portugal">
                                        ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}">${e.nome}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" name="dataInicio" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea name="observacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Observações adicionais sobre o registo..."></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Registo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

// === FUNÇÕES DE SALVAMENTO ===

async function salvarHeranca(event) {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'heranca')) return;
    const formData = new FormData(event.target);
    const clienteId = parseIdSafe(formData.get('clienteId'));
    const cliente = clientes.find(c => c.id === clienteId);
    
    const valor = parseFloat(formData.get('valor')) || 0;
    const iva = parseFloat(formData.get('iva')) || 0;
    const percentagem = parseFloat(formData.get('percentagem')) || 0;
    const valorComIva = valor + (valor * iva / 100);

    const novaHeranca = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        tipo: formData.get('tipo'),
        descricao: formData.get('descricao'),
        valor: valor,
        iva: iva,
        percentagem: percentagem,
        valorComIva: valorComIva,
        status: formData.get('status'),
        prioridade: formData.get('prioridade') || 'media',
        entidade: formData.get('entidade') || '',
        dataInicio: formData.get('dataInicio'),
        observacoes: formData.get('observacoes'),
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };

    herancas.unshift(novaHeranca);
    try {
        if (isCloudReady()) {
            await criarProcessoCloud('herancas', novaHeranca);
            salvarDados('herancas', herancas, { skipCloudSync: true });
        } else {
            salvarDados('herancas', herancas);
        }
    } catch (err) {
        console.warn('Erro ao criar herança na nuvem:', err);
        salvarDados('herancas', herancas);
    }
    
    // Criar prazo automático para a herança
    // Carregar prazos em memória antes de adicionar
    const prazosSalvos = appStorage.getItem('prazos');
    if (prazosSalvos) {
        prazos = JSON.parse(prazosSalvos);
        window.prazos = prazos;
    }
    
    const prazoHeranca = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        descricao: `Prazo para ${novaHeranca.tipo} - ${novaHeranca.descricao}`,
        dataLimite: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 60 dias
        status: 'ativo',
        tipo: 'heranca',
        prioridade: 'media',
        referenciaId: novaHeranca.id,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    prazos.push(prazoHeranca);
    window.prazos = prazos;
    salvarDados('prazos', prazos);
    
    mostrarNotificacao('Herança e prazo criados com sucesso!', 'success');
    fecharModal();
    carregarSecao('herancas');
    
    // Atualizar lista após salvar
    setTimeout(() => {
        if (typeof aplicarFiltrosHerancas === 'function') aplicarFiltrosHerancas();
    }, 200);
}

async function salvarMigracao(event) {
    try {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'migracao')) return;
        
    const formData = new FormData(event.target);
    const clienteId = parseIdSafe(formData.get('clienteId'));
    const cliente = clientes.find(c => c.id === clienteId);
    
    const valor = parseFloat(formData.get('valor')) || 0;
    const iva = parseFloat(formData.get('iva')) || 0;
    const percentagem = parseFloat(formData.get('percentagem')) || 0;
    const valorComIva = valor + (valor * iva / 100);
        
    const novaMigracao = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        tipo: formData.get('tipo'),
            descricao: '', // Campo não existe no modal de Migração
        valor: valor,
        iva: iva,
        percentagem: percentagem,
        valorComIva: valorComIva,
        status: formData.get('status'),
        prioridade: formData.get('prioridade') || 'media',
        entidade: formData.get('entidade') || '',
        dataInicio: formData.get('dataInicio'),
            parceria: formData.get('parceria'),
            parceriaNome: formData.get('parceriaNome'),
        observacoes: formData.get('observacoes'),
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };

    migracoes.unshift(novaMigracao);
    try {
        if (isCloudReady()) {
            await criarProcessoCloud('migracoes', novaMigracao);
            salvarDados('migracoes', migracoes, { skipCloudSync: true });
        } else {
            salvarDados('migracoes', migracoes);
        }
    } catch (err) {
        console.warn('Erro ao criar migração na nuvem:', err);
        salvarDados('migracoes', migracoes);
    }
    // Criar prazo automático para a migração
    // Carregar prazos em memória antes de adicionar
    const prazosSalvos = appStorage.getItem('prazos');
    if (prazosSalvos) {
        prazos = JSON.parse(prazosSalvos);
        window.prazos = prazos;
    }
    
    const prazoMigracao = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        descricao: `Prazo para ${novaMigracao.tipo}`,
        dataLimite: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 90 dias
        status: 'ativo',
        tipo: 'migracao',
        prioridade: 'media',
        referenciaId: novaMigracao.id,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    prazos.push(prazoMigracao);
    window.prazos = prazos;
    salvarDados('prazos', prazos);
    mostrarNotificacao('Processo de migração e prazo criados com sucesso!', 'success');
    fecharModal();
        
        setTimeout(() => {
            carregarSecao('migracoes');
        }, 100);
        
    } catch (error) {
        console.error('❌ Erro ao salvar migração:', error);
        mostrarNotificacao('Erro ao salvar migração: ' + error.message, 'error');
    }
}

async function salvarRegisto(event) {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'registo')) return;
    const formData = new FormData(event.target);
    const clienteId = parseIdSafe(formData.get('clienteId'));
    const cliente = clientes.find(c => c.id === clienteId);
    
    const valor = parseFloat(formData.get('valor')) || 0;
    const iva = parseFloat(formData.get('iva')) || 0;
    const percentagem = parseFloat(formData.get('percentagem')) || 0;
    const valorComIva = valor + (valor * iva / 100);

    const novoRegisto = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        tipo: formData.get('tipo'),
        descricao: formData.get('descricao'),
        valor: valor,
        iva: iva,
        percentagem: percentagem,
        valorComIva: valorComIva,
        status: formData.get('status'),
        prioridade: formData.get('prioridade') || 'media',
        entidade: formData.get('entidade') || '',
        dataInicio: formData.get('dataInicio'),
        observacoes: formData.get('observacoes'),
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };

    registos.unshift(novoRegisto);
    try {
        if (isCloudReady()) {
            await criarProcessoCloud('registos', novoRegisto);
            salvarDados('registos', registos, { skipCloudSync: true });
        } else {
            salvarDados('registos', registos);
        }
    } catch (err) {
        console.warn('Erro ao criar registo na nuvem:', err);
        salvarDados('registos', registos);
    }
    
    // Criar prazo automático para o registo
    // Carregar prazos em memória antes de adicionar
    const prazosSalvos = appStorage.getItem('prazos');
    if (prazosSalvos) {
        prazos = JSON.parse(prazosSalvos);
        window.prazos = prazos;
    }
    
    const prazoRegisto = {
        id: gerarIdImutavel(),
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : 'Cliente não encontrado',
        descricao: `Prazo para ${novoRegisto.tipo} - ${novoRegisto.descricao}`,
        dataLimite: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 dias
        status: 'ativo',
        tipo: 'registo',
        prioridade: 'media',
        referenciaId: novoRegisto.id,
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };
    
    prazos.push(prazoRegisto);
    window.prazos = prazos;
    salvarDados('prazos', prazos);
    
    mostrarNotificacao('Registo e prazo criados com sucesso!', 'success');
    fecharModal();
    
    // FORÇAR RECARREGAMENTO IMEDIATO
    
    // Recarregar seção
    setTimeout(() => {
        carregarSecao('registos');
    }, 100);
    
    // Atualizar lista após salvar (usa filtros e paginação)
    setTimeout(() => {
        if (typeof aplicarFiltrosRegistos === 'function') aplicarFiltrosRegistos();
    }, 300);
}

// === FUNÇÕES DE EDIÇÃO E EXCLUSÃO ===

function duplicarHeranca(id) {
    const heranca = obterHerancasAtual().find(h => String(h.id) === String(id));
    if (!heranca) {
        mostrarNotificacao('Herança não encontrada!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('criar', 'heranca')) return;
    fecharModalRobusto();
    abrirModalHeranca();
    setTimeout(() => {
        const form = document.getElementById('formHeranca');
        if (form) {
            form.clienteId.value = heranca.clienteId || '';
            form.tipo.value = heranca.tipo || '';
            form.elements['descricao'] && (form.elements['descricao'].value = heranca.descricao || '');
            form.valor.value = heranca.valor ?? '';
            form.iva.value = String(heranca.iva ?? 23);
            form.elements['parceria'] && (form.elements['parceria'].value = heranca.parceria || 'sem');
            form.elements['parceriaNome'] && (form.elements['parceriaNome'].value = heranca.parceriaNome || '');
            form.elements['percentagem'] && (form.elements['percentagem'].value = heranca.percentagem ?? '');
            form.status.value = 'pendente';
            form.elements['prioridade'] && (form.elements['prioridade'].value = heranca.prioridade || 'media');
            form.elements['entidade'] && (form.elements['entidade'].value = heranca.entidade || '');
            form.dataInicio.value = heranca.dataInicio || '';
            form.observacoes.value = heranca.observacoes || '';
            const parceriaDiv = document.getElementById('herancaParceriaNomeDiv');
            if (parceriaDiv) parceriaDiv.style.display = (heranca.parceria === 'empresa' || heranca.parceria === 'pessoa') ? '' : 'none';
        }
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Herança';
        lucide.createIcons();
    }, 150);
}

function duplicarMigracao(id) {
    const migracao = obterMigracoesAtual().find(m => String(m.id) === String(id));
    if (!migracao) {
        mostrarNotificacao('Migração não encontrada!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('criar', 'migracao')) return;
    fecharModalRobusto();
    abrirModalMigracao();
    setTimeout(() => {
        const form = document.getElementById('formMigracao');
        if (form) {
            form.clienteId.value = migracao.clienteId || '';
            form.tipo.value = migracao.tipo || '';
            form.valor.value = migracao.valor ?? '';
            form.iva.value = String(migracao.iva ?? 23);
            form.elements['parceria'] && (form.elements['parceria'].value = migracao.parceria || 'sem');
            form.elements['parceriaNome'] && (form.elements['parceriaNome'].value = migracao.parceriaNome || '');
            form.elements['percentagem'] && (form.elements['percentagem'].value = migracao.percentagem ?? '');
            form.status.value = 'pendente';
            form.elements['prioridade'] && (form.elements['prioridade'].value = migracao.prioridade || 'media');
            form.elements['entidade'] && (form.elements['entidade'].value = migracao.entidade || '');
            form.dataInicio.value = migracao.dataInicio || '';
            form.observacoes.value = migracao.observacoes || '';
            const parceriaDiv = document.getElementById('herancaParceriaNomeDiv');
            if (parceriaDiv) parceriaDiv.style.display = (migracao.parceria === 'empresa' || migracao.parceria === 'pessoa') ? '' : 'none';
        }
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Migração';
        lucide.createIcons();
    }, 150);
}

function duplicarRegisto(id) {
    const registo = obterRegistosAtual().find(r => String(r.id) === String(id));
    if (!registo) {
        mostrarNotificacao('Registo não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('criar', 'registo')) return;
    fecharModalRobusto();
    abrirModalRegisto();
    setTimeout(() => {
        const form = document.getElementById('formRegisto');
        if (form) {
            form.clienteId.value = registo.clienteId || '';
            form.tipo.value = registo.tipo || '';
            form.valor.value = registo.valor ?? '';
            form.iva.value = String(registo.iva ?? 23);
            form.elements['parceria'] && (form.elements['parceria'].value = registo.parceria || 'sem');
            form.elements['parceriaNome'] && (form.elements['parceriaNome'].value = registo.parceriaNome || '');
            form.elements['percentagem'] && (form.elements['percentagem'].value = registo.percentagem ?? '');
            form.status.value = 'pendente';
            form.elements['prioridade'] && (form.elements['prioridade'].value = registo.prioridade || 'media');
            form.elements['entidade'] && (form.elements['entidade'].value = registo.entidade || '');
            form.dataInicio.value = registo.dataInicio || '';
            form.observacoes.value = registo.observacoes || '';
            const parceriaDiv = document.getElementById('herancaParceriaNomeDiv');
            if (parceriaDiv) parceriaDiv.style.display = (registo.parceria === 'empresa' || registo.parceria === 'pessoa') ? '' : 'none';
        }
        const titulo = document.querySelector('#modalContainer .modal-content h3');
        if (titulo) titulo.textContent = 'Duplicar Registo';
        lucide.createIcons();
    }, 150);
}

function editarHeranca(id) {
    const heranca = herancas.find(h => h.id === id);
    if (!heranca) return;

    abrirModalHeranca();
    // Preencher formulário com dados existentes
    setTimeout(() => {
        const form = document.getElementById('formHeranca');
        if (form) {
            form.clienteId.value = heranca.clienteId;
            form.tipo.value = heranca.tipo;
            form.descricao.value = heranca.descricao || '';
            form.valor.value = heranca.valor || '';
            form.iva.value = heranca.iva || 23;
            form.status.value = heranca.status;
            if (form.elements['prioridade']) form.elements['prioridade'].value = heranca.prioridade || 'media';
            if (form.elements['entidade']) form.elements['entidade'].value = heranca.entidade || '';
            form.dataInicio.value = heranca.dataInicio || '';
            form.observacoes.value = heranca.observacoes || '';
            
            // Alterar título do modal
            document.querySelector('#modalContainer h3').textContent = 'Editar Herança';
            
            // Adicionar campo hidden para ID
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'id';
            hiddenId.value = heranca.id;
            form.appendChild(hiddenId);
        }
    }, 100);
}

function editarMigracao(id) {
    const migracao = migracoes.find(m => m.id === id);
    if (!migracao) return;

    abrirModalMigracao();
    setTimeout(() => {
        const form = document.getElementById('formMigracao');
        if (form) {
            form.clienteId.value = migracao.clienteId;
            form.tipo.value = migracao.tipo;
            form.descricao.value = migracao.descricao || '';
            form.valor.value = migracao.valor || '';
            form.iva.value = migracao.iva || 23;
            form.status.value = migracao.status;
            if (form.elements['prioridade']) form.elements['prioridade'].value = migracao.prioridade || 'media';
            if (form.elements['entidade']) form.elements['entidade'].value = migracao.entidade || '';
            form.dataInicio.value = migracao.dataInicio || '';
            form.observacoes.value = migracao.observacoes || '';
            
            document.querySelector('#modalContainer h3').textContent = 'Editar Processo de Migração';
            
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'id';
            hiddenId.value = migracao.id;
            form.appendChild(hiddenId);
        }
    }, 100);
}

function editarRegisto(id) {
    const registo = registos.find(r => r.id === id);
    if (!registo) return;

    abrirModalRegisto();
    setTimeout(() => {
        const form = document.getElementById('formRegisto');
        if (form) {
            form.clienteId.value = registo.clienteId;
            form.tipo.value = registo.tipo;
            form.descricao.value = registo.descricao || '';
            form.valor.value = registo.valor || '';
            form.iva.value = registo.iva || 23;
            form.status.value = registo.status;
            if (form.elements['prioridade']) form.elements['prioridade'].value = registo.prioridade || 'media';
            if (form.elements['entidade']) form.elements['entidade'].value = registo.entidade || '';
            form.dataInicio.value = registo.dataInicio || '';
            form.observacoes.value = registo.observacoes || '';
            
            document.querySelector('#modalContainer h3').textContent = 'Editar Registo';
            
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'id';
            hiddenId.value = registo.id;
            form.appendChild(hiddenId);
        }
    }, 100);
}

function excluirHeranca(id) {
    if (confirm('Tem certeza que deseja excluir esta herança?')) {
        herancas = herancas.filter(h => h.id !== id);
        salvarDados('herancas', herancas);
        mostrarNotificacao('Herança excluída com sucesso!', 'success');
        carregarSecao('herancas');
    }
}

function excluirMigracao(id) {
    if (confirm('Tem certeza que deseja excluir este processo de migração?')) {
        migracoes = migracoes.filter(m => m.id !== id);
        salvarDados('migracoes', migracoes);
        mostrarNotificacao('Processo de migração excluído com sucesso!', 'success');
        carregarSecao('migracao');
    }
}

function excluirRegisto(id) {
    if (confirm('Tem certeza que deseja excluir este registo?')) {
        registos = registos.filter(r => r.id !== id);
        salvarDados('registos', registos);
        mostrarNotificacao('Registo excluído com sucesso!', 'success');
        carregarSecao('registos');
    }
}

// === SISTEMA DE ANEXOS DE DOCUMENTOS ===

function removerBotoesAnexos() {
    const seletores = [
        'button[onclick*="abrirAnexos"]',
        'button[title="Documentos"]',
        'button[title*="Anexo"]',
        'button[title*="Documento"]'
    ];
    document.querySelectorAll(seletores.join(',')).forEach(btn => btn.remove());
    document.querySelectorAll('i[data-lucide="paperclip"]').forEach(icon => {
        const btn = icon.closest('button');
        if (btn) btn.remove();
    });
    document.querySelectorAll('svg.lucide-paperclip').forEach(icon => {
        const btn = icon.closest('button');
        if (btn) btn.remove();
    });
}

function abrirAnexosCliente(clienteId) {
    mostrarNotificacao('Anexos foram removidos do sistema.', 'info');
    return;
    const cliente = clientes.find(c => c.id === clienteId);
    if (!cliente) return;
    
    // Inicializar array de anexos se não existir
    if (!cliente.anexos) {
        cliente.anexos = [];
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Documentos de ${cliente.nome}</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <!-- Upload de novos documentos -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                        <form onsubmit="adicionarAnexo(event, ${clienteId})" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                    <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                    <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('cliente')">
                                        <option value="">Selecione o tipo</option>
                                        <option value="identificacao">Identificação</option>
                                        <option value="contrato">Contrato</option>
                                        <option value="certificado">Certificado</option>
                                        <option value="comprovativo">Comprovativo</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <div id="tipoPersonalizadoCliente" class="mt-2 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                        <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-4">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Lista de documentos existentes -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${cliente.anexos.length})</h4>
                        ${cliente.anexos.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                <p>Nenhum documento anexado ainda</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${cliente.anexos.map(anexo => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="p-2 bg-blue-100 rounded-lg">
                                                <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="removerAnexo(${clienteId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function adicionarAnexo(event, clienteId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    // Usar tipo personalizado se "outro" foi selecionado
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const cliente = clientes.find(c => c.id === clienteId);
        if (cliente) {
            if (!cliente.anexos) cliente.anexos = [];
            cliente.anexos.push(anexo);
            atualizarClientesEmMemoria(clientes);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosCliente(clienteId); // Recarregar modal
        }
    });
}

function formatarTamanho(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Função para formatar valor com IVA incorporado
function formatarValorComIva(valor, iva, valorComIva) {
    const valorNum = parseFloat(valor) || 0;
    const ivaNum = parseFloat(iva) || 0;
    const valorComIvaNum = parseFloat(valorComIva) || 0;
    
    // Calcular valor com IVA se não foi fornecido
    const valorComIvaCalculado = valorComIvaNum > 0 ? valorComIvaNum : valorNum + (valorNum * ivaNum / 100);
    
    const valorFormatado = (Math.round(valorNum * 100) / 100).toFixed(2);
    const valorComIvaFormatado = (Math.round(valorComIvaCalculado * 100) / 100).toFixed(2);
    
    return `
        <div class="flex flex-col">
            <div class="text-sm font-medium text-gray-900">€${valorFormatado}</div>
            <div class="text-xs text-gray-500">
                <span class="text-gray-400">+ ${ivaNum}% IVA:</span>
                <span class="font-medium text-gray-700">€${valorComIvaFormatado}</span>
            </div>
        </div>
    `;
}

function visualizarAnexo(anexoId) {
    
    // Buscar anexo em todas as fontes
    let anexo = null;
    let tipo = '';
    
    // Buscar em contratos (prioriza global atualizada por ouvirContratos)
    const listaContratos = obterContratosAtual();
    for (const contrato of listaContratos) {
        if (contrato.anexos) {
            anexo = contrato.anexos.find(a => a.id === anexoId);
            if (anexo) {
                tipo = 'contrato';
                break;
            }
        }
    }
    
    // Buscar em heranças
    if (!anexo) {
        const herancasSalvas = appStorage.getItem('herancas');
        if (herancasSalvas) {
            const herancas = JSON.parse(herancasSalvas);
            for (const heranca of herancas) {
                if (heranca.anexos) {
                    anexo = heranca.anexos.find(a => a.id === anexoId);
                    if (anexo) {
                        tipo = 'heranca';
                        break;
                    }
                }
            }
        }
    }
    
    // Buscar em migrações
    if (!anexo) {
        const migracoesSalvas = appStorage.getItem('migracoes');
        if (migracoesSalvas) {
            const migracoes = JSON.parse(migracoesSalvas);
            for (const migracao of migracoes) {
                if (migracao.anexos) {
                    anexo = migracao.anexos.find(a => a.id === anexoId);
                    if (anexo) {
                        tipo = 'migracao';
                        break;
                    }
                }
            }
        }
    }
    
    // Buscar em registos
    if (!anexo) {
        const registosSalvos = appStorage.getItem('registos');
        if (registosSalvos) {
            const registos = JSON.parse(registosSalvos);
            for (const registo of registos) {
                if (registo.anexos) {
                    anexo = registo.anexos.find(a => a.id === anexoId);
                    if (anexo) {
                        tipo = 'registo';
                        break;
                    }
                }
            }
        }
    }
    
    // Buscar em clientes
    if (!anexo) {
        const clientes = obterClientesAtual();
        if (clientes.length > 0) {
            for (const cliente of clientes) {
                if (cliente.anexos) {
                    anexo = cliente.anexos.find(a => a.id === anexoId);
                    if (anexo) {
                        tipo = 'cliente';
                        break;
                    }
                }
            }
        }
    }
    
    if (!anexo) {
        mostrarNotificacao('Documento não encontrado!', 'error');
        return;
    }
    
    // Determinar tipo de arquivo
    const extensao = anexo.nome.split('.').pop().toLowerCase();
    const isImagem = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extensao);
    const isPDF = extensao === 'pdf';
    const isDocumento = ['doc', 'docx', 'txt', 'rtf'].includes(extensao);
    
    // Criar modal de visualização
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-900">${anexo.nome}</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 text-sm text-gray-600">
                        <p><strong>Tipo:</strong> ${anexo.tipo}</p>
                        <p><strong>Tamanho:</strong> ${anexo.tamanho}</p>
                        <p><strong>Data:</strong> ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                        ${anexo.descricao ? `<p><strong>Descrição:</strong> ${anexo.descricao}</p>` : ''}
                    </div>
                    
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        ${isImagem ? `
                            <div class="text-center">
                                <img src="${anexo.conteudo}" alt="${anexo.nome}" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                            </div>
                        ` : isPDF ? `
                            <div class="text-center">
                                <iframe src="${anexo.conteudo}" width="100%" height="500px" class="rounded-lg border-0"></iframe>
                            </div>
                        ` : isDocumento ? `
                            <div class="text-center py-8">
                                <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 text-blue-600"></i>
                                <p class="text-gray-600 mb-4">Visualização não disponível para este tipo de arquivo</p>
                                <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Baixar Documento
                                </button>
                            </div>
                        ` : `
                            <div class="text-center py-8">
                                <i data-lucide="file" class="w-16 h-16 mx-auto mb-4 text-gray-600"></i>
                                <p class="text-gray-600 mb-4">Visualização não disponível para este tipo de arquivo</p>
                                <button onclick="baixarAnexo('${anexoId}')" class="btn btn-primary">
                                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                    Baixar Arquivo
                                </button>
                            </div>
                        `}
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-4">
                        <button onclick="baixarAnexo('${anexoId}')" class="btn btn-secondary">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Baixar
                        </button>
                        <button onclick="fecharModalRobusto()" class="btn btn-primary">
                            <i data-lucide="x" class="w-4 h-4 mr-2"></i>
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar modal ao body
    const modalElement = document.createElement('div');
    modalElement.innerHTML = modal;
    document.body.appendChild(modalElement.firstElementChild);
    lucide.createIcons();
}

function baixarAnexo(anexoId) {
    
    // Buscar anexo em todas as fontes
    let anexo = null;
    
    // Buscar em contratos (prioriza global atualizada por ouvirContratos)
    const listaContratos = obterContratosAtual();
    for (const contrato of listaContratos) {
        if (contrato.anexos) {
            anexo = contrato.anexos.find(a => a.id === anexoId);
            if (anexo) break;
        }
    }
    
    // Buscar em heranças
    if (!anexo) {
        const herancasSalvas = appStorage.getItem('herancas');
        if (herancasSalvas) {
            const herancas = JSON.parse(herancasSalvas);
            for (const heranca of herancas) {
                if (heranca.anexos) {
                    anexo = heranca.anexos.find(a => a.id === anexoId);
                    if (anexo) break;
                }
            }
        }
    }
    
    // Buscar em migrações
    if (!anexo) {
        const migracoesSalvas = appStorage.getItem('migracoes');
        if (migracoesSalvas) {
            const migracoes = JSON.parse(migracoesSalvas);
            for (const migracao of migracoes) {
                if (migracao.anexos) {
                    anexo = migracao.anexos.find(a => a.id === anexoId);
                    if (anexo) break;
                }
            }
        }
    }
    
    // Buscar em registos
    if (!anexo) {
        const registosSalvos = appStorage.getItem('registos');
        if (registosSalvos) {
            const registos = JSON.parse(registosSalvos);
            for (const registo of registos) {
                if (registo.anexos) {
                    anexo = registo.anexos.find(a => a.id === anexoId);
                    if (anexo) break;
                }
            }
        }
    }
    
    // Buscar em clientes
    if (!anexo) {
        const clientes = obterClientesAtual();
        if (clientes.length > 0) {
            for (const cliente of clientes) {
                if (cliente.anexos) {
                    anexo = cliente.anexos.find(a => a.id === anexoId);
                    if (anexo) break;
                }
            }
        }
    }
    
    if (!anexo) {
        console.error('❌ Anexo não encontrado com ID:', anexoId);
        mostrarNotificacao('Documento não encontrado!', 'error');
        return;
    }
    
    
    try {
        
        // Verificar qual campo contém o conteúdo
        let conteudoBase64 = anexo.conteudo || anexo.dataURL || anexo.dados;
        
        // Validar se o conteúdo Base64 é válido
        if (!conteudoBase64 || typeof conteudoBase64 !== 'string' || conteudoBase64 === 'simulado') {
            throw new Error('Conteúdo do anexo não encontrado ou inválido');
        }
        
        // Verificar se é um data URL válido
        let base64Content = conteudoBase64;
        if (base64Content.startsWith('data:')) {
            // Extrair apenas a parte Base64 do data URL
            base64Content = base64Content.split(',')[1];
        }
        
        // Validar formato Base64
        const base64Regex = /^[A-Za-z0-9+/]*={0,2}$/;
        if (!base64Regex.test(base64Content)) {
            throw new Error('Formato Base64 inválido');
        }
        
        // Converter base64 para blob
        const byteCharacters = atob(base64Content);
        
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        
        // Detectar tipo MIME baseado na extensão do arquivo
        let mimeType = anexo.tipoMime || anexo.tipoArquivo || 'application/octet-stream';
        
        // Se não temos tipo MIME, detectar pela extensão
        if (!anexo.tipoMime && !anexo.tipoArquivo) {
            const extensao = anexo.nomeArquivo ? anexo.nomeArquivo.split('.').pop().toLowerCase() : '';
            const mimeTypes = {
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'bmp': 'image/bmp',
                'webp': 'image/webp',
                'pdf': 'application/pdf',
                'doc': 'application/msword',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'xls': 'application/vnd.ms-excel',
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'ppt': 'application/vnd.ms-powerpoint',
                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'txt': 'text/plain',
                'rtf': 'application/rtf',
                'zip': 'application/zip',
                'rar': 'application/x-rar-compressed',
                '7z': 'application/x-7z-compressed'
            };
            
            mimeType = mimeTypes[extensao] || 'application/octet-stream';
        }
        
        
        const blob = new Blob([byteArray], { type: mimeType });
        
        // Criar link de download
        const url = window.URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = anexo.nomeArquivo || anexo.nome;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        mostrarNotificacao('Download iniciado com sucesso!', 'success');
    } catch (error) {
        console.error('❌ Erro ao baixar arquivo:', error);
        console.error('❌ Detalhes do erro:', error.message);
        console.error('❌ Conteúdo do anexo (primeiros 100 chars):', anexo.conteudo ? anexo.conteudo.substring(0, 100) : 'N/A');
        
        let mensagemErro = 'Erro ao baixar arquivo!';
        if (error.message.includes('Base64')) {
            mensagemErro = 'Arquivo corrompido - Base64 inválido. Tente fazer upload novamente.';
        } else if (error.message.includes('conteúdo')) {
            mensagemErro = 'Conteúdo do arquivo não encontrado.';
        }
        
        mostrarNotificacao(mensagemErro, 'error');
    }
}

function carregarListaLocal(chave, listaAtual) {
    if (chave === 'clientes') return obterClientesAtual();
    if (Array.isArray(listaAtual) && listaAtual.length) {
        return listaAtual;
    }
    const salvo = appStorage.getItem(chave);
    return salvo ? JSON.parse(salvo) : (Array.isArray(listaAtual) ? listaAtual : []);
}

function removerAnexo(clienteId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaClientes = obterClientesAtual();
        const cliente = listaClientes.find(c => c.id === clienteId);
        if (cliente && cliente.anexos) {
            cliente.anexos = cliente.anexos.filter(a => a.id !== anexoId);
            atualizarClientesEmMemoria(listaClientes);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosCliente(clienteId); // Recarregar modal
        }
    }
}

// === SISTEMA DE ANEXOS PARA ÁREAS DE EXECUÇÃO ===

function abrirAnexosContrato(contratoId) {
    const contrato = contratos.find(c => c.id === contratoId);
    if (!contrato) return;
    
    if (!contrato.anexos) contrato.anexos = [];
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Documentos do Contrato</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                        <form onsubmit="adicionarAnexoContrato(event, ${contratoId})" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                    <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                    <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('contrato')">
                                        <option value="">Selecione o tipo</option>
                                        <option value="contrato">Contrato</option>
                                        <option value="anexo">Anexo</option>
                                        <option value="comprovativo">Comprovativo</option>
                                        <option value="certificado">Certificado</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <div id="tipoPersonalizadoContrato" class="mt-2 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                        <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-4">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                            </div>
                        </form>
                    </div>
                    
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${contrato.anexos.length})</h4>
                        ${contrato.anexos.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                <p>Nenhum documento anexado ainda</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${contrato.anexos.map(anexo => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="p-2 bg-blue-100 rounded-lg">
                                                <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="removerAnexoContrato(${contratoId}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function adicionarAnexoContrato(event, contratoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    // Usar tipo personalizado se "outro" foi selecionado
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const contrato = contratos.find(c => c.id === contratoId);
        if (contrato) {
            if (!contrato.anexos) contrato.anexos = [];
            contrato.anexos.push(anexo);
            salvarDados('contratos', contratos);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosContrato(contratoId);
        }
    });
}

function removerAnexoContrato(contratoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaContratos = carregarListaLocal('contratos', contratos);
        const contrato = listaContratos.find(c => c.id === contratoId);
        if (contrato && contrato.anexos) {
            contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
            salvarDados('contratos', listaContratos);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosContrato(contratoId);
        }
    }
}

// === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO TIPO PERSONALIZADO ===

function toggleTipoPersonalizado(area) {
    const select = document.getElementById('tipoDocumento');
    const divPersonalizado = document.getElementById(`tipoPersonalizado${area.charAt(0).toUpperCase() + area.slice(1)}`);
    const inputPersonalizado = document.getElementById('tipoPersonalizadoInput');
    
    
    if (select && divPersonalizado) {
        if (select.value === 'outro') {
            divPersonalizado.classList.remove('hidden');
            if (inputPersonalizado) {
                inputPersonalizado.required = true;
                inputPersonalizado.focus();
            }
        } else {
            divPersonalizado.classList.add('hidden');
            if (inputPersonalizado) {
                inputPersonalizado.required = false;
                inputPersonalizado.value = '';
            }
        }
    } else {
        console.error('❌ Elementos não encontrados:', { select: !!select, divPersonalizado: !!divPersonalizado });
    }
}

// === FUNÇÕES PARA PRAZOS ===


// FUNÇÃO atualizarCliente DUPLICADA REMOVIDA - A FUNÇÃO CORRETA ESTÁ NA LINHA 7675
// Esta função antiga estava sobrescrevendo a função correta com validações e logs

function atualizarPrazo(event, id) {
    event.preventDefault();
    
    const prazoIndex = prazos.findIndex(p => p.id === id);
    if (prazoIndex !== -1) {
        if (!exigirPermissaoAcao('editar', 'prazo')) {
            return false;
        }
        prazos[prazoIndex] = {
            ...prazos[prazoIndex],
            descricao: document.getElementById('prazoDescricao').value,
            dataLimite: document.getElementById('prazoDataLimite').value,
            prioridade: document.getElementById('prazoPrioridade').value,
            status: document.getElementById('prazoStatus').value,
            dataAtualizacao: new Date().toISOString()
        };
        
        salvarDados('prazos', prazos);
        mostrarNotificacao('Prazo atualizado com sucesso!', 'success');
        fecharModal();
        carregarSecao('prazos');
    }
}


// === FUNÇÕES DE MODAL DE EDIÇÃO ===

function abrirModalEdicaoCliente(cliente) {
    
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('modalContainer não encontrado!');
        return;
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Cliente</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formEditarCliente_${String(cliente.id).replace(/"/g, '&quot;')}" onsubmit="return atualizarCliente(event, ${JSON.stringify(cliente.id)});">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                                <input type="text" id="editarClienteNome" value="${cliente.nome}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input type="email" id="editarClienteEmail" value="${cliente.email}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Telefone *</label>
                                <input type="tel" id="editarClienteTelefone" value="${cliente.telefone}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIF *</label>
                                <input type="text" id="editarClienteNIF" value="${cliente.nif || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="123456789">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                <textarea id="editarClienteEndereco" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${cliente.endereco || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="editarClienteStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="ativo" ${cliente.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                    <option value="inativo" ${cliente.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                    <option value="suspenso" ${cliente.status === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" id="btnSalvarCliente_${cliente.id}" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modal;
    lucide.createIcons();
    
    // Adicionar listener direto no formulário após criá-lo
    setTimeout(() => {
        const form = document.getElementById(`formEditarCliente_${cliente.id}`);
        const btnSalvar = document.getElementById(`btnSalvarCliente_${cliente.id}`);
        
        if (form) {
            
            // Adicionar listener no formulário (sem clonar para manter listeners internos)
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const resultado = atualizarCliente(e, cliente.id);
                return false;
            }, false);
            
        } else {
            console.error('❌ Formulário não encontrado após criar modal!');
        }
        
        if (btnSalvar) {
            btnSalvar.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const form = document.getElementById(`formEditarCliente_${cliente.id}`);
                if (form) {
                    const resultado = atualizarCliente(e, cliente.id);
                }
            }, false);
        } else {
            console.error('❌ Botão Salvar não encontrado após criar modal!');
        }
    }, 100);
}

function abrirModalEdicaoContrato(contrato) {
    
    // Verificar se o modalContainer existe
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('modalContainer não encontrado!');
        mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
        return;
    }
    
    // Limpar qualquer conteúdo anterior
    modalContainer.innerHTML = '';
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Contrato</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="atualizarContrato(event, ${JSON.stringify(contrato.id)})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="contratoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === contrato.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <input type="text" id="contratoTipo" value="${contrato.tipo || ''}" list="tiposContrato" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Digite ou selecione um tipo">
                                <datalist id="tiposContrato">
                                    <option value="Compra e Venda">
                                    <option value="Arrendamento">
                                    <option value="Prestação de Serviços">
                                    <option value="Empréstimo">
                                    <option value="Alteração de pactos sociais">
                                    <option value="Análise e revisão de contratos">
                                    <option value="Cessão de quotas">
                                    <option value="Constituição de sociedades">
                                    <option value="Contratos de arrendamento">
                                    <option value="Contratos de compra e venda">
                                    <option value="Contratos de prestação de serviços">
                                    <option value="Contratos de trabalho">
                                    <option value="Pactos sociais">
                                    <option value="Consultoria">
                                    <option value="Assessoria">
                                    <option value="Representação">
                                    <option value="Outro">
                                </datalist>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="contratoValor" value="${contrato.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="contratoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${contrato.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${contrato.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${contrato.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${contrato.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="contratoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${contrato.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${contrato.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${contrato.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                    <input type="date" id="contratoDataInicio" value="${contrato.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Fim</label>
                                    <input type="date" id="contratoDataFim" value="${contrato.dataFim || ''}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="contratoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${contrato.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    try {
        modalContainer.innerHTML = modal;
        lucide.createIcons();
        
        // Verificar se o modal foi inserido corretamente
        const modalElement = modalContainer.querySelector('.fixed.inset-0');
        if (modalElement) {
            
            // Forçar visibilidade
            modalElement.style.display = 'flex';
            modalElement.style.visibility = 'visible';
            modalElement.style.opacity = '1';
            modalElement.style.zIndex = '9999';
            
        } else {
            console.error('❌ Modal não foi inserido corretamente');
            mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
        }
    } catch (error) {
        console.error('Erro ao inserir modal:', error);
        mostrarNotificacao('Erro ao abrir modal de edição!', 'error');
    }
}

function abrirModalEdicaoHonorario(honorario) {
    
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
        console.error('❌ modalContainer não encontrado!');
        mostrarNotificacao('Erro: Container do modal não encontrado!', 'error');
        return;
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Honorário</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form id="formEditarHonorario_${String(honorario.id).replace(/[^a-zA-Z0-9-]/g, '_')}" onsubmit="return atualizarHonorario(event, ${JSON.stringify(honorario.id)});">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <input type="text" id="honorarioCliente" value="${honorario.cliente}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Serviço *</label>
                                <input type="text" id="honorarioServico" value="${honorario.servico}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="honorarioValor" value="${honorario.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="honorarioStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${honorario.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="parcial" ${honorario.status === 'parcial' ? 'selected' : ''}>Parcial</option>
                                        <option value="pago" ${honorario.status === 'pago' ? 'selected' : ''}>Pago</option>
                                        <option value="vencido" ${honorario.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                                <input type="date" id="honorarioVencimento" value="${honorario.vencimento}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    modalContainer.innerHTML = modal;
    lucide.createIcons();
}

function abrirModalEdicaoHeranca(heranca) {
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    // Criar modal diretamente no body
    const modal = document.createElement('div');
    modal.id = 'modalEdicaoHeranca';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = fecharModal;
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form onsubmit="atualizarHeranca(event, ${JSON.stringify(heranca.id)})">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="herancaClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                            <select id="herancaTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Tipo</option>
                                <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="herancaValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <select id="herancaIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                    <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                    <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                    <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="herancaStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="herancaPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="baixa" ${(heranca.prioridade || 'media') === 'baixa' ? 'selected' : ''}>Baixa</option>
                                    <option value="media" ${(heranca.prioridade || 'media') === 'media' ? 'selected' : ''}>Média</option>
                                    <option value="alta" ${(heranca.prioridade || 'media') === 'alta' ? 'selected' : ''}>Alta</option>
                                    <option value="critica" ${(heranca.prioridade || 'media') === 'critica' ? 'selected' : ''}>Crítica</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                <select id="herancaEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}" ${(heranca.entidade || '') === e.id ? 'selected' : ''}>${e.nome}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                            <input type="date" id="herancaDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="herancaObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Remover modal anterior se existir
    const modalAnterior = document.getElementById('modalEdicaoHeranca');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Adicionar ao body
    document.body.appendChild(modal);
    lucide.createIcons();
}

function abrirModalEdicaoMigracao(migracao) {
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    // Criar modal diretamente no body
    const modal = document.createElement('div');
    modal.id = 'modalEdicaoMigracao';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = fecharModal;
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                    <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <form onsubmit="atualizarMigracao(event, ${JSON.stringify(migracao.id)})">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                            <select id="migracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Cliente</option>
                                ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                            <select id="migracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                <option value="">Selecionar Tipo</option>
                                <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                <input type="number" id="migracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                <select id="migracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                    <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                    <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                    <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="migracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                <select id="migracaoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="baixa" ${(migracao.prioridade || 'media') === 'baixa' ? 'selected' : ''}>Baixa</option>
                                    <option value="media" ${(migracao.prioridade || 'media') === 'media' ? 'selected' : ''}>Média</option>
                                    <option value="alta" ${(migracao.prioridade || 'media') === 'alta' ? 'selected' : ''}>Alta</option>
                                    <option value="critica" ${(migracao.prioridade || 'media') === 'critica' ? 'selected' : ''}>Crítica</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                <select id="migracaoEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}" ${(migracao.entidade || '') === e.id ? 'selected' : ''}>${e.nome}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                            <input type="date" id="migracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                            <textarea id="migracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // Remover modal anterior se existir
    const modalAnterior = document.getElementById('modalEdicaoMigracao');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Adicionar ao body
    document.body.appendChild(modal);
    lucide.createIcons();
}

function abrirModalEdicaoRegisto(registo) {
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    // Criar modal diretamente no body
    const modal = document.createElement('div');
    modal.id = 'modalEdicaoRegisto';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.onclick = fecharModal;
    
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="atualizarRegisto(event, ${JSON.stringify(registo.id)})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="registoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="registoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                    <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                    <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                    <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                    <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                    <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                    <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                    <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="registoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="registoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="registoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select id="registoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa" ${(registo.prioridade || 'media') === 'baixa' ? 'selected' : ''}>Baixa</option>
                                        <option value="media" ${(registo.prioridade || 'media') === 'media' ? 'selected' : ''}>Média</option>
                                        <option value="alta" ${(registo.prioridade || 'media') === 'alta' ? 'selected' : ''}>Alta</option>
                                        <option value="critica" ${(registo.prioridade || 'media') === 'critica' ? 'selected' : ''}>Crítica</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Entidade</label>
                                    <select id="registoEntidade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        ${(typeof ENTIDADES_PORTUGAL !== 'undefined' ? ENTIDADES_PORTUGAL : []).map(e => `<option value="${e.id}" ${(registo.entidade || '') === e.id ? 'selected' : ''}>${e.nome}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="registoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="registoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal anterior se existir
    const modalAnterior = document.getElementById('modalEdicaoRegisto');
    if (modalAnterior) {
        modalAnterior.remove();
    }
    
    // Adicionar ao body
    document.body.appendChild(modal);
    lucide.createIcons();
}

function abrirModalEdicaoPrazo(prazo) {
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Prazo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="atualizarPrazo(event, ${JSON.stringify(prazo.id)})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente</label>
                                <input type="text" id="prazoCliente" value="${prazo.clienteNome}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <input type="text" id="prazoTipo" value="${prazo.tipo}" readonly class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-100">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                <textarea id="prazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${prazo.descricao}</textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                    <input type="date" id="prazoDataLimite" value="${prazo.dataLimite}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select id="prazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa" ${prazo.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                                        <option value="media" ${prazo.prioridade === 'media' ? 'selected' : ''}>Média</option>
                                        <option value="alta" ${prazo.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                                        <option value="critica" ${prazo.prioridade === 'critica' ? 'selected' : ''}>Crítica</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="prazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="ativo" ${prazo.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                    <option value="concluido" ${prazo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    <option value="vencido" ${prazo.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                    <option value="cancelado" ${prazo.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function abrirModalCriarPrazo(dataInicial) {
    if (!exigirPermissaoAcao('criar', 'prazo')) {
        return;
    }
    const clientesParaSelect = Array.isArray(clientes) ? clientes : [];
    const dataValor = dataInicial || new Date().toISOString().split('T')[0];
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Novo Prazo</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarNovoPrazo(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="novoPrazoCliente" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecione</option>
                                    ${clientesParaSelect.map(cliente => `<option value="${cliente.id}">${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                                <select id="novoPrazoTipo" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="contrato">Contrato</option>
                                    <option value="heranca">Herança</option>
                                    <option value="migracao">Migração</option>
                                    <option value="registo">Registo</option>
                                    <option value="prazo">Prazo</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição *</label>
                                <textarea id="novoPrazoDescricao" rows="3" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Data Limite *</label>
                                    <input type="date" id="novoPrazoDataLimite" value="${dataValor}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select id="novoPrazoPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa">Baixa</option>
                                        <option value="media" selected>Média</option>
                                        <option value="alta">Alta</option>
                                        <option value="critica">Crítica</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="novoPrazoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="ativo" selected>Ativo</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="vencido">Vencido</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="novoPrazoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black"></textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Criar Prazo
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    document.getElementById('modalContainer').innerHTML = modal;
    lucide.createIcons();
}

function salvarNovoPrazo(event) {
    event.preventDefault();
    if (!exigirPermissaoAcao('criar', 'prazo')) return;

    const clienteId = parseIdSafe(document.getElementById('novoPrazoCliente').value);
    const cliente = clientes.find(c => c.id === clienteId);
    if (!clienteId || !cliente) {
        mostrarNotificacao('Selecione um cliente válido.', 'warning');
        return;
    }
    const descricao = document.getElementById('novoPrazoDescricao').value.trim();
    const dataLimite = document.getElementById('novoPrazoDataLimite').value;
    if (!descricao || !dataLimite) {
        mostrarNotificacao('Preencha a descrição e a data limite.', 'warning');
        return;
    }

    const prazo = {
        id: gerarIdImutavel(),
        clienteId,
        clienteNome: cliente.nome || '',
        descricao,
        dataLimite,
        tipo: document.getElementById('novoPrazoTipo').value,
        prioridade: document.getElementById('novoPrazoPrioridade').value,
        status: document.getElementById('novoPrazoStatus').value,
        observacoes: document.getElementById('novoPrazoObservacoes').value || '',
        dataCriacao: new Date().toISOString(),
        criadoPor: appStorage.getItem('usuarioLogado') || 'N/D',
        tipoUsuario: appStorage.getItem('tipoUsuario') || 'N/D'
    };

    const lista = Array.isArray(prazos) ? prazos : [];
    lista.unshift(prazo);
    salvarDados('prazos', lista);
    registrarAuditoria('criar', 'prazo', `Prazo criado: ${prazo.descricao}`, null, prazo);
    mostrarNotificacao('Prazo criado com sucesso!', 'success');
    fecharModalRobusto();
    carregarSecao('calendario');
}

// === FUNÇÕES DE ATUALIZAÇÃO ===
// atualizarContrato está definido acima; suporta ambos os modais (editarContrato* e contrato*)

async function atualizarHonorario(event, id) {
    event.preventDefault();
    
    const honorarioIndex = honorarios.findIndex(h => String(h.id) === String(id));
    if (honorarioIndex === -1) {
        mostrarNotificacao('Honorário não encontrado!', 'error');
        return;
    }
    if (!exigirPermissaoAcao('editar', 'honorario')) return;

    const dados = {
        ...honorarios[honorarioIndex],
        cliente: document.getElementById('honorarioCliente')?.value,
        servico: document.getElementById('honorarioServico')?.value,
        valor: parseFloat(document.getElementById('honorarioValor')?.value) || 0,
        status: document.getElementById('honorarioStatus')?.value,
        vencimento: document.getElementById('honorarioVencimento')?.value,
        dataAtualizacao: new Date().toISOString()
    };

    try {
        if (isCloudReady()) {
            await atualizarHonorarioCloud(String(id), dados);
            honorarios[honorarioIndex] = dados;
            salvarDados('honorarios', honorarios, { skipCloudSync: true });
        } else {
            honorarios[honorarioIndex] = dados;
            salvarDados('honorarios', honorarios);
        }
        mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
        fecharModal();
        carregarSecao('honorarios');
    } catch (err) {
        console.warn('Erro ao atualizar honorário na nuvem:', err);
        honorarios[honorarioIndex] = dados;
        salvarDados('honorarios', honorarios);
        mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
        fecharModal();
        carregarSecao('honorarios');
    }
}

function atualizarHeranca(event, id) {
    event.preventDefault();
    
    const herancas = obterHerancasAtual();
    const clientes = obterClientesAtual();
    
    const herancaIndex = herancas.findIndex(h => h.id === id);
    if (herancaIndex !== -1) {
        if (!exigirPermissaoAcao('editar', 'heranca')) {
            return false;
        }
        const clienteId = document.getElementById('herancaClienteId').value;
        const cliente = clientes.find(c => String(c.id) === String(clienteId));
        
        herancas[herancaIndex] = {
            ...herancas[herancaIndex],
            clienteId: clienteId,
            clienteNome: cliente ? cliente.nome : herancas[herancaIndex].clienteNome,
            tipo: document.getElementById('herancaTipo').value,
            valor: document.getElementById('herancaValor').value,
            iva: document.getElementById('herancaIva').value,
            status: document.getElementById('herancaStatus').value,
            prioridade: document.getElementById('herancaPrioridade')?.value || 'media',
            entidade: document.getElementById('herancaEntidade')?.value || '',
            dataInicio: document.getElementById('herancaDataInicio').value,
            observacoes: document.getElementById('herancaObservacoes').value,
            dataAtualizacao: new Date().toISOString()
        };
        
        salvarDados('herancas', herancas);
        mostrarNotificacao('Herança atualizada com sucesso!', 'success');
        
        // Fechar modal explicitamente
        fecharModal();
        
        // Aguardar um pouco antes de recarregar
        setTimeout(() => {
            carregarSecao('herancas');
        }, 100);
        
    } else {
        console.error('❌ Herança não encontrada com ID:', id);
        mostrarNotificacao('Erro: Herança não encontrada!', 'error');
    }
}

// Tornar função global
window.atualizarHeranca = atualizarHeranca;

function atualizarMigracao(event, id) {
    event.preventDefault();
    
    const migracoes = obterMigracoesAtual();
    const clientes = obterClientesAtual();
    
    const migracaoIndex = migracoes.findIndex(m => m.id === id);
    if (migracaoIndex !== -1) {
        if (!exigirPermissaoAcao('editar', 'migracao')) {
            return false;
        }
        const clienteId = document.getElementById('migracaoClienteId').value;
        const cliente = clientes.find(c => String(c.id) === String(clienteId));
        
        migracoes[migracaoIndex] = {
            ...migracoes[migracaoIndex],
            clienteId: clienteId,
            clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
            tipo: document.getElementById('migracaoTipo').value,
            valor: document.getElementById('migracaoValor').value,
            iva: document.getElementById('migracaoIva').value,
            status: document.getElementById('migracaoStatus').value,
            prioridade: document.getElementById('migracaoPrioridade')?.value || 'media',
            entidade: document.getElementById('migracaoEntidade')?.value || '',
            dataInicio: document.getElementById('migracaoDataInicio').value,
            observacoes: document.getElementById('migracaoObservacoes').value,
            dataAtualizacao: new Date().toISOString()
        };
        
        salvarDados('migracoes', migracoes);
        mostrarNotificacao('Migração atualizada com sucesso!', 'success');
        
        fecharModal();
        
        // Aguardar um pouco antes de recarregar
        setTimeout(() => {
            carregarSecao('migracoes');
        }, 100);
    } else {
        console.error('❌ Migração não encontrada com ID:', id);
        mostrarNotificacao('Erro: Migração não encontrada!', 'error');
    }
}

// Tornar função global
window.atualizarMigracao = atualizarMigracao;

function atualizarRegisto(event, id) {
    event.preventDefault();
    
    // Buscar registos
    const registosSalvos = appStorage.getItem('registos');
    let registos = [];
    if (registosSalvos) {
        registos = JSON.parse(registosSalvos);
    }
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    const registoIndex = registos.findIndex(r => r.id === id);
    if (registoIndex !== -1) {
        if (!exigirPermissaoAcao('editar', 'registo')) {
            return false;
        }
        const clienteId = document.getElementById('registoClienteId').value;
        const cliente = clientes.find(c => String(c.id) === String(clienteId));
        
        registos[registoIndex] = {
            ...registos[registoIndex],
            clienteId: clienteId,
            clienteNome: cliente ? cliente.nome : registos[registoIndex].clienteNome,
            tipo: document.getElementById('registoTipo').value,
            valor: document.getElementById('registoValor').value,
            iva: document.getElementById('registoIva').value,
            status: document.getElementById('registoStatus').value,
            prioridade: document.getElementById('registoPrioridade')?.value || 'media',
            entidade: document.getElementById('registoEntidade')?.value || '',
            dataInicio: document.getElementById('registoDataInicio').value,
            observacoes: document.getElementById('registoObservacoes').value,
            dataAtualizacao: new Date().toISOString()
        };
        
        salvarDados('registos', registos);
        mostrarNotificacao('Registo atualizado com sucesso!', 'success');
        
        // Fechar modal explicitamente
        fecharModal();
        
        // Aguardar um pouco antes de recarregar
        setTimeout(() => {
            carregarSecao('registos');
        }, 100);
        
    } else {
        console.error('❌ Registo não encontrado com ID:', id);
        mostrarNotificacao('Erro: Registo não encontrado!', 'error');
    }
}

// Tornar função global
window.atualizarRegisto = atualizarRegisto;

// === FUNÇÃO SIMPLES PARA SALVAR HERANÇA EDITADA ===
async function salvarHerancaEditada(event, id) {
    event.preventDefault();
    const herancasAtual = obterHerancasAtual();
    const clientesAtual = obterClientesAtual();
    const herancaIndex = herancasAtual.findIndex(h => String(h.id) === String(id));
    if (herancaIndex === -1) {
        mostrarNotificacao('Herança não encontrada!', 'error');
        return;
    }
    const clienteId = document.getElementById('editClienteId').value;
    const cliente = clientesAtual.find(c => String(c.id) === String(clienteId));
    const dadosAtualizados = {
        ...herancasAtual[herancaIndex],
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : herancasAtual[herancaIndex].clienteNome,
        tipo: document.getElementById('editTipo').value,
        valor: document.getElementById('editValor').value,
        iva: document.getElementById('editIva').value,
        status: document.getElementById('editStatus').value,
        prioridade: document.getElementById('editPrioridade')?.value || 'media',
        dataInicio: document.getElementById('editDataInicio').value,
        observacoes: document.getElementById('editObservacoes').value,
        dataAtualizacao: new Date().toISOString()
    };
    herancas = herancasAtual.map((h, i) => i === herancaIndex ? dadosAtualizados : h);
    try {
        if (isCloudReady()) {
            await atualizarProcessoCloud('herancas', id, dadosAtualizados);
            salvarDados('herancas', herancas, { skipCloudSync: true });
        } else {
            salvarDados('herancas', herancas);
        }
        mostrarNotificacao('Herança atualizada com sucesso!', 'success');
    } catch (err) {
        salvarDados('herancas', herancas);
        console.warn('Erro ao atualizar herança na nuvem:', err);
        mostrarNotificacao('Herança atualizada localmente.', 'info');
    }
    const modal = document.getElementById('modalEdicaoHeranca');
    if (modal) modal.remove();
    carregarSecao('herancas');
}

// Tornar função global
window.salvarHerancaEditada = salvarHerancaEditada;

// === FUNÇÃO PARA SALVAR MIGRAÇÃO EDITADA ===
async function salvarMigracaoEditada(event, id) {
    event.preventDefault();
    const migracoesAtual = obterMigracoesAtual();
    const clientesAtual = obterClientesAtual();
    const migracaoIndex = migracoesAtual.findIndex(m => String(m.id) === String(id));
    if (migracaoIndex === -1) {
        mostrarNotificacao('Migração não encontrada!', 'error');
        return;
    }
    const clienteId = document.getElementById('editMigracaoClienteId').value;
    const cliente = clientesAtual.find(c => String(c.id) === String(clienteId));
    const dadosAtualizados = {
        ...migracoesAtual[migracaoIndex],
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : migracoesAtual[migracaoIndex].clienteNome,
        tipo: document.getElementById('editMigracaoTipo').value,
        valor: document.getElementById('editMigracaoValor').value,
        iva: document.getElementById('editMigracaoIva').value,
        status: document.getElementById('editMigracaoStatus').value,
        dataInicio: document.getElementById('editMigracaoDataInicio').value,
        observacoes: document.getElementById('editMigracaoObservacoes').value,
        dataAtualizacao: new Date().toISOString()
    };
    migracoes = migracoesAtual.map((m, i) => i === migracaoIndex ? dadosAtualizados : m);
    try {
        if (isCloudReady()) {
            await atualizarProcessoCloud('migracoes', id, dadosAtualizados);
            salvarDados('migracoes', migracoes, { skipCloudSync: true });
        } else {
            salvarDados('migracoes', migracoes);
        }
        mostrarNotificacao('Migração atualizada com sucesso!', 'success');
    } catch (err) {
        salvarDados('migracoes', migracoes);
        console.warn('Erro ao atualizar migração na nuvem:', err);
        mostrarNotificacao('Migração atualizada localmente.', 'info');
    }
    const modal = document.getElementById('modalEdicaoMigracao');
    if (modal) modal.remove();
    setTimeout(() => carregarSecao('migracoes'), 100);
}

// Tornar função global
window.salvarMigracaoEditada = salvarMigracaoEditada;

// === FUNÇÃO PARA SALVAR REGISTO EDITADO ===
async function salvarRegistoEditado(event, id) {
    event.preventDefault();
    const registosAtual = obterRegistosAtual();
    const clientesAtual = obterClientesAtual();
    const registoIndex = registosAtual.findIndex(r => String(r.id) === String(id));
    if (registoIndex === -1) {
        mostrarNotificacao('Registo não encontrado!', 'error');
        return;
    }
    const clienteId = document.getElementById('editRegistoClienteId').value;
    const cliente = clientesAtual.find(c => String(c.id) === String(clienteId));
    const dadosAtualizados = {
        ...registosAtual[registoIndex],
        clienteId: clienteId,
        clienteNome: cliente ? cliente.nome : registosAtual[registoIndex].clienteNome,
        tipo: document.getElementById('editRegistoTipo').value,
        valor: document.getElementById('editRegistoValor').value,
        iva: document.getElementById('editRegistoIva').value,
        status: document.getElementById('editRegistoStatus').value,
        dataInicio: document.getElementById('editRegistoDataInicio').value,
        observacoes: document.getElementById('editRegistoObservacoes').value,
        dataAtualizacao: new Date().toISOString()
    };
    registos = registosAtual.map((r, i) => i === registoIndex ? dadosAtualizados : r);
    try {
        if (isCloudReady()) {
            await atualizarProcessoCloud('registos', id, dadosAtualizados);
            salvarDados('registos', registos, { skipCloudSync: true });
        } else {
            salvarDados('registos', registos);
        }
        mostrarNotificacao('Registo atualizado com sucesso!', 'success');
    } catch (err) {
        salvarDados('registos', registos);
        console.warn('Erro ao atualizar registo na nuvem:', err);
        mostrarNotificacao('Registo atualizado localmente.', 'info');
    }
    const modal = document.getElementById('modalEdicaoRegisto');
    if (modal) modal.remove();
    setTimeout(() => {
        carregarSecao('registos');
        setTimeout(() => { if (typeof aplicarFiltrosRegistos === 'function') aplicarFiltrosRegistos(); }, 150);
    }, 100);
}

// Tornar função global
window.salvarRegistoEditado = salvarRegistoEditado;

// === FUNÇÃO PARA CONTROLAR MENU MOBILE ===
// Nota: primeira definição de toggleSidebar (perto de carregarSecao) tem overlay e body class;
// esta redefine para manter consistência - aria-expanded aplicado em ambos os botões de menu
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const menuBtn = document.getElementById('mobileMenuBtn');
    const menuHamburguer = document.getElementById('menuHamburguer');
    if (sidebar) {
        const aberto = sidebar.classList.toggle('open');
        document.body.classList.toggle('sidebar-open', aberto);
        if (overlay) overlay.classList.toggle('active', aberto);
        if (menuBtn) menuBtn.setAttribute('aria-expanded', aberto ? 'true' : 'false');
        if (menuHamburguer) menuHamburguer.setAttribute('aria-expanded', aberto ? 'true' : 'false');
    }
}

// Fechar sidebar ao clicar fora (mobile)
document.addEventListener('click', function(event) {
    try {
        const sidebar = document.getElementById('sidebar');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        
        if (window.innerWidth <= 1024 && sidebar && mobileMenuBtn) {
            if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                sidebar.classList.remove('open');
            }
        }
    } catch (error) {
    }
});

// Fechar sidebar ao redimensionar para desktop
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar && window.innerWidth > 1024) {
        sidebar.classList.remove('open');
    }
});

// === FUNÇÃO PARA CONTROLAR VISIBILIDADE DO NOME DA PARCERIA ===

function toggleParceriaNome(tipo) {
    const parceriaSelect = document.getElementById(`${tipo}Parceria`) || document.querySelector(`select[name="parceria"]`);
    const nomeDiv = document.getElementById(`${tipo}ParceriaNomeDiv`) || document.getElementById(`${tipo}ParceriaNomeDiv`);
    
    if (parceriaSelect && nomeDiv) {
        if (parceriaSelect.value === 'empresa' || parceriaSelect.value === 'pessoa') {
            nomeDiv.style.display = 'block';
        } else {
            nomeDiv.style.display = 'none';
        }
    }
}

// === FUNÇÕES ESPECÍFICAS DE EDIÇÃO E EXCLUSÃO PARA ÁREAS DE ATUAÇÃO ===

function editarHeranca(id) {
    // Buscar herança
    const herancasSalvas = appStorage.getItem('herancas');
    let herancas = [];
    if (herancasSalvas) {
        herancas = JSON.parse(herancasSalvas);
    }
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    const heranca = herancas.find(h => h.id === id);
    if (heranca) {
        // Fechar qualquer modal aberto
        fecharModal();
        
        // Criar modal com layout original
        const modal = document.createElement('div');
        modal.id = 'modalEdicaoHeranca';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Herança</h3>
                        <button onclick="document.getElementById('modalEdicaoHeranca').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarHerancaEditada(event, ${id})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === heranca.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="editTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Aceitação da herança" ${heranca.tipo === 'Aceitação da herança' ? 'selected' : ''}>Aceitação da herança</option>
                                    <option value="Doações" ${heranca.tipo === 'Doações' ? 'selected' : ''}>Doações</option>
                                    <option value="Escrituras de partilha" ${heranca.tipo === 'Escrituras de partilha' ? 'selected' : ''}>Escrituras de partilha</option>
                                    <option value="Habilitação de herdeiros" ${heranca.tipo === 'Habilitação de herdeiros' ? 'selected' : ''}>Habilitação de herdeiros</option>
                                    <option value="Partilhas em vida" ${heranca.tipo === 'Partilhas em vida' ? 'selected' : ''}>Partilhas em vida</option>
                                    <option value="Partilhas por óbito" ${heranca.tipo === 'Partilhas por óbito' ? 'selected' : ''}>Partilhas por óbito</option>
                                    <option value="Processo de inventário" ${heranca.tipo === 'Processo de inventário' ? 'selected' : ''}>Processo de inventário</option>
                                    <option value="Renúncia à herança" ${heranca.tipo === 'Renúncia à herança' ? 'selected' : ''}>Renúncia à herança</option>
                                    <option value="Testamentos" ${heranca.tipo === 'Testamentos' ? 'selected' : ''}>Testamentos</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="editValor" value="${heranca.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="editIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${heranca.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${heranca.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${heranca.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${heranca.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${heranca.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${heranca.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${heranca.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridade</label>
                                    <select id="editPrioridade" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="baixa" ${(heranca.prioridade || 'media') === 'baixa' ? 'selected' : ''}>Baixa</option>
                                        <option value="media" ${(heranca.prioridade || 'media') === 'media' ? 'selected' : ''}>Média</option>
                                        <option value="alta" ${(heranca.prioridade || 'media') === 'alta' ? 'selected' : ''}>Alta</option>
                                        <option value="critica" ${(heranca.prioridade || 'media') === 'critica' ? 'selected' : ''}>Crítica</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="editDataInicio" value="${heranca.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="editObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${heranca.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoHeranca').remove()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lucide.createIcons();
    }
}

function excluirHeranca(id) {
    excluirItem('heranca', id);
}

function editarMigracao(id) {
    // Buscar migração
    const migracoesSalvas = appStorage.getItem('migracoes');
    let migracoes = [];
    if (migracoesSalvas) {
        migracoes = JSON.parse(migracoesSalvas);
    }
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    const migracao = migracoes.find(m => m.id === id);
    if (migracao) {
        // Fechar qualquer modal aberto
        fecharModal();
        
        // Criar modal com layout original
        const modal = document.createElement('div');
        modal.id = 'modalEdicaoMigracao';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                        <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarMigracaoEditada(event, ${id})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                    <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                    <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                    <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                    <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                    <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lucide.createIcons();
    }
}

function excluirMigracao(id) {
    excluirItem('migracao', id);
}

function editarRegisto(id) {
    // Buscar registo
    const registosSalvos = appStorage.getItem('registos');
    let registos = [];
    if (registosSalvos) {
        registos = JSON.parse(registosSalvos);
    }
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    const registo = registos.find(r => r.id === id);
    if (registo) {
        // Fechar qualquer modal aberto
        fecharModal();
        
        // Criar modal com layout original
        const modal = document.createElement('div');
        modal.id = 'modalEdicaoRegisto';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Registo</h3>
                        <button onclick="document.getElementById('modalEdicaoRegisto').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarRegistoEditado(event, ${id})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editRegistoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === registo.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="editRegistoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autenticação de documentos" ${registo.tipo === 'Autenticação de documentos' ? 'selected' : ''}>Autenticação de documentos</option>
                                    <option value="Certificação de fotocópias" ${registo.tipo === 'Certificação de fotocópias' ? 'selected' : ''}>Certificação de fotocópias</option>
                                    <option value="Documentos para o estrangeiro" ${registo.tipo === 'Documentos para o estrangeiro' ? 'selected' : ''}>Documentos para o estrangeiro</option>
                                    <option value="Procurações" ${registo.tipo === 'Procurações' ? 'selected' : ''}>Procurações</option>
                                    <option value="Reconhecimento presencial de assinaturas" ${registo.tipo === 'Reconhecimento presencial de assinaturas' ? 'selected' : ''}>Reconhecimento presencial de assinaturas</option>
                                    <option value="Registos automóveis" ${registo.tipo === 'Registos automóveis' ? 'selected' : ''}>Registos automóveis</option>
                                    <option value="Registos comerciais" ${registo.tipo === 'Registos comerciais' ? 'selected' : ''}>Registos comerciais</option>
                                    <option value="Registos de propriedade" ${registo.tipo === 'Registos de propriedade' ? 'selected' : ''}>Registos de propriedade</option>
                                    <option value="Termos de autenticação" ${registo.tipo === 'Termos de autenticação' ? 'selected' : ''}>Termos de autenticação</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="editRegistoValor" value="${registo.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="editRegistoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${registo.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${registo.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${registo.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${registo.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editRegistoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${registo.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${registo.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${registo.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="editRegistoDataInicio" value="${registo.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="editRegistoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${registo.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoRegisto').remove()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lucide.createIcons();
    }
}

function excluirRegisto(id) {
    excluirItem('registo', id);
}

// === FUNÇÕES DE FILTRO PARA MIGRAÇÕES ===
function filtrarMigracoes() {
    aplicarFiltrosMigracoes();
}

function aplicarFiltrosMigracoes() {
    const busca = document.getElementById('buscaMigracoes')?.value.toLowerCase() || '';
    const statusFiltro = document.getElementById('filtroStatusMigracao')?.value || '';
    const tipoFiltro = document.getElementById('filtroTipoMigracao')?.value || '';
    const valorMin = parseFloat(document.getElementById('filtroValorMinMigracao')?.value) || 0;
    const valorMax = parseFloat(document.getElementById('filtroValorMaxMigracao')?.value) || Infinity;
    const nif = document.getElementById('filtroNifMigracao')?.value || '';

    const migracoesFiltradas = migracoes.filter(migracao => {
        const matchBusca = !busca || 
            (migracao.clienteNome?.toLowerCase().includes(busca)) ||
            (migracao.tipo?.toLowerCase().includes(busca));
        
        const matchStatus = !statusFiltro || migracao.status === statusFiltro;
        const matchTipo = !tipoFiltro || migracao.tipo === tipoFiltro;
        const valor = parseFloat(migracao.valor) || 0;
        const matchValor = valor >= valorMin && valor <= valorMax;

        // Filtro por NIF
        const cliente = clientes.find(c => c.id === migracao.clienteId);
        const matchNif = !nif || (cliente && cliente.nif && cliente.nif.includes(nif));

        return matchBusca && matchStatus && matchTipo && matchValor && matchNif;
    });

    // Atualizar tabela
    const tbody = document.getElementById('listaMigracoes');
    if (tbody) {
        tbody.innerHTML = migracoesFiltradas.map(migracao => `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${renderClienteLink(migracao.clienteId, migracao.clienteNome || 'N/A')}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.tipo || 'N/A'}</td>
                <td class="px-6 py-4 text-sm text-gray-500">${migracao.descricao || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="text-sm font-bold text-black">€${(migracao.valor || 0).toFixed(2)}</div>
                    <div class="text-xs font-bold text-red-600">+ IVA: €${((migracao.valor || 0) + ((migracao.valor || 0) * (migracao.iva || 0) / 100)).toFixed(2)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge status-${migracao.status}">${migracao.status === 'concluido' ? 'Concluído' : migracao.status === 'em_andamento' ? 'Em Andamento' : 'Pendente'}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${migracao.dataInicio ? new Date(migracao.dataInicio).toLocaleDateString('pt-PT') : 'Data não definida'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editarMigracaoDireto(${JSON.stringify(migracao.id)})" class="text-blue-600 hover:text-blue-900 mr-3" title="Editar">
                        <i data-lucide="edit" class="w-4 h-4" style="pointer-events:none"></i>
                    </button>
                    <button onclick="abrirAnexosMigracao(${JSON.stringify(migracao.id)})" class="text-green-600 hover:text-green-900 mr-3" title="Documentos">
                        <i data-lucide="paperclip" class="w-4 h-4" style="pointer-events:none"></i>
                    </button>
                    <button onclick="excluirMigracaoDireto(${JSON.stringify(migracao.id)})" class="text-red-600 hover:text-red-900" title="Excluir">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Atualizar contador
    const contador = document.getElementById('contadorMigracoes');
    if (contador) {
        contador.textContent = migracoesFiltradas.length;
    }

    // Recriar ícones
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function limparFiltrosMigracoes() {
    const elementos = [
        'buscaMigracoes',
        'filtroStatusMigracao', 
        'filtroTipoMigracao',
        'filtroValorMinMigracao',
        'filtroValorMaxMigracao',
        'filtroNifMigracao'
    ];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.value = '';
        }
    });
    
    aplicarFiltrosMigracoes();
}

function abrirAnexosMigracao(id) {
    const migracao = obterMigracoesAtual().find(m => String(m.id) === String(id));
    if (migracao) {
        abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
    }
}

// === FUNÇÃO DE EDIÇÃO PADRÃO ===
function abrirModalEdicaoMigracao(migracao) {
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    if (migracao) {
        fecharModal();
        // Criar modal com layout padrão
        const modal = document.createElement('div');
        modal.id = 'modalEdicaoMigracao';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                        <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarMigracaoEditada(event, ${id})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                    <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                    <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                    <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                    <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                    <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="editMigracaoValor" value="${migracao.valor}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lucide.createIcons();
    } else {
    }
}

// === FUNÇÃO DE SALVAR PADRÃO ===
function salvarMigracaoEditada(event, id) {
    event.preventDefault();
    
    // Buscar migrações
    const migracoesSalvas = appStorage.getItem('migracoes');
    let migracoes = [];
    if (migracoesSalvas) {
        migracoes = JSON.parse(migracoesSalvas);
    }
    
    // Buscar clientes (Firestore)
    const clientes = obterClientesAtual();
    
    // Encontrar a migração
    const migracaoIndex = migracoes.findIndex(m => m.id == id);
    
    if (migracaoIndex !== -1) {
        const clienteId = parseIdSafe(document.getElementById('editMigracaoClienteId').value);
        const cliente = clientes.find(c => c.id === clienteId);
        
        const valor = parseFloat(document.getElementById('editMigracaoValor').value);
        const ivaPercent = parseFloat(document.getElementById('editMigracaoIva').value);
        const valorIVA = (valor * ivaPercent) / 100;
        const valorComIva = valor + valorIVA;
        
        // Atualizar os dados
        migracoes[migracaoIndex] = {
            ...migracoes[migracaoIndex],
            clienteId: clienteId,
            clienteNome: cliente ? cliente.nome : migracoes[migracaoIndex].clienteNome,
            tipo: document.getElementById('editMigracaoTipo').value,
            valor: valor,
            iva: ivaPercent,
            valorIVA: valorIVA,
            valorComIva: valorComIva,
            status: document.getElementById('editMigracaoStatus').value,
            dataInicio: document.getElementById('editMigracaoDataInicio').value,
            observacoes: document.getElementById('editMigracaoObservacoes').value,
            dataAtualizacao: new Date().toISOString()
        };
        
        
        // Salvar no Firestore
        salvarDados('migracoes', migracoes);
        window.migracoes = migracoes;
        
        mostrarNotificacao('Migração atualizada com sucesso!', 'success');
        
        // Fechar modal
        const modal = document.getElementById('modalEdicaoMigracao');
        if (modal) {
            modal.remove();
        }
        
        // Recarregar seção
        setTimeout(() => {
            carregarSecao('migracoes');
        }, 100);
    } else {
        mostrarNotificacao('Erro: Migração não encontrada!', 'error');
    }
}

// Tornar função global
window.salvarMigracaoEditada = salvarMigracaoEditada;

// === FUNÇÃO PARA ANEXOS DE CONTRATOS ===
function abrirAnexosContrato(id) {
    const contrato = contratos.find(c => c.id === id);
    if (contrato) {
        abrirModalAnexos('contrato', id, contrato.clienteNome || 'Contrato');
    }
}

// === FUNÇÃO PARA ANEXOS DE HERANÇAS ===
function abrirAnexosHeranca(id) {
    const heranca = herancas.find(h => h.id === id);
    if (heranca) {
        abrirModalAnexos('heranca', id, heranca.clienteNome || 'Herança');
    }
}

// === FUNÇÃO PARA ANEXOS DE MIGRAÇÕES ===
function abrirAnexosMigracao(id) {
    const migracao = obterMigracoesAtual().find(m => String(m.id) === String(id));
    if (migracao) {
        abrirModalAnexos('migracao', id, migracao.clienteNome || 'Migração');
    }
}

// === FUNÇÃO PARA ANEXOS DE REGISTOS ===
function abrirAnexosRegisto(id) {
    const registo = registos.find(r => r.id === id);
    if (registo) {
        abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
    }
}

// === FUNÇÃO PRINCIPAL PARA ABRIR MODAL DE ANEXOS ===
function abrirModalAnexos(tipo, id, nome) {
    mostrarNotificacao('Anexos foram removidos do sistema.', 'info');
    return;
    
    // Fechar qualquer modal aberto primeiro
    fecharModal();
    
    // Buscar dados
    let dados = [];
    let item = null;
    
    if (tipo === 'contrato') {
        dados = obterContratosAtual();
        item = dados.find(c => String(c.id) === String(id));
    } else if (tipo === 'heranca') {
        const herancasSalvas = appStorage.getItem('herancas');
        if (herancasSalvas) {
            dados = JSON.parse(herancasSalvas);
        }
        item = dados.find(h => h.id === id);
    } else if (tipo === 'migracao') {
        const migracoesSalvas = appStorage.getItem('migracoes');
        if (migracoesSalvas) {
            dados = JSON.parse(migracoesSalvas);
        }
        item = dados.find(m => m.id === id);
    } else if (tipo === 'registo') {
        const registosSalvos = appStorage.getItem('registos');
        if (registosSalvos) {
            dados = JSON.parse(registosSalvos);
        }
        item = dados.find(r => r.id === id);
    }
    
    if (!item) {
        mostrarNotificacao('Item não encontrado!', 'error');
        return;
    }
    
    // Inicializar array de anexos se não existir
    if (!item.anexos) {
        item.anexos = [];
    }
    
    const modal = `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="fecharModalRobusto()">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Documentos de ${nome}</h3>
                        <button onclick="fecharModalRobusto()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <!-- Upload de novos documentos -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Adicionar Novo Documento</h4>
                        <form onsubmit="adicionarAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(event, ${id})" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Documento</label>
                                    <input type="text" id="nomeDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                    <select id="tipoDocumento" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" onchange="toggleTipoPersonalizado('${tipo}')">
                                        <option value="">Selecione o tipo</option>
                                        <option value="documento">Documento</option>
                                        <option value="comprovativo">Comprovativo</option>
                                        <option value="certificado">Certificado</option>
                                        <option value="contrato">Contrato</option>
                                        <option value="outro">Outro</option>
                                    </select>
                                    <div id="tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}" class="mt-2 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Especificar tipo</label>
                                        <input type="text" id="tipoPersonalizadoInput" placeholder="Digite o tipo de documento..." class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Arquivo</label>
                                <input type="file" id="arquivoDocumento" required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição (opcional)</label>
                                <textarea id="descricaoDocumento" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black" placeholder="Descrição do documento..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 mt-4">
                                <button type="button" onclick="fecharModalRobusto()" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Adicionar Documento</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Lista de documentos existentes -->
                    <div>
                        <h4 class="text-lg font-semibold mb-4">Documentos Anexados (${item.anexos.length})</h4>
                        ${item.anexos.length === 0 ? `
                            <div class="text-center py-8 text-gray-500">
                                <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                                <p>Nenhum documento anexado ainda</p>
                            </div>
                        ` : `
                            <div class="space-y-3">
                                ${item.anexos.map(anexo => `
                                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <div class="p-2 bg-blue-100 rounded-lg">
                                                <i data-lucide="file" class="w-5 h-5 text-blue-600"></i>
                                            </div>
                                            <div>
                                                <h5 class="font-medium text-gray-900">${anexo.nome}</h5>
                                                <p class="text-sm text-gray-500">${anexo.tipo} • ${anexo.tamanho} • ${new Date(anexo.dataUpload).toLocaleDateString('pt-PT')}</p>
                                                ${anexo.descricao ? `<p class="text-sm text-gray-600 mt-1">${anexo.descricao}</p>` : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="visualizarAnexo('${anexo.id}')" class="text-blue-600 hover:text-blue-800" title="Visualizar">
                                                <i data-lucide="eye" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="baixarAnexo('${anexo.id}')" class="text-green-600 hover:text-green-800" title="Baixar">
                                                <i data-lucide="download" class="w-4 h-4"></i>
                                            </button>
                                            <button onclick="removerAnexo${tipo.charAt(0).toUpperCase() + tipo.slice(1)}(${id}, '${anexo.id}')" class="text-red-600 hover:text-red-800" title="Remover">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar modal ao body
    const modalElement = document.createElement('div');
    modalElement.innerHTML = modal;
    document.body.appendChild(modalElement.firstElementChild);
    lucide.createIcons();
}

// === FUNÇÕES PARA ADICIONAR ANEXOS ===
function adicionarAnexoContrato(event, contratoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const contrato = contratos.find(c => c.id === contratoId);
        if (contrato) {
            if (!contrato.anexos) contrato.anexos = [];
            contrato.anexos.push(anexo);
            salvarDados('contratos', contratos);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosContrato(contratoId);
        }
    });
}

function adicionarAnexoHeranca(event, herancaId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const heranca = herancas.find(h => h.id === herancaId);
        if (heranca) {
            if (!heranca.anexos) heranca.anexos = [];
            heranca.anexos.push(anexo);
            salvarDados('herancas', herancas);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosHeranca(herancaId);
        } else {
            console.error('❌ Herança não encontrada com ID:', herancaId);
            mostrarNotificacao('Herança não encontrada!', 'error');
        }
    });
}

function adicionarAnexoMigracao(event, migracaoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const migracao = migracoes.find(m => m.id === migracaoId);
        if (migracao) {
            if (!migracao.anexos) migracao.anexos = [];
            migracao.anexos.push(anexo);
            salvarDados('migracoes', migracoes);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosMigracao(migracaoId);
        }
    });
}

function adicionarAnexoRegisto(event, registoId) {
    event.preventDefault();
    
    const nome = document.getElementById('nomeDocumento').value;
    const tipoSelecionado = document.getElementById('tipoDocumento').value;
    const tipoPersonalizado = document.getElementById('tipoPersonalizadoInput').value;
    const arquivo = document.getElementById('arquivoDocumento').files[0];
    const descricao = document.getElementById('descricaoDocumento').value;
    
    if (!arquivo) {
        mostrarNotificacao('Por favor, selecione um arquivo', 'error');
        return;
    }
    
    const tipo = tipoSelecionado === 'outro' ? tipoPersonalizado : tipoSelecionado;
    
    if (tipoSelecionado === 'outro' && !tipoPersonalizado.trim()) {
        mostrarNotificacao('Por favor, especifique o tipo de documento', 'error');
        return;
    }
    
    // Converter arquivo para Base64
    converterArquivoParaBase64(arquivo, function(base64Content) {
        const anexo = {
            id: gerarIdImutavel(),
            nome: nome,
            tipo: tipo,
            descricao: descricao,
            nomeArquivo: arquivo.name,
            tamanho: formatarTamanho(arquivo.size),
            dataUpload: new Date().toISOString(),
            tipoArquivo: arquivo.type,
            conteudo: base64Content
        };
        
        const registo = registos.find(r => r.id === registoId);
        if (registo) {
            if (!registo.anexos) registo.anexos = [];
            registo.anexos.push(anexo);
            salvarDados('registos', registos);
            mostrarNotificacao('Documento adicionado com sucesso!', 'success');
            abrirAnexosRegisto(registoId);
        }
    });
}

// === FUNÇÕES PARA REMOVER ANEXOS ===
function removerAnexoContrato(contratoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const contrato = contratos.find(c => c.id === contratoId);
        if (contrato && contrato.anexos) {
            contrato.anexos = contrato.anexos.filter(a => a.id !== anexoId);
            salvarDados('contratos', contratos);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosContrato(contratoId);
        }
    }
}

function removerAnexoHeranca(herancaId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaHerancas = carregarListaLocal('herancas', herancas);
        const heranca = listaHerancas.find(h => h.id === herancaId);
        if (heranca && heranca.anexos) {
            heranca.anexos = heranca.anexos.filter(a => a.id !== anexoId);
            salvarDados('herancas', listaHerancas);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosHeranca(herancaId);
        }
    }
}

function removerAnexoMigracao(migracaoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaMigracoes = carregarListaLocal('migracoes', migracoes);
        const migracao = listaMigracoes.find(m => m.id === migracaoId);
        if (migracao && migracao.anexos) {
            migracao.anexos = migracao.anexos.filter(a => a.id !== anexoId);
            salvarDados('migracoes', listaMigracoes);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosMigracao(migracaoId);
        }
    }
}

function removerAnexoRegisto(registoId, anexoId) {
    if (confirm('Tem certeza que deseja remover este documento?')) {
        const listaRegistos = carregarListaLocal('registos', registos);
        const registo = listaRegistos.find(r => r.id === registoId);
        if (registo && registo.anexos) {
            registo.anexos = registo.anexos.filter(a => a.id !== anexoId);
            salvarDados('registos', listaRegistos);
            mostrarNotificacao('Documento removido com sucesso!', 'success');
            abrirAnexosRegisto(registoId);
        }
    }
}

// === FUNÇÃO PARA TOGGLE TIPO PERSONALIZADO ===
function toggleTipoPersonalizado(tipo) {
    const select = document.getElementById('tipoDocumento');
    const divPersonalizado = document.getElementById(`tipoPersonalizado${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
    
    if (select.value === 'outro') {
        divPersonalizado.classList.remove('hidden');
    } else {
        divPersonalizado.classList.add('hidden');
    }
}

/** Lista honorários: APENAS Firestore (global atualizada por ouvirHonorarios). Sem localStorage. */
function obterHonorariosAtual() {
    return Array.isArray(honorarios) ? honorarios : [];
}

// === FUNÇÕES DIRETAS PARA CONTRATOS ===
/** Lista contratos: apenas Firestore (global atualizada por ouvirContratos). Sem localStorage. */
function obterContratosAtual() {
    return Array.isArray(contratos) ? contratos : [];
}

/** Lista heranças: apenas Firestore (global atualizada por ouvirProcessos). Sem localStorage. */
function obterHerancasAtual() {
    return Array.isArray(herancas) ? herancas : [];
}

/** Lista migrações: apenas Firestore (global atualizada por ouvirProcessos). Sem localStorage. */
function obterMigracoesAtual() {
    return Array.isArray(migracoes) ? migracoes : [];
}

/** Lista registos: apenas Firestore (global atualizada por ouvirProcessos). Sem localStorage. */
function obterRegistosAtual() {
    return Array.isArray(registos) ? registos : [];
}

function obterEntidadesAtual() {
    return Array.isArray(entidades) ? entidades : [];
}

function obterIntegracoesExternasAtual() {
    return Array.isArray(integracoesExternas) ? integracoesExternas : [];
}

function editarContratoDireto(id) {
    const listaContratos = obterContratosAtual();
    const contrato = listaContratos.find(c => String(c.id) === String(id));
    if (contrato) {
        fecharModal();
        setTimeout(() => abrirModalEdicaoContrato(contrato), 100);
    } else {
        mostrarNotificacao('Contrato não encontrado!', 'error');
    }
}

async function excluirContratoDireto(id) {
    if (!exigirPermissaoAcao('apagar', 'contrato')) return;
    if (!confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) return;

    let contratosAtual = obterContratosAtual();
    const contratosAtualizados = contratosAtual.filter(c => String(c.id) !== String(id));

    try {
        if (isCloudReady()) {
            await apagarContratoCloud(id);
            contratos = contratosAtualizados;
            window.contratos = contratos;
            salvarDados('contratos', contratosAtualizados, { skipCloudSync: true });
        } else {
            salvarDados('contratos', contratosAtualizados);
        }
        mostrarNotificacao('Contrato excluído com sucesso!', 'success');
        setTimeout(() => carregarSecao('contratos'), 100);
    } catch (err) {
        console.warn('Erro ao apagar contrato na nuvem, a guardar localmente:', err);
        salvarDados('contratos', contratosAtualizados);
        mostrarNotificacao('Contrato excluído com sucesso!', 'success');
        setTimeout(() => carregarSecao('contratos'), 100);
    }
}

// === FUNÇÕES DIRETAS PARA HERANÇAS ===
async function excluirHerancaDireto(id) {
    if (!confirm('Tem certeza que deseja excluir esta herança? Esta ação não pode ser desfeita.')) return;
    const herancasAtualizadas = obterHerancasAtual().filter(h => String(h.id) !== String(id));
    try {
        if (isCloudReady()) {
            await apagarProcessoCloud('herancas', id);
            herancas = herancasAtualizadas;
            window.herancas = herancas;
            salvarDados('herancas', herancasAtualizadas, { skipCloudSync: true });
        } else {
            herancas = herancasAtualizadas;
            window.herancas = herancas;
            salvarDados('herancas', herancasAtualizadas);
        }
        mostrarNotificacao('Herança excluída com sucesso!', 'success');
        carregarSecao('herancas');
    } catch (err) {
        console.warn('Erro ao apagar herança na nuvem:', err);
        herancas = herancasAtualizadas;
        window.herancas = herancas;
        salvarDados('herancas', herancasAtualizadas);
        mostrarNotificacao('Herança excluída com sucesso!', 'success');
        carregarSecao('herancas');
    }
}

// === FUNÇÕES DIRETAS PARA MIGRAÇÕES ===
function editarMigracaoDireto(id) {
    const migracoesAtual = obterMigracoesAtual();
    const migracao = migracoesAtual.find(m => String(m.id) === String(id));
    
    if (migracao) {
        // Fechar qualquer modal existente
        fecharModal();
        
        // Criar modal simples de edição
        const modal = document.createElement('div');
        modal.id = 'modalEdicaoMigracao';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.onclick = function(e) {
            if (e.target === modal) {
                modal.remove();
            }
        };
        
        const clientes = obterClientesAtual();
        
        modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">Editar Migração</h3>
                        <button onclick="document.getElementById('modalEdicaoMigracao').remove()" class="text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <form onsubmit="salvarMigracaoEditada(event, ${JSON.stringify(migracao.id)})">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Cliente *</label>
                                <select id="editMigracaoClienteId" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Cliente</option>
                                    ${clientes.map(cliente => `<option value="${cliente.id}" ${cliente.id === migracao.clienteId ? 'selected' : ''}>${cliente.nome}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo *</label>
                                <select id="editMigracaoTipo" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                    <option value="">Selecionar Tipo</option>
                                    <option value="Autorização de residência" ${migracao.tipo === 'Autorização de residência' ? 'selected' : ''}>Autorização de residência</option>
                                    <option value="Certificados de residência permanente" ${migracao.tipo === 'Certificados de residência permanente' ? 'selected' : ''}>Certificados de residência permanente</option>
                                    <option value="Processos de nacionalidade portuguesa" ${migracao.tipo === 'Processos de nacionalidade portuguesa' ? 'selected' : ''}>Processos de nacionalidade portuguesa</option>
                                    <option value="Reagrupamento familiar" ${migracao.tipo === 'Reagrupamento familiar' ? 'selected' : ''}>Reagrupamento familiar</option>
                                    <option value="Renovação de autorizações" ${migracao.tipo === 'Renovação de autorizações' ? 'selected' : ''}>Renovação de autorizações</option>
                                    <option value="Vistos D7" ${migracao.tipo === 'Vistos D7' ? 'selected' : ''}>Vistos D7</option>
                                    <option value="Vistos Gold" ${migracao.tipo === 'Vistos Gold' ? 'selected' : ''}>Vistos Gold</option>
                                    <option value="Vistos para estudantes" ${migracao.tipo === 'Vistos para estudantes' ? 'selected' : ''}>Vistos para estudantes</option>
                                    <option value="Vistos para trabalho" ${migracao.tipo === 'Vistos para trabalho' ? 'selected' : ''}>Vistos para trabalho</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Valor *</label>
                                    <input type="number" id="editMigracaoValor" value="${migracao.valor || ''}" step="0.01" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">IVA (%)</label>
                                    <select id="editMigracaoIva" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="0" ${migracao.iva === '0' ? 'selected' : ''}>0% (Isento)</option>
                                        <option value="6" ${migracao.iva === '6' ? 'selected' : ''}>6% (Reduzida)</option>
                                        <option value="13" ${migracao.iva === '13' ? 'selected' : ''}>13% (Intermédia)</option>
                                        <option value="23" ${migracao.iva === '23' ? 'selected' : ''}>23% (Normal)</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="editMigracaoStatus" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                                        <option value="pendente" ${migracao.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                        <option value="em_andamento" ${migracao.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                        <option value="concluido" ${migracao.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data Início *</label>
                                <input type="date" id="editMigracaoDataInicio" value="${migracao.dataInicio || ''}" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                                <textarea id="editMigracaoObservacoes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:border-black">${migracao.observacoes || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="document.getElementById('modalEdicaoMigracao').remove()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Cancelar
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        lucide.createIcons();
    } else {
        mostrarNotificacao('Migração não encontrada!', 'error');
    }
}

async function excluirMigracaoDireto(id) {
    if (!confirm('Tem certeza que deseja excluir esta migração? Esta ação não pode ser desfeita.')) return;
    const migracoesAtualizadas = obterMigracoesAtual().filter(m => String(m.id) !== String(id));
    try {
        if (isCloudReady()) {
            await apagarProcessoCloud('migracoes', id);
            migracoes = migracoesAtualizadas;
            window.migracoes = migracoes;
            salvarDados('migracoes', migracoesAtualizadas, { skipCloudSync: true });
        } else {
            migracoes = migracoesAtualizadas;
            window.migracoes = migracoes;
            salvarDados('migracoes', migracoesAtualizadas);
        }
        
        mostrarNotificacao('Migração excluída com sucesso!', 'success');
        carregarSecao('migracoes');
    } catch (err) {
        console.warn('Erro ao apagar migração na nuvem:', err);
        migracoes = migracoesAtualizadas;
        salvarDados('migracoes', migracoesAtualizadas);
        mostrarNotificacao('Migração excluída com sucesso!', 'success');
        carregarSecao('migracoes');
    }
}

// === SISTEMA DE IVA TRIMESTRAL ===

// Função para determinar o trimestre atual
function obterTrimestreAtual() {
    const agora = new Date();
    const mes = agora.getMonth() + 1; // Janeiro = 1, Dezembro = 12
    
    if (mes >= 1 && mes <= 3) return 1; // 1º Trimestre (Jan-Mar)
    if (mes >= 4 && mes <= 6) return 2; // 2º Trimestre (Abr-Jun)
    if (mes >= 7 && mes <= 9) return 3; // 3º Trimestre (Jul-Set)
    if (mes >= 10 && mes <= 12) return 4; // 4º Trimestre (Out-Dez)
}

// Função para obter datas de prazo do IVA
function obterPrazosIVA(trimestre) {
    const ano = new Date().getFullYear();
    const prazos = {
        1: { // 1º Trimestre
            entrega: `${ano}-05-20`,
            pagamento: `${ano}-05-25`,
            periodo: 'Janeiro a Março'
        },
        2: { // 2º Trimestre
            entrega: `${ano}-07-20`,
            pagamento: `${ano}-07-25`,
            periodo: 'Abril a Junho'
        },
        3: { // 3º Trimestre
            entrega: `${ano}-11-20`,
            pagamento: `${ano}-11-25`,
            periodo: 'Julho a Setembro'
        },
        4: { // 4º Trimestre
            entrega: `${ano + 1}-02-20`,
            pagamento: `${ano + 1}-02-25`,
            periodo: 'Outubro a Dezembro'
        }
    };
    return prazos[trimestre];
}

// Função para calcular IVA acumulado por trimestre
function calcularIVATrimestral_REMOVED() {
    const trimestreAtual = obterTrimestreAtual();
    const ano = new Date().getFullYear();
    
    // Buscar todos os dados (contratos prioriza global atualizada por ouvirContratos)
    const herancasSalvas = appStorage.getItem('herancas');
    const migracoesSalvas = appStorage.getItem('migracoes');
    const registosSalvos = appStorage.getItem('registos');
    
    let contratos = obterContratosAtual();
    let herancas = [], migracoes = [], registos = [];
    if (herancasSalvas) herancas = JSON.parse(herancasSalvas);
    if (migracoesSalvas) migracoes = JSON.parse(migracoesSalvas);
    if (registosSalvos) registos = JSON.parse(registosSalvos);
    
    const todosItens = [...contratos, ...herancas, ...migracoes, ...registos];
    
    // Calcular IVA por trimestre
    const ivaPorTrimestre = {
        1: { valor: 0, itens: 0, periodo: 'Janeiro a Março' },
        2: { valor: 0, itens: 0, periodo: 'Abril a Junho' },
        3: { valor: 0, itens: 0, periodo: 'Julho a Setembro' },
        4: { valor: 0, itens: 0, periodo: 'Outubro a Dezembro' }
    };
    
    todosItens.forEach(item => {
        if (item.dataInicio) {
            const dataInicio = new Date(item.dataInicio);
            const mes = dataInicio.getMonth() + 1;
            
            let trimestre;
            if (mes >= 1 && mes <= 3) trimestre = 1;
            else if (mes >= 4 && mes <= 6) trimestre = 2;
            else if (mes >= 7 && mes <= 9) trimestre = 3;
            else if (mes >= 10 && mes <= 12) trimestre = 4;
            
            if (trimestre && item.valorIVA) {
                ivaPorTrimestre[trimestre].valor += parseFloat(item.valorIVA) || 0;
                ivaPorTrimestre[trimestre].itens += 1;
            }
        }
    });
    
    return { ivaPorTrimestre, trimestreAtual };
}

// Função para criar prazos automáticos de IVA
function criarPrazosIVA() {
    const trimestreAtual = obterTrimestreAtual();
    const prazos = obterPrazosIVA(trimestreAtual);
    
    // Verificar se já existem prazos de IVA para este trimestre
    const prazosSalvos = appStorage.getItem('prazos');
    let prazosExistentes = [];
    if (prazosSalvos) prazosExistentes = JSON.parse(prazosSalvos);
    
    const prazoEntregaExiste = prazosExistentes.some(p => 
        p.tipo === 'iva_entrega' && p.dataLimite === prazos.entrega
    );
    
    const prazoPagamentoExiste = prazosExistentes.some(p => 
        p.tipo === 'iva_pagamento' && p.dataLimite === prazos.pagamento
    );
    
    // Criar prazo de entrega se não existir
    if (!prazoEntregaExiste) {
        const prazoEntrega = {
            id: gerarIdImutavel(),
            clienteId: 0,
            clienteNome: 'Sistema',
            descricao: `Entrega da declaração de IVA - ${prazos.periodo}`,
            dataLimite: prazos.entrega,
            status: 'ativo',
            tipo: 'iva_entrega',
            prioridade: 'alta',
            referenciaId: null,
            dataCriacao: new Date().toISOString()
        };
        prazosExistentes.push(prazoEntrega);
    }
    
    // Criar prazo de pagamento se não existir
    if (!prazoPagamentoExiste) {
        const prazoPagamento = {
            id: gerarIdImutavel(),
            clienteId: 0,
            clienteNome: 'Sistema',
            descricao: `Pagamento do IVA - ${prazos.periodo}`,
            dataLimite: prazos.pagamento,
            status: 'ativo',
            tipo: 'iva_pagamento',
            prioridade: 'alta',
            referenciaId: null,
            dataCriacao: new Date().toISOString()
        };
        prazosExistentes.push(prazoPagamento);
    }
    
    // Salvar prazos
    salvarDados('prazos', prazosExistentes);
    window.prazos = prazosExistentes;
}

// === FUNÇÕES DE IVA TRIMESTRAL ===

function obterTrimestreAtual() {
    const agora = new Date();
    return Math.floor(agora.getMonth() / 3) + 1;
}

function calcularIVATrimestral_REMOVED() {
    const anoAtual = new Date().getFullYear();
    const trimestreAtual = obterTrimestreAtual();
    
    const ivaPorTrimestre = {
        1: { valor: 0, itens: 0, periodo: 'Jan-Mar' },
        2: { valor: 0, itens: 0, periodo: 'Abr-Jun' },
        3: { valor: 0, itens: 0, periodo: 'Jul-Set' },
        4: { valor: 0, itens: 0, periodo: 'Out-Dez' }
    };
    
    // Calcular IVA de todas as fontes
    const todasFontes = [
        ...contratos.map(c => ({ ...c, fonte: 'contrato' })),
        ...herancas.map(h => ({ ...h, fonte: 'heranca' })),
        ...migracoes.map(m => ({ ...m, fonte: 'migracao' })),
        ...registos.map(r => ({ ...r, fonte: 'registo' }))
    ];
    
    todasFontes.forEach(item => {
        if (item.dataCriacao) {
            const data = new Date(item.dataCriacao);
            const ano = data.getFullYear();
            
            if (ano === anoAtual) {
                const trimestre = Math.floor(data.getMonth() / 3) + 1;
                const valor = parseFloat(item.valor) || 0;
                const iva = parseFloat(item.iva) || 0;
                const valorIVA = (valor * iva) / 100;
                
                if (ivaPorTrimestre[trimestre]) {
                    ivaPorTrimestre[trimestre].valor += valorIVA;
                    ivaPorTrimestre[trimestre].itens++;
                }
            }
        }
    });
    
    return { ivaPorTrimestre, trimestreAtual };
}

function obterPrazosIVA(trimestre) {
    const anoAtual = new Date().getFullYear();
    const mesInicio = (trimestre - 1) * 3;
    const mesFim = mesInicio + 2;
    
    // Prazo de entrega: até o dia 10 do segundo mês após o fim do trimestre
    const dataEntrega = new Date(anoAtual, mesFim + 2, 10);
    
    // Prazo de pagamento: até o dia 15 do segundo mês após o fim do trimestre
    const dataPagamento = new Date(anoAtual, mesFim + 2, 15);
    
    const periodos = {
        1: 'Janeiro-Março',
        2: 'Abril-Junho',
        3: 'Julho-Setembro',
        4: 'Outubro-Dezembro'
    };
    
    return {
        trimestre: trimestre,
        periodo: periodos[trimestre],
        entrega: dataEntrega.toISOString(),
        pagamento: dataPagamento.toISOString()
    };
}

function criarPrazosIVA() {
    const trimestreAtual = obterTrimestreAtual();
    const prazosIVA = obterPrazosIVA(trimestreAtual);
    // const { ivaPorTrimestre } = calcularIVATrimestral(); // REMOVIDO
    
    // Verificar se já existe um prazo de IVA para este trimestre
    const prazoExistente = prazos.find(p => 
        p.tipo === 'iva_trimestral' && 
        p.trimestre === trimestreAtual &&
        new Date(p.dataCriacao).getFullYear() === new Date().getFullYear()
    );
    
    if (prazoExistente) {
        mostrarNotificacao('Já existe um prazo de IVA para este trimestre!', 'warning');
        return;
    }
    
    // Criar prazos de entrega e pagamento
    const prazoEntrega = {
        id: gerarIdImutavel(),
        clienteId: null,
        clienteNome: 'Autoridade Tributária',
        tipo: 'iva_trimestral',
        trimestre: trimestreAtual,
        descricao: `Entrega da Declaração de IVA - ${prazosIVA.periodo}`,
        dataLimite: prazosIVA.entrega.split('T')[0],
        status: 'ativo',
        prioridade: 'alta',
        valorIVA: ivaPorTrimestre[trimestreAtual].valor,
        dataCriacao: new Date().toISOString()
    };
    
    const prazoPagamento = {
        id: gerarIdImutavel(),
        clienteId: null,
        clienteNome: 'Autoridade Tributária',
        tipo: 'iva_trimestral',
        trimestre: trimestreAtual,
        descricao: `Pagamento do IVA - ${prazosIVA.periodo} (€${ivaPorTrimestre[trimestreAtual].valor.toFixed(2)})`,
        dataLimite: prazosIVA.pagamento.split('T')[0],
        status: 'ativo',
        prioridade: 'alta',
        valorIVA: ivaPorTrimestre[trimestreAtual].valor,
        dataCriacao: new Date().toISOString()
    };
    
    prazos.push(prazoEntrega, prazoPagamento);
    salvarDados('prazos', prazos);
    
    mostrarNotificacao('Prazos de IVA criados com sucesso!', 'success');
    
    // Recarregar a seção de prazos se estiver ativa
    if (secaoAtiva === 'prazos') {
        carregarSecao('prazos');
    }
}

// Função para gerar relatório de IVA trimestral




async function salvarHonorarioEditado(event, id) {
    event.preventDefault();
    let honorarios = obterHonorariosAtual();
    
    // Converter ID para number se necessário
    const idNum = parseIdSafe(id) ?? id;
    
    // Tentar diferentes tipos de comparação
    let honorarioIndex = honorarios.findIndex(h => h.id == idNum);
    if (honorarioIndex === -1) {
        honorarioIndex = honorarios.findIndex(h => h.id == id);
    }
    if (honorarioIndex === -1) {
        honorarioIndex = honorarios.findIndex(h => String(h.id) === String(id));
    }
    
    if (honorarioIndex !== -1) {
        const dados = {
            ...honorarios[honorarioIndex],
            cliente: document.getElementById('editHonorarioCliente')?.value,
            servico: document.getElementById('editHonorarioServico')?.value,
            valor: parseFloat(document.getElementById('editHonorarioValor')?.value) || 0,
            status: document.getElementById('editHonorarioStatus')?.value,
            vencimento: document.getElementById('editHonorarioVencimento')?.value,
            dataAtualizacao: new Date().toISOString()
        };
        try {
            if (isCloudReady()) {
                await atualizarHonorarioCloud(String(id), dados);
                honorarios[honorarioIndex] = dados;
                salvarDados('honorarios', honorarios, { skipCloudSync: true });
            } else {
                honorarios[honorarioIndex] = dados;
                salvarDados('honorarios', honorarios);
            }
            window.honorarios = honorarios;
        } catch (err) {
            console.warn('Erro ao atualizar honorário na nuvem:', err);
            honorarios[honorarioIndex] = dados;
            salvarDados('honorarios', honorarios);
        }
        const modal = document.getElementById('modalEdicaoHonorario');
        if (modal) modal.remove();
        mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
        setTimeout(() => carregarSecao('honorarios'), 100);
    } else {
        mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
    }
}

async function salvarHonorarioEditadoSimples(id) {
    let honorarios = obterHonorariosAtual();
    const honorarioIndex = honorarios.findIndex(h => String(h.id) === String(id));
    
    if (honorarioIndex !== -1) {
        const dados = {
            ...honorarios[honorarioIndex],
            cliente: document.getElementById('editHonorarioCliente')?.value,
            servico: document.getElementById('editHonorarioServico')?.value,
            valor: parseFloat(document.getElementById('editHonorarioValor')?.value) || 0,
            status: document.getElementById('editHonorarioStatus')?.value,
            vencimento: document.getElementById('editHonorarioVencimento')?.value,
            dataAtualizacao: new Date().toISOString()
        };
        try {
            if (isCloudReady()) {
                await atualizarHonorarioCloud(String(id), dados);
                honorarios[honorarioIndex] = dados;
                salvarDados('honorarios', honorarios, { skipCloudSync: true });
            } else {
                honorarios[honorarioIndex] = dados;
                salvarDados('honorarios', honorarios);
            }
            window.honorarios = honorarios;
        } catch (err) {
            console.warn('Erro ao atualizar honorário na nuvem:', err);
            honorarios[honorarioIndex] = dados;
            salvarDados('honorarios', honorarios);
        }
        mostrarNotificacao('Honorário atualizado com sucesso!', 'success');
        const modal = document.getElementById('modalEdicaoHonorario');
        if (modal) modal.remove();
        setTimeout(() => carregarSecao('honorarios'), 100);
    } else {
        mostrarNotificacao('Erro: Honorário não encontrado!', 'error');
    }
}

// === FUNÇÕES DIRETAS PARA REGISTOS ===
function editarRegistoDireto(id) {
    const registo = obterRegistosAtual().find(r => String(r.id) === String(id));
    if (registo) {
        fecharModal();
        setTimeout(() => abrirModalEdicaoRegisto(registo), 100);
    } else {
        mostrarNotificacao('Registo não encontrado!', 'error');
    }
}

function abrirAnexosRegisto(id) {
    const registo = obterRegistosAtual().find(r => String(r.id) === String(id));
    if (registo) {
        abrirModalAnexos('registo', id, registo.clienteNome || 'Registo');
    } else {
        console.error('❌ Registo não encontrado com ID:', id);
        mostrarNotificacao('Registo não encontrado!', 'error');
    }
}

async function excluirRegistoDireto(id) {
    if (!confirm('Tem certeza que deseja excluir este registo? Esta ação não pode ser desfeita.')) return;
    const registosAtualizados = obterRegistosAtual().filter(r => String(r.id) !== String(id));
    try {
        if (isCloudReady()) {
            await apagarProcessoCloud('registos', id);
            registos = registosAtualizados;
            window.registos = registos;
            salvarDados('registos', registosAtualizados, { skipCloudSync: true });
        } else {
            registos = registosAtualizados;
            window.registos = registos;
            salvarDados('registos', registosAtualizados);
        }
        mostrarNotificacao('Registo excluído com sucesso!', 'success');
        carregarSecao('registos');
        setTimeout(() => { if (typeof aplicarFiltrosRegistos === 'function') aplicarFiltrosRegistos(); }, 150);
    } catch (err) {
        console.warn('Erro ao apagar registo na nuvem:', err);
        registos = registosAtualizados;
        salvarDados('registos', registosAtualizados);
        mostrarNotificacao('Registo excluído com sucesso!', 'success');
        carregarSecao('registos');
    }
}

// === FUNÇÕES PARA HERANÇAS (evitar duplicata - usar obterHerancasAtual) ===
function editarHerancaDireto(id) {
    const heranca = obterHerancasAtual().find(h => String(h.id) === String(id));
    if (heranca) {
        fecharModal();
        setTimeout(() => abrirModalEdicaoHeranca(heranca), 100);
    } else {
        mostrarNotificacao('Herança não encontrada!', 'error');
    }
}

function abrirAnexosHeranca(id) {
    const heranca = obterHerancasAtual().find(h => String(h.id) === String(id));
    if (heranca) {
        abrirModalAnexos('heranca', id, heranca.clienteNome || 'Herança');
    } else {
        console.error('❌ Herança não encontrada com ID:', id);
        mostrarNotificacao('Herança não encontrada!', 'error');
    }
}

// Tornar funções globais
window.abrirAnexosContrato = abrirAnexosContrato;
window.abrirAnexosHeranca = abrirAnexosHeranca;
window.abrirAnexosMigracao = abrirAnexosMigracao;
window.abrirAnexosRegisto = abrirAnexosRegisto;
window.abrirModalAnexos = abrirModalAnexos;
window.visualizarAnexo = visualizarAnexo;
window.baixarAnexo = baixarAnexo;
window.adicionarAnexoContrato = adicionarAnexoContrato;
window.adicionarAnexoHeranca = adicionarAnexoHeranca;
window.adicionarAnexoMigracao = adicionarAnexoMigracao;
window.adicionarAnexoRegisto = adicionarAnexoRegisto;
window.removerAnexoContrato = removerAnexoContrato;
window.removerAnexoHeranca = removerAnexoHeranca;
window.removerAnexoMigracao = removerAnexoMigracao;

if (typeof editarRegistoDireto !== 'function') console.error('editarRegistoDireto não definida');
if (typeof abrirAnexosRegisto !== 'function') console.error('abrirAnexosRegisto não definida');
if (typeof excluirRegistoDireto !== 'function') console.error('excluirRegistoDireto não definida');
window.removerAnexoRegisto = removerAnexoRegisto;
window.toggleTipoPersonalizado = toggleTipoPersonalizado;
window.atualizarContrato = atualizarContrato;
window.abrirModalEdicaoContrato = abrirModalEdicaoContrato;
window.editarContratoDireto = editarContratoDireto;
window.duplicarContrato = duplicarContrato;
window.excluirContratoDireto = excluirContratoDireto;
window.editarHerancaDireto = editarHerancaDireto;
window.duplicarHeranca = duplicarHeranca;
window.excluirHerancaDireto = excluirHerancaDireto;
window.duplicarMigracao = duplicarMigracao;
window.duplicarRegisto = duplicarRegisto;
window.editarMigracaoDireto = editarMigracaoDireto;
window.excluirMigracaoDireto = excluirMigracaoDireto;
window.editarRegistoDireto = editarRegistoDireto;
window.excluirRegistoDireto = excluirRegistoDireto;
window.abrirModalEdicaoMigracao = abrirModalEdicaoMigracao;
window.salvarMigracaoEditada = salvarMigracaoEditada;
window.editarHonorarioDireto = editarHonorarioDireto;
window.duplicarHonorario = duplicarHonorario;
window.excluirHonorarioDireto = excluirHonorarioDireto;
window.salvarHonorarioEditado = salvarHonorarioEditado;
window.excluirClienteDireto = excluirClienteDireto;

// Service Worker Registration REMOVIDO

// PWA completamente removido

