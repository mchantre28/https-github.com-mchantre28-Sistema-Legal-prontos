<div class="invoice-body">
  <div class="invoice-container">
    <!-- Header: Logotipo (esquerda) + Dados da Solicitadora (direita), igual ao documento de referência -->
    <header class="header">
      {{#if logo}}
      <img src="{{logo}}" class="logo" alt="Ana Paula Medina Solicitadora" loading="eager" decoding="sync" />
      {{/if}}
      <div class="issuer-info">
        <h2>{{#if issuer.titulo}}{{issuer.titulo}} {{/if}}{{issuer.name}}</h2>
        {{#if issuer.nif}}<p>NIF: {{issuer.nif}}</p>{{/if}}
        {{#if issuer.phone}}<p>Tlm: {{issuer.phone}}</p>{{/if}}
        {{#if issuer.email}}<p>Email: {{issuer.email}}</p>{{/if}}
        {{#if issuer.iban}}<p>IBAN: {{issuer.iban}}</p>{{/if}}
        {{#if issuer.sede}}<p>Sede: {{issuer.sede}}</p>{{/if}}
      </div>
    </header>
    <hr class="header-divider" />
    <div class="doc-title-block">
      <h2 class="doc-type">{{#if recibo}}Fatura/Recibo {{numero}}{{else}}Fatura {{numero}}{{/if}}</h2>
      <p class="doc-date">Data: {{formatDate dataEmissao}}</p>
    </div>

    {{#if hasCaseMeta}}
    <!-- Tipo de caso / Entidade / Área / Processo -->
    <section class="case-meta-section">
      <div class="case-meta-block">
        {{#if tipoCaso}}<p><strong>Tipo de caso:</strong> {{formatTipoCaso tipoCaso}}</p>{{/if}}
        {{#if entidade}}<p><strong>Entidade:</strong> {{entidade}}</p>{{/if}}
        {{#if areaAtuacao}}<p><strong>Área de atuação:</strong> {{areaAtuacao}}</p>{{/if}}
        {{#if numeroProcesso}}<p><strong>Nº processo:</strong> {{numeroProcesso}}</p>{{/if}}
        {{#if objetoProcesso}}<p><strong>Objeto:</strong> {{objetoProcesso}}</p>{{/if}}
        {{#if referencia}}<p><strong>Referência:</strong> {{referencia}}</p>{{/if}}
      </div>
    </section>
    {{/if}}

    <!-- Dados do cliente -->
    <section class="client-section">
      <h3 class="section-title">Cliente</h3>
      <div class="client-block">
        <p class="client-name">{{cliente.nome}}</p>
        {{#if cliente.numeroCliente}}<p class="client-detail">Nº cliente: {{cliente.numeroCliente}}</p>{{/if}}
        {{#if cliente.nif}}<p class="client-detail">NIF: {{formatNif cliente.nif}}</p>{{/if}}
        {{#if cliente.representanteLegal}}<p class="client-detail">Representante: {{cliente.representanteLegal}}</p>{{/if}}
        <p class="client-address">{{cliente.morada}}</p>
        <p class="client-address">{{cliente.codigoPostal}} {{cliente.localidade}}</p>
        {{#if cliente.pais}}<p class="client-address">{{cliente.pais}}</p>{{/if}}
        {{#if cliente.telefone}}<p class="client-contact">Tlm: {{cliente.telefone}}</p>{{/if}}
        {{#if cliente.email}}<p class="client-contact">Email: {{cliente.email}}</p>{{/if}}
      </div>
    </section>

    <!-- Tabela de itens -->
    <section class="items-section">
      <table class="items-table">
        <thead>
          <tr>
            <th>Descrição</th>
            <th>Art.</th>
            <th>Qtd</th>
            {{#if hasUnidade}}<th>Unidade</th>{{/if}}
            <th>Incidência</th>
            <th>Preço Unit.</th>
            <th>IVA %</th>
            {{#if hasDesconto}}<th>Desc.</th>{{/if}}
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {{#each itens}}
          <tr>
            <td>{{descricao}}{{#if referenciaExterna}} <span class="item-ref">({{referenciaExterna}})</span>{{/if}}</td>
            <td class="center">{{artigo}}</td>
            <td class="center">{{quantidade}}</td>
            {{#if ../hasUnidade}}<td class="center">{{#if unidade}}{{formatUnidade unidade}}{{else}}-{{/if}}</td>{{/if}}
            <td class="center">{{incidencia}}</td>
            <td class="right">{{formatCurrency precoUnitario}}</td>
            <td class="center">{{#if ivaPercent}}{{ivaPercent}}{{else}}0{{/if}}%</td>
            {{#if ../hasDesconto}}<td class="right">{{#if descontoPercent}}{{descontoPercent}}%{{/if}}{{#if descontoValor}}{{#if descontoPercent}} / {{/if}}{{formatCurrency descontoValor}}{{/if}}</td>{{/if}}
            <td class="right">{{formatCurrency total}}</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </section>

    <!-- Totais (caixa à direita: Serviços/Produtos, Despesas, IVA, Total, Valor a Pagar) -->
    <section class="totals-section">
      <div class="totals">
        <table class="totals-table">
        <tr>
          <td>Serviços/Produtos</td>
          <td class="right">{{formatCurrency subtotalServicos}}</td>
        </tr>
        {{#if hasDespesas}}
        <tr>
          <td>Despesas</td>
          <td class="right">{{formatCurrency subtotalDespesas}}</td>
        </tr>
        {{/if}}
        <tr>
          <td>IVA</td>
          <td class="right">{{formatCurrency totais.iva}}</td>
        </tr>
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td class="right"><strong>{{formatCurrency totais.totalComIva}}</strong></td>
        </tr>
        <tr class="amount-due-row">
          <td><strong>Valor a Pagar</strong></td>
          <td class="right"><strong>{{formatCurrency totais.valorAPagar}}</strong></td>
        </tr>
      </table>
      </div>
    </section>

    <!-- Menções legais (Art.53 CIVA, retenção CIRS) -->
    {{#if mencoesLegais}}
    <section class="legal-mentions-section">
      <p class="legal-mentions">{{mencoesLegais}}</p>
    </section>
    {{/if}}

    <!-- Recibo integrado -->
    {{#if recibo}}
    <section class="receipt-section">
      <h3 class="section-title">Recibo</h3>
      <div class="receipt-block">
        <p><strong>Nº:</strong> {{recibo.numero}}</p>
        <p><strong>Data:</strong> {{formatDate recibo.data}}</p>
        <p><strong>Valor Recebido:</strong> {{formatCurrency recibo.valorRecebido}}</p>
        {{#if recibo.formaPagamento}}<p><strong>Forma de pagamento:</strong> {{recibo.formaPagamento}}</p>{{/if}}
        {{#if recibo.referencia}}<p><strong>Referência:</strong> {{recibo.referencia}}</p>{{/if}}
        {{#if recibo.localPagamento}}<p><strong>Local:</strong> {{recibo.localPagamento}}</p>{{/if}}
        {{#if recibo.comprovanteRef}}<p><strong>Comprovante:</strong> {{recibo.comprovanteRef}}</p>{{/if}}
      </div>
    </section>
    {{/if}}

    <!-- Observações -->
    {{#if observacoes}}
    <section class="notes-section">
      <h3 class="section-title">Observações</h3>
      <div class="notes-block">{{observacoes}}</div>
    </section>
    {{/if}}

    <!-- Footer com QR Code à direita -->
    {{#if qrCodeBase64}}
    <div class="footer">
      <img src="data:image/png;base64,{{qrCodeBase64}}" class="qrcode" alt="QR Code" />
    </div>
    {{/if}}

  </div>
</div>
